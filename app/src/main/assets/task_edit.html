<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¼–è¾‘ä»»åŠ¡</title>
    <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: white;
            color: #333;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e9ecef;
        }

        .back-btn {
            background: transparent;
            border: none;
            color: #667eea;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            margin-right: 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .container {
            padding: 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-label.required::after {
            content: " *";
            color: #f44336;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ·å¼ */
        .quill-editor-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .quill-editor-container .ql-toolbar {
            border: none;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .quill-editor-container .ql-container {
            border: none;
            font-size: 14px;
            min-height: 120px;
            max-height: 400px;
            overflow-y: auto;
        }

        .quill-editor-container .ql-editor {
            min-height: 120px;
            padding: 12px;
            line-height: 1.6;
        }

        .quill-editor-container .ql-editor.ql-blank::before {
            color: #999;
            font-style: normal;
        }

        .quill-editor-container:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .btn-upload {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-upload:hover {
            background: #5568d3;
        }

        .image-preview-container {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .image-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .image-preview .remove-btn:hover {
            transform: scale(1.1);
        }

        /* è‡ªå®šä¹‰é€‰æ‹©æ¡†æ ·å¼ */
        .custom-single-select {
            position: relative;
            width: 100%;
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-height: 48px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .custom-select-trigger:hover {
            border-color: #b0b0b0;
        }

        .custom-select-trigger.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .custom-select-display {
            flex: 1;
        }

        .custom-select-arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .custom-select-trigger.active .custom-select-arrow {
            transform: rotate(180deg);
        }

        .custom-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: -1px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .custom-select-dropdown.active {
            display: block;
        }

        .custom-select-option {
            padding: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-select-option:hover {
            background-color: #e3f2fd;
        }

        .custom-select-option.selected {
            background-color: #667eea;
            color: white;
            font-weight: 500;
        }

        .custom-select-option.selected:hover {
            background-color: #5568d3;
        }

        /* å¤šé€‰å®Œæˆäººæ ·å¼ */
        .multi-select-container {
            position: relative;
        }

        .multi-select-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-height: 48px;
            transition: all 0.3s ease;
        }

        .multi-select-display:hover {
            border-color: #b0b0b0;
        }

        .multi-select-display.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .multi-select-tags {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .assignee-tag {
            display: inline-flex;
            align-items: center;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 13px;
            gap: 6px;
        }

        .assignee-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .placeholder {
            color: #999;
        }

        .dropdown-arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .multi-select-display.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: -1px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .multi-select-dropdown.active {
            display: block;
        }

        .assignee-search {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .assignee-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .assignee-option {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f5f5f5;
        }

        .assignee-option:last-child {
            border-bottom: none;
        }

        .assignee-option:hover {
            background-color: #e3f2fd;
        }

        .assignee-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .assignee-option label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        .footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
            max-width: 800px;
            margin: 0 auto;
            border-top: 1px solid #e9ecef;
        }

        .btn-cancel,
        .btn-save {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #5568d3;
        }

        .form-help {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            display: block;
        }

        /* Loading æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Loading é®ç½©å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="margin-top: 20px; color: #667eea; font-size: 14px;">åŠ è½½ä¸­...</div>
    </div>

    <div class="header">
        <button class="back-btn" onclick="goBack()">â†</button>
        <div class="header-title">âœï¸ ç¼–è¾‘ä»»åŠ¡</div>
    </div>

    <div class="container">
        <div class="form-group">
            <label class="form-label required">ä»»åŠ¡æ ‡é¢˜</label>
            <input type="text" class="form-input" id="taskTitle" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜..." maxlength="100">
        </div>

        <div class="form-group">
            <label class="form-label">ä»»åŠ¡å¤‡æ³¨</label>
            <div class="quill-editor-container">
                <div id="taskNotesEditor"></div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">å¤‡æ³¨å›¾ç‰‡</label>
            <input type="file" id="taskNotesImages" accept="image/*" multiple style="display: none;">
            <button type="button" class="btn-upload" onclick="document.getElementById('taskNotesImages').click()">
                ğŸ“· é€‰æ‹©å›¾ç‰‡
            </button>
            <div class="image-preview-container" id="taskNotesImagesPreview"></div>
            <small class="form-help">å¯é€‰æ‹©å¤šå¼ å›¾ç‰‡ä½œä¸ºä»»åŠ¡å¤‡æ³¨çš„é™„ä»¶</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">ä¼˜å…ˆçº§</label>
                <div class="custom-single-select" id="priorityContainer">
                    <div class="custom-select-trigger" onclick="toggleDropdown('priority')">
                        <div class="custom-select-display" id="priorityDisplay">é«˜ä¼˜å…ˆçº§</div>
                        <div class="custom-select-arrow">â–¼</div>
                    </div>
                    <div class="custom-select-dropdown" id="priorityDropdown">
                        <div class="custom-select-option selected" data-value="high" onclick="selectOption('priority', 'high', 'é«˜ä¼˜å…ˆçº§')">é«˜ä¼˜å…ˆçº§</div>
                        <div class="custom-select-option" data-value="medium" onclick="selectOption('priority', 'medium', 'ä¸­ä¼˜å…ˆçº§')">ä¸­ä¼˜å…ˆçº§</div>
                        <div class="custom-select-option" data-value="low" onclick="selectOption('priority', 'low', 'ä½ä¼˜å…ˆçº§')">ä½ä¼˜å…ˆçº§</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">åˆ†ç±»</label>
                <div class="custom-single-select" id="categoryContainer">
                    <div class="custom-select-trigger" onclick="toggleDropdown('category')">
                        <div class="custom-select-display" id="categoryDisplay">å·¥ä½œ</div>
                        <div class="custom-select-arrow">â–¼</div>
                    </div>
                    <div class="custom-select-dropdown" id="categoryDropdown">
                        <div class="custom-select-option selected" data-value="work" onclick="selectOption('category', 'work', 'å·¥ä½œ')">å·¥ä½œ</div>
                        <div class="custom-select-option" data-value="life" onclick="selectOption('category', 'life', 'ç”Ÿæ´»')">ç”Ÿæ´»</div>
                        <div class="custom-select-option" data-value="study" onclick="selectOption('category', 'study', 'å­¦ä¹ ')">å­¦ä¹ </div>
                        <div class="custom-select-option" data-value="other" onclick="selectOption('category', 'other', 'å…¶ä»–')">å…¶ä»–</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">æˆªæ­¢æ—¶é—´</label>
            <input type="datetime-local" class="form-input" id="deadline">
        </div>

        <div class="form-group">
            <label class="form-label">å®Œæˆäºº</label>
            <div class="multi-select-container">
                <div class="multi-select-display" onclick="toggleAssigneeDropdown()">
                    <div class="multi-select-tags" id="assigneeTags">
                        <span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>
                    </div>
                    <span class="dropdown-arrow">â–¼</span>
                </div>
                <div class="multi-select-dropdown" id="assigneeDropdown">
                    <div class="assignee-search">
                        <input type="text" placeholder="æœç´¢å®Œæˆäºº..." onkeyup="filterAssignees(this.value)">
                    </div>
                    <div id="assigneeOptions">
                        <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            <small class="form-help">å¯ä»¥é€‰æ‹©å¤šä¸ªå®Œæˆäºº</small>
        </div>
    </div>

    <div class="footer-actions">
        <button class="btn-cancel" onclick="goBack()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveTask()">ğŸ’¾ ä¿å­˜</button>
    </div>

    <script>
        // ä»URLå‚æ•°è·å–ä»»åŠ¡æ•°æ®
        let taskData = null;
        let selectedImages = [];
        let selectedValues = {
            priority: 'high',
            category: 'work'
        };
        let selectedAssignees = [];
        let assignees = [];
        let taskNotesQuill = null;

        // æ˜¾ç¤ºåŠ è½½ä¸­
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        // éšè—åŠ è½½ä¸­
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        window.onload = async function() {
            // åˆå§‹åŒ–Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            taskNotesQuill = new Quill('#taskNotesEditor', {
                theme: 'snow',
                placeholder: 'è¯·è¾“å…¥ä»»åŠ¡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link'],
                        ['clean']
                    ]
                }
            });

            // åŠ è½½å®Œæˆäººåˆ—è¡¨
            loadAssignees();

            // ä»URLå‚æ•°æˆ–localStorageè·å–ä»»åŠ¡æ•°æ®
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('id');

            if (taskId) {
                // æ˜¾ç¤ºåŠ è½½ä¸­
                showLoading();

                // å¦‚æœlocalStorageä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æ•°æ®åº“æŸ¥è¯¢
                try {
                    const completeData = await fetchTaskFromDatabase(taskId);
                    if (completeData) {
                        taskData = completeData;
                        loadTaskData(taskData);
                    } else {
                        alert('ä»»åŠ¡æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·è¿”å›é‡è¯•');
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
                    alert('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                } finally {
                    // éšè—åŠ è½½ä¸­
                    hideLoading();
                }

            }

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-single-select') && !e.target.closest('.multi-select-container')) {
                    closeAllDropdowns();
                }
            });
        };

        function loadAssignees() {
            const saved = localStorage.getItem('assignees');
            if (saved) {
                try {
                    assignees = JSON.parse(saved);
                    // è§„èŒƒåŒ–æ•°æ®æ ¼å¼
                    assignees = assignees.map(assignee => {
                        if (typeof assignee === 'string') {
                            return { name: assignee };
                        }
                        return assignee;
                    });
                } catch (error) {
                    console.error('åŠ è½½å®Œæˆäººåˆ—è¡¨å¤±è´¥:', error);
                    assignees = [];
                }
            }
            renderAssigneeOptions();
        }

        function renderAssigneeOptions() {
            const container = document.getElementById('assigneeOptions');
            container.innerHTML = '';

            if (assignees.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æš‚æ— å®Œæˆäººï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ </div>';
                return;
            }

            assignees.forEach(assignee => {
                const name = typeof assignee === 'string' ? assignee : assignee.name;
                const isChecked = selectedAssignees.includes(name);

                const option = document.createElement('div');
                option.className = 'assignee-option';
                option.innerHTML = `
                    <input type="checkbox" id="assignee_${name}" ${isChecked ? 'checked' : ''} onchange="toggleAssignee('${name}')">
                    <label for="assignee_${name}">${name}</label>
                `;
                container.appendChild(option);
            });
        }

        function toggleAssignee(name) {
            const index = selectedAssignees.indexOf(name);
            if (index > -1) {
                selectedAssignees.splice(index, 1);
            } else {
                selectedAssignees.push(name);
            }
            updateAssigneeDisplay();
        }

        function updateAssigneeDisplay() {
            const tagsContainer = document.getElementById('assigneeTags');

            if (selectedAssignees.length === 0) {
                tagsContainer.innerHTML = '<span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>';
            } else {
                tagsContainer.innerHTML = selectedAssignees.map(name => `
                    <span class="assignee-tag">
                        ${name}
                        <span class="remove" onclick="removeAssignee('${name}')">Ã—</span>
                    </span>
                `).join('');
            }
        }

        function removeAssignee(name) {
            event.stopPropagation();
            const index = selectedAssignees.indexOf(name);
            if (index > -1) {
                selectedAssignees.splice(index, 1);
                updateAssigneeDisplay();
                renderAssigneeOptions();
            }
        }

        function toggleAssigneeDropdown() {
            event.stopPropagation();
            const display = document.querySelector('.multi-select-display');
            const dropdown = document.getElementById('assigneeDropdown');

            closeAllDropdowns('assignee');

            const isActive = dropdown.classList.contains('active');
            if (isActive) {
                display.classList.remove('active');
                dropdown.classList.remove('active');
            } else {
                display.classList.add('active');
                dropdown.classList.add('active');
            }
        }

        function filterAssignees(searchText) {
            const options = document.querySelectorAll('.assignee-option');
            const search = searchText.toLowerCase();

            options.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                option.style.display = label.includes(search) ? 'flex' : 'none';
            });
        }

        function loadTaskData(data) {
            document.getElementById('taskTitle').value = data.title || '';

            // åŠ è½½å¯Œæ–‡æœ¬å¤‡æ³¨å†…å®¹
            if (taskNotesQuill && data.notes) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºHTMLå†…å®¹ï¼ˆå¯Œæ–‡æœ¬ï¼‰
                if (data.notes.includes('<') && data.notes.includes('>')) {
                    taskNotesQuill.root.innerHTML = data.notes;
                } else {
                    // çº¯æ–‡æœ¬å†…å®¹
                    taskNotesQuill.setText(data.notes);
                }
            }

            // åŠ è½½å¤‡æ³¨å›¾ç‰‡
            if (data.notes_images) {
                try {
                    const images = typeof data.notes_images === 'string'
                        ? JSON.parse(data.notes_images)
                        : data.notes_images;
                    if (Array.isArray(images)) {
                        // å°†å›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºdisplayImagesæœŸæœ›çš„æ ¼å¼
                        selectedImages = images.map((img, index) => {
                            if (typeof img === 'string') {
                                // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                                return {
                                    data: img,
                                    name: `å¤‡æ³¨å›¾ç‰‡${index + 1}`
                                };
                            } else if (img && typeof img === 'object') {
                                // å¦‚æœå·²ç»æ˜¯å¯¹è±¡ï¼Œç¡®ä¿æœ‰dataå’Œnameå±æ€§
                                return {
                                    data: img.data || img,
                                    name: img.name || `å¤‡æ³¨å›¾ç‰‡${index + 1}`
                                };
                            }
                            return null;
                        }).filter(img => img !== null);

                        console.log('åŠ è½½çš„å¤‡æ³¨å›¾ç‰‡æ•°é‡:', selectedImages.length);
                        displayImages();
                    }
                } catch (error) {
                    console.error('åŠ è½½å¤‡æ³¨å›¾ç‰‡å¤±è´¥:', error);
                }
            }

            // è½¬æ¢æˆªæ­¢æ—¶é—´æ ¼å¼ä¸º datetime-local æ‰€éœ€æ ¼å¼
            if (data.deadline) {
                const deadlineFormatted = convertToDatetimeLocal(data.deadline);
                document.getElementById('deadline').value = deadlineFormatted;
            }

            // è®¾ç½®ä¼˜å…ˆçº§
            if (data.priority) {
                selectedValues.priority = data.priority;
                updateSelectDisplay('priority', data.priority);
            }

            // è®¾ç½®åˆ†ç±»
            if (data.category) {
                selectedValues.category = data.category;
                updateSelectDisplay('category', data.category);
            }

            // è®¾ç½®å®Œæˆäºº
            if (data.assignees && Array.isArray(data.assignees)) {
                selectedAssignees = [...data.assignees];
            } else if (data.assignee) {
                selectedAssignees = [data.assignee];
            }
            updateAssigneeDisplay();
            renderAssigneeOptions();
        }

        // å°† ISO æ—¥æœŸæ ¼å¼è½¬æ¢ä¸º datetime-local è¾“å…¥æ¡†æ‰€éœ€çš„æ ¼å¼
        function convertToDatetimeLocal(isoString) {
            try {
                // ä» UTC æ—¶é—´åˆ›å»º Date å¯¹è±¡
                const utcDate = new Date(isoString);

                // å‡å»8å°æ—¶ï¼Œè½¬æ¢ä¸ºå®é™…çš„åŒ—äº¬æ—¶é—´
                const localDate = new Date(utcDate.getTime() - 8 * 60 * 60 * 1000);

                // æ ¼å¼åŒ–ä¸º datetime-local æ‰€éœ€æ ¼å¼
                const year = localDate.getFullYear();
                const month = String(localDate.getMonth() + 1).padStart(2, '0');
                const day = String(localDate.getDate()).padStart(2, '0');
                const hours = String(localDate.getHours()).padStart(2, '0');
                const minutes = String(localDate.getMinutes()).padStart(2, '0');

                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼è½¬æ¢å¤±è´¥:', error);
                return '';
            }
        }

        function updateSelectDisplay(type, value) {
            const displayMap = {
                priority: {
                    high: 'é«˜ä¼˜å…ˆçº§',
                    medium: 'ä¸­ä¼˜å…ˆçº§',
                    low: 'ä½ä¼˜å…ˆçº§'
                },
                category: {
                    work: 'å·¥ä½œ',
                    life: 'ç”Ÿæ´»',
                    study: 'å­¦ä¹ ',
                    other: 'å…¶ä»–'
                }
            };

            const display = document.getElementById(type + 'Display');
            if (display && displayMap[type][value]) {
                display.textContent = displayMap[type][value];
            }

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const dropdown = document.getElementById(type + 'Dropdown');
            if (dropdown) {
                const options = dropdown.querySelectorAll('.custom-select-option');
                options.forEach(option => {
                    if (option.getAttribute('data-value') === value) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
            }
        }

        function toggleDropdown(type) {
            event.stopPropagation();

            const trigger = document.querySelector(`#${type}Container .custom-select-trigger`);
            const dropdown = document.getElementById(type + 'Dropdown');

            // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
            closeAllDropdowns(type);

            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†
            const isActive = dropdown.classList.contains('active');
            if (isActive) {
                trigger.classList.remove('active');
                dropdown.classList.remove('active');
            } else {
                trigger.classList.add('active');
                dropdown.classList.add('active');
            }
        }

        function closeAllDropdowns(except) {
            const dropdowns = document.querySelectorAll('.custom-select-dropdown');
            const triggers = document.querySelectorAll('.custom-select-trigger');

            dropdowns.forEach((dropdown, index) => {
                if (!except || dropdown.id !== except + 'Dropdown') {
                    dropdown.classList.remove('active');
                    if (triggers[index]) {
                        triggers[index].classList.remove('active');
                    }
                }
            });

            if (except !== 'assignee') {
                const assigneeDisplay = document.querySelector('.multi-select-display');
                const assigneeDropdown = document.getElementById('assigneeDropdown');
                if (assigneeDisplay) assigneeDisplay.classList.remove('active');
                if (assigneeDropdown) assigneeDropdown.classList.remove('active');
            }
        }

        function selectOption(type, value, label) {
            event.stopPropagation();

            selectedValues[type] = value;
            document.getElementById(type + 'Display').textContent = label;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const dropdown = document.getElementById(type + 'Dropdown');
            const options = dropdown.querySelectorAll('.custom-select-option');
            options.forEach(option => {
                if (option.getAttribute('data-value') === value) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });

            // å…³é—­ä¸‹æ‹‰æ¡†
            closeAllDropdowns();
        }

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        document.getElementById('taskNotesImages').addEventListener('change', function(e) {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(event) {
                    selectedImages.push({
                        data: event.target.result,
                        name: file.name
                    });
                    displayImages();
                };

                reader.readAsDataURL(file);
            }
        });

        function displayImages() {
            const container = document.getElementById('taskNotesImagesPreview');
            if (!container) {
                console.error('å›¾ç‰‡é¢„è§ˆå®¹å™¨ä¸å­˜åœ¨');
                return;
            }

            container.innerHTML = '';

            selectedImages.forEach((img, index) => {
                // ç¡®ä¿imgå¯¹è±¡æœ‰æ•ˆä¸”æœ‰dataå±æ€§
                if (!img || !img.data) {
                    console.warn(`å›¾ç‰‡${index}æ•°æ®æ— æ•ˆ:`, img);
                    return;
                }

                const div = document.createElement('div');
                div.className = 'image-preview';
                div.innerHTML = `
                    <img src="${img.data || ''}" alt="${img.name || 'å›¾ç‰‡'}" onerror="this.style.display='none'">
                    <button class="remove-btn" onclick="removeImage(${index})">Ã—</button>
                `;
                container.appendChild(div);
            });

            console.log('æ˜¾ç¤ºå›¾ç‰‡æ•°é‡:', selectedImages.length);
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            displayImages();
        }

        // è·å–æœ¬åœ°æ—¶é—´çš„ISOå­—ç¬¦ä¸²ï¼ˆä¸å¸¦æ—¶åŒºæ ‡è¯†ï¼‰
        function getLocalISOString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }

        async function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();

            if (!title) {
                alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                return;
            }

            if (!taskData || !taskData.id) {
                alert('ä»»åŠ¡æ•°æ®ä¸¢å¤±ï¼Œè¯·è¿”å›é‡è¯•');
                return;
            }

            // è·å–æ•°æ®åº“é…ç½®
            const supabaseUrl = localStorage.getItem('supabase_url');
            const supabaseAnonKey = localStorage.getItem('supabase_anon_key');
            const supabaseUserId = localStorage.getItem('supabase_user_id');

            if (!supabaseUrl || !supabaseAnonKey || supabaseUrl.includes('YOUR_PROJECT_ID') || supabaseAnonKey.includes('YOUR_SUPABASE_ANON_KEY')) {
                alert('æ•°æ®åº“é…ç½®ä¸¢å¤±æˆ–æœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®Supabaseè¿æ¥ä¿¡æ¯');
                window.location.href = 'index.html';
                return;
            }

            const DATABASE_CONFIG = {
                supabaseUrl: supabaseUrl,
                supabaseAnonKey: supabaseAnonKey,
                tableName: 'tasks',
                userId: supabaseUserId
            };

            // è·å–ä»»åŠ¡æ•°æ®ï¼ˆä»Quillç¼–è¾‘å™¨è·å–HTMLå†…å®¹ï¼‰
            const notesHtml = taskNotesQuill.root.innerHTML;
            const notes = taskNotesQuill.getText().trim() ? notesHtml : '';
            const deadline = document.getElementById('deadline').value || null;

            // æ›´æ–°ä»»åŠ¡å¯¹è±¡
            const assigneeString = selectedAssignees.length > 0 ? selectedAssignees.join(',') : null;

            const taskDataToUpdate = {
                title: title,
                notes: notes || null,
                notes_images: selectedImages.length > 0 ? JSON.stringify(selectedImages) : null,
                assignee: assigneeString,
                category: selectedValues.category || 'work',
                deadline: deadline,
                priority: selectedValues.priority || 'medium',
                assignees: selectedAssignees || null,
                updated_at: getLocalISOString()
            };

            // è°ƒç”¨APIæ›´æ–°ä»»åŠ¡
            try {
                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}?id=eq.${taskData.id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskDataToUpdate)
                });

                if (response.ok) {
                    console.log('ä»»åŠ¡æ›´æ–°æˆåŠŸ');

                    // å‘é€æ¶ˆæ¯é€šçŸ¥ç»™é™¤äº†è‡ªå·±ä¹‹å¤–çš„å®Œæˆäºº
                    await sendTaskNotificationToAssignees(
                        DATABASE_CONFIG,
                        taskData.id,
                        title,
                        'task_updated',
                        selectedAssignees
                    );

                    // ä¿å­˜åˆ°localStorageä¾›ä¸»é¡µé¢ä½¿ç”¨ï¼ˆå¯é€‰ï¼‰
                    const taskObj = {
                        id: taskData.id,
                        title: title,
                        notes: notes,
                        priority: selectedValues.priority,
                        category: selectedValues.category,
                        deadline: deadline,
                        assignees: selectedAssignees,
                        images: selectedImages
                    };
                    localStorage.setItem('savedTask', JSON.stringify(taskObj));

                    // è¿”å›ä¸»é¡µé¢
                    window.location.href = 'index.html?action=taskSaved';
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('æ›´æ–°ä»»åŠ¡å¤±è´¥:', error);
                alert('æ›´æ–°ä»»åŠ¡å¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            }
        }

        // ä»Supabaseæ•°æ®åº“æŸ¥è¯¢ä»»åŠ¡å®Œæ•´æ•°æ®
        async function fetchTaskFromDatabase(taskId) {
            try {
                // ä»localStorageè·å–Supabaseé…ç½®
                const supabaseUrl = localStorage.getItem('supabase_url');
                const supabaseKey = localStorage.getItem('supabase_anon_key');
                const userId = localStorage.getItem('supabase_user_id');

                if (!supabaseUrl || !supabaseKey || !userId) {
                    throw new Error('Supabaseé…ç½®ä¸å®Œæ•´');
                }

                // æ„å»ºæŸ¥è¯¢URL
                const queryUrl = `${supabaseUrl}/rest/v1/tasks?id=eq.${taskId}&user_id=eq.${userId}&select=*`;

                console.log('æŸ¥è¯¢ä»»åŠ¡æ•°æ®URL:', queryUrl);

                // å‘èµ·è¯·æ±‚
                const response = await fetch(queryUrl, {
                    method: 'GET',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                console.log('ä»æ•°æ®åº“æŸ¥è¯¢åˆ°ä»»åŠ¡æ•°æ®:', data);

                if (data && data.length > 0) {
                    const taskData = data[0];
                    console.log('ä»»åŠ¡å¤‡æ³¨å›¾ç‰‡å­—æ®µ:', taskData.notes_images);
                    console.log('å¤‡æ³¨å›¾ç‰‡ç±»å‹:', typeof taskData.notes_images);
                    return taskData; // è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„ä»»åŠ¡
                }
                return null;
            } catch (error) {
                console.error('æŸ¥è¯¢ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        /**
         * å‘é€ä»»åŠ¡é€šçŸ¥æ¶ˆæ¯ç»™å®Œæˆäººï¼ˆæ’é™¤è‡ªå·±ï¼‰
         */
        async function sendTaskNotificationToAssignees(dbConfig, taskId, taskTitle, messageType, assignees) {
            try {
                const personalInfoStr = localStorage.getItem('personalInfo');
                if (!personalInfoStr || !assignees || assignees.length === 0) {
                    return;
                }

                const personalInfo = JSON.parse(personalInfoStr);
                const currentUser = personalInfo.myAssignee || 'æˆ‘';
                const otherAssignees = assignees.filter(assignee => assignee !== currentUser);

                if (otherAssignees.length === 0) {
                    return;
                }

                const messageTitle = getMessageTitle(messageType);
                const messageContent = getMessageContent(messageType, currentUser, taskTitle);

                const promises = otherAssignees.map(async (receiver) => {
                    const messageData = {
                        sender_id: currentUser,
                        receiver_id: receiver,
                        user_id: dbConfig.userId,
                        task_id: taskId,
                        message_type: messageType,
                        title: messageTitle,
                        content: messageContent,
                        task_title: taskTitle,
                        is_read: false
                    };

                    await fetch(`${dbConfig.supabaseUrl}/rest/v1/messages`, {
                        method: 'POST',
                        headers: {
                            'apikey': dbConfig.supabaseAnonKey,
                            'Authorization': `Bearer ${dbConfig.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(messageData)
                    });
                });

                await Promise.all(promises);
            } catch (error) {
                console.error('å‘é€ä»»åŠ¡é€šçŸ¥å¤±è´¥:', error);
            }
        }

        function getMessageTitle(messageType) {
            switch (messageType) {
                case 'task_created': return 'â• æ–°ä»»åŠ¡åˆ†é…';
                case 'task_updated': return 'âœï¸ ä»»åŠ¡å·²æ›´æ–°';
                case 'task_deleted': return 'ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤';
                default: return 'ğŸ“¢ ä»»åŠ¡é€šçŸ¥';
            }
        }

        function getMessageContent(messageType, sender, taskTitle) {
            switch (messageType) {
                case 'task_created': return `${sender} åˆ›å»ºäº†æ–°ä»»åŠ¡ï¼š${taskTitle}`;
                case 'task_updated': return `${sender} æ›´æ–°äº†ä»»åŠ¡ï¼š${taskTitle}`;
                case 'task_deleted': return `${sender} åˆ é™¤äº†ä»»åŠ¡ï¼š${taskTitle}`;
                default: return `${sender} å¯¹ä»»åŠ¡ã€Œ${taskTitle}ã€è¿›è¡Œäº†æ“ä½œ`;
            }
        }

        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html>
