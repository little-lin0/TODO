<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥å¾…åŠè®¾ç½®</title>
    <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 12px;
            margin-right: 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
        }

        .container {
            padding: 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .info-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .info-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .info-banner p {
            font-size: 13px;
            opacity: 0.95;
            line-height: 1.6;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin: 20px 0 12px;
            padding-left: 12px;
            border-left: 3px solid #667eea;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            position: relative;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-item-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .task-item-actions {
            display: flex;
            gap: 8px;
        }

        .task-item-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .task-item-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .task-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .task-item-detail {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .add-task-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .form-group {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-label.required::after {
            content: " *";
            color: #f44336;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .form-checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* è‡ªå®šä¹‰é€‰æ‹©æ¡†æ ·å¼ */
        .custom-single-select {
            position: relative;
            width: 100%;
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-height: 48px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .custom-select-trigger:hover {
            border-color: #b0b0b0;
        }

        .custom-select-trigger.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .custom-select-display {
            flex: 1;
        }

        .custom-select-arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .custom-select-trigger.active .custom-select-arrow {
            transform: rotate(180deg);
        }

        .custom-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: -1px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .custom-select-dropdown.active {
            display: block;
        }

        .custom-select-option {
            padding: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-select-option:hover {
            background-color: #fff3e0;
        }

        .custom-select-option.selected {
            background-color: #667eea;
            color: white;
            font-weight: 500;
        }

        .custom-select-option.selected:hover {
            background-color: #5568d3;
        }

        /* å¤šé€‰å®Œæˆäººæ ·å¼ */
        .multi-select-container {
            position: relative;
        }

        .multi-select-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-height: 48px;
            transition: all 0.3s ease;
        }

        .multi-select-display:hover {
            border-color: #b0b0b0;
        }

        .multi-select-display.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .multi-select-tags {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .assignee-tag {
            display: inline-flex;
            align-items: center;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 13px;
            gap: 6px;
        }

        .assignee-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        .placeholder {
            color: #999;
        }

        .dropdown-arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .multi-select-display.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: -1px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .multi-select-dropdown.active {
            display: block;
        }

        .assignee-search {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .assignee-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .assignee-option {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f5f5f5;
        }

        .assignee-option:last-child {
            border-bottom: none;
        }

        .assignee-option:hover {
            background-color: #fff3e0;
        }

        .assignee-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .assignee-option label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ·å¼ */
        .quill-editor-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .quill-editor-container .ql-toolbar {
            border: none;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .quill-editor-container .ql-container {
            border: none;
            font-size: 14px;
            min-height: 80px;
            max-height: 300px;
            overflow-y: auto;
        }

        .quill-editor-container .ql-editor {
            min-height: 80px;
            padding: 12px;
            line-height: 1.6;
        }

        .quill-editor-container .ql-editor.ql-blank::before {
            color: #999;
            font-style: normal;
        }

        .quill-editor-container:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
            max-width: 800px;
            margin: 0 auto;
            border-top: 1px solid #e9ecef;
        }

        .btn-cancel,
        .btn-save {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #5568d3;
        }

        .form-help {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            display: block;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .close-modal-btn {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.2s ease;
        }

        .close-modal-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid #e9ecef;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="goBack()">â†</button>
        <div class="header-title">ğŸ“‹ æ¯æ—¥å¾…åŠè®¾ç½®</div>
    </div>

    <div class="container">
        <div class="info-banner">
            <h3>ğŸ’¡ åŠŸèƒ½è¯´æ˜</h3>
            <p>è®¾ç½®æ¯æ—¥å›ºå®šä»»åŠ¡æ¨¡æ¿ï¼Œç³»ç»Ÿå°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡ã€‚ä½ å¯ä»¥é…ç½®ä»»åŠ¡çš„æ ‡é¢˜ã€å¤‡æ³¨ã€ä¼˜å…ˆçº§ã€åˆ†ç±»ã€æˆªæ­¢æ—¶é—´å’Œå®Œæˆäººç­‰ä¿¡æ¯ã€‚</p>
        </div>

        <section class="section-title">åŸºæœ¬è®¾ç½®</section>

        <div class="form-group">
            <label class="form-checkbox-group">
                <input type="checkbox" id="enableDailyTodo" checked>
                <span>å¯ç”¨æ¯æ—¥è‡ªåŠ¨æ·»åŠ ä»»åŠ¡</span>
            </label>
        </div>

        <div class="form-group">
            <label class="form-checkbox-group">
                <input type="checkbox" id="skipHolidays" checked>
                <span>è·³è¿‡èŠ‚å‡æ—¥ï¼ˆå‘¨æœ«å’Œæ³•å®šèŠ‚å‡æ—¥ï¼‰</span>
            </label>
            <small class="form-help">å¼€å¯åå°†ä¸ä¼šåœ¨å‘¨æœ«å’Œæ³•å®šèŠ‚å‡æ—¥ç”Ÿæˆæ¯æ—¥ä»»åŠ¡</small>
        </div>

        <div class="form-group">
            <label class="form-label">è‡ªåŠ¨ç”Ÿæˆæ—¶é—´</label>
            <input type="time" class="form-input" id="autoAddTime" value="09:00">
            <small class="form-help">ç³»ç»Ÿå°†åœ¨æ­¤æ—¶é—´è‡ªåŠ¨ç”Ÿæˆæ¯æ—¥ä»»åŠ¡</small>
        </div>

        <section class="section-title">ä»»åŠ¡æ¨¡æ¿åˆ—è¡¨</section>

        <div class="task-list" id="taskList">
            <!-- ä»»åŠ¡é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <button class="add-task-btn" onclick="openAddTaskModal()">
            â• æ·»åŠ ä»»åŠ¡æ¨¡æ¿
        </button>
    </div>

    <div class="footer-actions">
        <button class="btn-cancel" onclick="goBack()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
    </div>

    <!-- ä»»åŠ¡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ·»åŠ ä»»åŠ¡æ¨¡æ¿</div>
                <button class="close-modal-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">ä»»åŠ¡æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="taskTitle" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜..." maxlength="100">
                </div>

                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡å¤‡æ³¨</label>
                    <div class="quill-editor-container">
                        <div id="taskNotesEditor"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ä¼˜å…ˆçº§</label>
                        <div class="custom-single-select" id="priorityContainer">
                            <div class="custom-select-trigger" onclick="toggleDropdown('priority')">
                                <div class="custom-select-display" id="priorityDisplay">ä¸­ä¼˜å…ˆçº§</div>
                                <div class="custom-select-arrow">â–¼</div>
                            </div>
                            <div class="custom-select-dropdown" id="priorityDropdown">
                                <div class="custom-select-option" data-value="high" onclick="selectOption('priority', 'high', 'é«˜ä¼˜å…ˆçº§')">é«˜ä¼˜å…ˆçº§</div>
                                <div class="custom-select-option selected" data-value="medium" onclick="selectOption('priority', 'medium', 'ä¸­ä¼˜å…ˆçº§')">ä¸­ä¼˜å…ˆçº§</div>
                                <div class="custom-select-option" data-value="low" onclick="selectOption('priority', 'low', 'ä½ä¼˜å…ˆçº§')">ä½ä¼˜å…ˆçº§</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">åˆ†ç±»</label>
                        <div class="custom-single-select" id="categoryContainer">
                            <div class="custom-select-trigger" onclick="toggleDropdown('category')">
                                <div class="custom-select-display" id="categoryDisplay">å·¥ä½œ</div>
                                <div class="custom-select-arrow">â–¼</div>
                            </div>
                            <div class="custom-select-dropdown" id="categoryDropdown">
                                <div class="custom-select-option selected" data-value="work" onclick="selectOption('category', 'work', 'å·¥ä½œ')">å·¥ä½œ</div>
                                <div class="custom-select-option" data-value="life" onclick="selectOption('category', 'life', 'ç”Ÿæ´»')">ç”Ÿæ´»</div>
                                <div class="custom-select-option" data-value="study" onclick="selectOption('category', 'study', 'å­¦ä¹ ')">å­¦ä¹ </div>
                                <div class="custom-select-option" data-value="other" onclick="selectOption('category', 'other', 'å…¶ä»–')">å…¶ä»–</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">æˆªæ­¢æ—¶é—´</label>
                    <input type="time" class="form-input" id="deadline" value="23:59">
                    <small class="form-help">è®¾ç½®ä»»åŠ¡çš„æˆªæ­¢æ—¶é—´ï¼ˆé»˜è®¤23:59ï¼‰</small>
                </div>

                <div class="form-group">
                    <label class="form-label">å®Œæˆäºº</label>
                    <div class="multi-select-container">
                        <div class="multi-select-display" onclick="toggleAssigneeDropdown()">
                            <div class="multi-select-tags" id="assigneeTags">
                                <span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>
                            </div>
                            <span class="dropdown-arrow">â–¼</span>
                        </div>
                        <div class="multi-select-dropdown" id="assigneeDropdown">
                            <div class="assignee-search">
                                <input type="text" placeholder="æœç´¢å®Œæˆäºº..." onkeyup="filterAssignees(this.value)">
                            </div>
                            <div id="assigneeOptions">
                                <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    <small class="form-help">å¯ä»¥é€‰æ‹©å¤šä¸ªå®Œæˆäºº</small>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeTaskModal()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="saveTask()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let taskTemplates = [];
        let assignees = [];
        let selectedAssignees = [];
        let selectedValues = {
            priority: 'medium',
            category: 'work'
        };
        let taskNotesQuill = null;
        let editingTaskIndex = -1;

        window.onload = function() {
            // åˆå§‹åŒ–Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            taskNotesQuill = new Quill('#taskNotesEditor', {
                theme: 'snow',
                placeholder: 'è¯·è¾“å…¥ä»»åŠ¡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link'],
                        ['clean']
                    ]
                }
            });

            // åŠ è½½é…ç½®
            loadSettings();
            loadAssignees();

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-single-select') && !e.target.closest('.multi-select-container')) {
                    closeAllDropdowns();
                }
            });
        };

        function loadSettings() {
            try {
                const settings = localStorage.getItem('dailyTodoSettings');
                if (settings) {
                    const parsed = JSON.parse(settings);

                    // åŠ è½½åŸºæœ¬è®¾ç½®
                    document.getElementById('enableDailyTodo').checked = parsed.enabled !== false;
                    document.getElementById('skipHolidays').checked = parsed.skipHolidays !== false;
                    document.getElementById('autoAddTime').value = parsed.autoAddTime || '09:00';

                    // åŠ è½½ä»»åŠ¡æ¨¡æ¿ï¼ˆJSONæ ¼å¼ï¼‰
                    if (parsed.templates && Array.isArray(parsed.templates)) {
                        taskTemplates = parsed.templates;
                    } else {
                        // å…¼å®¹æ—§çš„å­—ç¬¦ä¸²æ¨¡æ¿æ ¼å¼
                        taskTemplates = [];
                    }
                }
                renderTaskList();
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }

        function loadAssignees() {
            const saved = localStorage.getItem('assignees');
            if (saved) {
                try {
                    assignees = JSON.parse(saved);
                    assignees = assignees.map(assignee => {
                        if (typeof assignee === 'string') {
                            return { name: assignee };
                        }
                        return assignee;
                    });
                } catch (error) {
                    console.error('åŠ è½½å®Œæˆäººåˆ—è¡¨å¤±è´¥:', error);
                    assignees = [];
                }
            }
            renderAssigneeOptions();
        }

        function renderTaskList() {
            const container = document.getElementById('taskList');
            container.innerHTML = '';

            if (taskTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“‹</div>
                        <div style="font-size: 14px;">æš‚æ— ä»»åŠ¡æ¨¡æ¿</div>
                        <div style="font-size: 12px; margin-top: 8px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ä»»åŠ¡æ¨¡æ¿</div>
                    </div>
                `;
                return;
            }

            taskTemplates.forEach((task, index) => {
                const priorityMap = {
                    'high': 'ğŸ”´ é«˜',
                    'medium': 'ğŸŸ¡ ä¸­',
                    'low': 'ğŸŸ¢ ä½'
                };
                const categoryMap = {
                    'work': 'ğŸ’¼ å·¥ä½œ',
                    'life': 'ğŸ  ç”Ÿæ´»',
                    'study': 'ğŸ“š å­¦ä¹ ',
                    'other': 'ğŸ“Œ å…¶ä»–'
                };

                const div = document.createElement('div');
                div.className = 'task-item';
                div.innerHTML = `
                    <div class="task-item-header">
                        <div class="task-item-title">${task.title}</div>
                        <div class="task-item-actions">
                            <button class="task-item-btn" onclick="editTask(${index})" title="ç¼–è¾‘">âœï¸</button>
                            <button class="task-item-btn" onclick="deleteTask(${index})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    ${task.notes ? `<div style="font-size: 13px; color: #666; margin-top: 8px; line-height: 1.5;">${task.notes.replace(/<[^>]*>/g, ' ').substring(0, 100)}${task.notes.length > 100 ? '...' : ''}</div>` : ''}
                    <div class="task-item-details">
                        <div class="task-item-detail">${priorityMap[task.priority] || 'ğŸŸ¡ ä¸­'}</div>
                        <div class="task-item-detail">${categoryMap[task.category] || 'ğŸ’¼ å·¥ä½œ'}</div>
                        <div class="task-item-detail">â° ${task.deadline || '23:59'}</div>
                        ${task.assignees && task.assignees.length > 0 ? `<div class="task-item-detail">ğŸ‘¥ ${task.assignees.join(', ')}</div>` : '<div class="task-item-detail">ğŸ‘¤ æœªåˆ†é…</div>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openAddTaskModal() {
            editingTaskIndex = -1;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ ä»»åŠ¡æ¨¡æ¿';
            clearTaskForm();
            document.getElementById('taskModal').classList.add('active');
        }

        function editTask(index) {
            editingTaskIndex = index;
            const task = taskTemplates[index];

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡æ¨¡æ¿';
            document.getElementById('taskTitle').value = task.title;

            // è®¾ç½®å¤‡æ³¨
            if (task.notes) {
                taskNotesQuill.root.innerHTML = task.notes;
            } else {
                taskNotesQuill.setText('');
            }

            // è®¾ç½®ä¼˜å…ˆçº§
            selectedValues.priority = task.priority || 'medium';
            const priorityLabels = { 'high': 'é«˜ä¼˜å…ˆçº§', 'medium': 'ä¸­ä¼˜å…ˆçº§', 'low': 'ä½ä¼˜å…ˆçº§' };
            document.getElementById('priorityDisplay').textContent = priorityLabels[selectedValues.priority];
            updateDropdownSelection('priority', selectedValues.priority);

            // è®¾ç½®åˆ†ç±»
            selectedValues.category = task.category || 'work';
            const categoryLabels = { 'work': 'å·¥ä½œ', 'life': 'ç”Ÿæ´»', 'study': 'å­¦ä¹ ', 'other': 'å…¶ä»–' };
            document.getElementById('categoryDisplay').textContent = categoryLabels[selectedValues.category];
            updateDropdownSelection('category', selectedValues.category);

            // è®¾ç½®æˆªæ­¢æ—¶é—´
            document.getElementById('deadline').value = task.deadline || '23:59';

            // è®¾ç½®å®Œæˆäºº
            selectedAssignees = task.assignees || [];
            updateAssigneeDisplay();
            renderAssigneeOptions();

            document.getElementById('taskModal').classList.add('active');
        }

        function deleteTask(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡æ¨¡æ¿å—ï¼Ÿ')) {
                taskTemplates.splice(index, 1);
                renderTaskList();
            }
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            clearTaskForm();
        }

        function clearTaskForm() {
            document.getElementById('taskTitle').value = '';
            taskNotesQuill.setText('');
            selectedValues = { priority: 'medium', category: 'work' };
            selectedAssignees = [];
            document.getElementById('priorityDisplay').textContent = 'ä¸­ä¼˜å…ˆçº§';
            document.getElementById('categoryDisplay').textContent = 'å·¥ä½œ';
            document.getElementById('deadline').value = '23:59';
            updateDropdownSelection('priority', 'medium');
            updateDropdownSelection('category', 'work');
            updateAssigneeDisplay();
            renderAssigneeOptions();
        }

        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                return;
            }

            const notesHtml = taskNotesQuill.root.innerHTML;
            const notes = taskNotesQuill.getText().trim() ? notesHtml : '';

            const task = {
                title: title,
                notes: notes || null,
                priority: selectedValues.priority || 'medium',
                category: selectedValues.category || 'work',
                deadline: document.getElementById('deadline').value || '23:59',
                assignees: selectedAssignees.length > 0 ? selectedAssignees : null
            };

            if (editingTaskIndex >= 0) {
                taskTemplates[editingTaskIndex] = task;
            } else {
                taskTemplates.push(task);
            }

            renderTaskList();
            closeTaskModal();
        }

        function saveSettings() {
            const settings = {
                enabled: document.getElementById('enableDailyTodo').checked,
                skipHolidays: document.getElementById('skipHolidays').checked,
                autoAddTime: document.getElementById('autoAddTime').value,
                templates: taskTemplates,
                lastAddedDate: null // é‡ç½®ç”Ÿæˆæ—¥æœŸï¼Œç¡®ä¿ä¿å­˜åä¼šé‡æ–°ç”Ÿæˆ
            };

            try {
                localStorage.setItem('dailyTodoSettings', JSON.stringify(settings));

                // åŒæ­¥åˆ°Androidç«¯
                if (window.AndroidDatabase && typeof window.AndroidDatabase.saveDailyTodoSettings === 'function') {
                    const success = window.AndroidDatabase.saveDailyTodoSettings(
                        JSON.stringify(taskTemplates), // ä¼ é€’JSONå­—ç¬¦ä¸²
                        settings.enabled,
                        settings.skipHolidays
                    );
                    console.log('Androidæ¯æ—¥å¾…åŠé…ç½®åŒæ­¥ç»“æœ:', success);
                }

                alert('è®¾ç½®ä¿å­˜æˆåŠŸï¼');
                goBack();
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        function goBack() {
            window.history.back();
        }

        // ä¸‹æ‹‰æ¡†ç›¸å…³å‡½æ•°
        function toggleDropdown(type) {
            event.stopPropagation();
            const trigger = document.querySelector(`#${type}Container .custom-select-trigger`);
            const dropdown = document.getElementById(type + 'Dropdown');
            closeAllDropdowns(type);
            const isActive = dropdown.classList.contains('active');
            if (isActive) {
                trigger.classList.remove('active');
                dropdown.classList.remove('active');
            } else {
                trigger.classList.add('active');
                dropdown.classList.add('active');
            }
        }

        function closeAllDropdowns(except) {
            const dropdowns = document.querySelectorAll('.custom-select-dropdown');
            const triggers = document.querySelectorAll('.custom-select-trigger');
            dropdowns.forEach((dropdown, index) => {
                if (!except || dropdown.id !== except + 'Dropdown') {
                    dropdown.classList.remove('active');
                    if (triggers[index]) {
                        triggers[index].classList.remove('active');
                    }
                }
            });
            if (except !== 'assignee') {
                const assigneeDisplay = document.querySelector('.multi-select-display');
                const assigneeDropdown = document.getElementById('assigneeDropdown');
                if (assigneeDisplay) assigneeDisplay.classList.remove('active');
                if (assigneeDropdown) assigneeDropdown.classList.remove('active');
            }
        }

        function selectOption(type, value, label) {
            event.stopPropagation();
            selectedValues[type] = value;
            document.getElementById(type + 'Display').textContent = label;
            updateDropdownSelection(type, value);
            closeAllDropdowns();
        }

        function updateDropdownSelection(type, value) {
            const dropdown = document.getElementById(type + 'Dropdown');
            const options = dropdown.querySelectorAll('.custom-select-option');
            options.forEach(option => {
                if (option.getAttribute('data-value') === value) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // å®Œæˆäººç›¸å…³å‡½æ•°
        function renderAssigneeOptions() {
            const container = document.getElementById('assigneeOptions');
            container.innerHTML = '';

            if (assignees.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æš‚æ— å®Œæˆäººï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ </div>';
                return;
            }

            assignees.forEach(assignee => {
                const name = typeof assignee === 'string' ? assignee : assignee.name;
                const isChecked = selectedAssignees.includes(name);

                const option = document.createElement('div');
                option.className = 'assignee-option';
                option.innerHTML = `
                    <input type="checkbox" id="assignee_${name}" ${isChecked ? 'checked' : ''} onchange="toggleAssignee('${name}')">
                    <label for="assignee_${name}">${name}</label>
                `;
                container.appendChild(option);
            });
        }

        function toggleAssignee(name) {
            const index = selectedAssignees.indexOf(name);
            if (index > -1) {
                selectedAssignees.splice(index, 1);
            } else {
                selectedAssignees.push(name);
            }
            updateAssigneeDisplay();
        }

        function updateAssigneeDisplay() {
            const tagsContainer = document.getElementById('assigneeTags');
            if (selectedAssignees.length === 0) {
                tagsContainer.innerHTML = '<span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>';
            } else {
                tagsContainer.innerHTML = selectedAssignees.map(name => `
                    <span class="assignee-tag">
                        ${name}
                        <span class="remove" onclick="removeAssignee('${name}')">Ã—</span>
                    </span>
                `).join('');
            }
        }

        function removeAssignee(name) {
            event.stopPropagation();
            const index = selectedAssignees.indexOf(name);
            if (index > -1) {
                selectedAssignees.splice(index, 1);
                updateAssigneeDisplay();
                renderAssigneeOptions();
            }
        }

        function toggleAssigneeDropdown() {
            event.stopPropagation();
            const display = document.querySelector('.multi-select-display');
            const dropdown = document.getElementById('assigneeDropdown');
            closeAllDropdowns('assignee');
            const isActive = dropdown.classList.contains('active');
            if (isActive) {
                display.classList.remove('active');
                dropdown.classList.remove('active');
            } else {
                display.classList.add('active');
                dropdown.classList.add('active');
            }
        }

        function filterAssignees(searchText) {
            const options = document.querySelectorAll('.assignee-option');
            const search = searchText.toLowerCase();
            options.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                option.style.display = label.includes(search) ? 'flex' : 'none';
            });
        }
    </script>
</body>
</html>
