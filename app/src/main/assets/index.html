<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“… æ¯æ—¥å¾…åŠ</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='80'%3EğŸ“‹%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAUVBMVEX///8AAADHyMnP0NHX2NnJysvMzc7q6+z19fb39/j7+/z9/f7+/v/u7/Dz9PT29vfp6uv4+Pnx8vLs7e7i4+T5+frn6Onk5eb09PXw8fH8/PzY2drKyskAAACRAAAA6klEQVQ4T42T2w6CMAxGW1pAQFEUvOD7P6cttMwYJvGkycz3n7ZJm/yJiHjOWWstIuI5Z621iIjnnLXWIiKec9ZaizhnoLOzk/4f9o5DpyhUleY3Wp8Ov9EpChCaSSCT+T+GBHGJSCJ8Q3QMcYlIItJoQ4k88kPKCGxKj2hP4QG0t36pxYAFnIRSU8R3CCzgJJSaIr5DYAEH4UpbRqBpA2fhCnlChTSS7SftLoSMjnOBZTqf3v4T+Jj4cJj1NSMFZJL4aBT4QlqJm4c7iSWnCqRkSVqJ1YRfS8hJQoOSLpwJO6qR7YFo8kFZjXRYHqz+g22eBfEXqY8G2+w2FAAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAABXKSURBVHic7Z15fBTVvcc/5zszyWSbTDJZyEYS9gAJhLAoiCIoKiqKe61atdZa671W8fq89/re+3p9r7fW2mr7rFrr1lJrrVq1bq2CKCqLCIKsYQsECCEhZCEkk30mk5nMzP394wQSICuZzGSSPN+Pn/mQOXPO7/zOb373d8652xEREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREWkTx2gHMJKoqlpf89ddmJyxeHx+5fGy69uxY58XGC9LkmQsLi7Gbrfftl8Cz6+9+K3YpOcfeCwzPdXa9vEF/iZJyGprLU9fv/7A6NnOBMcgdMt8a+J8/PjxfLj80L3BQPCmPj7vl7fXfyLCMdKOVg6n6+P6+vqFdXX1J/5Ws+uf5eXl/o4G2xWO5s/u7u7x8+bNy03PSL00fdJ+t9Vqbc8hKnCP59ePEydO/NqNN954/yOPPKJFGsP/B5qamr7t8/l2ZGdnb33rrbe+GYhO6AAlq6KiYkxFRcXZhobGGgBVVTHo5O7YI4JhGLxZv3Xb1m3bb9VzYqJjHTAAVFdXF27cuHG6JElDJJL+/yP1wIEDlwwmyYBhaA2xTwh/EzQaDRiGAVVVDT2nK1BVFYZhGIHggKq3tbm2/D7Dw2fNTlnV/y0UURYV/QNsXPk6JO9NYD8+fHwBzK3KGJGrKooCXddJTU2lu7t7SFsrIvTQQx9/fOrYsWMrBrNNz5FjJ0Rnzpw5t6h8RlNlZWVPfWMDmfNfgl+HqvmDmJIKlrIJWJvWw5SIEtdBtY3BLj+FrfZ9rHXvYxfOwV6+FkddKY6SkyibO5AWw/KgBbPyeqKiLCrCBhNWgFLO+6sGI8og3wcdwG+/+d3MqVOmvOj3+5+/7777ek0Tx1hTaGBwO+08RqT0XEhEhB768bQqaEVRCNFIk1iN4zz/u7B5X6LGNgOAQjJYlNdpJ5VuUlFJQSMRjVS6ydKq2Gf7GlblBUye0xhDFhC5kxD86CDPOG3Q/Qfajh079OPHjz+uKMo/R0L0aOkYkqJ3OOy3j8AhOh5CaK11XHHN6hnT8xaOHlk2U5bly2fOnHn90gL21NbuDQaDgeDXnzr5xQVJfmRYLLN0w6BNF1AFNkGhWZKwA0aUH4+PCAztOqpJ6yNtZ3AcjTjG/W+6DJJwA4SbAUiIoRFNAg2JAqOJFEsFiUgjD8OyEt+2T9AoGhGPv8sTCW1KFCJXjR/z4gcf7hy2BnrpyIlvT1VV9f0333zzmxs3bnQ3Nze7AURZPPzjbZ2TmJ5P4OwbRHLOzXjyFqLpflRVHbKJQ1XHjRv3t+Li4u12u72wtLS04GJS6B7lHJqLSaEJTZK+YzNLH7ZGjZSdH+48jHWEJxJGdBKJbSU+/gCE9CL+wDkSwBcZORqKoqAoStRvvyP1IqiKw+T9H7cN61pxdHS8iqKcVBTlZGfTlC48Oq9q4LjJP7Z5fJfYbLYLKg62eTjWbC4vy7o8FPJbrVZr5BSioyn0kERPxKJvJ3S3L6qfx2d0nj9oZLOPwGabwYgIGz+UQh80NvgkjSvHo6L3KRNJ1EgkqYtOO/dK2j0Z4y4rKAh9G2hCe5lG8e4OSAI8NP9NrqGRRBpJRJGEi2aSsArNhKx5MvqOyM5wZGRkJM6ePXu5y+XKSk1NnTBcfXcpOq7NeV38xMHY3VkTUfbZW8trxjdjjqQ6cCczLkFJGEwJgqjVaLb+uSmqVXvyUqlj3lPD1meXU+gONST1SXhO7k+GqZJnb6Iv7nxM5LrL2o9tZvBa96I8sDcqeyfSEUWdNGlSfkND84zjR48NyyJKs8u8U8y8KlFzTgPGXo6uG6jDZOTY7VhsdhKSkjQZhY2N7zL9WDdM6zNPMGM8yt8b0He6t5vNdmwzHsGsKvFhpYyUuCiJoNB+A3XdYZo1Qxj5l0CK9RQWKzabn4T2VbBsNeZo4N7ZJNMKZ3lSZYDI0JGwIh3IMDT+fNnfb2hqqjJ7fV5v1XPPvRYI+K1Wm9ViNZmNRqNOr9frBFlWdCaTbDRJITmmJPGpVFy3xZ7BtWwx4FLlmqslZrBQ6vEKKhAMBhd7vd6NjdWfSocOH/ZUfn4oPTfHXVJSkpCVlZUTFZuhrzG++2BYOzTJZKnT5ZrvdDozHQ7H8xfaMv8m5g6pJO0sjpj3IfO7FJhVyqm1sLYU1Q2a6Q6YfjT8fW9qOm4/Pv9PZ+1fuf1qQNBV1Z/aKtUdZa7X6z+0Y8eOTZs3b2aqoqNgJFI7WxnbJH7/qVyBShMOLNgwE8SCnUQxjkQxDhNOFEkhIAYxhuwEgw0EQw0EAg0EQs0EQ20EQm2H7Gmdbe1I5S4YQXcn9Tk4jphD9V7VXlQeQRGjhkGkI5Whi+L0Ib9uGM0mtCIdYZh/jWGxd9rJkGBFwkqKWMdI6StuCBYWOKyL76gpOVtT8xQmHLx2t6VZO8OUuPi7+Ky4qFiEaYPNBcPvJyDcRFCpQQnVEgh1gxoEVUfQKJ3tJVofCEpWrJZxcfGLnClrHPaKm/ddPmP1K6+84V8lCRkK9HZpGgIIh7uTIKqugTEUjPNu5hGHQaJGT2fOGx2k0I41wGH/aMQTaR8K8/bWvWrjHGxzJ40YLW+1qVh6UB/aGQtL4+69J6pbwcI4AzLjbOVDmnYakmgpDYOLjceTlZGRcUdJSckdBQUFE8E2G3yDO9wdCEgGTJLo8gXM7aLQdqyY0eMRMRNRBxPdLGkTVCUKjZ+8LQHiIBgUPR4Lk+9d89YFR/oFf7Xq9LfmWlKmnPE78v6VPbGhO6mGgGFBsUmYLf2A4cKR9eXPSBe9bNtJyJBgVrTDJyLGzBCFtiGJTiQ5YCKgKB84k6PbkBhj7HMM8e2+eVx0GgihIy3xkmjmx6fev+bNHlPoj+esXr4kzbO8Mzlnwm8mprmM2mhGNwcHgsEwRLCRGELiE7DxMHfuM9zx4LN9gHNZW6sQJQpNaMhq+hBzp6/cBNMWob5eTJGWQM7fzHvdN4/rM4XeV/7BK0vzPCu68nNvfmlqmjtN6y1Ga2E9Y4Y8/Wr4q1RGMFRVBVXVhS+6jaLQNiQlJRJJ1LLObq5SkIwDZvFEp/8jha/+xb3Xe3O/L1Z/vz3vU6Mlr7aIY6mD6WQgRmGBxWHxnHg5gkGMwfQGVQ35+wJTTDNaP9zMLqZJyJG4Xk3o7mgdL0kSJlE0kjEjSV1yJzF6PJqR3nFyQ3uxvr7uVrfbvcjhcEzT8wjcQZ9vh81qu1zCRILJZVtlV5yrgJfKqBPfOdwthyqw2WzYbM5ik8l00uv19hqGaKcBwzDJEq6JQrSJOqLz7HZPCINl8XPLXzrfEUZz6tGXRJaezaOxtYOqLlOKo7n8JTFjBRjdOGuWz57x3HluMZJCO/H5n4aEiZS9FEGLnfzlbhZ9zKYbb7w7Y8aMGb8cOZj3tY1MVGV9VT0/e3FgQVr+qPaJREPg8XicubBt4z8XdKV4VjVOuPZHFpOldHgaD4/JrqZFr25fNJJCK8jGxhf5x5vfYRqNf7L22WdXXuL+KYCdAKJc7FQHVHr93eiw9o4JnYW52+fXWYKoXxVh9WKkbFRQfPRtb3E7hQ/vGrQ+sYB3YhgNt1+XGN1p3VgRvNFbCFy01l02FmhV6PkzdlzntSYts5gt3w4q4Wmd3XBPd/JZ6tLSKP1ycO6Z7Ybh+bLHhOIptK91XfLW8bJL3j55+tT8wQTWvlaPpJOkbYEo1KRXoHXHAONFi0qhF7qQIjNacruT25k8ZFhVcDrTvVkZhQvOvIqKgYJdTMTiXWyoHUVOdcdrDEZlFJqI1r6bVXNuvfRLAF1U+dBDj7zeFAx8RGxsKhYlJ/7OzHAhihTM1UVkHWCuTR+hVEYhihScWqWJgvJu0bEjI2T7/Ae0Y2CQbzQs2w1s3TbpMXS8GKbg4Lhfv7x/3AV+QEZxKVbGR60lBJP6Z4OJGkG2m8/7DF8O1h8xNMmRY7h9D4Hl5xOi/1aHIpQehmJpGM3zKLsOc3OJhJwlHFRLWTqRy1k6ccQjBmjJ7QfR5r6+9+F0u3TLLYvPbyNjjNadQKNGy9J1g3KUOHmfJMu3bNy4cW+fvUTfQnc0F6X7oVpZD8xhIIWvdHqtO2iQDqIwmnqg9fO6yNwJdMIKbhEatOSCUWCCMD4YfF8b7B6I7e9Dls1Jv/6MWzNzsq8M8lnI6LFN1LjzRhAaYFQIvxjSrEaJK9f7LJfQ3fkDIxfZrZ/6nO/s2PqHHTumJyTEjzfJyZLN5jAhGQ2ybFBxGDGYJKNJMuil5vdvmVjWPNhzBAVDMCgYAUVHfbPn3ba0aP3o04MNr/xjQEfqJeqMcCKNEgYhBp8n/33e3Xm0+fI7MKYjOcfHzrRu5IUIxSPHp+kqZV/c+bpbv2vX7gdbu90QhZbdF9eJ6pv6rFOdwVXODDnCQ6NCQ+DstSzJwsNP/YaYbhcOSzYG3Qwk92s4OsYPm6NXoM2UvOJbWW6vN6+9ZfYJX0GCtOMJDacFB5r9Vy72pQGF9TJhxcYnlNJHf7tPuzVHxMLJrCsRDQONlLJRFNnHiePHjw+mzn2p3hxvyKg5Jkm5iuT4Rp/dVXdLV2YK+7rJNS6e8xrfcUFjhQGhKNJJR+hk/4P0vLYKhRJJyzNGr5oFUINGD/esBHBT/5NpKRLisFkUaA6t1W/hUXBQNHVgHaQkVOjkTzJyJBIoBRU7tWlpvHyV0pZx9fpqNn7U8Xz3tuJZmSELhZPxrI6CyYjDbkdMJHQjohGi3E5k3cHs2zFXdGZ8WKUV9mGn8DRGOzVvdOeGrGjEWJgHXdoQ7e9vBKTWBEUggZdp7bVvq8btWCW9rLcQ6GyD7yrNvNNl5OG3iA8ckJjsWLFTVNT04mRdpHaF6TKVjrtrq7gLnFhg6b+MvFnQHHaWnAO9WGgJ5xAn08ZEHNdI+FOpLjY+VjqWZY5Zw5lBRPLBOJRjzGdtQjkVOJ9lqNyB4P0yYXE1FUf7vY9FiYJx0wRjVFdLdpKJLxnJE1TXuvELQ96Oac8ydL5rFqJrPDQRCqZxgGaJyOB3IfxPdQoIKsZZFG2FJwOTJTLiVYT7PhXs23eBtAjBuJKJp5BZmOzq4DGShPqpqdE+zFgr9YSGgihzTEeqgUFVVPQUJeR7OGlFf7VnpDAaGx+l28u4Pz6NrOjN+vAg8dkJ+c0G8dGMwoJSPnT+sPVUmcZzOEjERiUbHhL7YFiZ2JNqN4J4l3iVkOW3yEzrAE7n+9rLdePcDW7cPZ3/jJo3TdwRJzxMnqeQnRRdmj6RUIrYiYtELqd9RVFXfCMsSDjNYL2HTGKMFnCxLkvTfJqN8WcI7O6f/Vl5CYXz9ot/RuAULCvYNd19eH8nJIskJqY8Xzt5FZ81bEYZAm67pOkbjpVdRJb3vfRG4COJD9tKCHHKOjnCALFOT6h7zQlCVvzn6/FLqNM2AzaxPkpBvR7Jqf2i2mTLzchJKVWGy6O+3b53cY8Gi3xmPPPJIrKOj4y6fzxdEjmFNzJ2Lk7FmP1GQSyNOpMJ3v1yLGHH09xNnR6OHhsJ1jT/8bWoE3bE7NmJhncTnezBvJQTvJJqr8Ci9w0z1OIOJ6zW2GcvfLbztvx79PjjlKXTxnKEWDnOb6lMqiOLHWz5E9LN4mgjKfWEjKfQQpQ5w4s8zEFoD7v1Fob3hNxL7yFi0Dd4frT6ZU8fCHJKRRR08ZZHFnzKaZOX+d7Y8m3Kz94J+XhNgfXBMGKwjnQ+vELaAc5qjJEwf9Lqv4Kxo4Y7dnvKPgOAP0dO8KORgZEEr+r4A1U5sOhg73q/AATG10GdHh6sGAAAAAElFTkSuQmCC">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: #fafafa;
            height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ç¡®ä¿å®¹å™¨å†…çš„ç›´æ¥å­å…ƒç´ æ— é¢å¤–é—´è· */
        .container > .filter-section,
        .container > .function-section,
        .container > .settings-section {
            margin: 0;
        }

        .header {
            background: white;
            color: #333;
            padding: 8px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 15px;
            margin-bottom: 0;
            font-weight: 600;
        }

        .progress-info {
            font-size: 11px;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 3px;
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        /* ç§»åŠ¨ç«¯å¤´éƒ¨ä¼˜åŒ– - å¤§å¹…å‹ç¼©é«˜åº¦ */
        @media (max-width: 768px) {
            .header {
                padding: 6px 12px; /* å¤§å¹…å‡å°‘ä¸Šä¸‹padding */
            }

            .header h1 {
                font-size: 14px; /* å¤§å¹…å‡å°å­—ä½“ */
                margin-bottom: 2px; /* å¤§å¹…å‡å°‘ä¸‹è¾¹è· */
            }

            .progress-info {
                font-size: 10px; /* å¤§å¹…å‡å°å­—ä½“ */
            }

            .progress-bar {
                height: 2px; /* å¤§å¹…å‡å°è¿›åº¦æ¡é«˜åº¦ */
                margin-top: 3px; /* å¤§å¹…å‡å°‘ä¸Šè¾¹è· */
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 5px 10px; /* å°å±å¹•æœ€å°padding */
            }

            .header h1 {
                font-size: 13px; /* å°å±å¹•æœ€å°å­—ä½“ */
                margin-bottom: 1px; /* æœ€å°ä¸‹è¾¹è· */
            }

            .progress-info {
                font-size: 9px; /* å°å±å¹•æœ€å°å­—ä½“ */
            }

            .progress-bar {
                height: 2px; /* å°å±å¹•æœ€ç»†è¿›åº¦æ¡ */
                margin-top: 2px; /* æœ€å°ä¸Šè¾¹è· */
            }
        }

        .progress-fill {
            background: #4caf50;
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .add-task {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .add-task-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-input-row {
            display: flex;
            gap: 8px;
        }

        .task-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .task-input:focus {
            border-color: #667eea;
        }

        .add-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #5a6fd8;
        }

        .task-options {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .task-select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .task-list {
            flex: 1;
            overflow-y: auto;
            /*padding: 8px;*/
            background: #f5f5f5;
            scrollbar-width: thin;
            min-height: 0; /* å…è®¸flexæ”¶ç¼© */
        }

        /* ç§»åŠ¨ç«¯ä»»åŠ¡åˆ—è¡¨è‡ªé€‚åº” */
        @media (max-width: 768px) {
            .task-list {
                max-width: 100%; /* ç§»åŠ¨ç«¯å……åˆ†åˆ©ç”¨å±å¹•å®½åº¦ */
                width: 100%; /* ç¡®ä¿å®½åº¦å……æ»¡å®¹å™¨ */
                padding-right: 2px; /* ç§»åŠ¨ç«¯å‡å°‘å³ä¾§padding */
                /*margin: 0 0 15px 0; !* ç§»é™¤ä¾§è¾¹è·ï¼Œä¿ç•™åº•éƒ¨é—´è· *!*/
            }

            .task-item {
                padding: 8px 12px; /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥å‡å°‘padding */
                font-size: 14px; /* ç§»åŠ¨ç«¯è°ƒæ•´å­—ä½“å¤§å° */
                width: 100%; /* ç¡®ä¿ä»»åŠ¡é¡¹å……æ»¡å®½åº¦ */
                box-sizing: border-box; /* åŒ…å«paddingåœ¨å®½åº¦è®¡ç®—å†… */
            }

            .task-title {
                font-size: 13px; /* ç§»åŠ¨ç«¯ä»»åŠ¡æ ‡é¢˜å­—ä½“ */
                line-height: 1.3;
                flex: 1; /* æ ‡é¢˜å ç”¨æ›´å¤šå¯ç”¨ç©ºé—´ */
                /*max-width: calc(100% - 50px); !* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ *!*/
            }

            .task-notes {
                font-size: 13px; /* ç§»åŠ¨ç«¯å¤‡æ³¨å­—ä½“ */
                line-height: 1.3;
                width: 100%; /* å¤‡æ³¨å……æ»¡å¯ç”¨å®½åº¦ */
            }

            .task-content {
                flex: 1; /* å†…å®¹åŒºåŸŸå ç”¨æ›´å¤šç©ºé—´ */
                min-width: 0; /* å…è®¸flexæ”¶ç¼© */
            }

            .task-complete-btn {
                width: 24px; /* ç§»åŠ¨ç«¯å®ŒæˆæŒ‰é’®å°ºå¯¸ */
                height: 24px;
                min-width: 40px; /* ä¿è¯è§¦æ‘¸åŒºåŸŸ */
                min-height: 40px;
            }

            .action-btn {
                padding: 8px 12px; /* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’® */
                font-size: 12px;
                min-width: 44px;
                min-height: 44px;
            }

            .task-options {
                flex-shrink: 0; /* æ“ä½œæŒ‰é’®åŒºåŸŸä¸æ”¶ç¼© */
                min-width: 120px; /* ç§»åŠ¨ç«¯æ“ä½œåŒºåŸŸæœ€å°å®½åº¦ */
            }
        }

        @media (max-width: 480px) {
            .task-list {
                max-width: 100%; /* å°å±å¹•å……åˆ†åˆ©ç”¨å±å¹•å®½åº¦ */
                width: 100%; /* ç¡®ä¿å®½åº¦å……æ»¡å®¹å™¨ */
                padding-right: 0; /* å°å±å¹•å–æ¶ˆå³ä¾§padding */
                /*margin: 0 0 10px 0; !* ç§»é™¤ä¾§è¾¹è·ï¼Œä¿ç•™åº•éƒ¨é—´è· *!*/
                padding-left: 0; /* å°å±å¹•ä¹Ÿç§»é™¤å·¦ä¾§padding */
            }

            .task-item {
                padding: 7px 10px; /* å°å±å¹•è¿›ä¸€æ­¥å‡å°‘padding */
                font-size: 13px;
                width: 100%; /* ç¡®ä¿ä»»åŠ¡é¡¹å……æ»¡å®½åº¦ */
                box-sizing: border-box; /* åŒ…å«paddingåœ¨å®½åº¦è®¡ç®—å†… */
            }

            .task-title {
                font-size: 13px; /* å°å±å¹•ä»»åŠ¡æ ‡é¢˜å­—ä½“ */
                flex: 1; /* æ ‡é¢˜å ç”¨æ›´å¤šå¯ç”¨ç©ºé—´ */
                /*max-width: calc(100% - 50px); !* å°å±å¹•ä¸ºæŒ‰é’®ç•™å‡ºæ›´å°‘ç©ºé—´ *!*/
            }

            .task-notes {
                font-size: 12px; /* å°å±å¹•å¤‡æ³¨å­—ä½“ */
                width: 100%; /* å¤‡æ³¨å……æ»¡å¯ç”¨å®½åº¦ */
            }

            .task-content {
                flex: 1; /* å†…å®¹åŒºåŸŸå ç”¨æ›´å¤šç©ºé—´ */
                min-width: 0; /* å…è®¸flexæ”¶ç¼© */
            }

            .task-complete-btn {
                width: 22px; /* å°å±å¹•å®ŒæˆæŒ‰é’®å°ºå¯¸ */
                height: 22px;
                min-width: 38px; /* ä¿è¯è§¦æ‘¸åŒºåŸŸ */
                min-height: 38px;
            }

            .action-btn {
                padding: 6px 10px; /* å°å±å¹•æ“ä½œæŒ‰é’® */
                font-size: 11px;
            }

            .task-options {
                gap: 6px; /* å°å±å¹•æ“ä½œæŒ‰é’®é—´è· */
                flex-shrink: 0; /* æ“ä½œæŒ‰é’®åŒºåŸŸä¸æ”¶ç¼© */
                min-width: 100px; /* æ“ä½œåŒºåŸŸæœ€å°å®½åº¦ */
            }
        }

        /* Webkitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
        .task-list::-webkit-scrollbar {
            width: 6px;
        }

        .task-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .task-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .task-list::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* ç§»åŠ¨ç«¯æ»šåŠ¨æ¡ä¼˜åŒ– */
        @media (max-width: 768px) {
            .task-list::-webkit-scrollbar {
                width: 4px; /* ç§»åŠ¨ç«¯æ›´ç»†çš„æ»šåŠ¨æ¡ */
            }
        }

        @media (max-width: 480px) {
            .task-list::-webkit-scrollbar {
                width: 3px; /* å°å±å¹•æ›´ç»†çš„æ»šåŠ¨æ¡ */
            }

            .task-list::-webkit-scrollbar-track {
                background: transparent; /* å°å±å¹•éšè—æ»šåŠ¨æ¡è½¨é“ */
            }
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .task-item.completed {
            opacity: 0.65;
            background-color: #fafafa;
        }

        /* é•¿æŒ‰æ¿€æ´»çŠ¶æ€ */
        .task-item.long-press-active {
            background-color: #e3f2fd;
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .task-complete-btn {
            width: 26px;
            height: 26px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            flex-shrink: 0;
            font-size: 14px;
            outline: none;
        }

        .task-complete-btn:hover {
            border-color: #667eea;
            transform: scale(1.1);
            box-shadow: 0 2px 12px rgba(102, 126, 234, 0.3);
        }

        .task-complete-btn.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-color: #4CAF50;
            color: white;
        }

        .task-complete-btn.completed:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
            border-color: #45a049;
            transform: scale(1.1);
        }

        /* ç¦ç”¨çŠ¶æ€çš„å®ŒæˆæŒ‰é’®æ ·å¼ */
        .task-complete-btn.disabled {
            background: #f0f0f0;
            border-color: #ddd;
            color: #bbb;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .task-complete-btn.disabled:hover {
            background: #f0f0f0;
            border-color: #ddd;
            color: #bbb;
        }

        /* æ— æƒé™æ“ä½œçš„ä»»åŠ¡æ ·å¼ */
        .task-item.not-operable {
            opacity: 0.7;
        }

        .task-item.not-operable .batch-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .task-item.not-operable .task-assignee {
            background: #ff9500;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            position: relative;
        }

        .task-item.not-operable .task-assignee::after {
            content: " (åªè¯»)";
            font-size: 10px;
            opacity: 0.9;
        }

        .task-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .task-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            transition: all 0.2s;
            color: #333;
            line-height: 1.3;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #999;
        }

        .task-notes {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .task-item.completed .task-notes {
            color: #999;
        }

        .task-time-info {
            display: flex;
            gap: 8px;
            margin-top: 3px;
            font-size: 10px;
            color: #999;
            line-height: 1.3;
        }

        .task-created, .task-completed {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            line-height: 1.4;
        }

        .task-created {
            color: #999;
        }

        .task-completed {
            color: #4CAF50 !important;
            font-weight: 500;
        }

        .task-created::before {
            content: 'ğŸ•';
            font-size: 10px;
        }

        .task-completed::before {
            content: 'âœ…';
            font-size: 10px;
        }

        .task-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .task-category {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }

        .category-work { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .category-life { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .category-study { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .category-other { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        .task-priority {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-high { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .priority-medium { background: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
        .priority-low { background: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; }

        .task-deadline {
            font-size: 11px;
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            background: #f5f5f5;
        }

        .task-deadline.overdue {
            color: #d32f2f;
            font-weight: 600;
            background: #ffebee;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            animation: deadlineFlash 2s ease-in-out infinite;
        }

        @keyframes deadlineFlash {
            0%, 100% {
                background: rgba(211, 47, 47, 0.1);
            }
            50% {
                background: rgba(211, 47, 47, 0.2);
            }
        }

        .task-item.overdue .task-title {
            color: #b71c1c;
            font-weight: 600;
        }

        .task-item.overdue .task-content {
            position: relative;
        }

        .task-item.overdue::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #d32f2f, #ff5722, #d32f2f);
            animation: overdueStripe 3s ease-in-out infinite;
        }

        @keyframes overdueStripe {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .task-item.overdue::after {
            content: "ğŸš¨";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 16px;
            animation: overdueIcon 1s ease-in-out infinite;
            z-index: 2;
        }

        @keyframes overdueIcon {
            0%, 100% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-10deg) scale(1.1);
            }
            75% {
                transform: rotate(10deg) scale(1.1);
            }
        }

        /* ç¡®ä¿è¶…æ—¶ä»»åŠ¡åœ¨åˆ—è¡¨ä¸­æ›´çªå‡º */
        .task-item.overdue {
            margin-bottom: 12px;
            border: 1px solid rgba(211, 47, 47, 0.2);
        }

        /* è¶…æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§æ ‡ç­¾ä¹Ÿè¦ç‰¹æ®Šæ˜¾ç¤º */
        .task-item.overdue .task-priority {
            border: 1px solid #d32f2f;
            font-weight: bold;
        }

        /* è¶…æ—¶ä»»åŠ¡çš„å¤‡æ³¨ä¹Ÿè¦çªå‡ºæ˜¾ç¤º */
        .task-item.overdue .task-notes {
            color: #8d0305;
            font-style: italic;
            font-weight: 500;
        }

        /* è¶…æ—¶ä»»åŠ¡çš„åˆ†ç±»æ ‡ç­¾æ ·å¼ */
        .task-item.overdue .task-category {
            background: rgba(211, 47, 47, 0.1);
            border: 1px solid rgba(211, 47, 47, 0.3);
            font-weight: bold;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .task-item.overdue::after {
                top: 4px;
                right: 4px;
                font-size: 14px;
            }

            .overdue-badge {
                font-size: 10px;
                padding: 2px 6px;
                margin-right: 6px;
            }

            .task-item.overdue {
                margin-bottom: 8px;
            }

            .task-item.overdue:hover {
                transform: none; /* ç§»åŠ¨ç«¯ä¸éœ€è¦hoveræ•ˆæœ */
            }
        }

        /* ä¸ºè¶…æ—¶ä»»åŠ¡æ·»åŠ éœ‡åŠ¨æ•ˆæœï¼ˆä»…åœ¨æ¡Œé¢ç«¯ï¼‰ */
        @media (min-width: 769px) {
            .task-item.overdue:hover {
                animation: overdueShake 0.5s ease-in-out;
            }
        }

        @keyframes overdueShake {
            0%, 100% { transform: translateX(0) translateY(-2px); }
            25% { transform: translateX(-2px) translateY(-2px); }
            75% { transform: translateX(2px) translateY(-2px); }
        }

        .task-assignee {
            font-size: 11px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .task-item.overdue {
            border-left: 6px solid #d32f2f;
            background: linear-gradient(90deg, #ffebee 0%, #fff5f5 100%);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.1);
            animation: overdueGlow 2s ease-in-out infinite alternate;
            position: relative;
            overflow: hidden;
        }

        .task-item.overdue:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(211, 47, 47, 0.2);
            transition: all 0.3s ease;
        }

        @keyframes overdueGlow {
            0% {
                box-shadow: 0 2px 8px rgba(211, 47, 47, 0.1);
            }
            100% {
                box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
            }
        }

        .task-item.overdue .task-complete-btn {
            border: 2px solid #d32f2f;
            background: rgba(211, 47, 47, 0.1);
        }

        .task-item.overdue .task-complete-btn:hover {
            background: rgba(211, 47, 47, 0.2);
            transform: scale(1.1);
        }

        .overdue-badge {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-right: 8px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 4px rgba(211, 47, 47, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: badgePulse 1.5s ease-in-out infinite;
        }

        .overdue-badge::before {
            content: "âš ï¸";
            font-size: 12px;
        }

        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-left: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .edit-btn {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: #1976d2;
            border: 2px solid rgba(25, 118, 210, 0.2);
            box-shadow:
                0 2px 8px rgba(25, 118, 210, 0.1),
                0 1px 4px rgba(25, 118, 210, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .edit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(25, 118, 210, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #e1bee7 100%);
            border-color: rgba(25, 118, 210, 0.4);
            box-shadow:
                0 6px 20px rgba(25, 118, 210, 0.25),
                0 3px 10px rgba(25, 118, 210, 0.15),
                0 1px 4px rgba(25, 118, 210, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.6);
            transform: translateY(-1px);
        }

        .edit-btn:hover::before {
            left: 100%;
        }

        .edit-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow:
                0 2px 8px rgba(25, 118, 210, 0.2),
                0 1px 4px rgba(25, 118, 210, 0.1),
                inset 0 2px 4px rgba(25, 118, 210, 0.1);
            background: linear-gradient(135deg, #90caf9 0%, #ce93d8 100%);
        }

        .delete-btn {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #d32f2f;
            border: 2px solid rgba(211, 47, 47, 0.2);
            box-shadow:
                0 2px 8px rgba(211, 47, 47, 0.1),
                0 1px 4px rgba(211, 47, 47, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .delete-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(211, 47, 47, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #ffcdd2 0%, #f8bbd9 100%);
            border-color: rgba(211, 47, 47, 0.4);
            box-shadow:
                0 6px 20px rgba(211, 47, 47, 0.25),
                0 3px 10px rgba(211, 47, 47, 0.15),
                0 1px 4px rgba(211, 47, 47, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.6);
            transform: translateY(-1px);
        }

        .delete-btn:hover::before {
            left: 100%;
        }

        .delete-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow:
                0 2px 8px rgba(211, 47, 47, 0.2),
                0 1px 4px rgba(211, 47, 47, 0.1),
                inset 0 2px 4px rgba(211, 47, 47, 0.1);
            background: linear-gradient(135deg, #ef9a9a 0%, #f48fb1 100%);
        }

        /* Emojiå›¾æ ‡ä¼˜åŒ–æ ·å¼ */
        .emoji-icon {
            display: inline-block;
            font-size: 18px;
            line-height: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow:
                0 2px 4px rgba(0, 0, 0, 0.15),
                0 1px 2px rgba(0, 0, 0, 0.1);
            font-family:
                "Apple Color Emoji",
                "Segoe UI Emoji",
                "Noto Color Emoji",
                "Android Emoji",
                "EmojiOne Color",
                "Twemoji Mozilla",
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: "liga" off;
            filter: contrast(1.1) brightness(1.05) saturate(1.1);
            transform-origin: center;
        }

        .edit-btn:hover .emoji-icon {
            transform: scale(1.25) translateY(-2px) rotate(8deg);
            text-shadow:
                0 4px 8px rgba(25, 118, 210, 0.5),
                0 2px 4px rgba(25, 118, 210, 0.3),
                0 0 0 rgba(255, 255, 255, 0.8);
            filter:
                contrast(1.2)
                brightness(1.1)
                saturate(1.2)
                drop-shadow(0 3px 6px rgba(25, 118, 210, 0.3));
            animation: editBounce 0.6s ease-out;
        }

        @keyframes editBounce {
            0% { transform: scale(1) translateY(0) rotate(0deg); }
            30% { transform: scale(1.35) translateY(-3px) rotate(12deg); }
            60% { transform: scale(1.15) translateY(-1px) rotate(5deg); }
            100% { transform: scale(1.25) translateY(-2px) rotate(8deg); }
        }

        .delete-btn:hover .emoji-icon {
            transform: scale(1.25) translateY(-2px) rotate(-8deg);
            text-shadow:
                0 4px 8px rgba(211, 47, 47, 0.5),
                0 2px 4px rgba(211, 47, 47, 0.3),
                0 0 0 rgba(255, 255, 255, 0.8);
            filter:
                contrast(1.2)
                brightness(1.1)
                saturate(1.2)
                drop-shadow(0 3px 6px rgba(211, 47, 47, 0.3));
            animation: deleteBounce 0.6s ease-out;
        }

        @keyframes deleteBounce {
            0% { transform: scale(1) translateY(0) rotate(0deg); }
            30% { transform: scale(1.35) translateY(-3px) rotate(-12deg); }
            60% { transform: scale(1.15) translateY(-1px) rotate(-5deg); }
            100% { transform: scale(1.25) translateY(-2px) rotate(-8deg); }
        }

        .action-btn:active .emoji-icon {
            transform: scale(0.8) translateY(1px);
            text-shadow:
                0 1px 2px rgba(0, 0, 0, 0.4),
                0 0 4px rgba(0, 0, 0, 0.2);
            filter:
                contrast(1.3)
                brightness(0.95)
                saturate(1.1);
            animation: clickPulse 0.15s ease-out;
        }

        @keyframes clickPulse {
            0% { transform: scale(1.25) translateY(-2px); }
            50% { transform: scale(0.75) translateY(2px); }
            100% { transform: scale(0.8) translateY(1px); }
        }

        /* ç¦ç”¨çŠ¶æ€çš„emojiæ ·å¼ */
        .action-btn.disabled .emoji-icon {
            opacity: 0.3;
            filter: grayscale(100%) brightness(0.8);
            transform: none;
        }

        .action-btn.disabled:hover .emoji-icon {
            transform: none;
            text-shadow: none;
        }

        /* ä¸åŒå°ºå¯¸çš„emojié€‚é… */
        @media (max-width: 768px) {
            .emoji-icon {
                font-size: 25px;
            }
            .edit-btn:hover .emoji-icon,
            .delete-btn:hover .emoji-icon {
                transform: scale(1.2) translateY(-1px) rotate(6deg);
            }
        }

        @media (max-width: 480px) {
            .emoji-icon {
                font-size: 25px;
            }
            .edit-btn:hover .emoji-icon,
            .delete-btn:hover .emoji-icon {
                animation: none;
                transform: scale(1.15) translateY(-1px) rotate(4deg);
            }
            .action-btn:active .emoji-icon {
                animation: none;
                transform: scale(0.85) translateY(0.5px);
            }
        }

        /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
        @media (prefers-contrast: high) {
            .edit-btn {
                border: 2px solid #1976d2;
            }
            .delete-btn {
                border: 2px solid #d32f2f;
            }
            .emoji-icon {
                text-shadow: 0 0 3px rgba(0, 0, 0, 0.8), 0 1px 0 rgba(255, 255, 255, 0.8);
                filter: contrast(1.5) brightness(1.1);
            }
            .edit-btn:hover .emoji-icon {
                text-shadow: 0 0 5px rgba(25, 118, 210, 0.8), 0 2px 0 rgba(255, 255, 255, 0.9);
            }
            .delete-btn:hover .emoji-icon {
                text-shadow: 0 0 5px rgba(211, 47, 47, 0.8), 0 2px 0 rgba(255, 255, 255, 0.9);
            }
        }

        /* å‡å°‘åŠ¨ç”»æ¨¡å¼æ”¯æŒ */
        @media (prefers-reduced-motion: reduce) {
            .emoji-icon {
                transition: none;
            }
            .edit-btn:hover .emoji-icon,
            .delete-btn:hover .emoji-icon,
            .action-btn:active .emoji-icon {
                transform: none;
                animation: none;
            }
            .edit-btn:hover .emoji-icon {
                text-shadow: 0 2px 4px rgba(25, 118, 210, 0.4);
            }
            .delete-btn:hover .emoji-icon {
                text-shadow: 0 2px 4px rgba(211, 47, 47, 0.4);
            }

            /* å¯¼èˆªæ åŠ¨ç”»ç¦ç”¨ */
            .nav-btn.active::before,
            .nav-add-btn::before {
                animation: none;
            }
            .nav-add-btn {
                animation: none;
            }
            .nav-btn.active .nav-icon,
            .nav-btn:hover:not(.active) .nav-icon,
            .nav-add-btn:hover .nav-add-icon {
                animation: none;
            }
            .nav-add-btn:hover .nav-add-icon {
                transform: rotate(45deg) scale(1.05);
            }
        }

        /* æ·±è‰²æ¨¡å¼ä¼˜åŒ– */
        @media (prefers-color-scheme: dark) {
            .edit-btn {
                background: #1a237e;
                color: #90caf9;
                border: 1px solid rgba(144, 202, 249, 0.3);
            }
            .edit-btn:hover {
                background: #283593;
                box-shadow: 0 4px 12px rgba(144, 202, 249, 0.3);
            }
            .edit-btn:hover .emoji-icon {
                text-shadow: 0 3px 6px rgba(144, 202, 249, 0.6);
                filter: brightness(1.2) contrast(1.1);
            }
            .delete-btn {
                background: #b71c1c;
                color: #ffcdd2;
                border: 1px solid rgba(255, 205, 210, 0.3);
            }
            .delete-btn:hover {
                background: #c62828;
                box-shadow: 0 4px 12px rgba(255, 205, 210, 0.3);
            }
            .delete-btn:hover .emoji-icon {
                text-shadow: 0 3px 6px rgba(255, 205, 210, 0.6);
                filter: brightness(1.2) contrast(1.1);
            }
            .nav-btn.active {
                background: rgba(144, 202, 249, 0.15);
                border: 1px solid rgba(144, 202, 249, 0.3);
            }
            .nav-btn:hover:not(.active) {
                background: rgba(144, 202, 249, 0.1);
            }
            .emoji-icon {
                text-shadow: 0 1px 3px rgba(255, 255, 255, 0.1);
            }
        }

        /* Android 14 å…¼å®¹æ€§ä¼˜åŒ– */
        .delete-btn:active {
            background: #ff9999 !important;
            transform: scale(0.95);
        }

        /* ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡» */
        .delete-btn {
            -webkit-tap-highlight-color: rgba(211, 47, 47, 0.3);
            tap-highlight-color: rgba(211, 47, 47, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: auto;
        }

        .footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        /* ç»Ÿä¸€æ‰€æœ‰åŠŸèƒ½æ¨¡å—çš„åŸºç¡€æ ·å¼ */
        .filter-section,
        .function-section,
        .settings-section {
            background: #f8f9fa;
            border: none;
            margin: 0;
            padding: 0;
            display: block;
            position: relative;
        }

        /* ä¸ºæ¯ä¸ªæ¨¡å—æ·»åŠ åˆ†éš”çº¿ */
        .filter-section {
            border-bottom: 1px solid #e9ecef;
            background: white;
            overflow: visible;
        }

        /* ç­›é€‰å¤´éƒ¨ï¼ˆæœç´¢æ¡†å’Œæ¼æ–—æŒ‰é’®ï¼‰ */
        .filter-header {
            display: flex;
            gap: 12px;
            padding: 5px 16px;
            background: white;
            align-items: center;
        }

        .search-box {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 0 12px;
            transition: all 0.2s ease;
        }

        .search-box:focus-within {
            background: #fff;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            font-size: 14px;
            color: #999;
            margin-right: 8px;
        }

        .search-input {
            flex: 1;
            border: none !important;
            background: transparent;
            outline: none;
            padding: 8px 0;
            font-size: 13px;
            color: #333;
            box-shadow: none !important;
        }

        .search-input:focus {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .filter-toggle-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-toggle-btn:hover {
            background: #f5f5f5;
            transform: scale(1.05);
        }

        .filter-toggle-btn:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .filter-toggle-btn:not(.active):hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .filter-icon {
            font-size: 18px;
            color: #666;
            transition: transform 0.3s ease;
        }

        .filter-toggle-btn:not(.active) .filter-icon {
            color: #667eea;
        }

        .filter-toggle-btn.active .filter-icon {
            transform: rotate(180deg);
        }

        /* ç­›é€‰é¢æ¿ */
        .filter-panel {
            background: white;
            border-top: 1px solid #f0f0f0;
            max-height: 800px;
            overflow: visible;
            transition: max-height 0.3s ease;
        }

        .filter-panel.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        /* ç­›é€‰åº•éƒ¨æ“ä½œæŒ‰é’® */
        .filter-actions {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            justify-content: center;
            background: white;
        }

        .filter-action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }

        .filter-sort-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .filter-sort-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 3px 10px rgba(33, 150, 243, 0.35);
        }

        .filter-sort-btn.desc {
            transform: rotate(180deg);
        }

        .filter-sort-btn.desc:hover {
            transform: rotate(180deg) scale(1.08);
        }

        .filter-reset-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .filter-reset-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 3px 10px rgba(244, 67, 54, 0.35);
        }

        .function-section {
            border-bottom: 1px solid #e9ecef;
        }

        .settings-section {
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        /* ç»Ÿä¸€çš„section-headeræ ·å¼ - ç´§å‡‘ç‰ˆ */
        .section-header {
            padding: 12px 16px;
            background: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: none;
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
            margin: 0;
            position: relative;
        }

        .section-header:hover {
            background: #dee2e6;
        }

        .section-header:hover .collapse-icon {
            background: rgba(102, 126, 234, 0.25); /* headeræ‚¬åœæ—¶å›¾æ ‡èƒŒæ™¯æ›´æ˜æ˜¾ */
        }

        /* ç¡®ä¿ç¬¬ä¸€ä¸ªæ¨¡å—çš„headeræ²¡æœ‰ä¸Šè¾¹æ¡† */
        .filter-section .section-header {
            border-top: none;
        }

        .section-title {
            font-weight: 600;
            font-size: 15px; /* ç¨å¾®å¢å¤§å­—ä½“ */
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px; /* å›¾æ ‡å’Œæ–‡å­—é—´è· */
        }

        .section-header:hover .section-title {
            color: #333; /* æ‚¬åœæ—¶æ ‡é¢˜é¢œè‰²æ›´æ·± */
        }

        .collapse-icon {
            font-size: 14px;
            color: #667eea;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 4px 6px;
            border-radius: 6px;
            background: transparent;
            min-width: 24px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .collapse-icon:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapse-icon.collapsed:hover {
            transform: rotate(-90deg) scale(1.1);
            background: rgba(102, 126, 234, 0.1);
        }

        /* ç§»åŠ¨ç«¯æŠ˜å å›¾æ ‡ä¼˜åŒ– - ç´§å‡‘åŒ– */
        @media (max-width: 768px) {
            .collapse-icon {
                font-size: 12px;
                padding: 3px 5px;
                min-width: 22px;
                border-radius: 4px;
            }
        }

        @media (max-width: 480px) {
            .collapse-icon {
                font-size: 11px;
                padding: 2px 4px;
                min-width: 20px;
                border-radius: 4px;
            }
        }

        /* ç§»åŠ¨ç«¯ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸä¼˜åŒ– - å¤§å¹…å‹ç¼©é«˜åº¦ */
        @media (max-width: 768px) {
            .stats-row {
                padding: 3px 0; /* å¤§å¹…å‡å°‘ä¸Šä¸‹padding */
                margin-top: 2px; /* å¤§å¹…å‡å°‘ä¸Šè¾¹è· */
                border-radius: 3px; /* æ›´å°åœ†è§’ */
            }

            .stats-row .stat-number {
                font-size: 12px; /* å¤§å¹…å‡å°æ•°å­—å­—ä½“ */
                margin-bottom: 0px; /* æ— ä¸‹è¾¹è· */
            }

            .stats-row .stat-label {
                font-size: 8px; /* å¤§å¹…å‡å°æ ‡ç­¾å­—ä½“ */
            }
        }

        @media (max-width: 480px) {
            .stats-row {
                padding: 2px 0; /* å°å±å¹•æœ€å°padding */
                margin-top: 1px; /* æœ€å°ä¸Šè¾¹è· */
                border-radius: 2px; /* æœ€å°åœ†è§’ */
            }

            .stats-row .stat-number {
                font-size: 10px; /* å°å±å¹•æœ€å°æ•°å­—å­—ä½“ */
                margin-bottom: 0px; /* æ— ä¸‹è¾¹è· */
            }

            .stats-row .stat-label {
                font-size: 6px; /* å°å±å¹•æœ€å°æ ‡ç­¾å­—ä½“ */
            }
        }

        /* ç§»åŠ¨ç«¯ç­›é€‰è®¾ç½®åŒºåŸŸæ•´ä½“ä¼˜åŒ– - æé™å‹ç¼©é«˜åº¦ */
        @media (max-width: 768px) {
            .section-header {
                padding: 2px 8px; /* æé™å‡å°‘ç§»åŠ¨ç«¯section-headerçš„padding */
                min-height: 28px; /* è®¾ç½®æœ€å°é«˜åº¦ */
            }

            .section-title {
                font-size: 9px; /* ç§»åŠ¨ç«¯æé™å‡å°å­—ä½“ */
                gap: 2px; /* æé™å‡å°‘å›¾æ ‡å’Œæ–‡å­—é—´è· */
                line-height: 1.2; /* å‡å°‘è¡Œé«˜ */
            }

            .collapsible-content {
                padding: 4px; /* æé™å‡å°‘ç§»åŠ¨ç«¯å†…å®¹åŒºåŸŸçš„padding */
            }

            .collapsible-content.collapsed {
                padding: 0 4px; /* ä¿æŒå·¦å³paddingä¸€è‡´ */
            }

            /* ç­›é€‰å™¨å†…éƒ¨å…ƒç´ æé™ä¼˜åŒ– */
            .filter-row {
                gap: 2px; /* æé™å‡å°‘ç­›é€‰è¡Œé—´è· */
                margin-bottom: 2px; /* æé™å‡å°‘ä¸‹è¾¹è· */
                flex-wrap: wrap; /* å…è®¸æ¢è¡Œä»¥èŠ‚çœç©ºé—´ */
            }

            .filter-group {
                margin-bottom: 2px; /* æé™å‡å°‘ç­›é€‰ç»„ä¸‹è¾¹è· */
                min-width: 80px; /* è®¾ç½®æœ€å°å®½åº¦ */
            }

            /* ç§»åŠ¨ç«¯ç´§å‡‘æ ·å¼ä¼˜åŒ– */
            .filter-row-compact {
                flex-wrap: wrap !important;
                gap: 6px !important;
                align-items: flex-end !important;
                margin-bottom: 10px !important;
            }

            .filter-group-compact {
                gap: 3px !important;
                min-width: 60px !important;
            }

            .filter-label-compact {
                font-size: 11px !important;
            }

            .custom-select-compact {
                min-width: 60px !important;
                max-width: 90px !important;
            }

            .custom-select-compact .custom-select-trigger {
                padding: 5px 6px !important;
                min-height: 28px !important;
                font-size: 12px !important;
            }

            .button-group-compact {
                gap: 4px !important;
                margin-left: 0 !important;
                flex-direction: row !important;
                width: 100% !important;
                justify-content: flex-end !important;
            }

            .filter-action-btn-compact {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }

            .custom-select-compact .custom-select-dropdown,
            .custom-single-select.custom-select-compact .custom-select-dropdown {
                max-height: 180px !important;
            }

            .date-range-input {
                padding: 5px 6px !important;
                min-height: 28px !important;
                font-size: 12px !important;
            }

            #customDateRangeRow .filter-group-compact {
                min-width: 70px !important;
            }

            .filter-label {
                font-size: 8px; /* æé™å‡å°æ ‡ç­¾å­—ä½“ */
                margin-bottom: 0px; /* æ— ä¸‹è¾¹è· */
                line-height: 1.1; /* å‡å°‘è¡Œé«˜ */
            }

            .filter-select {
                padding: 1px 4px; /* æé™å‡å°‘é€‰æ‹©æ¡†padding */
                font-size: 9px; /* æé™å‡å°å­—ä½“ */
                min-height: 20px; /* å‡å°æœ€å°é«˜åº¦ */
                line-height: 1.2; /* å‡å°‘è¡Œé«˜ */
            }

            /* æå°å±å¹•æŒ‡å®šæ—¥æœŸé€‰æ‹©æ¡† */
            .custom-single-select.custom-date-picker {
                min-width: 80px;
                width: 80px;
                max-width: 90px; /* ç¼©å°æå°å±å¹•æœ€å¤§å®½åº¦ */
                margin-right: 12px; /* å¢åŠ æå°å±å¹•å³è¾¹è· */
            }

            /* æå°å±å¹•ä¼˜å…ˆçº§ç­›é€‰æ¡† */
            #priorityFilterContainer.custom-single-select {
                max-width: 65px; /* è¿›ä¸€æ­¥ç¼©å°æå°å±å¹•å®½åº¦ */
                min-width: 65px; /* è¿›ä¸€æ­¥ç¼©å°æå°å±å¹•å®½åº¦ */
                width: 65px; /* è¿›ä¸€æ­¥ç¼©å°æå°å±å¹•å®½åº¦ */
            }

            /* çŠ¶æ€ç­›é€‰æŒ‰é’®ä¼˜åŒ– */
            .status-filter-buttons {
                gap: 2px; /* æé™å‡å°‘æŒ‰é’®é—´è· */
                margin: 2px 0; /* æé™å‡å°‘ä¸Šä¸‹è¾¹è· */
            }

            .status-filter-btn {
                padding: 2px 6px; /* æé™å‡å°‘æŒ‰é’®padding */
                font-size: 8px; /* æé™å‡å°å­—ä½“ */
                min-height: 18px; /* å‡å°æœ€å°é«˜åº¦ */
                line-height: 1.1; /* å‡å°‘è¡Œé«˜ */
            }
        }

        @media (max-width: 480px) {
            .section-header {
                padding: 1px 6px; /* å°å±å¹•æé™padding */
                min-height: 24px; /* æ›´å°æœ€å°é«˜åº¦ */
            }

            .section-title {
                font-size: 8px; /* å°å±å¹•æé™å­—ä½“ */
                gap: 1px; /* æé™å›¾æ ‡å’Œæ–‡å­—é—´è· */
                line-height: 1.1; /* æé™è¡Œé«˜ */
            }

            .collapsible-content {
                padding: 3px; /* å°å±å¹•æé™padding */
            }

            .collapsible-content.collapsed {
                padding: 0 3px; /* ä¿æŒå·¦å³paddingä¸€è‡´ */
            }

            /* å°å±å¹•ç­›é€‰å™¨å†…éƒ¨å…ƒç´ æé™åŒ– */
            .filter-row {
                gap: 1px; /* æé™ç­›é€‰è¡Œé—´è· */
                margin-bottom: 1px; /* æé™ä¸‹è¾¹è· */
                flex-wrap: wrap; /* å…è®¸æ¢è¡ŒèŠ‚çœç©ºé—´ */
            }

            .filter-group {
                margin-bottom: 1px; /* æé™ç­›é€‰ç»„ä¸‹è¾¹è· */
                min-width: 70px; /* æ›´å°æœ€å°å®½åº¦ */
            }

            .filter-label {
                font-size: 7px; /* æé™æ ‡ç­¾å­—ä½“ */
                margin-bottom: 0px; /* æ— ä¸‹è¾¹è· */
                line-height: 1.0; /* æé™è¡Œé«˜ */
            }

            .filter-select {
                padding: 0px 2px; /* æé™é€‰æ‹©æ¡†padding */
                font-size: 8px; /* æé™å­—ä½“ */
                min-height: 16px; /* æé™æœ€å°é«˜åº¦ */
                line-height: 1.1; /* æé™è¡Œé«˜ */
            }

            /* è¶…å°å±å¹•æŒ‡å®šæ—¥æœŸé€‰æ‹©æ¡† */
            .custom-single-select.custom-date-picker {
                min-width: 75px;
                width: 75px;
                max-width: 85px; /* ç¼©å°è¶…å°å±å¹•æœ€å¤§å®½åº¦ */
                margin-right: 10px; /* å¢åŠ è¶…å°å±å¹•å³è¾¹è· */
            }

            /* è¶…å°å±å¹•ä¼˜å…ˆçº§ç­›é€‰æ¡† */
            #priorityFilterContainer.custom-single-select {
                max-width: 55px; /* è¿›ä¸€æ­¥ç¼©å°è¶…å°å±å¹•å®½åº¦ */
                min-width: 55px; /* è¿›ä¸€æ­¥ç¼©å°è¶…å°å±å¹•å®½åº¦ */
                width: 55px; /* è¿›ä¸€æ­¥ç¼©å°è¶…å°å±å¹•å®½åº¦ */
            }

            /* å°å±å¹•çŠ¶æ€ç­›é€‰æŒ‰é’®æé™ä¼˜åŒ– */
            .status-filter-buttons {
                gap: 1px; /* æé™æŒ‰é’®é—´è· */
                margin: 1px 0; /* æé™ä¸Šä¸‹è¾¹è· */
                flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            }

            .status-filter-btn {
                padding: 1px 4px; /* æé™æŒ‰é’®padding */
                font-size: 7px; /* æé™å­—ä½“ */
                min-height: 14px; /* æé™æœ€å°é«˜åº¦ */
                line-height: 1.0; /* æé™è¡Œé«˜ */
            }
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            max-height: 800px;
            padding: 20px;
            margin: 0; /* ç¡®ä¿æ²¡æœ‰å¤–è¾¹è· */
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 20px;
            margin: 0; /* ç¡®ä¿æŠ˜å æ—¶æ²¡æœ‰å¤–è¾¹è· */
        }

        .footer-actions {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .footer-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .filter-btn {
            background: #e8f4fd;
            color: #1976d2;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #1976d2;
            color: white;
        }

        .export-btn {
            background: #e8f5e8;
            color: #388e3c;
        }

        .export-btn:hover {
            background: #388e3c;
            color: white;
        }

        .import-btn {
            background: #fff3e0;
            color: #f57c00;
        }

        .import-btn:hover {
            background: #f57c00;
            color: white;
        }

        .stats {
            margin-top: 16px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            text-align: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* ç¼–è¾‘æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 10vh;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
            padding-bottom: max(100px, env(safe-area-inset-bottom, 0px)); /* æ”¯æŒå®‰å…¨åŒºåŸŸå’Œåº•éƒ¨å¯¼èˆªæ  */
            box-sizing: border-box;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: calc(85vh - 100px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦å’Œé¢å¤–è¾¹è· */
            display: flex;
            flex-direction: column;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.2),
                0 8px 24px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 100px; /* ç¡®ä¿å¼¹æ¡†åº•éƒ¨ä¸è¢«å¯¼èˆªæ é®æŒ¡ */
        }

        /* è®¾ç½®æ¨¡æ€æ¡†ç‰¹æ®Šæ ·å¼ - å¢åŠ æ›´å¤šå†…è¾¹è·å’Œæ›´å¤§å®½åº¦ */
        #dailyTodoModal .modal-content,
        #wechatModal .modal-content,
        #assigneeModal .modal-content {
            max-width: 520px;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* æ•°æ®åº“å’Œä¸ªäººä¿¡æ¯å¼¹æ¡†ä½¿ç”¨ä¸åŒçš„å¸ƒå±€ */
        #databaseModal .modal-content,
        #personalInfoModal .modal-content {
            max-width: 520px;
            padding: 0;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* æ•°æ®åº“å’Œä¸ªäººä¿¡æ¯å¼¹æ¡†çš„ä¸»ä½“å†…å®¹å¯æ»šåŠ¨ */
        #databaseModal .modal-body,
        #personalInfoModal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            min-height: 0;
        }

        /* æ•°æ®åº“å’Œä¸ªäººä¿¡æ¯å¼¹æ¡†çš„å¤´éƒ¨å›ºå®š */
        #databaseModal .modal-header,
        #personalInfoModal .modal-header {
            flex-shrink: 0;
            padding: 24px 30px 0 30px;
            margin-bottom: 0;
            border-bottom: 2px solid #f0f0f0;
            background: white;
            z-index: 10;
        }

        /* æ•°æ®åº“å’Œä¸ªäººä¿¡æ¯å¼¹æ¡†çš„åº•éƒ¨æŒ‰é’®å›ºå®š */
        #databaseModal .form-actions,
        #personalInfoModal .form-actions {
            flex-shrink: 0;
            padding: 20px 30px 30px 30px;
            margin-top: 0;
            background: white;
            border-top: 1px solid #f0f0f0;
            z-index: 10;
        }

        /* è®¾ç½®æ¨¡æ€æ¡†çš„å¤´éƒ¨æ ·å¼è°ƒæ•´ */
        #dailyTodoModal .modal-header,
        #wechatModal .modal-header,
        #assigneeModal .modal-header {
            padding: 0 0 16px 0;
            margin-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* è®¾ç½®æ¨¡æ€æ¡†çš„è¡¨å•ç»„é—´è·è°ƒæ•´ - ç´§å‡‘å¸ƒå±€ */
        #dailyTodoModal .form-group,
        #wechatModal .form-group,
        #assigneeModal .form-group {
            margin-bottom: 16px;
        }

        /* è®¾ç½®æ¨¡æ€æ¡†çš„æ“ä½œæŒ‰é’®åŒºåŸŸ - ç´§å‡‘å¸ƒå±€ */
        #dailyTodoModal .form-actions,
        #wechatModal .form-actions,
        #assigneeModal .form-actions {
            padding-top: 16px;
            margin-top: 16px;
            border-top: 1px solid #f0f0f0;
        }

        /* æ•°æ®åº“è®¾ç½®å¼¹æ¡†ä¸“å±æ ·å¼ */
        #databaseModal .connection-status-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        #databaseModal .database-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #databaseModal .status-icon {
            font-size: 24px;
            line-height: 1;
        }

        #databaseModal .status-info {
            flex: 1;
        }

        #databaseModal .status-text {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        #databaseModal .status-detail {
            font-size: 14px;
            color: #6c757d;
        }

        #databaseModal .status-test-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #databaseModal .status-test-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        #databaseModal .form-section {
            margin-bottom: 28px;
        }

        #databaseModal .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        #databaseModal .label-required {
            color: #dc3545;
            margin-left: 4px;
        }

        #databaseModal .form-help {
            color: #6c757d;
            font-size: 12px;
            margin-top: 6px;
            display: block;
        }

        #databaseModal .setup-help {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        #databaseModal .setup-help summary {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            user-select: none;
        }

        #databaseModal .setup-help summary:hover {
            background: rgba(0,0,0,0.05);
        }

        #databaseModal .help-content {
            padding: 0 16px 16px 16px;
            color: #6c757d;
            font-size: 14px;
            line-height: 1.5;
        }

        #databaseModal .help-content p {
            margin-bottom: 12px;
        }

        #databaseModal .help-content pre {
            background: #212529;
            color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            margin: 8px 0;
        }

        #databaseModal .help-content a {
            color: #007bff;
            text-decoration: none;
        }

        #databaseModal .help-content a:hover {
            text-decoration: underline;
        }

        /* ä¸ªäººä¿¡æ¯è®¾ç½®å¼¹æ¡†ä¸“å±æ ·å¼ */
        #personalInfoModal .current-identity-status {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 1px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        }

        #personalInfoModal .status-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        #personalInfoModal .status-icon {
            width: 32px;
            height: 32px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        #personalInfoModal .status-title {
            font-size: 18px;
            font-weight: 600;
            color: #2E7D32;
            margin: 0;
        }

        #personalInfoModal .current-identity {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #C8E6C9;
            margin-bottom: 12px;
        }

        #personalInfoModal .identity-icon {
            width: 24px;
            height: 24px;
            background: #66BB6A;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        #personalInfoModal .identity-name {
            font-weight: 600;
            color: #2E7D32;
            flex: 1;
        }

        #personalInfoModal .status-description {
            color: #388E3C;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        #personalInfoModal .settings-section {
            background: #fafafa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e0e0e0;
        }

        #personalInfoModal .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #personalInfoModal .section-icon {
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        #personalInfoModal .form-group {
            margin-bottom: 20px;
        }

        #personalInfoModal .form-group:last-child {
            margin-bottom: 0;
        }

        #personalInfoModal .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #personalInfoModal .required-field::after {
            content: " *";
            color: #f44336;
            font-weight: bold;
        }

        #personalInfoModal .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 6px;
            line-height: 1.4;
            display: block;
        }

        #personalInfoModal .permission-info {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 4px solid #ff9800;
        }

        #personalInfoModal .permission-info .info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        #personalInfoModal .permission-info .info-icon {
            width: 24px;
            height: 24px;
            background: #ff9800;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        #personalInfoModal .permission-info .info-title {
            font-weight: 600;
            color: #e65100;
            margin: 0;
            font-size: 16px;
        }

        #personalInfoModal .permission-info .info-text {
            color: #ef6c00;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        #personalInfoModal .permission-warning {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border-left: 4px solid #d32f2f;
        }

        #personalInfoModal .warning-text {
            color: #c62828;
            font-size: 13px;
            line-height: 1.4;
            margin: 0;
        }

        #personalInfoModal .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #personalInfoModal .form-checkbox-group:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        #personalInfoModal .form-checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        #personalInfoModal .form-checkbox-group span {
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }

        #personalInfoModal .custom-single-select {
            position: relative;
        }

        #personalInfoModal .custom-select-trigger {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #personalInfoModal .custom-select-trigger:hover {
            border-color: #667eea;
        }

        #personalInfoModal .custom-select-trigger.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #personalInfoModal .custom-select-display {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        #personalInfoModal .custom-select-arrow {
            color: #666;
            transition: transform 0.2s ease;
        }

        #personalInfoModal .custom-select-trigger.active .custom-select-arrow {
            transform: rotate(180deg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0 24px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 0;
            position: relative;
        }

        /* æ»šåŠ¨æŒ‡ç¤ºå™¨ */
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-content.has-scroll .modal-header::after {
            opacity: 1;
        }

        .modal-title {
            font-size: 16px;
            font-weight: bold;
        }

        /* è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜ç‰¹æ®Šä¼˜åŒ– */
        #dailyTodoModal .modal-title,
        #wechatModal .modal-title,
        #assigneeModal .modal-title {
            font-size: 15px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #666;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
            transition: scrollbar-color 0.3s ease;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        .modal-body:hover {
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }

        /* Webkitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        .modal-body::-webkit-scrollbar-thumb:active {
            background: rgba(0, 0, 0, 0.35);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 0 24px 24px 24px;
            flex-shrink: 0;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 0;
            position: relative;
        }

        /* åº•éƒ¨æ»šåŠ¨æŒ‡ç¤ºå™¨ */
        .modal-footer::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-content.has-scroll-bottom .modal-footer::before {
            opacity: 1;
        }

        /* å¼¹çª—å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
                max-height: calc(95vh - 120px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦å’Œé¢å¤–è¾¹è· */
                margin: 5px 10px 120px 10px; /* å¢åŠ åº•éƒ¨è¾¹è·é¿å¼€å¯¼èˆªæ  */
                min-height: 300px;
            }

            /* æ¯æ—¥å¾…åŠã€å¾®ä¿¡é€šçŸ¥ã€å®Œæˆäººç®¡ç†å¼¹æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #dailyTodoModal .modal-content,
            #wechatModal .modal-content,
            #assigneeModal .modal-content {
                width: 95%;
                padding: 20px;
                max-height: calc(95vh - 120px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
                overflow-y: auto;
                margin: 5px auto 120px auto; /* å¢åŠ åº•éƒ¨è¾¹è·é¿å¼€å¯¼èˆªæ  */
            }

            #dailyTodoModal .modal-header,
            #wechatModal .modal-header,
            #assigneeModal .modal-header {
                padding: 0 0 16px 0;
                margin-bottom: 20px;
                border-bottom: 1px solid #f0f0f0;
            }

            #dailyTodoModal .form-group,
            #wechatModal .form-group,
            #assigneeModal .form-group {
                margin-bottom: 20px;
            }

            #dailyTodoModal .form-actions,
            #wechatModal .form-actions,
            #assigneeModal .form-actions {
                padding-top: 16px;
                margin-top: 16px;
                border-top: 1px solid #f0f0f0;
            }

            /* æ•°æ®åº“å’Œä¸ªäººä¿¡æ¯å¼¹æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #databaseModal .modal-content,
            #personalInfoModal .modal-content {
                max-height: calc(95vh - 120px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
                width: 95%;
                margin: 5px auto 120px auto; /* å¢åŠ åº•éƒ¨è¾¹è·é¿å¼€å¯¼èˆªæ  */
                display: flex;
                flex-direction: column;
            }

            #databaseModal .modal-header,
            #personalInfoModal .modal-header {
                padding: 16px 20px 12px 20px;
                flex-shrink: 0;
                border-bottom: 1px solid #f0f0f0;
            }

            #databaseModal .modal-body,
            #personalInfoModal .modal-body {
                padding: 16px 20px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                flex: 1;
                min-height: 0;
            }

            #databaseModal .form-actions,
            #personalInfoModal .form-actions {
                padding: 16px 20px 20px 20px;
                flex-shrink: 0;
                border-top: 1px solid #f0f0f0;
                background: white;
            }

            .modal-header {
                padding: 20px 20px 0 20px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 0 20px 20px 20px;
                flex-direction: column-reverse;
                gap: 8px;
            }

            .modal-footer button {
                width: 100%;
                min-height: 44px;
            }

            /* ç§»åŠ¨ç«¯æ»šåŠ¨æ¡ä¼˜åŒ– */
            .modal-body::-webkit-scrollbar {
                width: 4px;
            }

            .modal-body {
                scrollbar-width: thin;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                max-height: calc(98vh - 120px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
                border-radius: 8px;
                margin: 2px auto 120px auto; /* å¢åŠ åº•éƒ¨è¾¹è·é¿å¼€å¯¼èˆªæ  */
            }

            /* æ¯æ—¥å¾…åŠã€å¾®ä¿¡é€šçŸ¥ã€å®Œæˆäººç®¡ç†å¼¹æ¡†å°å±å¹•ä¼˜åŒ– */
            #dailyTodoModal .modal-content,
            #wechatModal .modal-content,
            #assigneeModal .modal-content {
                width: 98%;
                padding: 16px;
                max-height: calc(98vh - 120px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
                overflow-y: auto;
                margin: 2px auto 120px auto; /* å¢åŠ åº•éƒ¨è¾¹è·é¿å¼€å¯¼èˆªæ  */
            }

            #dailyTodoModal .modal-header,
            #wechatModal .modal-header,
            #assigneeModal .modal-header {
                padding: 0 0 12px 0;
                margin-bottom: 16px;
                border-bottom: 1px solid #f0f0f0;
            }

            #dailyTodoModal .form-group,
            #wechatModal .form-group,
            #assigneeModal .form-group {
                margin-bottom: 16px;
            }

            #dailyTodoModal .form-actions,
            #wechatModal .form-actions,
            #assigneeModal .form-actions {
                padding-top: 12px;
                margin-top: 12px;
                border-top: 1px solid #f0f0f0;
            }

            /* æ•°æ®åº“å’Œä¸ªäººä¿¡æ¯å¼¹æ¡†å°å±å¹•ä¼˜åŒ– */
            #databaseModal .modal-content,
            #personalInfoModal .modal-content {
                max-height: calc(98vh - 120px); /* å‡å»åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
                width: 98%;
                margin: 2px auto 120px auto; /* å¢åŠ åº•éƒ¨è¾¹è·é¿å¼€å¯¼èˆªæ  */
            }

            #databaseModal .modal-header,
            #personalInfoModal .modal-header {
                padding: 12px 16px 8px 16px;
                flex-shrink: 0;
            }

            #databaseModal .modal-body,
            #personalInfoModal .modal-body {
                padding: 12px 16px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                flex: 1;
                min-height: 0;
            }

            #databaseModal .form-actions,
            #personalInfoModal .form-actions {
                padding: 12px 16px 16px 16px;
                flex-shrink: 0;
            }

            .modal-header {
                padding: 16px 16px 0 16px;
            }

            .modal-body {
                padding: 16px;
            }

            .modal-footer {
                padding: 0 16px 16px 16px;
            }

            /* å°å±å¹•å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ä¼˜åŒ– */
            .modal-body .form-group {
                margin-bottom: 20px;
            }

            .modal-body .form-input,
            .modal-body .form-select,
            .modal-body .form-textarea {
                padding: 12px 14px;
                font-size: 14px;
            }

            .modal-body .complete-task-info {
                padding: 16px;
                margin-bottom: 20px;
            }

            .modal-body .completion-time {
                padding: 14px 16px;
                margin-top: 20px;
            }

            .modal-title {
                font-size: 16px;
            }

            /* å°å±å¹•éšè—æ»šåŠ¨æ¡ */
            .modal-body::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }

            .modal-body {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ä¸­çš„è¡¨å•ç»„ä¼˜åŒ– */
        .modal-body .form-group {
            margin-bottom: 24px;
        }

        .modal-body .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        /* è®¾ç½®æ¨¡æ€æ¡†çš„è¡¨å•æ ‡ç­¾ä¼˜åŒ– */
        #dailyTodoModal .form-label,
        #wechatModal .form-label,
        #assigneeModal .form-label {
            font-size: 12px;
            margin-bottom: 4px;
        }

        /* è®¾ç½®æ¨¡æ€æ¡†çš„è¡¨å•è¾“å…¥æ¡†ä¼˜åŒ– */
        #dailyTodoModal .form-input,
        #dailyTodoModal .form-select,
        #dailyTodoModal .form-textarea,
        #wechatModal .form-input,
        #wechatModal .form-select,
        #wechatModal .form-textarea,
        #assigneeModal .form-input,
        #assigneeModal .form-select,
        #assigneeModal .form-textarea {
            padding: 8px 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        /* å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ä¸­çš„è¡¨å•æ ‡ç­¾ä¼˜åŒ– */
        .modal-body .form-label {
            margin-bottom: 10px;
            font-size: 15px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
            line-height: 1.4;
        }

        /* å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ä¸­çš„è¡¨å•è¾“å…¥æ¡†ä¼˜åŒ– */
        .modal-body .form-input,
        .modal-body .form-select,
        .modal-body .form-textarea {
            padding: 14px 16px;
            font-size: 15px;
            border-radius: 10px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* å›¾ç‰‡ä¸Šä¼ ç»„ä»¶æ ·å¼ */
        .image-upload-container {
            margin-top: 8px;
        }

        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .image-preview-container {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .image-preview-item {
            position: relative;
            display: inline-block;
            border-radius: 6px;
            overflow: hidden;
            background: #f5f5f5;
            border: 1px solid #e1e5e9;
        }

        .image-preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        /* å¯ç‚¹å‡»çš„å›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .preview-image-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preview-image-clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        .image-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .image-preview-remove:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        /* ä»»åŠ¡åˆ—è¡¨ä¸­çš„å¤‡æ³¨å›¾ç‰‡æ ·å¼ */
        .task-notes-images {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .task-notes-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-notes-image:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .image-modal {
            backdrop-filter: blur(2px);
        }

        .image-modal img {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* ç§»åŠ¨ç«¯è¡¨å•é€‰æ‹©æ¡†ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* é˜²æ­¢iOS Safariè‡ªåŠ¨ç¼©æ”¾ */
            input, select, textarea {
                font-size: 10px !important;
            }
            .form-select {
                font-size: 16px;
                min-height: 44px;
                padding: 12px 16px;
                border-radius: 8px;
                background: white;
                border: 2px solid #e1e5e9;
                /* ä¿æŒåŸç”Ÿappearance */
            }

            .form-select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                outline: none;
            }

            /* iOS Safariä¼˜åŒ– */
            @supports (-webkit-touch-callout: none) {
                .form-select {
                    -webkit-appearance: menulist;
                    -webkit-border-radius: 8px;
                }
            }

            /* iOSè®¾å¤‡ä¸“ç”¨æ ·å¼ */
            .ios-device .form-select,
            .ios-device .filter-select {
                -webkit-appearance: menulist;
                border-radius: 8px;
                background: white;
                cursor: pointer;
            }

            .ios-device .form-select:focus,
            .ios-device .filter-select:focus {
                -webkit-user-select: none;
                user-select: none;
            }

            /* Androidè®¾å¤‡ä¼˜åŒ– */
            .android-device .form-select,
            .android-device .filter-select {
                -webkit-appearance: menulist;
                -moz-appearance: menulist;
                appearance: auto;
                background: white;
                border: 2px solid #e1e5e9;
            }

            /* Android 12+ é€‰æ‹©æ¡†ä¼˜åŒ– - å¼ºåˆ¶ä¸‹æ‹‰åˆ—è¡¨æ¨¡å¼ */
            .android-14-compat .form-select,
            .android-14-compat .filter-select {
                background: white;
                border: 2px solid #667eea;
                border-radius: 8px;
                -webkit-appearance: menulist !important;
                -moz-appearance: menulist !important;
                appearance: menulist !important;
                background-image: none;
                padding-right: 30px;
            }

            .form-input {
                font-size: 16px;
                min-height: 44px;
                border-radius: 8px;
            }

            .form-textarea {
                font-size: 16px;
                border-radius: 8px;
            }
        }

        .form-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-save {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* æµ‹è¯•æŒ‰é’®æ ·å¼ - ç´§å‡‘ç‰ˆ */
        .btn-test {
            padding: 6px 12px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .btn-test:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-test:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-test.morning {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-test.morning:hover {
            background: linear-gradient(135deg, #218838, #1ba085);
        }

        .btn-test.deadline {
            background: linear-gradient(135deg, #ff6b35, #f0432a);
        }

        .btn-test.deadline:hover {
            background: linear-gradient(135deg, #e55a2b, #d63926);
        }

        .btn-test.web {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .btn-test.web:hover {
            background: linear-gradient(135deg, #0069d9, #004085);
        }

        .btn-test.native {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }

        .btn-test.native:hover {
            background: linear-gradient(135deg, #e0a800, #c69500);
        }

        .btn-test.overdue {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            animation: overdueButtonPulse 2s ease-in-out infinite;
        }

        .btn-test.overdue:hover {
            background: linear-gradient(135deg, #c62828, #a00000);
            animation: none;
        }

        @keyframes overdueButtonPulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
            }
            50% {
                box-shadow: 0 4px 16px rgba(211, 47, 47, 0.5);
            }
        }

        .btn-test.reminder {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
        }

        .btn-test.reminder:hover {
            background: linear-gradient(135deg, #8e24aa, #5e35b1);
        }

        .btn-test.comprehensive {
            background: linear-gradient(135deg, #00bcd4, #009688);
        }

        .btn-test.comprehensive:hover {
            background: linear-gradient(135deg, #00acc1, #00897b);
        }

        /* æµ‹è¯•æŒ‰é’®å®¹å™¨ - ç´§å‡‘ç‰ˆ */
        .test-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
            padding: 12px 0;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .test-buttons-label {
            width: 100%;
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 6px;
            font-weight: 500;
        }

        /* ä¸»è¦æ“ä½œæŒ‰é’®å®¹å™¨ - ç´§å‡‘ç‰ˆ */
        .main-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
        }

        /* å¢å¼ºä¸»è¦æ“ä½œæŒ‰é’®æ ·å¼ - ç´§å‡‘ç‰ˆ */
        .main-actions .btn-cancel,
        .main-actions .btn-save {
            padding: 10px 24px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: none;
            cursor: pointer;
            min-width: 80px;
        }

        .main-actions .btn-cancel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .main-actions .btn-cancel:hover {
            background: linear-gradient(135deg, #e9ecef, #d3d6db);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .main-actions .btn-save {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .main-actions .btn-save:hover {
            background: linear-gradient(135deg, #5a67d8, #6c5b7b);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .main-actions .btn-cancel:active,
        .main-actions .btn-save:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* å®Œæˆäººæ·»åŠ æŒ‰é’®æ ·å¼ */
        .assignee-add-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-add-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .btn-add-assignee:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .btn-add-assignee:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .btn-add-assignee .icon-plus {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }

        /* ç­›é€‰å™¨æ ·å¼å·²åœ¨ç»Ÿä¸€æ¨¡å—æ ·å¼ä¸­å®šä¹‰ */

        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 2px;
            align-items: flex-end;
            flex-wrap: nowrap;
            overflow: visible;
            position: relative;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 140px;
            flex: 1 1 auto;
            max-width: 200px;
        }

        /* æŒ‰é’®ç»„ï¼ˆæ°´å¹³æ’åˆ—ï¼‰ */
        .filter-group.button-group {
            flex-direction: row;
            align-items: flex-end;
            gap: 8px;
            flex: 0;
            min-width: auto;
        }

        /* ç´§å‡‘æ ·å¼ - å‡åŠé«˜åº¦ */
        .filter-row-compact {
            display: flex !important;
            flex-wrap: nowrap !important;
            align-items: flex-end !important;
            margin-bottom: 5px !important;
            gap: 8px !important;
            position: relative !important;
            overflow: visible !important;
        }

        /* ç¬¬ä¸€è¡Œç­›é€‰ï¼šæ—¥æœŸã€çŠ¶æ€ã€åˆ†ç±» */
        #dateRow {
            flex-wrap: nowrap !important;
        }

        #dateRow .filter-group-compact {
            flex: 1 1 0 !important;
            min-width: 0 !important;
            max-width: none !important;
        }

        /* ç¬¬äºŒè¡Œç­›é€‰ï¼šä¼˜å…ˆçº§ã€å®Œæˆäººã€æ’åºã€æŒ‰é’® */
        #categoryRow {
            flex-wrap: nowrap !important;
        }

        #categoryRow .filter-group-compact {
            flex: 1 1 0 !important;
            min-width: 0 !important;
            max-width: none !important;
        }

        #categoryRow .button-group-compact {
            flex: 0 0 auto !important;
        }

        /* è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´è¡Œé»˜è®¤éšè— - é«˜ä¼˜å…ˆçº§ */
        #customDateRangeRow {
            display: none !important;
        }

        /* å½“éœ€è¦æ˜¾ç¤ºæ—¶çš„æ ·å¼ */
        #customDateRangeRow.show {
            display: flex !important;
        }

        .filter-group-compact {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 4px !important;
            min-width: 0 !important;
            flex: 1 1 0 !important;
            max-width: none !important;
            position: relative !important;
            z-index: auto !important;
            overflow: visible !important;
        }

        .filter-label-compact {
            font-size: 12px !important;
            margin-bottom: 3px !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            color: #666 !important;
            font-weight: 500 !important;
            line-height: 1.2 !important;
        }

        .custom-select-compact,
        .custom-single-select.custom-select-compact {
            min-width: 0 !important;
            max-width: none !important;
            width: 100% !important;
            position: relative !important;
            overflow: visible !important;
            z-index: auto !important;
        }

        .custom-select-compact .custom-select-trigger {
            padding: 5px 6px !important;
            min-height: 28px !important;
            font-size: 12px !important;
        }

        .custom-select-compact .custom-select-display {
            font-size: 12px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .custom-select-compact .custom-select-arrow {
            font-size: 10px !important;
        }

        .custom-select-compact .custom-select-dropdown,
        .custom-single-select.custom-select-compact .custom-select-dropdown {
            z-index: 99999 !important;
            min-width: 110px !important;
            max-height: 220px !important;
            overflow-y: auto !important;
            position: absolute !important;
        }

        .button-group-compact {
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-end !important;
            gap: 4px !important;
            flex: 0 0 auto !important;
            min-width: auto !important;
            flex-shrink: 0 !important;
            margin-left: 0 !important;
            padding-bottom: 0 !important;
            width: auto !important;
        }

        .filter-action-btn-compact {
            width: 28px !important;
            height: 28px !important;
            padding: 0 !important;
            font-size: 14px !important;
            min-width: 28px !important;
            max-width: 28px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            border: 1px solid #d1d5d9 !important;
            border-radius: 4px !important;
            background: white !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .filter-action-btn-compact:hover {
            background: #f0f2ff !important;
            border-color: #667eea !important;
        }

        .filter-action-btn-compact.filter-reset-btn {
            color: #dc3545 !important;
        }

        .filter-action-btn-compact.filter-reset-btn:hover {
            background: #fff5f5 !important;
            border-color: #dc3545 !important;
        }

        .selected-tags-compact {
            display: none !important; /* ç´§å‡‘æ¨¡å¼ä¸‹éšè—æ ‡ç­¾ */
        }

        /* æ—¶é—´èŒƒå›´è¾“å…¥æ¡†æ ·å¼ */
        .date-range-input {
            padding: 6px 10px;
            border: 1px solid #d1d5d9;
            border-radius: 4px;
            font-size: 13px;
            min-height: 34px;
            width: 100%;
            box-sizing: border-box;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
        }

        .date-range-input:hover {
            border-color: #b1b5b9;
        }

        .date-range-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
        }

        /* ç¡®ä¿æ—¶é—´èŒƒå›´è¾“å…¥æ¡†çš„filter-groupä¹Ÿä½¿ç”¨ç´§å‡‘æ ·å¼ */
        #customDateRangeRow .filter-group-compact {
            min-width: 90px !important;
        }

        .filter-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            white-space: nowrap;
        }

        .filter-select {
            padding: 6px 10px;
            border: 1px solid #d1d5d9;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            background: white;
            min-width: 100px;
            transition: all 0.2s ease;
        }

        /* æŒ‡å®šæ—¥æœŸé€‰æ‹©æ¡†ç‰¹æ®Šæ ·å¼ */
        .custom-single-select.custom-date-picker {
            min-width: 120px;
            width: 120px;
            max-width: 130px; /* ç¼©å°æœ€å¤§å®½åº¦ */
            margin-right: 18px; /* å¢åŠ å³è¾¹è· */
        }

        /* ç§»é™¤ç‰¹å®šç­›é€‰æ¡†å®½åº¦é™åˆ¶ï¼Œä½¿ç”¨å¼¹æ€§å¸ƒå±€ */

        .filter-select:hover {
            border-color: #b1b5b9;
        }

        .filter-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        /* ä¼˜åŒ–çš„ç­›é€‰å™¨æ–°æ ·å¼ */
        .filter-input {
            padding: 6px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            background: white;
            width: 100%;
            min-height: 32px;
        }

        .filter-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ä¼˜åŒ–ç­›é€‰å™¨å­—ä½“å’Œé—´è· */
        .filter-label {
            font-size: 10px !important;
            color: #666;
            font-weight: 500;
            white-space: nowrap;
            margin-bottom: 3px;
        }

        .filter-select {
            padding: 3px 5px !important;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 9px !important;
            outline: none;
            background: white;
            min-width: 80px !important;
            max-width: 150px;
            min-height: 28px !important;
        }

        /* ç§»åŠ¨ç«¯æŒ‡å®šæ—¥æœŸé€‰æ‹©æ¡†ç‰¹æ®Šæ ·å¼ */
        .custom-single-select.custom-date-picker {
            min-width: 100px !important;
            width: 100px !important;
            max-width: 110px !important; /* ç¼©å°ç§»åŠ¨ç«¯æœ€å¤§å®½åº¦ */
            margin-right: 20px !important; /* è¿›ä¸€æ­¥å¢åŠ ç§»åŠ¨ç«¯å³è¾¹è· */
        }

        /* ç§»åŠ¨ç«¯ä¼˜å…ˆçº§ç­›é€‰æ¡†ç‰¹æ®Šæ ·å¼ */
        #priorityFilterContainer.custom-single-select {
            max-width: 70px !important; /* å†æ¬¡ç¼©å°ç§»åŠ¨ç«¯å®½åº¦ */
            min-width: 70px !important; /* å†æ¬¡ç¼©å°ç§»åŠ¨ç«¯å®½åº¦ */
            width: 70px !important; /* å†æ¬¡ç¼©å°ç§»åŠ¨ç«¯å®½åº¦ */
        }

        .filter-row {
            display: flex;
            gap: 12px !important;
            margin-bottom: 12px !important;
            align-items: flex-end;
            flex-wrap: wrap;
            overflow: visible !important;
            position: relative !important;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px !important;
            min-width: 100px;
            flex: 1 1 auto;
            max-width: 180px;
        }

        /* å¯æŠ˜å è¡Œçš„æ ·å¼ */
        .collapsible-row {
            transition: all 0.3s ease;
            overflow: visible;
        }

        .collapsible-row.collapsed {
            display: none;
        }

        /* ç­›é€‰å†…å®¹åŒºåŸŸæ ·å¼ */
        .filter-content {
            padding: 5px 16px;
            background: #f8f9fa;
            overflow: visible;
        }

        /* åŠŸèƒ½æŒ‰é’®æ ·å¼ */
        .function-btn {
            padding: 8px 16px;
            border: 1px solid #667eea;
            border-radius: 4px;
            background: white;
            color: #667eea;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-height: 34px;
        }

        .function-btn:hover {
            background: #f0f2ff;
            border-color: #5a6fd8;
        }

        .function-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* å¤šé€‰ä¸‹æ‹‰æ¡†ä¼˜åŒ–æ ·å¼ */
        select[multiple].filter-select {
            min-height: 32px;
            max-height: 80px;
            overflow-y: auto;
            padding: 4px 6px !important;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            position: relative;
        }

        select[multiple].filter-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        /* å¤šé€‰ä¸‹æ‹‰æ¡†é€‰é¡¹æ ·å¼ */
        select[multiple].filter-select option {
            padding: 3px 6px;
            border-radius: 3px;
            margin: 1px 0;
            font-size: 11px;
            line-height: 1.3;
            background: white;
            color: #333;
            cursor: pointer;
        }

        select[multiple].filter-select option:checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 500;
        }

        select[multiple].filter-select option:hover {
            background: #f0f3ff;
        }

        select[multiple].filter-select option:checked:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* çŠ¶æ€ç­›é€‰ç‰¹æ®Šæ ·å¼ */
        #statusFilter option[value="all"]:checked {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        #statusFilter option[value="active"]:checked {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        #statusFilter option[value="completed"]:checked {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        #statusFilter option[value="overdue"]:checked {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        /* å®Œæˆäººç­›é€‰æ ·å¼ */
        #assigneeFilter option:checked {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        }

        /* å¤šé€‰æ¡†å¤–è§‚æŒ‡ç¤ºå™¨ */
        select[multiple].filter-select::after {
            content: "â–¼ å¤šé€‰";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 9px;
            color: #666;
            pointer-events: none;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* ç§»åŠ¨ç«¯å¤šé€‰ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
        @media (max-width: 768px) {
            select[multiple].filter-select {
                min-height: 28px;
                max-height: 70px;
                font-size: 10px;
                padding: 3px 5px !important;
            }

            select[multiple].filter-select option {
                padding: 2px 4px;
                font-size: 10px;
                line-height: 1.2;
            }

            select[multiple].filter-select::after {
                font-size: 8px;
                padding: 1px 3px;
                right: 6px;
            }
        }

        /* å°å±å¹•ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            select[multiple].filter-select {
                min-height: 26px;
                max-height: 60px;
                font-size: 9px;
                padding: 2px 4px !important;
            }

            select[multiple].filter-select option {
                padding: 1px 3px;
                font-size: 9px;
                line-height: 1.1;
            }

            select[multiple].filter-select::after {
                font-size: 7px;
                padding: 1px 2px;
                right: 4px;
            }
        }

        /* å¤šé€‰ä¸‹æ‹‰æ¡†çŠ¶æ€æç¤º */
        .filter-group:has(select[multiple]) .filter-label::after {
            content: " (å¯å¤šé€‰)";
            font-size: 8px;
            color: #999;
            font-weight: normal;
        }

        /* é€‰ä¸­çŠ¶æ€æ•°é‡æ˜¾ç¤º */
        .multi-select-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .filter-group {
            position: relative;
        }

        /* å½“æœ‰å¤šä¸ªé€‰ä¸­é¡¹æ—¶æ˜¾ç¤ºæ•°é‡æ ‡è¯† */
        .filter-group:has(select[multiple]) .multi-select-count.show {
            display: block;
        }

        /* ç‰¹æ®Šæ ·å¼ï¼šå…¨é€‰çŠ¶æ€ */
        select[multiple].filter-select.all-selected {
            border-color: #28a745;
            background: linear-gradient(to right, #f8fff9, white);
        }

        /* ç‰¹æ®Šæ ·å¼ï¼šéƒ¨åˆ†é€‰ä¸­çŠ¶æ€ */
        select[multiple].filter-select.partial-selected {
            border-color: #ffc107;
            background: linear-gradient(to right, #fffbf0, white);
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨æ ·å¼ */
        .custom-select {
            position: relative;
            display: inline-block;
            width: 100%;
            min-width: 80px;
            max-width: 150px;
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 8px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 28px;
            font-size: 11px;
            transition: all 0.2s ease;
            user-select: none;
        }

        .custom-select-trigger:hover {
            border-color: #c1c5c9;
        }

        .custom-select-trigger.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .custom-select-display {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .custom-select-arrow {
            margin-left: 5px;
            font-size: 10px;
            color: #666;
            transition: transform 0.2s ease;
        }

        .custom-select-trigger.active .custom-select-arrow {
            transform: rotate(180deg);
        }

        .custom-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .custom-select-dropdown.active {
            display: block;
        }

        .custom-select-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-select-option:hover {
            background-color: #f0f3ff;
        }

        .custom-select-option.selected {
            background-color: #667eea;
            color: white;
            font-weight: 500;
        }

        .custom-select-option.selected:hover {
            background-color: #5a6fd8;
        }

        .custom-select-checkbox {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* å•é€‰ç‰ˆæœ¬çš„è‡ªå®šä¹‰é€‰æ‹©å™¨ */
        .custom-single-select {
            position: relative;
            display: inline-block;
            width: 100%;
            min-width: 80px;
            max-width: 150px;
        }

        .custom-single-select .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 8px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 28px;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .custom-single-select .custom-select-trigger:hover {
            border-color: #c1c5c9;
        }

        .custom-single-select .custom-select-trigger.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .custom-single-select .custom-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .custom-single-select .custom-select-dropdown.active {
            display: block;
        }

        .custom-single-select .custom-select-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-single-select .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-single-select .custom-select-option:hover {
            background-color: #f0f3ff;
        }

        .custom-single-select .custom-select-option.selected {
            background-color: #667eea;
            color: white;
            font-weight: 500;
        }

        .custom-single-select .custom-select-option.selected:hover {
            background-color: #5a6fd8;
        }

        /* å¼¹æ¡†ä¸­çš„è‡ªå®šä¹‰é€‰æ‹©å™¨æ ·å¼ */
        .modal-body .custom-single-select {
            max-width: none;
            width: 100%;
        }

        .modal-body .custom-single-select .custom-select-trigger {
            min-height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid #e1e5e9;
        }

        .modal-body .custom-single-select .custom-select-option {
            padding: 8px 12px;
            font-size: 14px;
        }

        .modal-body .custom-single-select .custom-select-dropdown {
            max-height: 150px;
        }

        /* é€‰ä¸­çŠ¶æ€æ˜¾ç¤ºæ ‡ç­¾ */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 2px;
        }

        .selected-tag {
            background: #667eea;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            line-height: 1.2;
        }

        /* çŠ¶æ€ç‰¹æ®Šé¢œè‰² */
        .status-tag-all { background: #28a745; }
        .status-tag-active { background: #ffc107; color: #333; }
        .status-tag-completed { background: #28a745; }
        .status-tag-overdue { background: #dc3545; }

        .assignee-tag { background: #17a2b8; }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .custom-select-trigger,
            .custom-single-select .custom-select-trigger {
                padding: 4px 6px;
                min-height: 26px;
                font-size: 10px;
            }

            .custom-select-option,
            .custom-single-select .custom-select-option {
                padding: 5px 6px;
                font-size: 10px;
            }

            .custom-select-dropdown,
            .custom-single-select .custom-select-dropdown {
                max-height: 100px;
            }

            .selected-tag {
                font-size: 8px;
                padding: 1px 3px;
            }
        }

        @media (max-width: 480px) {
            .custom-select-trigger,
            .custom-single-select .custom-select-trigger {
                padding: 3px 5px;
                min-height: 24px;
                font-size: 9px;
            }

            .custom-select-option,
            .custom-single-select .custom-select-option {
                padding: 4px 5px;
                font-size: 9px;
            }

            .custom-select-dropdown,
            .custom-single-select .custom-select-dropdown {
                max-height: 80px;
            }

            .selected-tag {
                font-size: 7px;
                padding: 1px 2px;
            }
        }

        /* ç»Ÿè®¡ä¿¡æ¯è¡Œæ ·å¼ */
        .stats-row {
            display: flex;
            justify-content: space-around;
            padding: 6px 16px;
            background: white;
            flex-shrink: 0;
        }

        .stats-row .stat-item {
            text-align: center;
            flex: 1;
        }

        .stats-row .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .stats-row .stat-number:nth-child(1) {
            color: #2196F3;
        }

        .stats-row .stat-item:nth-child(2) .stat-number {
            color: #4CAF50;
        }

        .stats-row .stat-item:nth-child(3) .stat-number {
            color: #FF9800;
        }

        .stats-row .stat-label {
            font-size: 11px;
            color: #999;
            font-weight: 500;
        }

        /* æ·»åŠ ä»»åŠ¡æŒ‰é’®æ ·å¼ */
        .add-task-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .add-task-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
        }

        /* è¡¨å•è¡Œæ ·å¼ */
        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .daily-todo-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .daily-todo-btn:hover {
            background: #5a6fd8;
        }

        .clear-filters-btn {
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .clear-filters-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .clear-filters-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .clear-filters-btn:hover::before {
            left: 100%;
        }

        .clear-filters-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* å¤é€‰æ¡†ç»„æ ·å¼ */
        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .form-checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-checkbox-group span {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        /* æ‰¹é‡æ“ä½œæ ·å¼ */
        .batch-controls {
            margin: 0;
            padding: 3px 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            border-radius: 6px;
        }

        .batch-info {
            font-size: 12px;
            color: #667eea;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .batch-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .batch-btn {
            padding: 6px 8px;
            border: 1px solid;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 50px;
            min-height: 28px;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .batch-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .batch-btn:hover::before {
            left: 100%;
        }

        .select-all-btn {
            background: white;
            color: #4caf50;
            border-color: #4caf50;
        }

        .select-all-btn:hover {
            background: #4caf50;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .deselect-all-btn {
            background: white;
            color: #ff9800;
            border-color: #ff9800;
        }

        .deselect-all-btn:hover {
            background: #ff9800;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }

        .delete-selected-btn {
            background: white;
            color: #f44336;
            border-color: #f44336;
        }

        .delete-selected-btn:hover {
            background: #f44336;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .complete-selected-btn {
            background: white;
            color: #2196f3;
            border-color: #2196f3;
        }

        .complete-selected-btn:hover {
            background: #2196f3;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .cancel-batch-btn {
            background: white;
            color: #757575;
            border-color: #757575;
        }

        .cancel-batch-btn:hover {
            background: #757575;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(117, 117, 117, 0.3);
        }

        .toggle-select-btn {
            background: white;
            color: #4caf50;
            border-color: #4caf50;
        }

        .toggle-select-btn:hover {
            background: #4caf50;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .toggle-select-btn.all-selected {
            background: white;
            color: #ff9800;
            border-color: #ff9800;
        }

        .toggle-select-btn.all-selected:hover {
            background: #ff9800;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }

        /* æ‰¹é‡æ¨¡å¼æŒ‰é’®ç§»åŠ¨ç«¯ä¼˜åŒ– */
        /* ç§»åŠ¨ç«¯æ‰¹é‡æŒ‰é’®ä¼˜åŒ– */
        @media (max-width: 768px) {

            .batch-buttons {
                flex-direction: row;
                gap: 4px;
                width: 100%;
                flex-wrap: wrap;
            }

            .batch-btn {
                flex: 1;
                font-size: 8px;
                padding: 6px 4px;
                min-height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 65px;
                gap: 1px;
            }

            .batch-actions {
                display: flex;
                gap: 4px;
                flex-wrap: wrap;
                background: transparent;
                padding: 0;
                border: none;
                box-shadow: none;
            }

            .task-list {
                /*padding-bottom: 20px;*/
            }
        }

        @media (max-width: 480px) {
            .batch-btn {
                font-size: 7px;
                padding: 5px 3px;
                border-radius: 4px;
                min-width: 55px;
                gap: 1px;
            }

            .batch-actions {
                padding:3px;
            }
        }

        .batch-mode-btn {
            background: #9c27b0;
            color: white;
        }

        .batch-mode-btn:hover {
            background: #7b1fa2;
        }

        .batch-mode-btn.active {
            background: #d32f2f;
            border: 2px solid #b71c1c;
        }

        .batch-mode-btn.active:hover {
            background: #c62828;
        }

        /* æ‰¹é‡é€‰æ‹©å¤é€‰æ¡† */
        .batch-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #667eea;
            flex-shrink: 0;
        }

        /* æ‰¹é‡æ¨¡å¼ä¸‹çš„ä»»åŠ¡é¡¹æ ·å¼ */
        .batch-mode .task-item {
            padding-left: 12px;
        }

        /* Android è®¾å¤‡è§¦æ‘¸ä¼˜åŒ– */
        .action-btn {
            min-width: 44px;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Android 14 æ‰¹é‡æ“ä½œæŒ‰é’®ä¼˜åŒ– */
        .android-14-compat .batch-btn {
            min-width: 48px !important;
            font-size: 8px;
            padding: 6px 4px;
            min-height: 32px
        }

        .android-14-compat .image-upload-area {
            cursor: pointer !important;
            touch-action: manipulation !important;
        }

        .android-14-compat .delete-selected-btn {
            /*background: #f44336 !important;*/
            border: 2px solid #d32f2f !important;
        }

        .android-14-compat .delete-selected-btn:active {
            /*background: #c62828 !important;*/
            transform: scale(0.95);
        }

        /* Android 12+ çŠ¶æ€ç­›é€‰æŒ‰é’®ä¸“ç”¨ä¿®å¤ */
        .android-14-compat .status-filter-buttons {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 2px !important;
            width: 100% !important;
            box-sizing: border-box !important;
            justify-content: space-between !important;
            align-items: stretch !important;
        }

        .android-14-compat .status-filter-btn {
            flex: 1 !important;
            min-width: 0 !important;
            max-width: none !important;
            padding: 6px 2px !important;
            font-size: 10px !important;
            border-width: 1px !important;
            border-radius: 4px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            text-align: center !important;
            box-sizing: border-box !important;
            -webkit-box-sizing: border-box !important;
            -moz-box-sizing: border-box !important;
        }

        /* Android 12+ å¼ºåˆ¶å•è¡Œæ˜¾ç¤º */
        .android-14-compat .status-filter-btn:nth-child(1),
        .android-14-compat .status-filter-btn:nth-child(2),
        .android-14-compat .status-filter-btn:nth-child(3) {
            flex: 1 !important;
            min-width: 0 !important;
            max-width: calc(33.333% - 2px) !important;
        }

        /* æ‰€æœ‰Androidè®¾å¤‡çš„ä¿é™©æªæ–½ */
        .android-device .status-filter-buttons {
            display: flex !important;
            flex-wrap: nowrap !important;
            width: 100% !important;
        }

        .android-device .status-filter-btn {
            flex: 1 !important;
            min-width: 0 !important;
            white-space: nowrap !important;
            box-sizing: border-box !important;
        }

        /* æ‰€æœ‰Androidè®¾å¤‡é€‰æ‹©æ¡†åŸºç¡€ä¼˜åŒ– */
        .android-device select,
        .android-device .filter-select,
        .android-device .form-select {
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            appearance: menulist;
            background-image: none;
            min-height: 44px;
            font-size: 16px;
            padding-right: 24px;
        }

        /* ä»»åŠ¡å®Œæˆæ¨¡æ€æ¡†æ ·å¼ */
        .complete-task-info {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .task-title-display {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.4;
        }

        .completion-time {
            padding: 16px 20px;
            background: #e8f5e8;
            border-radius: 8px;
            color: #2e7d32;
            font-size: 14px;
            margin-top: 24px;
            border: 1px solid rgba(46, 125, 50, 0.1);
        }

        /* åŒå›¾ç‰‡ä¸Šä¼ å®¹å™¨ */
        .images-upload-container {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
        }

        /* å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ä¸­çš„å›¾ç‰‡ä¸Šä¼ å®¹å™¨ä¼˜åŒ– */
        .modal-body .images-upload-container {
            gap: 20px;
            margin-bottom: 16px;
        }

        /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .image-upload-area {
            flex: 1;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ä¸­çš„å›¾ç‰‡ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .modal-body .image-upload-area {
            padding: 20px;
            min-height: 120px;
            border-radius: 12px;
        }

        /* å·²ä¸Šä¼ å›¾ç‰‡åçš„ä¸Šä¼ åŒºåŸŸæ ·å¼ - é˜²æ­¢è¯¯è§¦ */
        .image-upload-area.has-image {
            cursor: default;
            pointer-events: none;
            border-color: #e0e0e0;
            background: #f5f5f5;
        }

        .image-upload-area:hover {
            /* background: #f0f3ff; */
        }

        /* ä»»åŠ¡å®Œæˆåæ–‡ä»¶é€‰æ‹©åŒºåŸŸç¼©å°é˜²è¯¯è§¦ */
        .image-upload-area.completed {
            min-height: 60px;
            padding: 8px;
            border-color: #ccc;
            background: #f8f8f8;
            transform: scale(0.85);
            opacity: 0.7;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .image-upload-area.completed .upload-icon {
            font-size: 20px;
            color: #999;
        }

        .image-upload-area.completed .upload-text {
            font-size: 12px;
            color: #999;
        }

        /* ç§»åŠ¨ç«¯åŒå›¾ç‰‡ä¸Šä¼ ä¼˜åŒ– */
        @media (max-width: 768px) {
            .images-upload-container {
                flex-direction: column;
                gap: 12px;
            }

            .image-upload-area {
                min-height: 90px;
                padding: 12px;
            }

            /* å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .modal-body .images-upload-container {
                gap: 16px;
            }

            .modal-body .image-upload-area {
                padding: 16px;
                min-height: 100px;
            }

            .image-upload-area.completed {
                min-height: 45px;
                padding: 6px;
                transform: scale(0.8);
            }

            .image-upload-area.has-image {
                min-height: 75px;
                padding: 8px;
            }
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .upload-icon {
            font-size: 32px;
            color: #666;
        }

        .upload-text {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .upload-placeholder small {
            color: #888;
            font-size: 11px;
        }

        /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥ç¼©å°ä¸Šä¼ åŒºåŸŸæ–‡å­— */
        @media (max-width: 768px) {
            .upload-text {
                font-size: 12px;
            }

            .upload-placeholder small {
                font-size: 10px;
            }

            .upload-icon {
                font-size: 24px;
            }
        }

        .image-preview {
            position: relative;
            display: inline-block;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff4757;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-image-btn:hover {
            background: #ff3838;
        }

        /* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†æ ·å¼ */
        .image-viewer {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
        }

        .image-view-container {
            text-align: center;
            padding: 20px;
        }

        .image-view-container img {
            max-width: 80vw;
            max-height: 60vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }



        .fab-action.syncing .fab-action-icon {
            opacity: 0.8;
        }

        /* é€šç”¨Loadingæ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 15000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            text-align: center;
            max-width: 280px;
            width: 90%;
            border: 1px solid #e3f2fd;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            position: relative;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid #e3f2fd;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: loadingSpin 1s linear infinite;
        }

        @keyframes loadingSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .loading-subtitle {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .image-info {
            padding: 16px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 16px;
        }

        .task-info {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .completion-info {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* å›¾ç‰‡å¯¼èˆªæ ·å¼ */
        .image-navigation {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            padding: 0 20px;
            transform: translateY(-50%);
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .image-navigation {
                padding: 0 15px;
            }
        }

        /* ä»»åŠ¡åˆ—è¡¨ä¸­çš„ç¼©ç•¥å›¾æ ·å¼ */
        .task-completion-media {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .completion-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .completion-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .completion-notes {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .completion-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* å·²å®Œæˆä»»åŠ¡çš„å®Œæˆä¿¡æ¯å±•ç¤º */
        .task-item.completed .task-completion-media {
            opacity: 0.8;
        }

        /* çŠ¶æ€ç­›é€‰æŒ‰é’®æ ·å¼ */
        .status-filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap; /* å¼ºåˆ¶å•è¡Œæ˜¾ç¤º */
            align-items: center;
            width: 100%;
        }

        .status-filter-btn {
            flex: 1;
            padding: 8px 6px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            min-width: 0;
            text-align: center;
            white-space: nowrap;
            box-sizing: border-box;
        }

        .status-filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f0f3ff;
        }

        .status-filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status-filter-btn.active:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
        }

        /* è®¾ç½®æ¨¡å—æŒ‰é’®æ ·å¼ */
        .settings-section .footer-btn {
            font-size: 12px;
            padding: 10px 14px;
            border-radius: 6px;
            font-weight: 500;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        /* æ¯æ—¥å¾…åŠè®¾ç½®æŒ‰é’® */
        .settings-section .daily-todo-btn:first-child {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* å¾®ä¿¡é€šçŸ¥è®¾ç½®æŒ‰é’® */
        .settings-section .daily-todo-btn:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        /* æ•°æ®åº“è®¾ç½®æŒ‰é’® */
        .settings-section .daily-todo-btn:last-child {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        /* è®¾ç½®æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .settings-section .daily-todo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .settings-section .daily-todo-btn:first-child:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .settings-section .daily-todo-btn:nth-child(2):hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        .settings-section .daily-todo-btn:last-child:hover {
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        /* è®¾ç½®æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        .settings-section .daily-todo-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* è®¾ç½®æŒ‰é’®å…‰æ³½æ•ˆæœ */
        .settings-section .daily-todo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .settings-section .daily-todo-btn:hover::before {
            left: 100%;
        }

        /* è®¾ç½®æŒ‰é’®å›¾æ ‡åŠ¨ç”» */
        .settings-section .daily-todo-btn {
            text-decoration: none;
        }

        .settings-section .daily-todo-btn:hover {
            animation: settingButtonPulse 2s infinite;
        }

        @keyframes settingButtonPulse {
            0% { transform: translateY(-2px) scale(1); }
            50% { transform: translateY(-2px) scale(1.02); }
            100% { transform: translateY(-2px) scale(1); }
        }

        /* è®¾ç½®åŒºåŸŸå¤´éƒ¨æ ·å¼ */
        .settings-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px 0;
        }

        .settings-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .settings-icon {
            font-size: 24px;
            animation: settingsIconRotate 3s ease-in-out infinite;
        }

        .settings-text {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-subtitle {
            font-size: 12px;
            color: #6c757d;
            font-weight: 400;
        }

        @keyframes settingsIconRotate {
            0%, 90%, 100% { transform: rotate(0deg); }
            95% { transform: rotate(360deg); }
        }

        /* è®¾ç½®ç½‘æ ¼å¸ƒå±€ */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        /* è®¾ç½®å¡ç‰‡æ ·å¼ */
        .setting-card {
            display: flex !important;
            align-items: center;
            justify-content: flex-start !important;
            text-align: left;
            padding: 16px 20px !important;
            min-height: 80px !important;
            width: 100% !important;
            gap: 14px !important;
            box-sizing: border-box;
            white-space: normal; /* å…è®¸æ¢è¡Œ */
            overflow: visible; /* å…è®¸å†…å®¹æ˜¾ç¤º */
        }

        .setting-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .setting-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0; /* å…è®¸æ”¶ç¼© */
        }

        .setting-title {
            font-size: 14px;
            font-weight: 600;
            color: inherit;
            line-height: 1.4;
            margin: 0;
            word-wrap: break-word;
            word-break: keep-all;
        }

        .setting-desc {
            font-size: 11px;
            opacity: 0.9;
            color: inherit;
            line-height: 1.4;
            margin: 0;
            word-wrap: break-word;
            word-break: keep-all;
        }

        /* ä¸­ç­‰å±å¹•é€‚é… (481px-768px) */
        @media (max-width: 768px) and (min-width: 481px) {
            .footer-actions {
                gap: 8px;
            }

            .footer-actions .footer-btn {
                flex: 1 1 calc(33.333% - 6px);
                min-width: calc(33.333% - 6px);
                padding: 10px 6px;
                font-size: 13px;
            }

            .footer-actions .footer-btn:nth-child(n+7) {
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
            }
        }

        /* å¤§å±ç§»åŠ¨ç«¯ä¼˜åŒ– (414px+ å®½åº¦ - iPhone Plus/Maxç³»åˆ—) */
        @media (max-width: 768px) and (min-width: 415px) {
            .status-filter-buttons {
                display: flex;
                gap: 10px;
                flex-wrap: nowrap;
                justify-content: center;
            }

            .status-filter-btn {
                flex: 0 0 auto;
                padding: 12px 20px;
                font-size: 14px;
                min-width: 80px;
                border-radius: 8px;
            }
        }

        /* 375pxç²¾ç¡®ä¼˜åŒ– (iPhone 6/7/8æ ‡å‡†å°ºå¯¸) */
        @media (max-width: 375px) and (min-width: 360px) {
            .status-filter-buttons {
                gap: 3px;
            }

            .status-filter-btn {
                padding: 7px 3px;
                font-size: 11px;
                border-width: 1px;
                border-radius: 5px;
            }
        }

        /* ä¸­ç­‰ç§»åŠ¨ç«¯å±å¹•ä¼˜åŒ– (376px-414pxå®½åº¦) */
        @media (max-width: 414px) and (min-width: 376px) {
            .status-filter-btn {
                padding: 9px 6px;
                font-size: 12px;
            }
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ - å®Œå…¨æ— é—´éš™ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* æŠ˜å å†…å®¹åŒºåŸŸ */
            .collapsible-content {
                transition: max-height 0.4s ease, padding 0.4s ease;
                margin: 0 !important;
                border: none !important;
            }

            .collapsible-content:not(.collapsed) {
                max-height: 1500px !important;
                overflow: visible;
                padding: 20px;
                margin: 0 !important;
            }

            .collapsible-content.collapsed {
                max-height: 0 !important;
                overflow: hidden;
                padding: 0 20px;
                margin: 0 !important;
            }

            /* æ‰€æœ‰æ¨¡å—ç»Ÿä¸€ç§»åŠ¨ç«¯æ ·å¼ */
            .filter-section,
            .function-section,
            .settings-section {
                margin: 0 !important;
                padding: 0 !important;
                border-radius: 0 !important;
                border-left: none !important;
                border-right: none !important;
                border-top: none !important;
                display: block;
            }

            /* æ¨¡å—headeråœ¨ç§»åŠ¨ç«¯çš„ç»Ÿä¸€æ ·å¼ */
            .section-header {
                padding: 14px 16px;
                margin: 0;
                border-radius: 0;
            }
        }

            .settings-header {
                padding: 12px 0;
                margin-bottom: 16px;
            }

            .settings-title .settings-text {
                font-size: 16px;
            }

            .settings-subtitle {
                font-size: 11px;
            }

            .settings-grid {
                gap: 10px;
                grid-template-columns: 1fr !important;
            }

            .setting-card {
                padding: 16px 12px !important;
                min-height: 72px !important;
                gap: 10px !important;
                flex-direction: row !important;
                align-items: flex-start !important;
            }

            .setting-icon {
                width: 36px;
                height: 36px;
                font-size: 20px;
                flex-shrink: 0;
                margin-top: 2px;
            }

            .setting-content {
                flex: 1;
                min-width: 0;
            }

            .setting-title {
                font-size: 14px !important;
                line-height: 1.3 !important;
                font-weight: 600 !important;
                margin-bottom: 4px;
                word-break: break-word;
            }

            .setting-desc {
                font-size: 11px !important;
                line-height: 1.4 !important;
                opacity: 0.9;
                word-break: break-word;
            }

            /* ç§»åŠ¨ç«¯è§¦æ‘¸ä½“éªŒä¼˜åŒ– */
            .settings-section .daily-todo-btn {
                min-height: 56px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .settings-section .daily-todo-btn:hover {
                animation: none; /* ç§»åŠ¨ç«¯ä¸éœ€è¦è„‰å†²åŠ¨ç”» */
            }

            .settings-section .daily-todo-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }

        /* å¹³æ¿ç«¯é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .settings-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 16px;
            }

            .setting-card {
                flex-direction: column;
                text-align: center !important;
                padding: 20px !important;
                min-height: 100px !important;
                gap: 12px !important;
            }

            .setting-icon {
                margin-bottom: 4px;
            }
        }

        /* å¤§å±å¹•é€‚é… */
        @media (min-width: 1025px) {
            .settings-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }

            .setting-card {
                min-height: 80px !important;
            }
        }

        /* ç­›é€‰æ¨¡å—çŠ¶æ€æŒ‰é’®é—´è·è°ƒæ•´ */
        .filter-group .status-filter-buttons {
            margin-top: 8px;
        }

        /* æ¨¡å—é—´å®Œå…¨æ— ç¼è¿æ¥ - æ–°çš„ç»Ÿä¸€æ ·å¼ */
        .filter-section,
        .function-section,
        .settings-section {
            /* æ‰€æœ‰æ¨¡å—ç»Ÿä¸€ï¼šæ— è¾¹è·ã€æ— é¢å¤–è¾¹æ¡† */
            border-top: none;
            border-left: none;
            border-right: none;
            margin: 0;
            padding: 0;
        }

        /* æ¯ä¸ªæ¨¡å—ä¹‹é—´çš„åˆ†éš”é€šè¿‡åº•éƒ¨è¾¹æ¡†å®ç° */
        .filter-section {
            border-bottom: 1px solid #e9ecef;
        }

        .function-section {
            border-bottom: 1px solid #e9ecef;
        }

        .settings-section {
            border-bottom: 1px solid #e9ecef;
        }

        .settings-description {
            padding: 0 0 12px 0;
            color: #6c757d;
            font-size: 12px;
            text-align: center;
            font-style: italic;
        }

        .settings-description p {
            margin: 0;
        }

        .batch-mode .task-item.selected {
            background-color: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
        }

        /* æ‰¹é‡æ¨¡å¼ä¸‹å®Œæˆä»»åŠ¡æŒ‰é’®çš„æ ·å¼è°ƒæ•´ */
        .batch-mode .task-complete-btn {
            margin-left: 8px;
            opacity: 0.8;
        }

        .batch-mode .task-complete-btn:hover {
            opacity: 1;
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        .hidden {
            display: none;
        }

        /* è¶…å°å±å¹•é€‚é… (360pxä»¥ä¸‹) - å®Œå…¨æ— é—´éš™ */
        @media (max-width: 360px) {
            .footer-actions .footer-btn {
                flex: 1 1 100% !important;
                min-width: 100% !important;
                margin-bottom: 6px;
            }

            .footer-actions {
                flex-direction: column;
                gap: 6px;
            }

            .collapsible-content:not(.collapsed) {
                max-height: 2000px !important;
                overflow: visible;
                padding: 15px !important;
                margin: 0 !important;
                border: none !important;
            }

            .collapsible-content.collapsed {
                max-height: 0 !important;
                overflow: hidden;
                padding: 0 15px !important;
                margin: 0 !important;
                border: none !important;
            }

            /* è¶…å°å±å¹•æ‰€æœ‰æ¨¡å—æ ·å¼å¼ºåˆ¶ç»Ÿä¸€ */
            .filter-section,
            .function-section,
            .settings-section {
                margin: 0 !important;
                padding: 0 !important;
                border-radius: 0 !important;
                border-left: none !important;
                border-right: none !important;
                border-top: none !important;
                /* åªä¿ç•™åº•éƒ¨åˆ†éš”çº¿ */
                border-bottom: 1px solid #e9ecef !important;
            }

            .section-header {
                padding: 12px 15px;
                margin: 0;
                border-radius: 0;
            }

            /* è¶…å°å±å¹•çŠ¶æ€ç­›é€‰ä¼˜åŒ– */
            .status-filter-buttons {
                display: flex;
                gap: 4px;
                flex-direction: column;
                width: 100%;
            }

            .status-filter-btn {
                flex: none;
                width: 100%;
                padding: 12px 8px;
                font-size: 14px;
                margin-bottom: 4px;
                border-radius: 6px;
                text-align: center;
            }

            .status-filter-btn:last-child {
                margin-bottom: 0;
            }
        }

            .section-title {
                font-size: 14px;
            }

            .settings-header {
                padding: 10px 0;
            }

            .settings-title .settings-text {
                font-size: 14px;
            }

            .settings-subtitle {
                font-size: 11px;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .task-options {
                flex-wrap: wrap;
            }

            .footer-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .footer-actions .footer-btn {
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
                padding: 10px 8px;
                font-size: 13px;
                min-height: 44px;
            }

            .footer-actions .footer-btn:nth-child(n+5) {
                flex: 1 1 calc(100% - 0px);
                min-width: calc(100% - 0px);
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .filter-group {
                min-width: auto;
                width: 100%;
            }

            .filter-select {
                margin-bottom: 4px;
                width: 100%;
                font-size: 16px;
                min-height: 44px;
                padding: 12px 16px;
                border-radius: 8px;
                background: white;
                border: 2px solid #e1e5e9;
                /* ä¿æŒåŸç”Ÿappearanceä»¥ç¡®ä¿ä¸‹æ‹‰åˆ—è¡¨æ­£å¸¸å·¥ä½œ */
            }

            .filter-select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                outline: none;
            }

            /* iOSç‰¹æ®Šä¼˜åŒ– */
            @supports (-webkit-touch-callout: none) {
                .filter-select {
                    -webkit-appearance: menulist;
                    -webkit-border-radius: 8px;
                }
            }

            /* Android 12+ è®¾å¤‡ç­›é€‰æ¡†ä¼˜åŒ– - å¼ºåˆ¶ä¸‹æ‹‰åˆ—è¡¨ */
            .android-14-compat .filter-select {
                background: white;
                border: 2px solid #667eea;
                border-radius: 6px;
                -webkit-appearance: menulist !important;
                -moz-appearance: menulist !important;
                appearance: menulist !important;
                background-image: none !important;
                padding: 5px 8px !important;
                padding-right: 25px !important;
                min-height: 32px !important;
                font-size: 11px !important;
                /* Android WebViewå¼ºåˆ¶ä¿®å¤ */
                -webkit-user-select: auto !important;
                user-select: auto !important;
                /* å°è¯•å¤šç§appearanceå€¼ */
                -webkit-appearance: listbox !important;
                -moz-appearance: listbox !important;
                appearance: listbox !important;
            }

            /* Android 14 è‡ªå®šä¹‰é€‰æ‹©å™¨ç»Ÿä¸€æ ·å¼ */
            .android-14-compat .custom-select-trigger {
                padding: 5px 8px !important;
                min-height: 32px !important;
                font-size: 11px !important;
                border: 2px solid #667eea !important;
                border-radius: 6px !important;
                background: white !important;
            }

            .android-14-compat .custom-select-option {
                padding: 6px 8px !important;
                font-size: 11px !important;
            }

            .android-14-compat .custom-select-display {
                font-size: 11px !important;
            }

            .android-14-compat .custom-select-arrow {
                font-size: 10px !important;
            }

            /* Android 14 æŒ‡å®šæ—¥æœŸé€‰æ‹©æ¡†ç‰¹æ®Šæ ·å¼ */
            .android-14-compat .custom-single-select.custom-date-picker {
                min-width: 110px !important;
                width: 110px !important;
                max-width: 120px !important; /* ç¼©å°Android 14æ—¥æœŸæ¡†æœ€å¤§å®½åº¦ */
                margin-right: 22px !important; /* å¢åŠ Android 14æ—¥æœŸæ¡†å³è¾¹è· */
            }

            /* Android 14 ä¼˜å…ˆçº§ç­›é€‰æ¡†ç‰¹æ®Šæ ·å¼ */
            .android-14-compat #priorityFilterContainer.custom-single-select {
                max-width: 75px !important; /* Android 14ä¼˜å…ˆçº§æ¡†ç¼©å°å®½åº¦ */
                min-width: 75px !important;
                width: 75px !important;
            }

            /* Android 14 ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
            @media (max-width: 768px) {
                .android-14-compat .filter-select {
                    min-height: 28px !important;
                    font-size: 10px !important;
                    padding: 4px 6px !important;
                    padding-right: 22px !important;
                }

                .android-14-compat .custom-select-trigger {
                    min-height: 28px !important;
                    font-size: 10px !important;
                    padding: 4px 6px !important;
                }

                .android-14-compat .custom-select-option {
                    padding: 5px 6px !important;
                    font-size: 10px !important;
                }

                .android-14-compat .custom-select-display {
                    font-size: 10px !important;
                }

                .android-14-compat .custom-select-arrow {
                    font-size: 9px !important;
                }
            }

            @media (max-width: 480px) {
                .android-14-compat .filter-select {
                    min-height: 26px !important;
                    font-size: 9px !important;
                    padding: 3px 5px !important;
                    padding-right: 20px !important;
                }

                .android-14-compat .custom-select-trigger {
                    min-height: 26px !important;
                    font-size: 9px !important;
                    padding: 3px 5px !important;
                }

                .android-14-compat .custom-select-option {
                    padding: 4px 5px !important;
                    font-size: 9px !important;
                }

                .android-14-compat .custom-select-display {
                    font-size: 9px !important;
                }

                .android-14-compat .custom-select-arrow {
                    font-size: 8px !important;
                }
            }

            .filter-buttons {
                flex-direction: column;
                width: 100%;
            }

            .daily-todo-btn {
                width: 100%;
                margin-bottom: 8px;
            }

            .clear-filters-btn {
                width: 36px;
                height: 36px;
                margin-bottom: 8px;
            }
        }

        /* åº•éƒ¨å¯¼èˆªæ æ ·å¼ - ç°ä»£åŒ–æ¯›ç»ç’ƒè®¾è®¡ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 11000;
            box-shadow:
                0 -8px 32px rgba(0, 0, 0, 0.12),
                0 -2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            height: 78px;
            padding: 8px 0 12px 0;
            margin: 0 8px 8px 8px;
            border-radius: 24px 24px 0 0;
            overflow: visible;
        }

        /* ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ æ¸å˜è¾¹æ¡†æ•ˆæœ */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, #764ba2, transparent);
            opacity: 0.6;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 6px 4px 6px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: #999;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            margin: 0 6px;
            min-height: 54px;
            justify-content: flex-end;
        }

        /* æ·»åŠ æŒ‰é’®æŒ‰ä¸‹æ³¢çº¹æ•ˆæœ */
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .nav-btn:active::before {
            width: 100px;
            height: 100px;
        }

        .nav-btn.active {
            color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15));
            transform: translateY(-3px);
            box-shadow:
                0 12px 32px rgba(102, 126, 234, 0.3),
                0 6px 16px rgba(102, 126, 234, 0.2),
                0 2px 8px rgba(102, 126, 234, 0.15),
                inset 0 2px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(102, 126, 234, 0.2);
            border: 2px solid rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2;
        }

        /* æ¿€æ´»çŠ¶æ€çš„å‘å…‰ç¯æ•ˆæœ */
        .nav-btn.active::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea, #764ba2);
            border-radius: inherit;
            z-index: -2;
            opacity: 0.6;
            animation: activeGlow 3s ease-in-out infinite;
        }

        @keyframes activeGlow {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        /* åº•éƒ¨æŒ‡ç¤ºå™¨ */
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px 2px 0 0;
            box-shadow:
                0 0 12px rgba(102, 126, 234, 0.7),
                0 -2px 8px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.active .nav-icon {
            transform: scale(1.2) translateY(-1px);
            filter: drop-shadow(0 3px 6px rgba(102, 126, 234, 0.4));
            animation: iconBounce 0.6s ease-out;
        }

        @keyframes iconBounce {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.3) translateY(-3px); }
            100% { transform: scale(1.2) translateY(-1px); }
        }

        .nav-btn.active .nav-label {
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .nav-btn:hover:not(.active) {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.12), rgba(118, 75, 162, 0.08));
            transform: translateY(-2px);
            color: #667eea;
            box-shadow:
                0 8px 20px rgba(102, 126, 234, 0.15),
                0 4px 10px rgba(102, 126, 234, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.15);
        }

        .nav-btn:hover:not(.active) .nav-icon {
            transform: scale(1.1) translateY(-1px);
            filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3));
            animation: hoverBounce 0.4s ease-out;
        }

        @keyframes hoverBounce {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.15) translateY(-2px); }
            100% { transform: scale(1.1) translateY(-1px); }
        }

        .nav-btn:hover:not(.active) .nav-label {
            color: #667eea;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(102, 126, 234, 0.2);
        }

        /* æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”» */
        .nav-btn:active:not(.active) {
            transform: translateY(0px) scale(0.98);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.12));
            box-shadow:
                0 4px 12px rgba(102, 126, 234, 0.2),
                inset 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
            position: relative;
            z-index: 3;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            z-index: 3;
        }

        /* ä¸­é—´æ‚¬æµ®çƒæŒ‰é’®æ ·å¼ - ç°ä»£ç£æ‚¬æµ®è®¾è®¡ */
        .nav-add-btn {
            width: 68px;
            height: 68px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transform: translateY(-10px);
            box-shadow:
                0 16px 48px rgba(102, 126, 234, 0.5),
                0 8px 24px rgba(102, 126, 234, 0.4),
                0 4px 12px rgba(102, 126, 234, 0.3),
                0 0 0 5px rgba(255, 255, 255, 0.9),
                0 0 0 8px rgba(102, 126, 234, 0.1),
                inset 0 3px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 3;
            overflow: hidden;
            animation: addBtnFloat 4s ease-in-out infinite;
        }

        @keyframes addBtnFloat {
            0%, 100% {
                transform: translateY(-10px);
            }
            50% {
                transform: translateY(-12px);
            }
        }

        /* å¤šå±‚å‘å…‰ç¯æ•ˆæœ */
        .nav-add-btn::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #667eea);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: all 0.4s ease;
            animation: rotateGlow 6s linear infinite;
        }

        .nav-add-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(102, 126, 234, 0.2) 40%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        @keyframes rotateGlow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .nav-add-btn:hover {
            transform: translateY(-16px) scale(1.12);
            animation: addBtnHover 0.8s ease-out;
            box-shadow:
                0 24px 64px rgba(102, 126, 234, 0.6),
                0 12px 32px rgba(102, 126, 234, 0.5),
                0 6px 16px rgba(102, 126, 234, 0.4),
                0 0 0 6px rgba(255, 255, 255, 0.95),
                0 0 0 10px rgba(102, 126, 234, 0.15),
                0 0 0 14px rgba(240, 147, 251, 0.1),
                inset 0 4px 0 rgba(255, 255, 255, 0.5);
        }

        @keyframes addBtnHover {
            0% { transform: translateY(-10px) scale(1); }
            30% { transform: translateY(-18px) scale(1.15); }
            100% { transform: translateY(-16px) scale(1.12); }
        }

        .nav-add-btn:hover::before {
            opacity: 0.9;
            transform: scale(1.1);
        }

        .nav-add-btn:hover::after {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .nav-add-btn:active {
            transform: translateY(-6px) scale(0.92);
            animation: addBtnClick 0.15s ease-out;
            box-shadow:
                0 12px 32px rgba(102, 126, 234, 0.5),
                0 6px 16px rgba(102, 126, 234, 0.4),
                0 0 0 4px rgba(255, 255, 255, 0.8),
                inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @keyframes addBtnClick {
            0% { transform: translateY(-16px) scale(1.12); }
            100% { transform: translateY(-6px) scale(0.92); }
        }

        .nav-add-icon {
            font-size: 30px;
            color: white;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .nav-add-btn:hover .nav-add-icon {
            transform: rotate(135deg) scale(1.15);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            animation: iconSpin 0.6s ease-out;
        }

        @keyframes iconSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(135deg) scale(1.15); }
        }

        .nav-add-btn:active .nav-add-icon {
            transform: rotate(90deg) scale(0.85);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        /* åº•éƒ¨å¯¼èˆªæ å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .bottom-nav {
                height: 76px;
                padding: 6px 0 10px 0;
                margin: 0 4px 4px 4px;
                border-radius: 20px 20px 0 0;
            }

            .nav-btn {
                padding: 6px 4px 2px 4px;
                margin: 0 3px;
                min-height: 52px;
            }

            .nav-btn.active {
                transform: translateY(-2px);
                box-shadow:
                    0 8px 20px rgba(102, 126, 234, 0.25),
                    0 4px 10px rgba(102, 126, 234, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            .nav-btn.active::after {
                width: 28px;
                height: 3px;
            }

            .nav-btn:hover:not(.active) {
                transform: translateY(-1px);
                box-shadow:
                    0 6px 16px rgba(102, 126, 234, 0.12),
                    0 3px 8px rgba(102, 126, 234, 0.08);
            }

            .nav-icon {
                font-size: 20px;
                margin-bottom: 3px;
            }

            .nav-label {
                font-size: 10px;
                letter-spacing: 0.3px;
            }

            .nav-add-btn {
                width: 60px;
                height: 60px;
                transform: translateY(-8px);
                animation: addBtnFloat 4s ease-in-out infinite;
            }

            @keyframes addBtnFloat {
                0%, 100% {
                    transform: translateY(-8px);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            .nav-add-btn:hover {
                transform: translateY(-12px) scale(1.08);
                box-shadow:
                    0 20px 48px rgba(102, 126, 234, 0.5),
                    0 10px 24px rgba(102, 126, 234, 0.4),
                    0 0 0 5px rgba(255, 255, 255, 0.9),
                    0 0 0 8px rgba(102, 126, 234, 0.12);
            }

            .nav-add-icon {
                font-size: 26px;
            }
        }

        @media (max-width: 480px) {
            .bottom-nav {
                height: 72px;
                padding: 4px 0 8px 0;
                margin: 0 2px 2px 2px;
                border-radius: 16px 16px 0 0;
            }

            .nav-btn {
                padding: 4px 2px 0px 2px;
                margin: 0 2px;
                min-height: 50px;
            }

            .nav-btn.active {
                transform: translateY(-1px);
                box-shadow:
                    0 6px 16px rgba(102, 126, 234, 0.2),
                    0 3px 8px rgba(102, 126, 234, 0.12),
                    inset 0 1px 0 rgba(255, 255, 255, 0.25);
            }

            .nav-btn.active::after {
                width: 24px;
                height: 2px;
            }

            .nav-btn:hover:not(.active) {
                transform: translateY(-0.5px);
                box-shadow:
                    0 4px 12px rgba(102, 126, 234, 0.1),
                    0 2px 6px rgba(102, 126, 234, 0.06);
            }

            /* å‡å°‘å°å±å¹•åŠ¨ç”»å¼ºåº¦ */
            .nav-btn.active .nav-icon {
                animation: none;
                transform: scale(1.1) translateY(-0.5px);
            }

            .nav-btn:hover:not(.active) .nav-icon {
                animation: none;
                transform: scale(1.05) translateY(-0.5px);
            }

            .nav-icon {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .nav-label {
                font-size: 9px;
                letter-spacing: 0.2px;
            }

            .nav-add-btn {
                width: 56px;
                height: 56px;
                transform: translateY(-6px);
                animation: addBtnFloatSmall 5s ease-in-out infinite;
            }

            @keyframes addBtnFloatSmall {
                0%, 100% {
                    transform: translateY(-6px);
                }
                50% {
                    transform: translateY(-8px);
                }
            }

            .nav-add-btn:hover {
                transform: translateY(-10px) scale(1.05);
                box-shadow:
                    0 16px 32px rgba(102, 126, 234, 0.4),
                    0 8px 16px rgba(102, 126, 234, 0.3),
                    0 0 0 4px rgba(255, 255, 255, 0.85),
                    0 0 0 6px rgba(102, 126, 234, 0.1);
            }

            .nav-add-btn:hover .nav-add-icon {
                animation: none;
                transform: rotate(90deg) scale(1.05);
            }

            .nav-add-icon {
                font-size: 24px;
            }
        }

        /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .multi-select-container {
            position: relative;
            width: 100%;
        }

        .multi-select-display {
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
            transition: all 0.2s ease;
        }

        .multi-select-display:hover {
            border-color: #667eea;
        }

        .multi-select-display.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .multi-select-display .placeholder {
            color: #999;
            flex: 1;
        }

        .multi-select-display .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
        }

        .selected-item {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .selected-item .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .dropdown-arrow {
            color: #999;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .multi-select-display.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 16000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-dropdown.active {
            display: block;
        }

        .assignee-search {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            font-size: 14px;
        }

        .assignee-options {
            max-height: 150px;
            overflow-y: auto;
        }

        .assignee-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .assignee-option:hover {
            background: #f8f9ff;
        }

        .assignee-option.selected {
            background: #667eea;
            color: white;
        }

        .assignee-option input[type="checkbox"] {
            margin: 0;
        }

        /* æ²¡æœ‰ç»“æœæç¤º */
        .no-results {
            padding: 12px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }

        /* è§†å›¾å®¹å™¨æ ·å¼ */
        .view-container {
            padding-bottom: 90px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºè¶³å¤Ÿç©ºé—´ */
            min-height: calc(100vh - 75px); /* è€ƒè™‘åº•éƒ¨å¯¼èˆªæ é«˜åº¦ */
            box-sizing: border-box;
        }

        /* å“åº”å¼è°ƒæ•´è§†å›¾å®¹å™¨åº•éƒ¨é—´è· */
        @media (max-width: 768px) {
            .view-container {
                padding-bottom: 85px; /* å¹³æ¿ç«¯è°ƒæ•´ */
                min-height: calc(100vh - 70px);
            }
        }

        @media (max-width: 480px) {
            .view-container {
                padding-bottom: 80px; /* æ‰‹æœºç«¯è°ƒæ•´ */
                min-height: calc(100vh - 65px);
            }
        }


        body {
            margin: 0;
            padding: 0;
        }

        /* ä»»åŠ¡ç•Œé¢æ ·å¼ */
        #taskView {
            width: 100%;
            position: relative;
            z-index: 1;
        }



        /* æ‚¬æµ®æ“ä½œçƒæ ·å¼ */
        .fab-container {
            position: fixed;
            bottom: 80px; /* åœ¨åº•éƒ¨å¯¼èˆªæ ä¸Šæ–¹ */
            right: 20px;
            z-index: 999;
        }

        .fab-main {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            user-select: none;
        }

        .fab-main:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .fab-main:active {
            transform: scale(0.95);
        }

        .fab-icon {
            font-size: 24px;
            color: white;
            transition: transform 0.3s ease;
        }

        .fab-main.active .fab-icon {
            transform: rotate(135deg);
        }

        .fab-menu {
            position: absolute;
            bottom: 65px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .fab-menu.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .fab-action {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: relative;
            transform: scale(0);
            animation: fabActionIn 0.3s ease forwards;
        }

        .fab-action:nth-child(1) { animation-delay: 0.1s; }
        .fab-action:nth-child(2) { animation-delay: 0.15s; }
        .fab-action:nth-child(3) { animation-delay: 0.2s; }
        .fab-action:nth-child(4) { animation-delay: 0.25s; }
        .fab-action:nth-child(5) { animation-delay: 0.3s; }
        .fab-action:nth-child(6) { animation-delay: 0.35s; }

        @keyframes fabActionIn {
            to {
                transform: scale(1);
            }
        }

        .fab-action:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .fab-action:active {
            transform: scale(0.95);
        }

        .fab-action-icon {
            font-size: 20px;
        }

        .fab-action::before {
            content: attr(data-tooltip);
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .fab-action:hover::before {
            opacity: 1;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .fab-container {
                bottom: 70px;
                right: 16px;
            }

            .fab-main {
                width: 50px;
                height: 50px;
            }

            .fab-icon {
                font-size: 20px;
            }

            .fab-action {
                width: 44px;
                height: 44px;
            }

            .fab-action-icon {
                font-size: 18px;
            }

            .fab-action::before {
                right: 50px;
                font-size: 11px;
                padding: 4px 8px;
            }
        }

        /* åˆ·æ–°æ‚¬æµ®æŒ‰é’®æ ·å¼ */
        .refresh-fab {
            position: fixed;
            right: 20px;
            bottom: 80px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            outline: none;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .refresh-fab::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .refresh-fab:hover::before {
            opacity: 0.5;
            animation: pulse-ring 1.5s ease-out infinite;
        }

        .refresh-fab:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
        }

        .refresh-fab.dragging {
            cursor: grabbing;
            transform: scale(1.15);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.7);
            transition: none;
        }

        .refresh-fab.refreshing {
            pointer-events: none;
        }

        .refresh-fab .refresh-icon {
            font-size: 26px;
            transition: transform 0.6s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .refresh-fab.refreshing .refresh-icon {
            animation: rotate-refresh 0.6s ease-in-out;
        }

        @keyframes rotate-refresh {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.3;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .refresh-fab {
                right: 16px;
                bottom: 70px;
                width: 52px;
                height: 52px;
            }

            .refresh-fab .refresh-icon {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div>
        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div class="bottom-nav">
            <button class="nav-btn active" id="taskViewBtn" onclick="switchToTaskView()">
            <span class="nav-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                    <path d="m9 14 2 2 4-4"/>
                </svg>
            </span>
                <span class="nav-label">ä»»åŠ¡</span>
            </button>
            <!-- ä¸­é—´æ‚¬æµ®çƒæŒ‰é’® -->
            <button class="nav-add-btn" onclick="showAddTaskModal()">
            <span class="nav-add-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="m12 8v8"/>
                    <path d="m8 12h8"/>
                </svg>
            </span>
            </button>
            <button class="nav-btn" id="settingsViewBtn" onclick="switchToSettingsView()">
            <span class="nav-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="m12 1v6m0 6v6"/>
                    <path d="m12.71 2.29 4.25 4.25m-8.48 8.48 4.25 4.25"/>
                    <path d="m2.29 12.71 4.25-4.25m8.48-8.48 4.25 4.25"/>
                </svg>
            </span>
                <span class="nav-label">è®¾ç½®</span>
            </button>
        </div>

        <!-- ä»»åŠ¡ç•Œé¢ -->
        <div class="view-container" id="taskView">
            <div class="container">
                <!-- å¤´éƒ¨ -->
                <div class="header">
                    <h1>ğŸ“… æ¯æ—¥å¾…åŠ</h1>
<!--                    <div class="progress-info" id="progressInfo">0/0 å®Œæˆ</div>-->
<!--                    <div class="progress-bar">-->
<!--                        <div class="progress-fill" id="progressFill"></div>-->
<!--                    </div>-->

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTasks">0</div>
                            <div class="stat-label">å½“å‰åˆ—è¡¨</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="completedTasks">0</div>
                            <div class="stat-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="completionRate">0%</div>
                            <div class="stat-label">å®Œæˆç‡</div>
                        </div>
                    </div>
                </div>

                <!-- ç­›é€‰å™¨ -->
                <div class="filter-section">
                    <!-- é¡¶éƒ¨æœç´¢æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
                    <div class="filter-header">
                        <div class="search-box">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" id="keywordSearch" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜æˆ–å¤‡æ³¨..." oninput="if (!window.isInitializing) applyFilters()">
                        </div>
                        <button class="filter-toggle-btn active" onclick="toggleFilterPanel()" id="filterToggleBtn" title="ç­›é€‰">
                            <span class="filter-icon">â–¼</span>
                        </button>
                    </div>

                    <!-- ç­›é€‰é¢æ¿ï¼ˆå¯æŠ˜å ï¼Œé»˜è®¤æ”¶èµ·ï¼‰ -->
                    <div class="filter-panel collapsed" id="filterPanel">
                        <div class="filter-content" id="filterContent">

                        <!-- ç¬¬ä¸€è¡Œï¼šæ—¥æœŸã€çŠ¶æ€ã€åˆ†ç±» -->
                        <div class="filter-row collapsible-row filter-row-compact" id="dateRow">
                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">ğŸ“… æ—¥æœŸ</label>
                                <div class="custom-single-select custom-select-compact" id="dateFilterContainer">
                                    <div class="custom-select-trigger" data-select-id="dateFilter">
                                        <div class="custom-select-display" id="dateFilterDisplay">ä»Šæ—¥</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="dateFilterDropdown">
                                        <div class="custom-select-option" data-value="all">
                                            <span>æ‰€æœ‰æ—¥æœŸ</span>
                                        </div>
                                        <div class="custom-select-option selected" data-value="today">
                                            <span>ä»Šæ—¥</span>
                                        </div>
                                        <div class="custom-select-option" data-value="tomorrow">
                                            <span>æ˜æ—¥</span>
                                        </div>
                                        <div class="custom-select-option" data-value="week">
                                            <span>æœ¬å‘¨</span>
                                        </div>
                                        <div class="custom-select-option" data-value="overdue">
                                            <span>å·²é€¾æœŸ</span>
                                        </div>
                                        <div class="custom-select-option" data-value="custom">
                                            <span>æ—¶é—´èŒƒå›´</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">âœ… çŠ¶æ€</label>
                                <div class="custom-select custom-select-compact" id="statusFilterContainer">
                                    <div class="custom-select-trigger" data-select-id="statusFilter">
                                        <div class="custom-select-display" id="statusFilterDisplay">å…¨éƒ¨</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="statusFilterDropdown">
                                        <div class="custom-select-option" data-value="all">
                                            <input type="checkbox" class="custom-select-checkbox" checked>
                                            <span>å…¨éƒ¨</span>
                                        </div>
                                        <div class="custom-select-option" data-value="active">
                                            <input type="checkbox" class="custom-select-checkbox">
                                            <span>æœªå®Œæˆ</span>
                                        </div>
                                        <div class="custom-select-option" data-value="completed">
                                            <input type="checkbox" class="custom-select-checkbox">
                                            <span>å·²å®Œæˆ</span>
                                        </div>
                                        <div class="custom-select-option" data-value="overdue">
                                            <input type="checkbox" class="custom-select-checkbox">
                                            <span>é€¾æœŸ</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="selected-tags selected-tags-compact" id="statusFilterTags"></div>
                            </div>

                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">ğŸ“ åˆ†ç±»</label>
                                <div class="custom-single-select custom-select-compact" id="categoryFilterContainer">
                                    <div class="custom-select-trigger" data-select-id="categoryFilter">
                                        <div class="custom-select-display" id="categoryFilterDisplay">æ‰€æœ‰</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="categoryFilterDropdown">
                                        <div class="custom-select-option selected" data-value="all">
                                            <span>æ‰€æœ‰</span>
                                        </div>
                                        <div class="custom-select-option" data-value="work">
                                            <span>å·¥ä½œ</span>
                                        </div>
                                        <div class="custom-select-option" data-value="life">
                                            <span>ç”Ÿæ´»</span>
                                        </div>
                                        <div class="custom-select-option" data-value="study">
                                            <span>å­¦ä¹ </span>
                                        </div>
                                        <div class="custom-select-option" data-value="other">
                                            <span>å…¶ä»–</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç¬¬äºŒè¡Œï¼šä¼˜å…ˆçº§ã€å®Œæˆäººã€æ’åºå’Œæ“ä½œæŒ‰é’® -->
                        <div class="filter-row collapsible-row filter-row-compact" id="categoryRow">
                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">â­ ä¼˜å…ˆçº§</label>
                                <div class="custom-single-select custom-select-compact" id="priorityFilterContainer">
                                    <div class="custom-select-trigger" data-select-id="priorityFilter">
                                        <div class="custom-select-display" id="priorityFilterDisplay">æ‰€æœ‰</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="priorityFilterDropdown">
                                        <div class="custom-select-option selected" data-value="all">
                                            <span>æ‰€æœ‰</span>
                                        </div>
                                        <div class="custom-select-option" data-value="high">
                                            <span>é«˜ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="medium">
                                            <span>ä¸­ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="low">
                                            <span>ä½ä¼˜å…ˆçº§</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">ğŸ‘¤ å®Œæˆäºº</label>
                                <div class="custom-select custom-select-compact" id="assigneeFilterContainer">
                                    <div class="custom-select-trigger" data-select-id="assigneeFilter">
                                        <div class="custom-select-display" id="assigneeFilterDisplay">æ‰€æœ‰</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="assigneeFilterDropdown">
                                        <div class="custom-select-option" data-value="all">
                                            <input type="checkbox" class="custom-select-checkbox" checked>
                                            <span>æ‰€æœ‰äºº</span>
                                        </div>
                                        <!-- å…¶ä»–é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                                <div class="selected-tags selected-tags-compact" id="assigneeFilterTags"></div>
                            </div>

                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">ğŸ”„ æ’åº</label>
                                <div class="custom-single-select custom-select-compact" id="sortFilterContainer">
                                    <div class="custom-select-trigger" data-select-id="sortFilter">
                                        <div class="custom-select-display" id="sortFilterDisplay">æˆªæ­¢</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="sortFilterDropdown">
                                        <div class="custom-select-option selected" data-value="deadline">
                                            <span>æˆªæ­¢æ—¶é—´</span>
                                        </div>
                                        <div class="custom-select-option" data-value="priority">
                                            <span>ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="created">
                                            <span>åˆ›å»ºæ—¶é—´</span>
                                        </div>
                                        <div class="custom-select-option" data-value="category">
                                            <span>åˆ†ç±»</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-group filter-group-compact button-group-compact">
                                <button class="filter-action-btn filter-action-btn-compact" id="sortOrderBtn" onclick="toggleSortOrder()" title="åˆ‡æ¢æ’åºé¡ºåº">
                                    <span id="sortOrderIcon">â†‘</span>
                                </button>
                                <button class="filter-action-btn filter-action-btn-compact filter-reset-btn" onclick="clearAllFilters()" title="é‡ç½®ç­›é€‰">
                                    <span>Ã—</span>
                                </button>
                            </div>
                        </div>

                        <!-- ç¬¬ä¸‰è¡Œï¼šæ—¶é—´èŒƒå›´é€‰æ‹©ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰ -->
                        <div class="filter-row collapsible-row filter-row-compact" id="customDateRangeRow">
                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">ğŸ“… å¼€å§‹</label>
                                <input type="date" class="date-range-input" id="startDateInput" onchange="handleDateRangeChange()">
                            </div>
                            <div class="filter-group filter-group-compact">
                                <label class="filter-label filter-label-compact">ğŸ“… ç»“æŸ</label>
                                <input type="date" class="date-range-input" id="endDateInput" onchange="handleDateRangeChange()">
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰¹é‡æ“ä½œæ§åˆ¶åŒº -->
                <div class="batch-controls" id="batchControls" style="display: none;">
                    <div class="batch-info">
                        <span id="selectedCount">0</span> é¡¹å·²é€‰æ‹©
                    </div>
                    <div class="batch-actions">
                        <!-- å…¨é€‰/å–æ¶ˆåˆ‡æ¢æŒ‰é’® -->
                        <button class="batch-btn toggle-select-btn">â˜‘ï¸ å…¨é€‰</button>
                        <button class="batch-btn delete-selected-btn">ğŸ—‘ï¸ åˆ é™¤</button>
                        <button class="batch-btn complete-selected-btn">âœ… å®Œæˆ</button>
                        <button class="batch-btn cancel-batch-btn">âŒ é€€å‡º</button>
                    </div>
                </div>

                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div class="task-list" id="taskList">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªå¼€å§‹å§ï¼</div>
                    </div>
                </div>

                <!-- æ‚¬æµ®æ“ä½œçƒ -->
                <!-- åŸæ‚¬æµ¯çƒå·²ç§»åŠ¨åˆ°åº•éƒ¨å¯¼èˆªæ ä¸­ -->
            </div>


            <!-- æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡† -->
            <div class="modal" id="addTaskModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">æ·»åŠ æ–°ä»»åŠ¡</div>
                        <button class="close-btn" id="closeAddTaskBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">ä»»åŠ¡æ ‡é¢˜ *</label>
                            <input type="text" class="form-input" id="addTaskTitle" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜..." maxlength="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä»»åŠ¡å¤‡æ³¨</label>
                            <textarea class="form-textarea" id="addTaskNotes" placeholder="è¯·è¾“å…¥ä»»åŠ¡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." maxlength="500" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¤‡æ³¨å›¾ç‰‡</label>
                            <div class="image-upload-container">
                                <input type="file" class="form-input-file" id="addTaskNotesImages" accept="image/*" multiple style="display: none;">
                                <button type="button" class="btn-upload" onclick="document.getElementById('addTaskNotesImages').click()">
                                    ğŸ“· é€‰æ‹©å›¾ç‰‡
                                </button>
                                <div class="image-preview-container" id="addTaskNotesImagesPreview"></div>
                            </div>
                            <small class="form-help">å¯é€‰æ‹©å¤šå¼ å›¾ç‰‡ä½œä¸ºä»»åŠ¡å¤‡æ³¨çš„é™„ä»¶</small>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ä¼˜å…ˆçº§</label>
                                <div class="custom-single-select" id="addTaskPriorityContainer">
                                    <div class="custom-select-trigger" data-select-id="addTaskPriority">
                                        <div class="custom-select-display" id="addTaskPriorityDisplay">ä¸­ä¼˜å…ˆçº§</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="addTaskPriorityDropdown">
                                        <div class="custom-select-option selected" data-value="medium">
                                            <span>ä¸­ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="high">
                                            <span>é«˜ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="low">
                                            <span>ä½ä¼˜å…ˆçº§</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">åˆ†ç±»</label>
                                <div class="custom-single-select" id="addTaskCategoryContainer">
                                    <div class="custom-select-trigger" data-select-id="addTaskCategory">
                                        <div class="custom-select-display" id="addTaskCategoryDisplay">å·¥ä½œ</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="addTaskCategoryDropdown">
                                        <div class="custom-select-option selected" data-value="work">
                                            <span>å·¥ä½œ</span>
                                        </div>
                                        <div class="custom-select-option" data-value="life">
                                            <span>ç”Ÿæ´»</span>
                                        </div>
                                        <div class="custom-select-option" data-value="study">
                                            <span>å­¦ä¹ </span>
                                        </div>
                                        <div class="custom-select-option" data-value="other">
                                            <span>å…¶ä»–</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æˆªæ­¢æ—¶é—´</label>
                            <input type="datetime-local" class="form-input" id="addTaskDeadline">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®Œæˆäºº</label>
                            <div class="multi-select-container">
                                <div class="multi-select-display" id="addTaskAssigneeDisplay" onclick="toggleAssigneeDropdown('add')">
                                    <span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>
                                    <span class="dropdown-arrow">â–¼</span>
                                </div>
                                <div class="multi-select-dropdown" id="addTaskAssigneeDropdown">
                                    <div class="assignee-search">
                                        <input type="text" class="search-input" placeholder="æœç´¢å®Œæˆäºº..." onkeyup="filterAssignees('add', this.value)">
                                    </div>
                                    <div class="assignee-options" id="addTaskAssigneeOptions">
                                        <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" id="cancelAddTaskBtn">å–æ¶ˆ</button>
                        <button class="btn-save" id="saveAddTaskBtn">æ·»åŠ ä»»åŠ¡</button>
                    </div>
                </div>
            </div>

            <!-- ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
            <div class="modal" id="editModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ç¼–è¾‘ä»»åŠ¡</div>
                        <button class="close-btn" id="closeEditBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">ä»»åŠ¡æ ‡é¢˜ *</label>
                            <input type="text" class="form-input" id="editTaskTitle" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜..." maxlength="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä»»åŠ¡å¤‡æ³¨</label>
                            <textarea class="form-textarea" id="editTaskNotes" placeholder="è¯·è¾“å…¥ä»»åŠ¡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." maxlength="500" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¤‡æ³¨å›¾ç‰‡</label>
                            <div class="image-upload-container">
                                <input type="file" class="form-input-file" id="editTaskNotesImages" accept="image/*" multiple style="display: none;">
                                <button type="button" class="btn-upload" onclick="document.getElementById('editTaskNotesImages').click()">
                                    ğŸ“· é€‰æ‹©å›¾ç‰‡
                                </button>
                                <div class="image-preview-container" id="editTaskNotesImagesPreview"></div>
                            </div>
                            <small class="form-help">å¯é€‰æ‹©å¤šå¼ å›¾ç‰‡ä½œä¸ºä»»åŠ¡å¤‡æ³¨çš„é™„ä»¶</small>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ä¼˜å…ˆçº§</label>
                                <div class="custom-single-select" id="editPriorityContainer">
                                    <div class="custom-select-trigger" data-select-id="editPriority">
                                        <div class="custom-select-display" id="editPriorityDisplay">é«˜ä¼˜å…ˆçº§</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="editPriorityDropdown">
                                        <div class="custom-select-option selected" data-value="high">
                                            <span>é«˜ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="medium">
                                            <span>ä¸­ä¼˜å…ˆçº§</span>
                                        </div>
                                        <div class="custom-select-option" data-value="low">
                                            <span>ä½ä¼˜å…ˆçº§</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">åˆ†ç±»</label>
                                <div class="custom-single-select" id="editCategoryContainer">
                                    <div class="custom-select-trigger" data-select-id="editCategory">
                                        <div class="custom-select-display" id="editCategoryDisplay">å·¥ä½œ</div>
                                        <div class="custom-select-arrow">â–¼</div>
                                    </div>
                                    <div class="custom-select-dropdown" id="editCategoryDropdown">
                                        <div class="custom-select-option selected" data-value="work">
                                            <span>å·¥ä½œ</span>
                                        </div>
                                        <div class="custom-select-option" data-value="life">
                                            <span>ç”Ÿæ´»</span>
                                        </div>
                                        <div class="custom-select-option" data-value="study">
                                            <span>å­¦ä¹ </span>
                                        </div>
                                        <div class="custom-select-option" data-value="other">
                                            <span>å…¶ä»–</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æˆªæ­¢æ—¶é—´</label>
                            <input type="datetime-local" class="form-input" id="editDeadline">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®Œæˆäºº</label>
                            <div class="multi-select-container">
                                <div class="multi-select-display" id="editTaskAssigneeDisplay" onclick="toggleAssigneeDropdown('edit')">
                                    <span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>
                                    <span class="dropdown-arrow">â–¼</span>
                                </div>
                                <div class="multi-select-dropdown" id="editTaskAssigneeDropdown">
                                    <div class="assignee-search">
                                        <input type="text" class="search-input" placeholder="æœç´¢å®Œæˆäºº..." onkeyup="filterAssignees('edit', this.value)">
                                    </div>
                                    <div class="assignee-options" id="editTaskAssigneeOptions">
                                        <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="form-actions">
                            <button class="btn-cancel" id="cancelEditBtn">å–æ¶ˆ</button>
                            <button class="btn-save" id="saveEditBtn">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ä»»åŠ¡å®Œæˆæ¨¡æ€æ¡† -->
            <div class="modal" id="completeTaskModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ğŸ‰ å®Œæˆä»»åŠ¡</div>
                        <button class="close-btn" id="closeCompleteBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="complete-task-info">
                            <div class="task-title-display" id="completeTaskTitle">ä»»åŠ¡æ ‡é¢˜</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®Œæˆå¤‡æ³¨ (å¯é€‰)</label>
                            <textarea class="form-input" id="completeNotes" placeholder="è®°å½•å®Œæˆæƒ…å†µã€å¿ƒå¾—ä½“ä¼š..." rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®Œæˆäºº (å¯é€‰)</label>
                            <div class="multi-select-container">
                                <div class="multi-select-display" id="completeTaskAssigneeDisplay" onclick="toggleAssigneeDropdown('complete')">
                                    <span class="placeholder">é€‰æ‹©å®Œæˆäººï¼ˆå¯é€‰ï¼‰</span>
                                    <span class="dropdown-arrow">â–¼</span>
                                </div>
                                <div class="multi-select-dropdown" id="completeTaskAssigneeDropdown">
                                    <div class="assignee-search">
                                        <input type="text" class="search-input" placeholder="æœç´¢å®Œæˆäºº..." onkeyup="filterAssignees('complete', this.value)">
                                    </div>
                                    <div class="assignee-options" id="completeTaskAssigneeOptions">
                                        <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®Œæˆå›¾ç‰‡ (å¯é€‰ï¼Œæœ€å¤š2å¼ )</label>
                            <div class="images-upload-container">
                                <!-- ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                                <div class="image-upload-area">
                                    <div class="upload-placeholder" id="uploadPlaceholder1">
                                        <div class="upload-icon">ğŸ“·</div>
                                        <div class="upload-text" onclick="selectCompleteImage(1)" style="cursor: pointer;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡1</div>
                                        <small>JPGã€PNGã€GIF æœ€å¤§5MB</small>
                                    </div>
                                    <div class="image-preview" id="imagePreview1" style="display: none;">
                                        <img id="previewImage1" src="" alt="é¢„è§ˆå›¾1">
                                        <button type="button" class="remove-image-btn" onclick="removeCompleteImage(1)">Ã—</button>
                                    </div>
                                </div>
                                <!-- ç¬¬äºŒå¼ å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                                <div class="image-upload-area">
                                    <div class="upload-placeholder" id="uploadPlaceholder2">
                                        <div class="upload-icon">ğŸ“·</div>
                                        <div class="upload-text" onclick="selectCompleteImage(2)" style="cursor: pointer;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡2</div>
                                        <small>JPGã€PNGã€GIF æœ€å¤§5MB</small>
                                    </div>
                                    <div class="image-preview" id="imagePreview2" style="display: none;">
                                        <img id="previewImage2" src="" alt="é¢„è§ˆå›¾2">
                                        <button type="button" class="remove-image-btn" onclick="removeCompleteImage(2)">Ã—</button>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="completeImageInput1" accept="image/*,image/jpeg,image/png,image/gif" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" onchange="handleCompleteImageSelect(event, 1)">
                            <input type="file" id="completeImageInput2" accept="image/*,image/jpeg,image/png,image/gif" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" onchange="handleCompleteImageSelect(event, 2)">

                            <!-- Android 14ä¸“ç”¨å¯è§æ–‡ä»¶è¾“å…¥æ¡† -->
                            <div id="android14FileInputs" style="display: none;">
                                <input type="file" id="android14Input1" accept="image/*" style="width: 1px; height: 1px; opacity: 0.01; position: fixed; top: 0; left: 0; z-index: -1;" onchange="handleAndroid14FileSelect(event, 1)">
                                <input type="file" id="android14Input2" accept="image/*" style="width: 1px; height: 1px; opacity: 0.01; position: fixed; top: 0; left: 0; z-index: -1;" onchange="handleAndroid14FileSelect(event, 2)">
                            </div>
                        </div>
                        <div class="completion-time">
                            <span>ğŸ• å®Œæˆæ—¶é—´ï¼š<span id="completionTime"></span></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" id="cancelCompleteBtn">å–æ¶ˆ</button>
                        <button class="btn-save" id="confirmCompleteBtn">ç¡®è®¤å®Œæˆ</button>
                    </div>
                </div>
            </div>

            <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
            <div class="modal" id="imageViewModal">
                <div class="modal-content image-viewer">
                    <div class="modal-header">
                        <div class="modal-title">ğŸ“· æŸ¥çœ‹å›¾ç‰‡</div>
                        <button class="close-btn" id="closeImageViewBtn">&times;</button>
                    </div>
                    <div class="image-view-container">
                        <img id="viewImage" src="" alt="æŸ¥çœ‹å›¾ç‰‡">
                    </div>
                    <div class="image-info">
                        <div class="task-info" id="imageTaskInfo">ä»»åŠ¡ä¿¡æ¯</div>
                        <div class="completion-info" id="imageCompletionInfo">å®Œæˆä¿¡æ¯</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="view-container" id="settingsView" style="display: none;">
            <!-- è®¾ç½®ç•Œé¢ -->
            <div class="container" style="background: white; overflow-y: auto;">

                <div style="padding: 16px;">
                    <h1 style="color: #333; font-size: 22px; margin: 12px 0; text-align: center;">âš™ï¸ åº”ç”¨è®¾ç½®</h1>
                    <p style="color: #666; margin: 6px 0; font-size: 14px; text-align: center;">ä¸ªæ€§åŒ–é…ç½®æ‚¨çš„å¾…åŠåº”ç”¨ï¼Œæå‡ä½¿ç”¨ä½“éªŒ</p>

                    <!-- è®¾ç½®é€‰é¡¹ -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px; padding: 16px 0; max-width: 400px; margin: 0 auto;">
                        <!-- æ¯æ—¥å¾…åŠè®¾ç½® -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease;" onclick="showDailyTodoSettings()">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); border-radius: 10px;">ğŸ“‹</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 3px;">æ¯æ—¥å¾…åŠ</div>
                                    <div style="font-size: 12px; opacity: 0.9;">è‡ªåŠ¨ä»»åŠ¡æ¨¡æ¿</div>
                                </div>
                            </div>
                        </div>

                        <!-- å¾®ä¿¡é€šçŸ¥è®¾ç½® -->
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 16px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease;" onclick="showWechatSettings()">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); border-radius: 10px;">ğŸ“±</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 3px;">å¾®ä¿¡é€šçŸ¥</div>
                                    <div style="font-size: 12px; opacity: 0.9;">æ¶ˆæ¯æ¨é€æé†’</div>
                                </div>
                            </div>
                        </div>

                        <!-- æ•°æ®åŒæ­¥è®¾ç½® -->
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 16px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease;" onclick="showDatabaseSettings()">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); border-radius: 10px;">ğŸ—„ï¸</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 3px;">æ•°æ®åŒæ­¥</div>
                                    <div style="font-size: 12px; opacity: 0.9;">äº‘ç«¯å­˜å‚¨é…ç½®</div>
                                </div>
                            </div>
                        </div>

                        <!-- å®Œæˆäººç®¡ç† -->
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 16px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease;" onclick="showAssigneeSettings()">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.2); border-radius: 10px;">ğŸ‘¥</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 3px;">å®Œæˆäººç®¡ç†</div>
                                    <div style="font-size: 12px; opacity: 0.9;">é…ç½®ä»»åŠ¡å®Œæˆäºº</div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸ªäººä¿¡æ¯è®¾ç½® -->
                        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 16px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease;" onclick="showPersonalInfoModal()">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.5); border-radius: 10px;">ğŸ‘¤</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 3px;">ä¸ªäººä¿¡æ¯</div>
                                    <div style="font-size: 12px; opacity: 0.8;">è®¾ç½®æˆ‘çš„èº«ä»½å’Œæƒé™</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¯æ—¥å¾…åŠè®¾ç½®æ¨¡æ€æ¡† -->
            <div class="modal" id="dailyTodoModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">æ¯æ—¥å¾…åŠè®¾ç½®</div>
                        <button class="close-btn" id="closeDailyTodoBtn">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¯æ—¥å›ºå®šä»»åŠ¡æ¨¡æ¿</label>
                        <textarea class="form-textarea" id="dailyTasksTemplate" placeholder="æ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ ¼å¼ï¼šä»»åŠ¡åç§°|ä¼˜å…ˆçº§|åˆ†ç±»|æˆªæ­¢æ—¶é—´|å®Œæˆäºº&#10;ä¾‹å¦‚ï¼š&#10;æŸ¥çœ‹é‚®ä»¶|medium|work|09:30|å¼ ä¸‰&#10;é”»ç‚¼30åˆ†é’Ÿ|high|life|18:00|æå››&#10;å­¦ä¹ æ–°çŸ¥è¯†|low|study|21:30|ç‹äº”&#10;åˆ¶å®šæ˜æ—¥è®¡åˆ’|medium|work|22:00|å¼ ä¸‰&#10;&#10;è¯´æ˜ï¼š&#10;- ä¼˜å…ˆçº§ï¼šhigh(é«˜)|medium(ä¸­)|low(ä½)&#10;- åˆ†ç±»ï¼šwork(å·¥ä½œ)|life(ç”Ÿæ´»)|study(å­¦ä¹ )|other(å…¶ä»–)&#10;- æˆªæ­¢æ—¶é—´ï¼šHH:MMæ ¼å¼ï¼Œä¸å¡«åˆ™é»˜è®¤23:59&#10;- å®Œæˆäººï¼šä»å®Œæˆäººåˆ—è¡¨ä¸­é€‰æ‹©ï¼Œä¸å¡«åˆ™ä¸ºæœªåˆ†é…&#10;- æ¯æ—¥ä¼šè‡ªåŠ¨ç”Ÿæˆæœªæ¥7å¤©çš„ä»»åŠ¡" rows="10"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è‡ªåŠ¨æ·»åŠ æ—¶é—´</label>
                        <input type="time" class="form-input" id="autoAddTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox-group">
                            <input type="checkbox" id="enableDailyTodo" checked>
                            <span>å¯ç”¨æ¯æ—¥è‡ªåŠ¨æ·»åŠ ä»»åŠ¡</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox-group">
                            <input type="checkbox" id="skipHolidays" checked>
                            <span>è·³è¿‡èŠ‚å‡æ—¥ï¼ˆå‘¨æœ«å’Œæ³•å®šèŠ‚å‡æ—¥ï¼‰</span>
                        </label>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            å¼€å¯åå°†ä¸ä¼šåœ¨å‘¨æœ«å’Œæ³•å®šèŠ‚å‡æ—¥ç”Ÿæˆæ¯æ—¥ä»»åŠ¡
                        </small>
                    </div>
                    <div class="form-actions">
                        <button class="btn-cancel" id="cancelDailyTodoBtn">å–æ¶ˆ</button>
                        <button class="btn-save" id="saveDailyTodoBtn">ä¿å­˜</button>
                    </div>
                    <!-- è°ƒè¯•å·¥å…· -->
                    <div class="form-group" style="border-top: 1px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
                        <label class="form-label">ğŸ”§ è°ƒè¯•å·¥å…·</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" style="background: #0066cc; color: white; flex: 1;" onclick="showDailyTodoDebugInfo()">æŸ¥çœ‹è¯Šæ–­ä¿¡æ¯</button>
                            <button class="btn" style="background: #28a745; color: white; flex: 1;" onclick="testTaskCreation()">æµ‹è¯•åˆ›å»ºä»»åŠ¡</button>
                        </div>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            å¦‚æœä»»åŠ¡æœªç”Ÿæˆï¼Œç‚¹å‡»"æŸ¥çœ‹è¯Šæ–­ä¿¡æ¯"æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
                        </small>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®åº“è®¾ç½®æ¨¡æ€æ¡† -->
            <div class="modal" id="databaseModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ğŸ—„ï¸ æ•°æ®åº“åŒæ­¥è®¾ç½®</div>
                        <button class="close-btn" id="closeDatabaseBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div class="connection-status-card">
                        <div class="database-status">
                            <div class="status-icon" id="databaseStatusIcon">ğŸ”´</div>
                            <div class="status-info">
                                <div class="status-text" id="statusText">æœªè¿æ¥</div>
                                <div class="status-detail" id="databaseStatusDetail">è¯·é…ç½®æ•°æ®åº“ä¿¡æ¯</div>
                                <div id="binIdInfo" style="margin-top: 4px; font-size: 12px; color: #6c757d;"></div>
                            </div>
                            <button class="status-test-btn" onclick="testDatabaseConnection()">æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>

                    <!-- åŸºæœ¬é…ç½® -->
                    <div class="form-section">
                        <h4 class="section-title">åŸºæœ¬é…ç½®</h4>

                        <div class="form-group">
                            <label class="form-label">
                                <span>Supabaseé¡¹ç›®URL</span>
                                <span class="label-required">*</span>
                            </label>
                            <input type="text" class="form-input" id="supabaseUrl"
                                   placeholder="https://your-project.supabase.co" maxlength="200">
                            <small class="form-help">åœ¨Supabaseæ§åˆ¶å°çš„Settings â†’ APIä¸­è·å–</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>Anon Key</span>
                                <span class="label-required">*</span>
                            </label>
                            <input type="text" class="form-input" id="supabaseAnonKey"
                                   placeholder="è¯·è¾“å…¥Supabase Anon Key" maxlength="200">
                            <small class="form-help">åœ¨Supabaseæ§åˆ¶å°çš„Settings â†’ APIä¸­è·å–</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·ID</label>
                            <input type="text" class="form-input" id="supabaseUserId"
                                   placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ" maxlength="100">
                            <small class="form-help">è‡ªå®šä¹‰IDå¯ç¡®ä¿å¤šè®¾å¤‡æ•°æ®åŒæ­¥</small>
                        </div>
                    </div>

                    <!-- åŒæ­¥è®¾ç½® -->
<!--                    <div class="form-section">-->
<!--                        <h4 class="section-title">åŒæ­¥è®¾ç½®</h4>-->

<!--                        <div class="form-group">-->
<!--                            <label class="form-checkbox-group">-->
<!--                                <input type="checkbox" id="enableOnlineSync" checked>-->
<!--                                <span>å¯ç”¨è‡ªåŠ¨åŒæ­¥</span>-->
<!--                            </label>-->
<!--                            <small class="form-help">å¼€å¯åæ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯</small>-->
<!--                        </div>-->

<!--                        <div class="form-group">-->
<!--                            <label class="form-label">åŒæ­¥é—´éš”</label>-->
<!--                            <div class="custom-single-select" id="syncIntervalSelectContainer">-->
<!--                                <div class="custom-select-trigger" data-select-id="syncIntervalSelect">-->
<!--                                    <div class="custom-select-display" id="syncIntervalSelectDisplay">5åˆ†é’Ÿ</div>-->
<!--                                    <div class="custom-select-arrow">â–¼</div>-->
<!--                                </div>-->
<!--                                <div class="custom-select-dropdown" id="syncIntervalSelectDropdown">-->
<!--                                    <div class="custom-select-option" data-value="1">-->
<!--                                        <span>1åˆ†é’Ÿ</span>-->
<!--                                    </div>-->
<!--                                    <div class="custom-select-option selected" data-value="5">-->
<!--                                        <span>5åˆ†é’Ÿ</span>-->
<!--                                    </div>-->
<!--                                    <div class="custom-select-option" data-value="10">-->
<!--                                        <span>10åˆ†é’Ÿ</span>-->
<!--                                    </div>-->
<!--                                    <div class="custom-select-option" data-value="30">-->
<!--                                        <span>30åˆ†é’Ÿ</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->

                    <!-- è®¾ç½®è¯´æ˜ -->
                    <div class="setup-help">
                        <details>
                            <summary>ğŸ“š é¦–æ¬¡ä½¿ç”¨è¯´æ˜</summary>
                            <div class="help-content">
                                <p><strong>1. åˆ›å»ºSupabaseé¡¹ç›®</strong></p>
                                <p>è®¿é—® <a href="https://supabase.com" target="_blank">supabase.com</a> åˆ›å»ºå…è´¹é¡¹ç›®</p>

                                <p><strong>2. è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬</strong></p>
                                <p>åœ¨SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹è¿ç§»è„šæœ¬åˆ›å»ºtasksè¡¨ç»“æ„ï¼š</p>
                                <pre><code>-- ä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰
\i pg_setup_complete_migration_fixed.sql

-- æˆ–åˆ†æ­¥æ‰§è¡Œ
\i pg_create_tasks_table_fixed.sql
\i pg_migrate_data_fixed.sql</code></pre>
                                <p><small>æ³¨æ„ï¼šæ–°ç‰ˆæœ¬ä½¿ç”¨ç»“æ„åŒ–çš„tasksè¡¨æ›¿ä»£JSONå­˜å‚¨ï¼Œæ‰€æœ‰æ•°æ®ç›´æ¥é€šè¿‡APIæ“ä½œ</small></p>

                                <p><strong>3. è·å–é…ç½®ä¿¡æ¯</strong></p>
                                <p>åœ¨é¡¹ç›®è®¾ç½® â†’ APIä¸­å¤åˆ¶URLå’ŒAnon Key</p>
                            </div>
                        </details>
                    </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-cancel" id="cancelDatabaseBtn">å–æ¶ˆ</button>
                        <button class="btn-save" id="saveDatabaseBtn">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>

            <!-- å¾®ä¿¡é€šçŸ¥è®¾ç½®æ¨¡æ€æ¡† -->
            <div class="modal" id="wechatModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">å¾®ä¿¡é€šçŸ¥è®¾ç½®</div>
                        <button class="close-btn" id="closeWechatBtn">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¾®ä¿¡é€šçŸ¥è®¾ç½® (Serveré…±)</label>
                        <input type="text" class="form-input" id="serverChanKey" placeholder="è¯·è¾“å…¥Serveré…±çš„SendKey" maxlength="100">
                        <small style="color: #666; font-size: 12px;">è·å–SendKeyï¼š<a href="https://sct.ftqq.com/" target="_blank">https://sct.ftqq.com/</a></small>
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox-group">
                            <input type="checkbox" id="enableWechatNotify">
                            <span>å¯ç”¨å¾®ä¿¡é€šçŸ¥</span>
                        </label>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            å¼€å¯åå°†åœ¨æ¯æ—¥9:00å’Œ18:00å‘é€ä»Šæ—¥ä»»åŠ¡å’Œé€¾æœŸä»»åŠ¡æ±‡æ€»æé†’
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é€šçŸ¥æ—¶é—´è®¾ç½®</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 14px;">æ™¨æŠ¥æ—¶é—´:</span>
                                <input type="time" class="form-input" id="morningNotifyTime" value="09:00" style="width: 120px;">
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 14px;">æ™šæŠ¥æ—¶é—´:</span>
                                <input type="time" class="form-input" id="eveningNotifyTime" value="18:00" style="width: 120px;">
                            </label>
                        </div>
                    </div>
                    <!-- æµ‹è¯•æŒ‰é’®åŒºåŸŸ -->
                    <div class="test-buttons-container">
                        <div class="test-buttons-label">ğŸ§ª åŠŸèƒ½æµ‹è¯•</div>
                        <button type="button" class="btn-test morning" onclick="testWechatNotification()" title="æµ‹è¯•å¾®ä¿¡æ™¨æ™šæŠ¥æ¨é€">
                            ğŸŒ… æµ‹è¯•æ™¨æ™šæŠ¥
                        </button>
                        <button type="button" class="btn-test deadline" onclick="testDeadlineReminder()" title="æµ‹è¯•ä»»åŠ¡è¶…æ—¶æé†’">
                            â° æµ‹è¯•è¶…æ—¶æé†’
                        </button>
                        <button type="button" class="btn-test web" onclick="testWebNotification()" title="æµ‹è¯•Webæµè§ˆå™¨é€šçŸ¥">
                            ğŸŒ æµ‹è¯•Webé€šçŸ¥
                        </button>
                        <button type="button" class="btn-test native" onclick="sendDailyReportNotification('morning')" title="æµ‹è¯•AndroidåŸç”Ÿé€šçŸ¥">
                            ğŸ“± åŸç”Ÿæ™¨æŠ¥
                        </button>
                        <button type="button" class="btn-test overdue" onclick="createTestOverdueTask()" title="åˆ›å»ºæµ‹è¯•è¶…æ—¶ä»»åŠ¡">
                            ğŸš¨ åˆ›å»ºè¶…æ—¶ä»»åŠ¡
                        </button>
                        <button type="button" class="btn-test reminder" onclick="triggerTaskReminders()" title="æ‰‹åŠ¨è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥">
                            ğŸ“¢ è§¦å‘ä»»åŠ¡æé†’
                        </button>
                        <button type="button" class="btn-test comprehensive" onclick="testReminderSystem()" title="å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯•">
                            ğŸ§ª å®Œæ•´ç³»ç»Ÿæµ‹è¯•
                        </button>
                        <button type="button" class="btn-test image" onclick="testImageModal()" title="æµ‹è¯•å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†">
                            ğŸ–¼ï¸ æµ‹è¯•å›¾ç‰‡é¢„è§ˆ
                        </button>
                    </div>

                    <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
                    <div class="main-actions">
                        <button class="btn-cancel" id="cancelWechatBtn">å–æ¶ˆ</button>
                        <button class="btn-save" id="saveWechatBtn">ä¿å­˜</button>
                    </div>
                </div>
            </div>

            <!-- å®Œæˆäººç®¡ç†è®¾ç½®æ¨¡æ€æ¡† -->
            <div class="modal" id="assigneeModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">å®Œæˆäººç®¡ç†</div>
                        <button class="close-btn" id="closeAssigneeBtn">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ·»åŠ å®Œæˆäºº</label>
                        <div class="assignee-add-container">
                            <input type="text" class="form-input" id="newAssigneeName" placeholder="è¯·è¾“å…¥å®Œæˆäººå§“å" maxlength="20">
                            <button class="btn-add-assignee" onclick="addAssignee()">
                                <i class="icon-plus">+</i>
                                <span>æ·»åŠ </span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å½“å‰å®Œæˆäººåˆ—è¡¨</label>
                        <div id="assigneeList" style="max-height: 200px; overflow-y: auto;">
                            <!-- å®Œæˆäººåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-cancel" id="cancelAssigneeBtn">å…³é—­</button>
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯è®¾ç½®æ¨¡æ€æ¡† -->
            <div class="modal" id="personalInfoModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ä¸ªäººä¿¡æ¯è®¾ç½®</div>
                        <button class="close-btn" id="closePersonalInfoBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                    <!-- å½“å‰èº«ä»½çŠ¶æ€ -->
                    <div class="current-identity-status">
                        <div class="status-header">
                            <div class="status-icon">ğŸ‘¤</div>
                            <h3 class="status-title">å½“å‰èº«ä»½çŠ¶æ€</h3>
                        </div>
                        <div class="current-identity" id="currentIdentityDisplay">
                            <div class="identity-icon">?</div>
                            <span class="identity-name">æœªè®¾ç½®èº«ä»½</span>
                        </div>
                        <p class="status-description">
                            èº«ä»½è®¾ç½®åå°†å½±å“ä»»åŠ¡æ“ä½œæƒé™ï¼Œè¯·é€‰æ‹©ä¸æ‚¨å®é™…èº«ä»½åŒ¹é…çš„å®Œæˆäºº
                        </p>
                    </div>

                    <!-- èº«ä»½é…ç½® -->
                    <div class="settings-section">
                        <div class="section-title">
                            <div class="section-icon">âš™ï¸</div>
                            èº«ä»½é…ç½®
                        </div>
                        <div class="form-group">
                            <label class="form-label required-field">é€‰æ‹©æˆ‘çš„èº«ä»½</label>
                            <div class="custom-single-select" id="myAssigneeSelectContainer">
                                <div class="custom-select-trigger" data-select-id="myAssigneeSelect">
                                    <div class="custom-select-display" id="myAssigneeSelectDisplay">è¯·ä»å®Œæˆäººåˆ—è¡¨ä¸­é€‰æ‹©è‡ªå·±</div>
                                    <div class="custom-select-arrow">â–¼</div>
                                </div>
                                <div class="custom-select-dropdown" id="myAssigneeSelectDropdown">
                                    <div class="custom-select-option selected" data-value="">
                                        <span>è¯·ä»å®Œæˆäººåˆ—è¡¨ä¸­é€‰æ‹©è‡ªå·±</span>
                                    </div>
                                </div>
                            </div>
                            <small class="help-text">
                                ä»ç°æœ‰å®Œæˆäººåˆ—è¡¨ä¸­é€‰æ‹©ä»£è¡¨æ‚¨èº«ä»½çš„é€‰é¡¹ï¼Œç”¨äºæƒé™æ§åˆ¶å’Œä»»åŠ¡åˆ†é…
                            </small>
                        </div>
                    </div>

                    <!-- æƒé™æ§åˆ¶ -->
                    <div class="settings-section">
                        <div class="section-title">
                            <div class="section-icon">ğŸ”’</div>
                            æƒé™æ§åˆ¶
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-group">
                                <input type="checkbox" id="enableRoleRestriction">
                                <span>å¯ç”¨è§’è‰²é™åˆ¶</span>
                            </label>
                            <small class="help-text">
                                å¼€å¯åæ‚¨åªèƒ½æ“ä½œåˆ†é…ç»™è‡ªå·±çš„ä»»åŠ¡å’Œæ— æŒ‡å®šå®Œæˆäººçš„ä»»åŠ¡ï¼Œä½†ä»å¯æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
                            </small>
                            <div class="permission-warning" style="display: none;" id="restrictionWarning">
                                <p class="warning-text">
                                    âš ï¸ å¯ç”¨è§’è‰²é™åˆ¶åï¼Œæ‚¨å°†æ— æ³•ç¼–è¾‘ã€åˆ é™¤æˆ–ä¿®æ”¹å…¶ä»–äººçš„ä»»åŠ¡ã€‚è¯·ç¡®è®¤æ‚¨å·²æ­£ç¡®è®¾ç½®èº«ä»½ã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- åŠŸèƒ½è¯´æ˜ -->
                    <div class="permission-info">
                        <div class="info-header">
                            <div class="info-icon">ğŸ’¡</div>
                            <h4 class="info-title">åŠŸèƒ½è¯´æ˜</h4>
                        </div>
                        <p class="info-text">
                            ä¸ªäººä¿¡æ¯è®¾ç½®ç”¨äºå¤šäººåä½œåœºæ™¯ï¼š<br>
                            â€¢ <strong>èº«ä»½é€‰æ‹©</strong>ï¼šä»å®Œæˆäººåˆ—è¡¨ä¸­é€‰æ‹©ä»£è¡¨æ‚¨çš„èº«ä»½<br>
                            â€¢ <strong>æƒé™æ§åˆ¶</strong>ï¼šé™åˆ¶åªèƒ½æ“ä½œå±äºè‡ªå·±çš„ä»»åŠ¡<br>
                            â€¢ <strong>ä»»åŠ¡å¯è§æ€§</strong>ï¼šå§‹ç»ˆå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡å†…å®¹<br>
                            â€¢ <strong>åä½œå‹å¥½</strong>ï¼šé¿å…è¯¯æ“ä½œä»–äººçš„ä»»åŠ¡
                        </p>
                    </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-cancel" onclick="closePersonalInfoModal()">å–æ¶ˆ</button>
                        <button class="btn-save" onclick="savePersonalInfo()">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="fileInput" class="hidden" accept=".json" onchange="handleFileImport(event)">
    </div>


    <script>
        // è§£ææœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼ˆæ•°æ®åº“è¿”å›çš„æ˜¯æœ¬åœ°æ—¶é—´ï¼Œä¸æ˜¯UTCï¼‰
        function parseLocalDateTime(dateTimeStr) {
            if (!dateTimeStr) return null;

            // å¦‚æœå­—ç¬¦ä¸²ä¸åŒ…å«æ—¶åŒºæ ‡è¯†ï¼Œç›´æ¥è§£æä¸ºæœ¬åœ°æ—¶é—´
            // æ ¼å¼ï¼šyyyy-MM-ddTHH:mm:ss
            const parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
            if (parts) {
                // ä½¿ç”¨æœ¬åœ°æ—¶åŒºæ„é€ Dateå¯¹è±¡
                return new Date(
                    parseInt(parts[1]), // year
                    parseInt(parts[2]) - 1, // month (0-11)
                    parseInt(parts[3]), // day
                    parseInt(parts[4]), // hour
                    parseInt(parts[5]), // minute
                    parseInt(parts[6])  // second
                );
            }

            // å…œåº•ï¼šç›´æ¥ä½¿ç”¨Dateæ„é€ 
            return new Date(dateTimeStr);
        }

        // å…¨å±€å˜é‡
        let tasks = [];
        let currentFilter = 'all';
        let editingTaskId = null;
        let currentDateFilter = 'today';
        let currentPriorityFilter = 'all';
        let currentCategoryFilter = 'all';
        let currentSortBy = 'deadline';
        let currentSortOrder = 'asc';
        let customDate = null;
        let isBatchMode = false;
        let selectedTasks = new Set();

        // ä»»åŠ¡åˆ—è¡¨å¸ƒå±€æ§åˆ¶
        let enableCompactModeToggle = false; // æ˜¯å¦å¯ç”¨ç´§å‡‘/æ­£å¸¸æ¨¡å¼åˆ‡æ¢ï¼Œé»˜è®¤å…³é—­

        // å¼¹æ¡†æ»šåŠ¨é”å®šç›¸å…³
        let scrollPosition = 0;

        // é”å®šé¡µé¢æ»šåŠ¨
        function lockScroll() {
            scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollPosition}px`;
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
        }

        // è§£é”é¡µé¢æ»šåŠ¨
        function unlockScroll() {
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            window.scrollTo(0, scrollPosition);
        }

        // åœ¨çº¿æ•°æ®åº“é…ç½® (Supabase)
        const DATABASE_CONFIG = {
            // Supabaseé¡¹ç›®é…ç½®
            supabaseUrl: 'https://YOUR_PROJECT_ID.supabase.co', // æ›¿æ¢ä¸ºæ‚¨çš„Supabaseé¡¹ç›®URL
            supabaseAnonKey: 'YOUR_SUPABASE_ANON_KEY', // æ›¿æ¢ä¸ºæ‚¨çš„Supabase Anon Key
            tableName: 'tasks', // æ•°æ®è¡¨å - ä½¿ç”¨æ–°çš„tasksè¡¨
            userId: null, // ç”¨æˆ·IDï¼Œå¯ä»¥è®¾ç½®å›ºå®šå€¼æˆ–åŠ¨æ€ç”Ÿæˆ
            dataPath: 'tasks' // æ•°æ®å­˜å‚¨è·¯å¾„ï¼ˆé€‚é…æ–°è¡¨ç»“æ„ï¼‰
        };

        // ä¸ºäº†å…¼å®¹ç°æœ‰ä»£ç ï¼Œæä¾›ä¸€ä¸ªç®€åŒ–çš„çŠ¶æ€å¯¹è±¡
        let syncStatus = {
            isOnline: true,
            syncInProgress: false,
            pendingChanges: false
        };

        // ========== åœ¨çº¿æ•°æ®åº“åŠŸèƒ½ ==========

        // æ—§ç‰ˆæœ¬åˆå§‹åŒ–å‡½æ•°å·²ç§»é™¤

        // ç½‘ç»œçŠ¶æ€ç›‘å¬å·²ç§»é™¤ï¼Œç›´æ¥ä½¿ç”¨APIæ“ä½œ


        // Loadingæ˜¾ç¤ºæ§åˆ¶å‡½æ•°
        function showLoading(text = 'æ­£åœ¨åŠ è½½...', subtitle = 'è¯·ç¨å€™') {
            const overlay = document.getElementById('loadingOverlay');
            const textElement = document.getElementById('loadingText');
            const subtitleElement = document.getElementById('loadingSubtitle');

            if (overlay && textElement && subtitleElement) {
                textElement.textContent = text;
                subtitleElement.textContent = subtitle;
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        // æ£€æŸ¥Supabaseé…ç½®æ˜¯å¦æœ‰æ•ˆ
        function checkSupabaseConfig() {
            if (!DATABASE_CONFIG.supabaseUrl || DATABASE_CONFIG.supabaseUrl.includes('YOUR_PROJECT_ID')) {
                console.error('è¯·å…ˆé…ç½®æœ‰æ•ˆçš„Supabaseé¡¹ç›®URL');
                alert('è¯·å…ˆé…ç½®æ‚¨çš„Supabaseé¡¹ç›®ä¿¡æ¯\n1. åœ¨Supabaseæ§åˆ¶å°åˆ›å»ºé¡¹ç›®\n2. è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬åˆ›å»ºtasksè¡¨\n3. é…ç½®é¡¹ç›®URLå’ŒAnon Key');
                return false;
            }

            if (!DATABASE_CONFIG.supabaseAnonKey || DATABASE_CONFIG.supabaseAnonKey.includes('YOUR_SUPABASE_ANON_KEY')) {
                console.error('è¯·å…ˆé…ç½®æœ‰æ•ˆçš„Supabase Anon Key');
                alert('è¯·å…ˆé…ç½®æ‚¨çš„Supabase Anon Key\nåœ¨Supabaseæ§åˆ¶å°çš„è®¾ç½®ä¸­è·å–');
                return false;
            }

            return true;
        }

        // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
        function initializeDatabase() {
            // ä»localStorageæ¢å¤é…ç½®
            const savedUrl = localStorage.getItem('supabase_url');
            const savedAnonKey = localStorage.getItem('supabase_anon_key');
            const savedUserId = localStorage.getItem('supabase_user_id');

            if (savedUrl && !savedUrl.includes('YOUR_PROJECT_ID')) {
                DATABASE_CONFIG.supabaseUrl = savedUrl;
                console.log('ä½¿ç”¨å·²ä¿å­˜çš„Supabase URL');
            }
            if (savedAnonKey && !savedAnonKey.includes('YOUR_SUPABASE_ANON_KEY')) {
                DATABASE_CONFIG.supabaseAnonKey = savedAnonKey;
                console.log('ä½¿ç”¨å·²ä¿å­˜çš„Supabase Anon Key');
            }

            // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·ID
            if (savedUserId) {
                DATABASE_CONFIG.userId = savedUserId;
            } else {
                // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ç”¨æˆ·ID
                DATABASE_CONFIG.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('supabase_user_id', DATABASE_CONFIG.userId);
            }

            console.log('ç”¨æˆ·ID:', DATABASE_CONFIG.userId);
        }

        // åˆå§‹åŒ–Supabaseæ•°æ®è¡¨
        async function initializeSupabaseData() {
            if (!checkSupabaseConfig()) {
                return false;
            }

            try {
                // æ£€æŸ¥ç”¨æˆ·æ•°æ®æ˜¯å¦å­˜åœ¨
                const url = `${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}?user_id=eq.${DATABASE_CONFIG.userId}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.length === 0) {
                        // æ•°æ®ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆå§‹æ•°æ®
                        console.log('åˆå§‹åŒ–Supabaseæ•°æ®...');
                        const initData = {
                            user_id: DATABASE_CONFIG.userId,
                            tasks: [],
                            created_at: getCurrentUTCTimeString(),
                            updated_at: getCurrentUTCTimeString(),
                            version: '1.0'
                        };

                        const initResponse = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}`, {
                            method: 'POST',
                            headers: {
                                'apikey': DATABASE_CONFIG.supabaseAnonKey,
                                'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(initData)
                        });

                        if (initResponse.ok) {
                            console.log('æˆåŠŸåˆå§‹åŒ–Supabaseæ•°æ®');
                            return true;
                        } else {
                            console.error('åˆå§‹åŒ–Supabaseæ•°æ®å¤±è´¥:', await initResponse.text());
                            return false;
                        }
                    } else {
                        console.log('Supabaseæ•°æ®å·²å­˜åœ¨');
                        return true;
                    }
                } else {
                    console.error('æ£€æŸ¥Supabaseæ•°æ®å¤±è´¥:', await response.text());
                    return false;
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–Supabaseæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                return false;
            }
        }

        // ä»Supabase tasksè¡¨åŠ è½½æ•°æ®
        async function loadTasksFromAPI(filters = {}) {
            if (!checkSupabaseConfig()) {
                alert('è¯·å…ˆé…ç½®Supabaseè¿æ¥ä¿¡æ¯');
                return false;
            }

            try {
                // æ˜¾ç¤ºloading
                const hasFilters = Object.keys(filters).some(key => filters[key] !== undefined && filters[key] !== '' && filters[key] !== 'all');
                if (hasFilters) {
                    showLoading('æ­£åœ¨ç­›é€‰æ•°æ®...', 'æ ¹æ®æ¡ä»¶æŸ¥è¯¢ä»»åŠ¡');
                } else {
                    showLoading('æ­£åœ¨åŠ è½½æ•°æ®...', 'ä»äº‘ç«¯è·å–æœ€æ–°ä»»åŠ¡');
                }

                console.log('æ­£åœ¨åŠ è½½æ•°æ®ï¼Œç­›é€‰æ¡ä»¶:', filters);

                // æ„å»ºæŸ¥è¯¢URLï¼Œæ”¯æŒç­›é€‰æ¡ä»¶
                let url = `${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}?user_id=eq.${DATABASE_CONFIG.userId}`;

                // æ·»åŠ å­—æ®µé€‰æ‹©ï¼Œæ’é™¤å¤§å­—æ®µï¼ˆå›¾ç‰‡ï¼‰ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
                // åªæŸ¥è¯¢åˆ—è¡¨å±•ç¤ºéœ€è¦çš„å­—æ®µï¼Œä¸åŒ…æ‹¬ notes_images å’Œ completion_images
                url += `&select=id,title,notes,assignee,category,deadline,priority,assignees,completed,created_at,completed_at,completed_by,completion_notes,user_id`;

                // æ·»åŠ ç­›é€‰æ¡ä»¶
                if (filters.keyword) {
                    // Supabaseæ”¯æŒæ–‡æœ¬æœç´¢
                    url += `&or=(title.ilike.*${filters.keyword}*,notes.ilike.*${filters.keyword}*)`;
                }

                if (filters.category && filters.category !== 'all') {
                    url += `&category=eq.${filters.category}`;
                }

                if (filters.priority && filters.priority !== 'all') {
                    url += `&priority=eq.${filters.priority}`;
                }

                // çŠ¶æ€ç­›é€‰
                if (filters.status && filters.status.length > 0 && !filters.status.includes('all')) {
                    if (filters.status.includes('completed') && filters.status.includes('active')) {
                        // åŒæ—¶åŒ…å«å·²å®Œæˆå’Œæœªå®Œæˆï¼Œä¸æ·»åŠ æ¡ä»¶
                    } else if (filters.status.includes('completed')) {
                        url += `&completed=eq.true`;
                    } else if (filters.status.includes('active')) {
                        url += `&completed=eq.false`;
                    }
                }

                // æ—¥æœŸç­›é€‰
                if (filters.dateFilter && filters.dateFilter !== 'all') {
                    const today = new Date();
                    let startDate, endDate;

                    switch (filters.dateFilter) {
                        case 'today':
                            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                            break;
                        case 'tomorrow':
                            const tomorrow = new Date(today);
                            tomorrow.setDate(today.getDate() + 1);
                            startDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate());
                            endDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate() + 1);
                            break;
                        case 'thisWeek':
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - today.getDay());
                            startDate = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
                            endDate = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate() + 7);
                            break;
                        case 'overdue':
                            endDate = today;
                            url += `&completed=eq.false&deadline=lt.${createDateRangeForFilter(endDate, true)}`;
                            break;
                        case 'custom':
                            // ä½¿ç”¨è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
                            if (filters.startDate && filters.endDate) {
                                startDate = new Date(filters.startDate);
                                // endDateéœ€è¦åŠ 1å¤©ï¼Œå› ä¸ºæŸ¥è¯¢æ˜¯ltï¼ˆå°äºï¼‰ï¼Œä¸åŒ…å«å½“å¤©
                                endDate = new Date(filters.endDate);
                                endDate.setDate(endDate.getDate() + 1);
                            } else if (filters.customDate) {
                                // å…¼å®¹æ—§çš„customDateå­—æ®µ
                                startDate = new Date(filters.customDate);
                                endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 1);
                            }
                            break;
                    }

                    if (startDate && endDate && filters.dateFilter !== 'overdue') {
                        const startDateUTC = createDateRangeForFilter(startDate, true);
                        const endDateUTC = createDateRangeForFilter(endDate, true);
                        url += `&deadline=gte.${startDateUTC}&deadline=lt.${endDateUTC}`;
                    }
                }

                // æ’åº
                const sortBy = filters.sortBy || 'created_at';
                const sortOrder = filters.sortOrder === 'asc' ? 'asc' : 'desc';
                url += `&order=${sortBy}.${sortOrder}`;

                console.log('æŸ¥è¯¢URL:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        // å°†æ•°æ®åº“è®°å½•è½¬æ¢ä¸ºæœ¬åœ°ä»»åŠ¡æ ¼å¼
                        tasks = data.map(dbTask => {
                            // ä»é€—å·åˆ†å‰²çš„assigneeå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
                            let assigneesArray = [];
                            if (dbTask.assignee && dbTask.assignee.trim()) {
                                assigneesArray = dbTask.assignee.split(',').map(a => a.trim()).filter(a => a);
                            } else if (dbTask.assignees && Array.isArray(dbTask.assignees)) {
                                assigneesArray = dbTask.assignees;
                            }

                            return {
                                id: dbTask.id,
                                title: dbTask.title,
                                notes: dbTask.notes || '',
                                // notesImages: åˆ—è¡¨æŸ¥è¯¢æ—¶ä¸åŠ è½½å›¾ç‰‡å­—æ®µ
                                assignee: assigneesArray.length > 0 ? assigneesArray[0] : '', // å…¼å®¹å•ä¸ªå®Œæˆäººå­—æ®µ
                                category: dbTask.category || 'work',
                                deadline: dbTask.deadline || '',
                                priority: dbTask.priority || 'medium',
                                assignees: assigneesArray, // ä½¿ç”¨è½¬æ¢åçš„æ•°ç»„
                                completed: dbTask.completed || false,
                                createdAt: dbTask.created_at,
                                completedAt: dbTask.completed_at || null,
                                completedBy: dbTask.completed_by || '',
                                // completionImage: åˆ—è¡¨æŸ¥è¯¢æ—¶ä¸åŠ è½½å›¾ç‰‡å­—æ®µ
                                completionNotes: dbTask.completion_notes || ''
                                // completionImages: åˆ—è¡¨æŸ¥è¯¢æ—¶ä¸åŠ è½½å›¾ç‰‡å­—æ®µ
                            };
                        });

                        console.log('æˆåŠŸä»æ•°æ®åº“åŠ è½½ä»»åŠ¡:', tasks.length, 'ä¸ª');
                        return true;
                    } else {
                        console.warn('æ•°æ®åº“è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
                        return false;
                    }
                } else if (response.status === 404) {
                    console.error('tasksè¡¨ä¸å­˜åœ¨');
                    alert('æ•°æ®åº“è¡¨ç»“æ„æœªå°±ç»ªï¼Œè¯·å…ˆè¿è¡Œè¿ç§»è„šæœ¬');
                    return false;
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
            } catch (error) {
                console.error('ä»æ•°æ®åº“åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message);
                return false;
            } finally {
                // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½éšè—loading
                hideLoading();
            }
        }

        // åˆ›å»ºä»»åŠ¡åˆ°API
        async function createTaskAPI(task) {
            if (!checkSupabaseConfig()) {
                alert('è¯·å…ˆé…ç½®Supabaseè¿æ¥ä¿¡æ¯');
                return false;
            }

            try {
                showLoading('æ­£åœ¨åˆ›å»ºä»»åŠ¡...', 'ä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“');
                // å°†assigneesæ•°ç»„è½¬æ¢ä¸ºé€—å·åˆ†å‰²çš„å­—ç¬¦ä¸²ç”¨äºæ•°æ®åº“å­˜å‚¨
                const assigneeString = task.assignees && task.assignees.length > 0
                    ? task.assignees.join(',')
                    : (task.assignee || null);

                const taskData = {
                    id: task.id,
                    title: task.title,
                    notes: task.notes || null,
                    notes_images: task.notesImages || null, // æ·»åŠ ä»»åŠ¡å¤‡æ³¨å›¾ç‰‡å­—æ®µ
                    assignee: assigneeString, // ä½¿ç”¨é€—å·åˆ†å‰²çš„å­—ç¬¦ä¸²
                    category: task.category || 'work',
                    deadline: convertLocalTimeToUTC(task.deadline),
                    priority: task.priority || 'medium',
                    assignees: task.assignees || null, // ä¿ç•™æ•°ç»„æ ¼å¼ç”¨äºå‰ç«¯
                    completed: task.completed || false,
                    created_at: task.createdAt || getCurrentUTCTimeString(),
                    completed_at: task.completedAt || null,
                    completed_by: task.completedBy || null,
                    completion_notes: task.completionNotes || null,
                    completion_image: task.completionImage || null,
                    completion_images: task.completionImages || null,
                    user_id: DATABASE_CONFIG.userId,
                    data_path: 'tasks'
                };

                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}`, {
                    method: 'POST',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    console.log('æˆåŠŸåˆ›å»ºä»»åŠ¡:', task.title);
                    return true;
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error.message);
                return false;
            } finally {
                hideLoading();
            }
        }

        // æ›´æ–°ä»»åŠ¡åˆ°API
        async function updateTaskAPI(task) {
            if (!checkSupabaseConfig()) {
                alert('è¯·å…ˆé…ç½®Supabaseè¿æ¥ä¿¡æ¯');
                return false;
            }

            try {
                showLoading('æ­£åœ¨æ›´æ–°ä»»åŠ¡...', 'ä¿å­˜æ›´æ”¹åˆ°äº‘ç«¯');
                // å°†assigneesæ•°ç»„è½¬æ¢ä¸ºé€—å·åˆ†å‰²çš„å­—ç¬¦ä¸²ç”¨äºæ•°æ®åº“å­˜å‚¨
                const assigneeString = task.assignees && task.assignees.length > 0
                    ? task.assignees.join(',')
                    : (task.assignee || null);

                const taskData = {
                    title: task.title,
                    notes: task.notes || null,
                    notes_images: task.notesImages || null, // æ·»åŠ ä»»åŠ¡å¤‡æ³¨å›¾ç‰‡å­—æ®µ
                    assignee: assigneeString, // ä½¿ç”¨é€—å·åˆ†å‰²çš„å­—ç¬¦ä¸²
                    category: task.category || 'work',
                    deadline: convertLocalTimeToUTC(task.deadline),
                    priority: task.priority || 'medium',
                    assignees: task.assignees || null, // ä¿ç•™æ•°ç»„æ ¼å¼ç”¨äºå‰ç«¯
                    completed: task.completed || false,
                    completed_at: task.completedAt || null,
                    completed_by: task.completedBy || null,
                    completion_notes: task.completionNotes || null,
                    completion_image: task.completionImage || null,
                    completion_images: task.completionImages || null,
                    updated_at: getCurrentUTCTimeString()
                };

                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}?id=eq.${task.id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    console.log('æˆåŠŸæ›´æ–°ä»»åŠ¡:', task.title);
                    return true;
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('æ›´æ–°ä»»åŠ¡å¤±è´¥:', error);
                alert('æ›´æ–°ä»»åŠ¡å¤±è´¥: ' + error.message);
                return false;
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤ä»»åŠ¡ä»API
        async function deleteTaskAPI(taskId) {
            if (!checkSupabaseConfig()) {
                alert('è¯·å…ˆé…ç½®Supabaseè¿æ¥ä¿¡æ¯');
                return false;
            }

            try {
                showLoading('æ­£åœ¨åˆ é™¤ä»»åŠ¡...', 'ä»äº‘ç«¯ç§»é™¤ä»»åŠ¡');
                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}?id=eq.${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    console.log('æˆåŠŸåˆ é™¤ä»»åŠ¡:', taskId);
                    return true;
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message);
                return false;
            } finally {
                hideLoading();
            }
        }

        // åŒæ­¥ç›¸å…³å‡½æ•°å·²ç§»é™¤


        // å¼ºåˆ¶ä»æ•°æ®åº“è¦†ç›–æœ¬åœ°æ•°æ®ï¼ˆå…¨å±€æµ‹è¯•å‡½æ•°ï¼‰
        window.forceLoadFromDatabase = async function() {
            console.log('å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½æ•°æ®è¦†ç›–æœ¬åœ°...');
            try {
                await checkForUpdatesFromServer();
                console.log('æ•°æ®å·²ä»æ•°æ®åº“è¦†ç›–å®Œæˆ');
            } catch (error) {
                console.error('å¼ºåˆ¶è¦†ç›–å¤±è´¥:', error);
            }
        };

        // æœ¬åœ°å­˜å‚¨å¤‡ä»½å‡½æ•°
        // æœ¬åœ°å­˜å‚¨åŠŸèƒ½å·²ç§»é™¤ï¼Œæ‰€æœ‰æ•°æ®æ“ä½œç›´æ¥é€šè¿‡APIè¿›è¡Œ

        // Androidé€‰æ‹©æ¡†ä¼˜åŒ–å‡½æ•° - å¢å¼ºç‰ˆ
        function optimizeSelectElements() {
            const androidVersion = parseFloat((navigator.userAgent.match(/Android ([\d.]+)/) || [])[1]) || 0;
            console.log(`Android ${androidVersion} é€‰æ‹©æ¡†ä¼˜åŒ–å¼€å§‹`);

            // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ä¼˜åŒ–é€‰æ‹©æ¡†
            setTimeout(() => {
                const selectElements = document.querySelectorAll('select, .filter-select, .form-select');
                console.log(`ä¼˜åŒ– ${selectElements.length} ä¸ªé€‰æ‹©æ¡†å…ƒç´ `);

                selectElements.forEach(select => {
                    // å¼ºåˆ¶è®¾ç½®ä¸ºåŸç”Ÿä¸‹æ‹‰åˆ—è¡¨æ¨¡å¼
                    select.style.setProperty('-webkit-appearance', 'listbox', 'important');
                    select.style.setProperty('-moz-appearance', 'listbox', 'important');
                    select.style.setProperty('appearance', 'listbox', 'important');
                    select.style.setProperty('background-image', 'none', 'important');

                    // Android 14+ ç‰¹æ®Šå¤„ç†
                    if (androidVersion >= 14) {
                        // ç¦ç”¨WebViewçš„è‡ªå®šä¹‰é€‰æ‹©å™¨
                        select.style.setProperty('-webkit-user-select', 'auto', 'important');
                        select.style.setProperty('user-select', 'auto', 'important');

                        // å°è¯•å¤šç§appearanceå€¼
                        select.style.setProperty('-webkit-appearance', 'menulist', 'important');
                        select.style.setProperty('-moz-appearance', 'menulist', 'important');
                        select.style.setProperty('appearance', 'menulist', 'important');
                    }

                    // ç¡®ä¿è§¦æ‘¸å‹å¥½ï¼Œä¸CSSæ ·å¼ä¿æŒä¸€è‡´
                    select.style.setProperty('min-height', '32px', 'important');
                    select.style.setProperty('font-size', '11px', 'important');
                    select.style.setProperty('padding', '5px 8px', 'important');
                    select.style.setProperty('padding-right', '25px', 'important');
                    select.style.setProperty('border', '2px solid #667eea', 'important');
                    select.style.setProperty('border-radius', '8px', 'important');
                    select.style.setProperty('background-color', 'white', 'important');

                    // ç§»é™¤å¯èƒ½çš„è‡ªå®šä¹‰æ ·å¼
                    select.classList.remove('custom-select');

                    // å¼ºåˆ¶è§¦æ‘¸äº‹ä»¶å¤„ç†
                    select.addEventListener('touchstart', function(e) {
                        console.log('é€‰æ‹©æ¡†è§¦æ‘¸å¼€å§‹');
                        this.focus();
                        // å°è¯•ä¸»åŠ¨è§¦å‘clickäº‹ä»¶
                        setTimeout(() => {
                            this.click();
                        }, 50);
                    }, { passive: false });

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç¡®ä¿æ­£å¸¸å¼¹å‡º
                    select.addEventListener('click', function(e) {
                        console.log('é€‰æ‹©æ¡†ç‚¹å‡»äº‹ä»¶');
                        // ç¡®ä¿èšç„¦
                        if (document.activeElement !== this) {
                            this.focus();
                        }
                    }, { passive: false });
                });

                console.log('Androidé€‰æ‹©æ¡†ä¼˜åŒ–å®Œæˆ');
            }, 200);
        }

        // Androidç‰ˆæœ¬æ£€æµ‹å‡½æ•°
        function getAndroidVersion() {
            const isAndroid = /Android/.test(navigator.userAgent);
            if (!isAndroid) return 0;

            const match = navigator.userAgent.match(/Android ([\d.]+)/);
            return match ? parseFloat(match[1]) : 0;
        }

        // æ£€æµ‹æ˜¯å¦ä¸ºAndroid 14åŠä»¥ä¸Šç‰ˆæœ¬
        function isAndroid14() {
            const androidVersion = getAndroidVersion();
            return androidVersion >= 14;
        }

        // Android 14 å…¼å®¹æ€§æ£€æµ‹
        function checkAndroidCompatibility() {
            const isAndroid = /Android/.test(navigator.userAgent);
            const androidVersion = getAndroidVersion();
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            // æ·»åŠ è®¾å¤‡ç±»å‹æ ‡è¯†
            if (isAndroid) {
                document.body.classList.add('android-device');
                console.log(`æ£€æµ‹åˆ° Android ${androidVersion} è®¾å¤‡`);

                // ä¸ºæ‰€æœ‰Androidè®¾å¤‡ä¼˜åŒ–é€‰æ‹©æ¡†
                optimizeSelectElements();

                // ç›‘å¬DOMå˜åŒ–ï¼Œç¡®ä¿æ–°æ·»åŠ çš„é€‰æ‹©æ¡†ä¹Ÿè¢«ä¼˜åŒ–
                if (androidVersion >= 12) {
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
                                    const selects = node.querySelectorAll ?
                                        node.querySelectorAll('select, .filter-select, .form-select') : [];
                                    if (selects.length > 0) {
                                        console.log(`å‘ç°æ–°çš„é€‰æ‹©æ¡†å…ƒç´ : ${selects.length} ä¸ª`);
                                        setTimeout(() => optimizeSelectElements(), 100);
                                    }
                                    // å¦‚æœèŠ‚ç‚¹æœ¬èº«å°±æ˜¯selectå…ƒç´ 
                                    if (node.tagName === 'SELECT' ||
                                        node.classList.contains('filter-select') ||
                                        node.classList.contains('form-select')) {
                                        console.log('å‘ç°æ–°çš„å•ä¸ªé€‰æ‹©æ¡†å…ƒç´ ');
                                        setTimeout(() => optimizeSelectElements(), 100);
                                    }
                                }
                            });
                        });
                    });

                    // å¼€å§‹è§‚å¯Ÿ
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }
            }

            if (isIOS) {
                document.body.classList.add('ios-device');
            }

            // Android 12+ éƒ½éœ€è¦çŠ¶æ€ç­›é€‰æŒ‰é’®ä¿®å¤
            if (isAndroid && androidVersion >= 12) {
                console.log(`æ£€æµ‹åˆ° Android ${androidVersion}+ è®¾å¤‡ï¼Œå¯ç”¨å…¼å®¹æ€§ä¼˜åŒ–`);
                document.body.classList.add('android-14-compat'); // ä½¿ç”¨ç»Ÿä¸€çš„ç±»å

                // ä¸ºAndroid 14æ·»åŠ é¢å¤–çš„CSSå…¼å®¹æ€§
                const style = document.createElement('style');
                style.textContent = `
                    .android-14-compat .action-btn {
                        min-width: 48px !important;
                        min-height: 48px !important;
                        font-size: 16px !important;
                    }

                    .android-14-compat .emoji-icon {
                        font-size: 25px !important;
                        text-shadow:
                            0 3px 6px rgba(0, 0, 0, 0.25) !important,
                            0 1px 3px rgba(0, 0, 0, 0.15) !important;
                        filter: contrast(1.15) brightness(1.08) saturate(1.15) !important;
                    }

                    .android-14-compat .edit-btn:hover .emoji-icon {
                        transform: scale(1.15) translateY(-1px) rotate(5deg) !important;
                        animation: none !important;
                        text-shadow:
                            0 4px 8px rgba(25, 118, 210, 0.4) !important,
                            0 2px 4px rgba(25, 118, 210, 0.2) !important;
                    }

                    .android-14-compat .delete-btn:hover .emoji-icon {
                        transform: scale(1.15) translateY(-1px) rotate(-5deg) !important;
                        animation: none !important;
                        text-shadow:
                            0 4px 8px rgba(211, 47, 47, 0.4) !important,
                            0 2px 4px rgba(211, 47, 47, 0.2) !important;
                    }

                    .android-14-compat .action-btn:active .emoji-icon {
                        transform: scale(0.9) translateY(0.5px) !important;
                        animation: none !important;
                    }
                    .android-14-compat .delete-btn {
                        background: #ffebee !important;
                        border: 2px solid #d32f2f !important;
                    }
                    /* Android 14 çŠ¶æ€ç­›é€‰æŒ‰é’®å¼ºåˆ¶å•è¡Œ */
                    .android-14-compat .status-filter-buttons {
                        display: flex !important;
                        flex-direction: row !important;
                        flex-wrap: nowrap !important;
                        width: 100% !important;
                        gap: 1px !important;
                        align-items: center !important;
                    }
                    .android-14-compat .status-filter-btn {
                        flex: 1 1 33.333% !important;
                        min-width: 0 !important;
                        max-width: 33.333% !important;
                        padding: 5px 1px !important;
                        font-size: 9px !important;
                        line-height: 1.2 !important;
                        border-width: 1px !important;
                        margin: 0 !important;
                        white-space: nowrap !important;
                        overflow: hidden !important;
                        text-overflow: ellipsis !important;
                        box-sizing: border-box !important;
                    }
                    /* Android 12+ é€‰æ‹©æ¡†å¼ºåˆ¶ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
                    .android-14-compat select,
                    .android-14-compat .filter-select,
                    .android-14-compat .form-select {
                        -webkit-appearance: menulist !important;
                        -moz-appearance: menulist !important;
                        appearance: menulist !important;
                        background-image: none !important;
                        padding: 5px 8px !important;
                        padding-right: 25px !important;
                        min-height: 32px !important;
                        font-size: 11px !important;
                        border: 2px solid #667eea !important;
                        border-radius: 8px !important;
                        background-color: white !important;
                        /* å¼ºåˆ¶ç¦ç”¨Android WebViewçš„è‡ªå®šä¹‰é€‰æ‹©å™¨ */
                        -webkit-user-select: auto !important;
                        user-select: auto !important;
                        /* å¼ºåˆ¶ä½¿ç”¨ç³»ç»ŸåŸç”Ÿæ§ä»¶ */
                        -webkit-appearance: listbox !important;
                        -moz-appearance: listbox !important;
                        appearance: listbox !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            console.error('Error message:', e.message);
            console.error('Error file:', e.filename);
            console.error('Error line:', e.lineno);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // æ‰“å°å½“å‰å±å¹•å°ºå¯¸ä¿¡æ¯
        function printScreenSize() {
            const screenInfo = {
                'å±å¹•åˆ†è¾¨ç‡': `${screen.width} x ${screen.height}`,
                'å¯ç”¨å±å¹•å°ºå¯¸': `${screen.availWidth} x ${screen.availHeight}`,
                'çª—å£å†…éƒ¨å°ºå¯¸': `${window.innerWidth} x ${window.innerHeight}`,
                'çª—å£å¤–éƒ¨å°ºå¯¸': `${window.outerWidth} x ${window.outerHeight}`,
                'è®¾å¤‡åƒç´ æ¯”': window.devicePixelRatio,
                'å±å¹•æ–¹å‘': screen.orientation ? screen.orientation.type : 'æœªçŸ¥',
                'è‰²å½©æ·±åº¦': `${screen.colorDepth}ä½`,
                'åƒç´ æ·±åº¦': `${screen.pixelDepth}ä½`
            };

            console.log('ğŸ–¥ï¸ å½“å‰å±å¹•å°ºå¯¸ä¿¡æ¯:');
            console.table(screenInfo);

            // åˆ¤æ–­è®¾å¤‡ç±»å‹
            const isMobile = window.innerWidth <= 768;
            const isSmallMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
            const isDesktop = window.innerWidth > 1024;

            let deviceType = '';
            if (isSmallMobile) deviceType = 'å°å±æ‰‹æœº';
            else if (isMobile) deviceType = 'æ‰‹æœº';
            else if (isTablet) deviceType = 'å¹³æ¿';
            else if (isDesktop) deviceType = 'æ¡Œé¢ç«¯';

            console.log(`ğŸ“± è®¾å¤‡ç±»å‹: ${deviceType}`);
            console.log(`ğŸ“ çª—å£æ¯”ä¾‹: ${(window.innerWidth / window.innerHeight).toFixed(2)}:1`);
        }

        // çª—å£å°ºå¯¸å˜åŒ–æ—¶é‡æ–°æ‰“å°
        window.addEventListener('resize', function() {
            console.log('ğŸ”„ çª—å£å°ºå¯¸å·²æ”¹å˜:');
            printScreenSize();
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, starting initialization');

            // è®¾ç½®åˆå§‹åŒ–æ ‡å¿—ï¼Œé˜²æ­¢åˆå§‹åŒ–æœŸé—´çš„é‡å¤æŸ¥è¯¢
            window.isInitializing = true;

            // æ‰“å°å±å¹•å°ºå¯¸ä¿¡æ¯
            printScreenSize();

            // è°ƒè¯•æƒé™ä¿¡æ¯
            setTimeout(() => {
                console.log('ğŸ” æƒé™é…ç½®çŠ¶æ€:');
                console.table(personalInfo);
                if (personalInfo.enableRoleRestriction) {
                    console.log('âœ… è§’è‰²é™åˆ¶å·²å¯ç”¨ - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ï¼Œä½†åªèƒ½æ“ä½œè‡ªå·±çš„ä»»åŠ¡');
                    if (personalInfo.myAssignee) {
                        console.log(`ğŸ‘¤ å½“å‰èº«ä»½: ${personalInfo.myAssignee}`);
                    } else {
                        console.log('âš ï¸ æœªè®¾ç½®èº«ä»½ï¼Œå°†æ— æ³•æ“ä½œä»»ä½•æœ‰æŒ‡å®šå®Œæˆäººçš„ä»»åŠ¡');
                    }
                } else {
                    console.log('âŒ è§’è‰²é™åˆ¶æœªå¯ç”¨ - å¯ä»¥æ“ä½œæ‰€æœ‰ä»»åŠ¡');
                }
            }, 2000);

            // æ£€æŸ¥Androidå…¼å®¹æ€§
            checkAndroidCompatibility();

            // åˆå§‹åŒ–åœ¨çº¿æ•°æ®åº“
            initializeDatabase();

            // åˆå§‹åŒ–é€šçŸ¥æƒé™
            await initNotificationPermission();

            // æ£€æŸ¥å¹¶æ·»åŠ æ¯æ—¥å¾…åŠï¼ˆåœ¨æ•°æ®åŠ è½½å‰ï¼‰
            // æ³¨æ„: æ¯æ—¥å¾…åŠä»»åŠ¡ç”Ÿæˆå·²ç§»è‡³åå°æœåŠ¡MessageListenerServiceä¸­æ‰§è¡Œ
            // const hasNewDailyTodos = await checkAndAddDailyTodos();

            // è®¾ç½®åˆå§‹ç­›é€‰çŠ¶æ€ï¼ˆéœ€è¦åœ¨åˆå§‹åŒ–æ ‡å¿—æ¸…é™¤å‰è®¾ç½®ï¼‰
            console.log('è®¾ç½®åˆå§‹ç­›é€‰çŠ¶æ€ä¸ºä»Šæ—¥ä»»åŠ¡');

            // ç¡®ä¿è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´è¡Œé»˜è®¤éšè—
            const customDateRangeRow = document.getElementById('customDateRangeRow');
            if (customDateRangeRow) {
                customDateRangeRow.classList.remove('show');
            }

            // åŠ è½½å®Œæˆäººæ•°æ®å¹¶æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            loadAssignees();
            updateCompletedByOptions();
            updateAssigneeFilterOptions();

            // åŠ è½½ä¸ªäººä¿¡æ¯ï¼ˆåœ¨ applyFilters ä¹‹å‰åŠ è½½ï¼Œä»¥ä¾¿è®¾ç½®é»˜è®¤å®Œæˆäººç­›é€‰ï¼‰
            loadPersonalInfo();

            // åº”ç”¨é»˜è®¤ç­›é€‰ï¼šå¦‚æœé…ç½®äº†ä¸ªäººä¿¡æ¯ï¼Œè®¾ç½®å®Œæˆäººç­›é€‰ä¸ºæœ¬äºº
            if (personalInfo.myAssignee) {
                customSelectValues.assigneeFilter = [personalInfo.myAssignee];
                updateCustomSelectDisplay('assigneeFilter');
                updateCustomSelectTags('assigneeFilter');
                updateCustomSelectCheckboxes('assigneeFilter');
                console.log('è®¾ç½®é»˜è®¤å®Œæˆäººç­›é€‰ä¸º:', personalInfo.myAssignee);
            }

            // åˆå§‹åŒ–å®Œæˆï¼Œæ¸…é™¤æ ‡å¿—ï¼Œå…è®¸åç»­çš„ç­›é€‰æŸ¥è¯¢
            window.isInitializing = false;

            // è·³è¿‡å…¨é‡æŸ¥è¯¢ï¼Œç›´æ¥ä½¿ç”¨ç­›é€‰æŸ¥è¯¢ï¼ˆé»˜è®¤ä»Šæ—¥ã€æœªå®Œæˆã€æœ¬äººä»»åŠ¡ï¼‰
            // è¿™æ ·å¯ä»¥é¿å…ä¸å¿…è¦çš„å…¨é‡æŸ¥è¯¢ï¼Œç›´æ¥å¾—åˆ°ç”¨æˆ·æœ€å¸¸ç”¨çš„ä»Šæ—¥ä»»åŠ¡è§†å›¾
            console.log('å¼€å§‹åˆå§‹ç­›é€‰æŸ¥è¯¢ï¼ˆä»Šæ—¥ã€æœªå®Œæˆã€æœ¬äººä»»åŠ¡ï¼‰');
            await applyFilters();
            // åŒæ­¥ç”¨æˆ·è®¾ç½®åˆ°Androidç«¯
            syncUserSettingsToAndroid();
            // åŒæ­¥æ•°æ®åº“é…ç½®åˆ°Androidç«¯
            syncDatabaseConfigToAndroid();

            // é˜²æ­¢ä»»åŠ¡åˆ—è¡¨æ»šåŠ¨æ—¶è§¦å‘bodyæ»šåŠ¨
            const taskList = document.getElementById('taskList');
            if (taskList) {
                taskList.addEventListener('wheel', function(e) {
                    const scrollTop = this.scrollTop;
                    const scrollHeight = this.scrollHeight;
                    const height = this.clientHeight;
                    const wheelDelta = e.deltaY;

                    // å¦‚æœå‘ä¸Šæ»šåŠ¨ä¸”å·²ç»åˆ°é¡¶éƒ¨ï¼Œæˆ–å‘ä¸‹æ»šåŠ¨ä¸”å·²ç»åˆ°åº•éƒ¨ï¼Œåˆ™å…è®¸bodyæ»šåŠ¨
                    if ((wheelDelta < 0 && scrollTop === 0) ||
                        (wheelDelta > 0 && scrollTop + height >= scrollHeight)) {
                        // å…è®¸bodyæ»šåŠ¨
                        return;
                    } else {
                        // é˜»æ­¢bodyæ»šåŠ¨
                        e.stopPropagation();
                    }
                });

                // é˜²æ­¢è§¦æ‘¸æ»šåŠ¨ä¼ æ’­
                taskList.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });

                // æ·»åŠ ä»»åŠ¡å¤‡æ³¨å›¾ç‰‡ç‚¹å‡»äº‹ä»¶å§”æ‰˜
                taskList.addEventListener('click', function(e) {
                    if (e.target.classList.contains('task-notes-image')) {
                        const imageSrc = e.target.getAttribute('data-image-src');
                        const imageName = e.target.getAttribute('data-image-name');
                        if (imageSrc) {
                            showImageModal(imageSrc, imageName);
                        }
                    }
                });
                // æ»šåŠ¨æ—¶è‡ªåŠ¨æŠ˜å ç­›é€‰å™¨
                let lastScrollTop = 0;
                let isFilterCollapsed = false;
                const filterSection = document.querySelector('.filter-section');
                const collapsibleRows = document.querySelectorAll('.collapsible-row');

                taskList.addEventListener('scroll', function(e) {
                    const currentScrollTop = this.scrollTop;
                    const scrollingDown = currentScrollTop > lastScrollTop;

                    if (scrollingDown && currentScrollTop > 50 && !isFilterCollapsed) {
                        // å‘ä¸‹æ»šåŠ¨è¶…è¿‡50pxæ—¶ï¼ŒæŠ˜å ç­›é€‰å™¨çš„å¯æŠ˜å è¡Œ
                        collapsibleRows.forEach(row => {
                            row.classList.add('collapsed');
                        });
                        const toggleBtn = document.getElementById('collapseToggleBtn');
                        if (toggleBtn) {
                            toggleBtn.textContent = 'ğŸ“‹ å±•å¼€ç­›é€‰';
                            toggleBtn.classList.add('active');
                        }
                        isFilterCollapsed = true;
                    } else if (!scrollingDown && currentScrollTop < 30 && isFilterCollapsed) {
                        // å‘ä¸Šæ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘æ—¶ï¼Œå±•å¼€ç­›é€‰å™¨
                        collapsibleRows.forEach(row => {
                            row.classList.remove('collapsed');
                        });
                        const toggleBtn = document.getElementById('collapseToggleBtn');
                        if (toggleBtn) {
                            toggleBtn.textContent = 'ğŸ“‹ æŠ˜å ç­›é€‰';
                            toggleBtn.classList.remove('active');
                        }
                        isFilterCollapsed = false;
                    }

                    lastScrollTop = currentScrollTop;
                });
            }

            // è°ƒè¯•ï¼šæ£€æŸ¥ç•Œé¢å…ƒç´ æ˜¯å¦å­˜åœ¨
            setTimeout(() => {
                const taskView = document.getElementById('taskView');
                const settingsView = document.getElementById('settingsView');
                console.log('é¡µé¢åŠ è½½å®Œæˆåçš„æ£€æŸ¥:');
                console.log('taskViewå…ƒç´ :', taskView);
                console.log('settingsViewå…ƒç´ :', settingsView);
                if (settingsView) {
                    console.log('settingsViewæ ·å¼:', settingsView.style.display);
                    console.log('settingsViewå†…å®¹:', settingsView.innerHTML.substring(0, 200));
                }
            }, 1000);

            // è®¾ç½®é»˜è®¤æˆªæ­¢æ—¶é—´ä¸ºä»Šå¤©23:59
            setDefaultDeadline();

            // åˆå§‹åŒ–ç­›é€‰å™¨
            initializeFilters();

            // åˆå§‹åŒ–å¤šé€‰UIçŠ¶æ€
            initializeMultiSelectUI();

            // æ¸…ç†è¿‡æœŸçš„æ¯æ—¥å¾…åŠä»»åŠ¡
            // æ³¨æ„: æ¸…ç†åŠŸèƒ½ä¿ç•™åœ¨å‰ç«¯ï¼Œç”¨äºæ¸…ç†æœ¬åœ°å­˜å‚¨ä¸­çš„è¿‡æœŸä»»åŠ¡
            cleanupExpiredDailyTodos();

            // å¯åŠ¨å®šæ—¶é€šçŸ¥æ£€æŸ¥å™¨
            startNotificationScheduler();

            // å¯åŠ¨å®šæ—¶æ•°æ®åŒæ­¥
            startDataSyncScheduler();

            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡é€šçŸ¥
            checkAndSendWechatNotification();

            // æ¢å¤æŠ˜å çŠ¶æ€
            restoreCollapsedStates();

            // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨ - ç§»åŠ¨ç«¯è‡ªé€‚åº”
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    console.log('çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´ä»»åŠ¡åˆ—è¡¨å¸ƒå±€');
                    if (enableCompactModeToggle) {
                        const filterCollapsed = localStorage.getItem('filterSectionCollapsed') === 'true';
                        if (filterCollapsed) {
                            adjustTaskItemHeight('normal');
                        } else {
                            adjustTaskItemHeight('compact');
                        }
                    } else {
                        console.log('æ¨¡å¼åˆ‡æ¢å·²ç¦ç”¨ï¼Œæ— éœ€è°ƒæ•´ä»»åŠ¡é¡¹é«˜åº¦');
                    }
                }, 250); // é˜²æŠ–å¤„ç†
            });

            // æ·»åŠ é”®ç›˜äº‹ä»¶
            const taskTitleInput = document.getElementById('taskTitleInput');
            if (taskTitleInput) {
                taskTitleInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addTask();
                    }
                });
            }

            // æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
            const addTaskModal = document.getElementById('addTaskModal');
            const closeAddTaskBtn = document.getElementById('closeAddTaskBtn');
            const cancelAddTaskBtn = document.getElementById('cancelAddTaskBtn');
            const saveAddTaskBtn = document.getElementById('saveAddTaskBtn');
            const addTaskTitle = document.getElementById('addTaskTitle');

            if (closeAddTaskBtn) {
                closeAddTaskBtn.addEventListener('click', closeAddTaskModal);
            }

            if (cancelAddTaskBtn) {
                cancelAddTaskBtn.addEventListener('click', closeAddTaskModal);
            }

            if (saveAddTaskBtn) {
                saveAddTaskBtn.addEventListener('click', addTaskFromModal);
            }

            // æ·»åŠ ä»»åŠ¡æ ‡é¢˜è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            if (addTaskTitle) {
                addTaskTitle.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addTaskFromModal();
                    }
                });
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            if (addTaskModal) {
                addTaskModal.addEventListener('click', function(e) {
                    if (e.target === addTaskModal) {
                        closeAddTaskModal();
                    }
                });
            }

            // ä¸ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†æ·»åŠ å›¾ç‰‡é¢„è§ˆç‚¹å‡»äº‹ä»¶å§”æ‰˜
            if (addTaskModal) {
                addTaskModal.addEventListener('click', function(e) {
                    if (e.target.classList.contains('preview-image-clickable')) {
                        const imageSrc = e.target.getAttribute('data-image-src');
                        const imageName = e.target.getAttribute('data-image-name');
                        if (imageSrc) {
                            showImageModal(imageSrc, imageName);
                        }
                    }
                });
            }
            
            // ç»‘å®šç¼–è¾‘æ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
            const closeEditBtn = document.getElementById('closeEditBtn');
            if (closeEditBtn) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                closeEditBtn.onclick = null;
                closeEditBtn.addEventListener('click', function(e) {
                    console.log('=== å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¼€å§‹ ===');
                    console.log('Event:', e);
                    console.log('Target:', e.target);
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('å…³é—­æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå³å°†è°ƒç”¨closeEditModal');
                    try {
                        closeEditModal();
                        console.log('closeEditModalè°ƒç”¨æˆåŠŸ');
                    } catch (error) {
                        console.error('closeEditModalè°ƒç”¨å¤±è´¥:', error);
                    }
                    console.log('=== å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶ç»“æŸ ===');
                });
                console.log('å…³é—­æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            } else {
                console.error('æœªæ‰¾åˆ°closeEditBtnå…ƒç´ ');
            }

            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                cancelEditBtn.onclick = null;
                cancelEditBtn.addEventListener('click', function(e) {
                    console.log('=== å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¼€å§‹ ===');
                    console.log('Event:', e);
                    console.log('Target:', e.target);
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('å–æ¶ˆæŒ‰é’®è¢«ç‚¹å‡»ï¼Œå³å°†è°ƒç”¨closeEditModal');
                    try {
                        closeEditModal();
                        console.log('closeEditModalè°ƒç”¨æˆåŠŸ');
                    } catch (error) {
                        console.error('closeEditModalè°ƒç”¨å¤±è´¥:', error);
                    }
                    console.log('=== å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶ç»“æŸ ===');
                });
                console.log('å–æ¶ˆæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            } else {
                console.error('æœªæ‰¾åˆ°cancelEditBtnå…ƒç´ ');
            }
            
            const saveEditBtn = document.getElementById('saveEditBtn');
            if (saveEditBtn) {
                saveEditBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»');
                    saveEditTask();
                });
                console.log('ä¿å­˜æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            } else {
                console.error('æœªæ‰¾åˆ°saveEditBtnå…ƒç´ ');
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeEditModal();
                    }
                });

                // ä¸ºç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†æ·»åŠ å›¾ç‰‡é¢„è§ˆç‚¹å‡»äº‹ä»¶å§”æ‰˜
                editModal.addEventListener('click', function(e) {
                    if (e.target.classList.contains('preview-image-clickable')) {
                        const imageSrc = e.target.getAttribute('data-image-src');
                        const imageName = e.target.getAttribute('data-image-name');
                        if (imageSrc) {
                            showImageModal(imageSrc, imageName);
                        }
                    }
                });
            } else {
                console.error('æœªæ‰¾åˆ°editModalå…ƒç´ ï¼Œæ— æ³•ç»‘å®šç‚¹å‡»å¤–éƒ¨å…³é—­äº‹ä»¶');
            }
            
            // ç»‘å®šæ¯æ—¥å¾…åŠè®¾ç½®æŒ‰é’®äº‹ä»¶
            bindDailyTodoEvents();

            // ç»‘å®šå¾®ä¿¡è®¾ç½®æŒ‰é’®äº‹ä»¶
            bindWechatEvents();

            // ç»‘å®šæ•°æ®åº“è®¾ç½®æŒ‰é’®äº‹ä»¶
            bindDatabaseEvents();

            // ç»‘å®šå®Œæˆäººè®¾ç½®æŒ‰é’®äº‹ä»¶
            bindAssigneeEvents();

            // ç»‘å®šä»»åŠ¡å®Œæˆæ¨¡æ€æ¡†äº‹ä»¶
            bindCompleteTaskEvents();

            // ç»‘å®šå›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†äº‹ä»¶
            bindImageViewEvents();

            // åˆå§‹åŒ–è‡ªå®šä¹‰é€‰æ‹©æ¡†ï¼ˆåœ¨æ‰€æœ‰æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®šå®Œæˆåï¼‰
            initializeCustomSelects();

            // æµ‹è¯•æŒ‰é’®æ˜¯å¦å­˜åœ¨
            console.log('=== æŒ‰é’®å­˜åœ¨æ€§æ£€æŸ¥ ===');
            console.log('closeEditBtn:', document.getElementById('closeEditBtn'));
            console.log('cancelEditBtn:', document.getElementById('cancelEditBtn'));
            console.log('saveEditBtn:', document.getElementById('saveEditBtn'));
            console.log('editModal:', document.getElementById('editModal'));

            // å»¶è¿ŸåŒæ­¥ï¼Œç¡®ä¿Androidæ¥å£å·²å‡†å¤‡å¥½
            setTimeout(() => {
                syncUserSettingsToAndroid();
                syncDatabaseConfigToAndroid();
                // è¿è¡Œæ—¶é—´æµ‹è¯•
                testTimeHandling();

                // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ å¤„ç†
                handleImageSelect('addTaskNotesImages', 'addTaskNotesImagesPreview');
                handleImageSelect('editTaskNotesImages', 'editTaskNotesImagesPreview');
            }, 1000);

            // åˆå§‹åŒ–åˆ·æ–°æ‚¬æµ®æŒ‰é’®ï¼ˆæ”¯æŒæ‹–åŠ¨ï¼‰
            const refreshFab = document.getElementById('refreshFab');
            if (refreshFab) {
                let isDragging = false;
                let hasMoved = false;
                let startX = 0;
                let startY = 0;
                let currentX = 0;
                let currentY = 0;
                let initialX = 0;
                let initialY = 0;

                // ä»localStorageè¯»å–ä¿å­˜çš„ä½ç½®
                const savedPosition = localStorage.getItem('refreshFabPosition');
                if (savedPosition) {
                    try {
                        const { right, bottom } = JSON.parse(savedPosition);
                        refreshFab.style.right = right + 'px';
                        refreshFab.style.bottom = bottom + 'px';
                    } catch (e) {
                        console.error('è§£ææ‚¬æµ®çƒä½ç½®å¤±è´¥:', e);
                    }
                }

                // è·å–å½“å‰ä½ç½®
                function getCurrentPosition() {
                    const rect = refreshFab.getBoundingClientRect();
                    return {
                        right: window.innerWidth - rect.right,
                        bottom: window.innerHeight - rect.bottom
                    };
                }

                // é¼ æ ‡/è§¦æ‘¸å¼€å§‹
                function handleStart(e) {
                    isDragging = true;
                    hasMoved = false;
                    refreshFab.classList.add('dragging');

                    const touch = e.type === 'touchstart' ? e.touches[0] : e;
                    startX = touch.clientX;
                    startY = touch.clientY;

                    const pos = getCurrentPosition();
                    initialX = pos.right;
                    initialY = pos.bottom;

                    e.preventDefault();
                }

                // é¼ æ ‡/è§¦æ‘¸ç§»åŠ¨
                function handleMove(e) {
                    if (!isDragging) return;

                    const touch = e.type === 'touchmove' ? e.touches[0] : e;
                    currentX = touch.clientX;
                    currentY = touch.clientY;

                    const deltaX = startX - currentX;
                    const deltaY = startY - currentY; // ä¿®å¤ï¼šYè½´ä¹Ÿåº”è¯¥æ˜¯start - current

                    // åˆ¤æ–­æ˜¯å¦çœŸçš„åœ¨æ‹–åŠ¨ï¼ˆç§»åŠ¨è¶…è¿‡5pxæ‰ç®—æ‹–åŠ¨ï¼‰
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        hasMoved = true;
                    }

                    if (hasMoved) {
                        const newRight = initialX + deltaX;
                        const newBottom = initialY + deltaY;

                        // è¾¹ç•Œæ£€æµ‹
                        const fabWidth = refreshFab.offsetWidth;
                        const fabHeight = refreshFab.offsetHeight;
                        const maxRight = window.innerWidth - fabWidth - 10;
                        const maxBottom = window.innerHeight - fabHeight - 10;

                        const boundedRight = Math.max(10, Math.min(newRight, maxRight));
                        const boundedBottom = Math.max(10, Math.min(newBottom, maxBottom));

                        refreshFab.style.right = boundedRight + 'px';
                        refreshFab.style.bottom = boundedBottom + 'px';
                    }

                    e.preventDefault();
                }

                // é¼ æ ‡/è§¦æ‘¸ç»“æŸ
                function handleEnd(e) {
                    if (!isDragging) return;

                    isDragging = false;
                    refreshFab.classList.remove('dragging');

                    // ä¿å­˜ä½ç½®åˆ°localStorage
                    const pos = getCurrentPosition();
                    localStorage.setItem('refreshFabPosition', JSON.stringify(pos));

                    // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼Œåˆ™è§¦å‘ç‚¹å‡»äº‹ä»¶
                    if (!hasMoved) {
                        handleClick();
                    }

                    e.preventDefault();
                }

                // ç‚¹å‡»äº‹ä»¶ï¼ˆåˆ·æ–°ï¼‰
                async function handleClick() {
                    console.log('åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');

                    // æ·»åŠ æ—‹è½¬åŠ¨ç”»
                    refreshFab.classList.add('refreshing');

                    // ä½¿ç”¨å½“å‰ç­›é€‰æ¡ä»¶é‡æ–°æŸ¥è¯¢
                    await applyFilters();

                    // æ»šåŠ¨åˆ°ä»»åŠ¡åˆ—è¡¨é¡¶éƒ¨
                    const taskList = document.getElementById('taskList');
                    if (taskList) {
                        taskList.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }

                    // ç§»é™¤æ—‹è½¬åŠ¨ç”»
                    setTimeout(() => {
                        refreshFab.classList.remove('refreshing');
                    }, 600);

                    console.log('ä»»åŠ¡åˆ—è¡¨å·²åˆ·æ–°å¹¶æ»šåŠ¨åˆ°é¡¶éƒ¨');
                }

                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                // é¼ æ ‡äº‹ä»¶
                refreshFab.addEventListener('mousedown', handleStart);
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);

                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                refreshFab.addEventListener('touchstart', handleStart, { passive: false });
                document.addEventListener('touchmove', handleMove, { passive: false });
                document.addEventListener('touchend', handleEnd, { passive: false });
            }
        });

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // è®¾ç½®é»˜è®¤æˆªæ­¢æ—¶é—´ä¸ºä»Šå¤©23:59
        function setDefaultDeadline() {
            const deadlineInput = document.getElementById('deadlineInput');
            if (deadlineInput) {
                const today = new Date();
                today.setHours(23, 59, 0, 0);
                // ç”Ÿæˆæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ç”¨äºdatetime-localè¾“å…¥æ¡†ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const hours = String(today.getHours()).padStart(2, '0');
                const minutes = String(today.getMinutes()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}T${hours}:${minutes}`;
                deadlineInput.value = dateString;
            }
        }

        // æ£€æŸ¥ä»»åŠ¡æ ‡é¢˜æ˜¯å¦é‡å¤ï¼ˆä»…æ£€æµ‹å½“æ—¥æˆªæ­¢çš„ä»»åŠ¡ï¼‰
        function checkTaskDuplication(title, excludeCompleted = false, assignee = '') {
            const today = new Date().toDateString();

            return tasks.find(task => {
                if (excludeCompleted && task.completed) return false;

                // åªæ£€æµ‹æœ‰æˆªæ­¢æ—¶é—´ä¸”æˆªæ­¢æ—¶é—´ä¸ºå½“æ—¥çš„ä»»åŠ¡
                if (!task.deadline) return false;
                const taskDate = parseLocalDateTime(task.deadline).toDateString();
                if (taskDate !== today) return false;

                // æ£€æŸ¥æ ‡é¢˜å’Œå®Œæˆäººæ˜¯å¦éƒ½åŒ¹é…
                const titleMatch = task.title.trim().toLowerCase() === title.trim().toLowerCase();

                // æ”¯æŒå¤šå®ŒæˆäººåŒ¹é…
                let assigneeMatch = false;
                if (task.assignees && Array.isArray(task.assignees)) {
                    assigneeMatch = task.assignees.includes(assignee) || (assignee === '' && task.assignees.length === 0);
                } else {
                    assigneeMatch = (task.assignee || '') === assignee;
                }

                return titleMatch && assigneeMatch;
            });
        }

        // æ£€æŸ¥æ¯æ—¥ä»»åŠ¡æ˜¯å¦åº”è¯¥è·³è¿‡åˆ›å»ºï¼ˆæ™ºèƒ½å»é‡ï¼‰
        function checkDailyTaskDuplication(title, targetDateString, assignee = '') {
            // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡é¢˜ã€å®Œæˆäººå’Œæ—¥æœŸçš„æ¯æ—¥ä»»åŠ¡ï¼ˆåŒ…æ‹¬å·²å®Œæˆï¼‰
            const existingDailyTask = tasks.find(t =>
                t.title === title &&
                (t.assignee || '') === assignee &&
                t.isDailyTodo === true &&
                t.deadline &&
                parseLocalDateTime(t.deadline).toDateString() === targetDateString
            );

            if (existingDailyTask) {
                const status = existingDailyTask.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                console.log(`è·³è¿‡åˆ›å»ºé‡å¤çš„æ¯æ—¥ä»»åŠ¡: ${title} (${assignee || 'æœªåˆ†é…'}) (${targetDateString}) - ${status}`);
                return true; // è·³è¿‡ï¼Œå·²å­˜åœ¨ç›¸åŒçš„æ¯æ—¥ä»»åŠ¡
            }

            // 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒæ ‡é¢˜å’Œå®Œæˆäººçš„æ‰‹åŠ¨åˆ›å»ºä»»åŠ¡ï¼ˆåŒä¸€å¤©ï¼ŒåŒ…æ‹¬å·²å®Œæˆï¼‰
            const manualTask = tasks.find(t =>
                t.title === title &&
                (t.assignee || '') === assignee &&
                !t.isDailyTodo &&
                t.deadline &&
                parseLocalDateTime(t.deadline).toDateString() === targetDateString
            );

            if (manualTask) {
                const status = manualTask.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                console.log(`è·³è¿‡åˆ›å»ºæ¯æ—¥ä»»åŠ¡ï¼Œå› ä¸ºå­˜åœ¨æ‰‹åŠ¨åˆ›å»ºçš„åŒååŒäººä»»åŠ¡: ${title} (${assignee || 'æœªåˆ†é…'}) (${targetDateString}) - ${status}`);
                return true; // è·³è¿‡ï¼Œé¿å…ä¸æ‰‹åŠ¨ä»»åŠ¡å†²çª
            }

            // 3. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒæ ‡é¢˜å’Œå®Œæˆäººçš„æœªå®Œæˆä»»åŠ¡ï¼ˆä¸é™ç±»å‹ï¼Œä¸é™æ—¥æœŸï¼‰
            const anyUncompletedTask = tasks.find(t =>
                t.title === title &&
                (t.assignee || '') === assignee &&
                !t.completed
            );

            if (anyUncompletedTask) {
                // å¦‚æœå­˜åœ¨ä½†ä¸åœ¨åŒä¸€å¤©ï¼Œåˆ™å…è®¸åˆ›å»ºï¼ˆç”¨æˆ·å¯èƒ½æƒ³åœ¨ä¸åŒå¤©é‡å¤ç›¸åŒä»»åŠ¡ï¼‰
                if (anyUncompletedTask.deadline) {
                    const existingTaskDate = parseLocalDateTime(anyUncompletedTask.deadline).toDateString();
                    if (existingTaskDate !== targetDateString) {
                        console.log(`å…è®¸åˆ›å»ºæ¯æ—¥ä»»åŠ¡ï¼Œå› ä¸ºç°æœ‰åŒååŒäººä»»åŠ¡åœ¨ä¸åŒæ—¥æœŸ: ${title} (${assignee || 'æœªåˆ†é…'})`);
                        return false; // ä¸è·³è¿‡ï¼Œå…è®¸åˆ›å»º
                    }
                }
            }

            return false; // ä¸è·³è¿‡ï¼Œå…è®¸åˆ›å»º
        }

        // æ˜¾ç¤ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†
        function showAddTaskModal() {
            try {
                console.log('æ‰“å¼€æ–°å¢ä»»åŠ¡é¡µé¢');

                // è·³è½¬åˆ°æ–°å¢ä»»åŠ¡é¡µé¢
                window.location.href = 'task_add.html';
            } catch (error) {
                console.error('æ‰“å¼€æ–°å¢ä»»åŠ¡é¡µé¢æ—¶å‡ºé”™:', error);
                alert('æ‰“å¼€æ–°å¢ä»»åŠ¡é¡µé¢å¤±è´¥ï¼š' + error.message);
            }
        }

        // å…³é—­æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†
        function closeAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
                // æ¸…ç©ºè¡¨å•
                const titleInput = document.getElementById('addTaskTitle');
                const notesInput = document.getElementById('addTaskNotes');
                const deadlineInput = document.getElementById('addTaskDeadline');
                // addTaskAssigneeå…ƒç´ ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤šé€‰ç»„ä»¶

                if (titleInput) titleInput.value = '';
                if (notesInput) notesInput.value = '';
                if (deadlineInput) deadlineInput.value = '';
                // æ¸…ç©ºå¤šé€‰assignee
                clearSelectedAssignees('add');

                // æ¸…ç©ºå›¾ç‰‡æ•°æ®
                clearImagesData();

                // é‡ç½®è‡ªå®šä¹‰é€‰æ‹©å™¨
                customSingleSelectValues.addTaskPriority = 'medium';
                customSingleSelectValues.addTaskCategory = 'work';
                updateCustomSingleSelectDisplay('addTaskPriority');
                updateCustomSingleSelectDisplay('addTaskCategory');
                updateCustomSingleSelectOptions('addTaskPriority');
                updateCustomSingleSelectOptions('addTaskCategory');
            }
        }

        // è®¾ç½®æ·»åŠ ä»»åŠ¡çš„é»˜è®¤æˆªæ­¢æ—¶é—´
        function setDefaultDeadlineForAdd() {
            const deadlineInput = document.getElementById('addTaskDeadline');
            if (deadlineInput) {
                const today = new Date();
                today.setHours(23, 59, 0, 0);
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const hours = String(today.getHours()).padStart(2, '0');
                const minutes = String(today.getMinutes()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}T${hours}:${minutes}`;
                if (deadlineInput) deadlineInput.value = dateString;
            }
        }

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†å‡½æ•°
        let notesImages = []; // å­˜å‚¨ä¸Šä¼ çš„å›¾ç‰‡æ•°æ®

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(inputId, previewContainerId) {
            const input = document.getElementById(inputId);
            const previewContainer = document.getElementById(previewContainerId);

            if (!input || !previewContainer) return;

            input.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageData = {
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                data: e.target.result
                            };

                            // æ·»åŠ åˆ°å…¨å±€æ•°ç»„
                            notesImages.push(imageData);

                            // æ·»åŠ é¢„è§ˆ
                            addImagePreview(previewContainer, imageData, notesImages.length - 1);
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // æ¸…ç©ºinputä»¥å…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
                input.value = '';
            });
        }

        // æ·»åŠ å›¾ç‰‡é¢„è§ˆ
        function addImagePreview(container, imageData, index) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${imageData.data}" alt="${imageData.name}" title="${imageData.name}" class="preview-image-clickable" data-image-src="${imageData.data}" data-image-name="${imageData.name}">
                <button type="button" class="image-preview-remove" onclick="removeImagePreview(${index})">Ã—</button>
            `;
            container.appendChild(previewItem);
        }

        // ç§»é™¤å›¾ç‰‡é¢„è§ˆ
        function removeImagePreview(index) {
            // ä»æ•°ç»„ä¸­ç§»é™¤
            notesImages.splice(index, 1);

            // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¢„è§ˆ
            refreshImagePreviews();
        }

        // åˆ·æ–°å›¾ç‰‡é¢„è§ˆæ˜¾ç¤º
        function refreshImagePreviews() {
            const addPreviewContainer = document.getElementById('addTaskNotesImagesPreview');
            const editPreviewContainer = document.getElementById('editTaskNotesImagesPreview');

            // æ¸…ç©ºå®¹å™¨
            if (addPreviewContainer) addPreviewContainer.innerHTML = '';
            if (editPreviewContainer) editPreviewContainer.innerHTML = '';

            // é‡æ–°æ·»åŠ é¢„è§ˆ
            notesImages.forEach((imageData, index) => {
                if (addPreviewContainer) addImagePreview(addPreviewContainer, imageData, index);
                if (editPreviewContainer) addImagePreview(editPreviewContainer, imageData, index);
            });
        }

        // æ¸…ç©ºå›¾ç‰‡æ•°æ®
        function clearImagesData() {
            notesImages = [];
            const addPreviewContainer = document.getElementById('addTaskNotesImagesPreview');
            const editPreviewContainer = document.getElementById('editTaskNotesImagesPreview');
            if (addPreviewContainer) addPreviewContainer.innerHTML = '';
            if (editPreviewContainer) editPreviewContainer.innerHTML = '';
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä¸­çš„å¤‡æ³¨å›¾ç‰‡
        function renderTaskNotesImages(notesImagesJson) {
            if (!notesImagesJson) return '';

            try {
                let images;
                if (typeof notesImagesJson === 'string') {
                    images = JSON.parse(notesImagesJson);
                } else if (Array.isArray(notesImagesJson)) {
                    images = notesImagesJson;
                } else {
                    return '';
                }

                if (!Array.isArray(images) || images.length === 0) {
                    return '';
                }

                const imagesHtml = images.map((imageData, index) => {
                    if (imageData && imageData.data) {
                        return `<img src="${imageData.data}" alt="${imageData.name || 'å›¾ç‰‡'}" class="task-notes-image" data-image-src="${imageData.data}" data-image-name="${imageData.name || 'å›¾ç‰‡'}">`;
                    }
                    return '';
                }).filter(html => html).join('');

                return imagesHtml ? `<div class="task-notes-images">${imagesHtml}</div>` : '';
            } catch (error) {
                console.warn('æ¸²æŸ“ä»»åŠ¡å¤‡æ³¨å›¾ç‰‡å¤±è´¥:', error);
                return '';
            }
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
        function showImageModal(imageSrc, imageName) {
            // åˆ›å»ºä¸´æ—¶æ¨¡æ€æ¡†æ˜¾ç¤ºå¤§å›¾
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;

            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = imageName;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
            `;

            modal.appendChild(img);
            document.body.appendChild(modal);

            // ç‚¹å‡»å…³é—­
            modal.onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // åŠ è½½ç°æœ‰çš„å¤‡æ³¨å›¾ç‰‡
        function loadExistingNotesImages(notesImagesJson) {
            console.log('loadExistingNotesImages è¢«è°ƒç”¨ï¼Œå‚æ•°:', notesImagesJson);

            // æ¸…ç©ºå½“å‰å›¾ç‰‡æ•°æ®
            clearImagesData();

            if (!notesImagesJson) {
                console.log('notesImagesJson ä¸ºç©ºï¼Œè·³è¿‡åŠ è½½');
                return;
            }

            try {
                // å¦‚æœå·²ç»æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™è§£æ
                let existingImages;
                if (typeof notesImagesJson === 'string') {
                    existingImages = JSON.parse(notesImagesJson);
                } else if (Array.isArray(notesImagesJson)) {
                    existingImages = notesImagesJson;
                } else {
                    console.warn('notesImagesJson æ ¼å¼ä¸æ­£ç¡®:', typeof notesImagesJson, notesImagesJson);
                    return;
                }

                console.log('è§£æåçš„å›¾ç‰‡æ•°æ®:', existingImages);

                if (Array.isArray(existingImages) && existingImages.length > 0) {
                    notesImages = [...existingImages];
                    refreshImagePreviews();
                    console.log('æˆåŠŸåŠ è½½', existingImages.length, 'å¼ å›¾ç‰‡');
                } else {
                    console.log('æ²¡æœ‰å›¾ç‰‡æ•°æ®éœ€è¦åŠ è½½');
                }
            } catch (error) {
                console.error('è§£æå¤‡æ³¨å›¾ç‰‡æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä»æ¨¡æ€æ¡†æ·»åŠ ä»»åŠ¡
        function addTaskFromModal() {
            const titleInput = document.getElementById('addTaskTitle');
            const notesInput = document.getElementById('addTaskNotes');
            const deadlineInput = document.getElementById('addTaskDeadline');
            // ä½¿ç”¨å¤šé€‰ç»„ä»¶è·å–assignee

            if (!titleInput) {
                console.error('æ‰¾ä¸åˆ°ä»»åŠ¡æ ‡é¢˜è¾“å…¥æ¡†å…ƒç´ ');
                alert('é¡µé¢å…ƒç´ æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            const title = titleInput.value.trim();
            if (!title) {
                alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                titleInput.focus();
                return;
            }

            // è·å–å³å°†åˆ›å»ºä»»åŠ¡çš„æˆªæ­¢æ—¶é—´
            const newTaskDeadline = deadlineInput ? deadlineInput.value : '' || null;

            // æ£€æŸ¥ä»»åŠ¡é‡å¤æ€§ï¼ˆåªæ£€æŸ¥æœªå®Œæˆçš„å½“æ—¥ä»»åŠ¡ï¼‰
            const selectedAssigneeList = getSelectedAssignees('add');
            const duplicateTask = checkTaskDuplication(title, true, selectedAssigneeList.join(','));
            if (duplicateTask) {
                const deadlineText = duplicateTask.deadline ?
                    `ï¼Œæˆªæ­¢æ—¶é—´ï¼š${formatDeadline(duplicateTask.deadline)}` : '';
                const categoryText = getCategoryName(duplicateTask.category);
                const priorityText = getPriorityName(duplicateTask.priority);

                const confirmMessage = `ä»Šæ—¥å·²å­˜åœ¨ç›¸åŒåç§°çš„ä»»åŠ¡"${title}"ï¼\n\nç°æœ‰ä»»åŠ¡ä¿¡æ¯ï¼š\n` +
                    `åˆ†ç±»ï¼š${categoryText}\n` +
                    `ä¼˜å…ˆçº§ï¼š${priorityText}${deadlineText}\n\n` +
                    `æ˜¯å¦ä»è¦åˆ›å»ºé‡å¤ä»»åŠ¡ï¼Ÿ`;

                if (!confirm(confirmMessage)) {
                    return; // ç”¨æˆ·é€‰æ‹©ä¸åˆ›å»ºé‡å¤ä»»åŠ¡
                }
            }

            // å¦‚æœæ–°ä»»åŠ¡æ²¡æœ‰æˆªæ­¢æ—¶é—´ï¼Œä½†å½“æ—¥æœ‰åŒåä»»åŠ¡ï¼Œä¹Ÿéœ€è¦æé†’
            if (!newTaskDeadline) {
                const today = new Date().toDateString();
                const sameTitleTask = tasks.find(task =>
                    !task.completed &&
                    task.deadline &&
                    parseLocalDateTime(task.deadline).toDateString() === today &&
                    task.title.trim().toLowerCase() === title.trim().toLowerCase()
                );

                if (sameTitleTask) {
                    const categoryText = getCategoryName(sameTitleTask.category);
                    const priorityText = getPriorityName(sameTitleTask.priority);
                    const deadlineText = formatDeadline(sameTitleTask.deadline);

                    const confirmMessage = `ä»Šæ—¥å·²å­˜åœ¨ç›¸åŒåç§°çš„ä»»åŠ¡"${title}"ï¼\n\nç°æœ‰ä»»åŠ¡ä¿¡æ¯ï¼š\n` +
                        `åˆ†ç±»ï¼š${categoryText}\n` +
                        `ä¼˜å…ˆçº§ï¼š${priorityText}\n` +
                        `æˆªæ­¢æ—¶é—´ï¼š${deadlineText}\n\n` +
                        `æ‚¨åˆ›å»ºçš„æ–°ä»»åŠ¡æ²¡æœ‰æˆªæ­¢æ—¶é—´ï¼Œæ˜¯å¦ä»è¦åˆ›å»ºï¼Ÿ`;

                    if (!confirm(confirmMessage)) {
                        return; // ç”¨æˆ·é€‰æ‹©ä¸åˆ›å»ºé‡å¤ä»»åŠ¡
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰è®¾ç½®æˆªæ­¢æ—¥æœŸï¼Œé»˜è®¤è®¾ç½®ä¸ºä»Šæ—¥23:59
            let taskDeadline = deadlineInput ? deadlineInput.value : '';
            if (!taskDeadline) {
                const today = new Date();
                today.setHours(23, 59, 0, 0);
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const hours = String(today.getHours()).padStart(2, '0');
                const minutes = String(today.getMinutes()).padStart(2, '0');
                taskDeadline = `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            const task = {
                id: generateId(),
                title: title,
                notes: notesInput ? notesInput.value.trim() || '' : '',
                notesImages: JSON.stringify(notesImages), // æ·»åŠ å¤‡æ³¨å›¾ç‰‡æ•°æ®
                completed: false,
                priority: getCustomSingleSelectValue('addTaskPriority'),
                category: getCustomSingleSelectValue('addTaskCategory'),
                deadline: taskDeadline,
                assignees: selectedAssigneeList, // å¤šé€‰å®Œæˆäººå­—æ®µ
                assignee: selectedAssigneeList.length > 0 ? selectedAssigneeList[0] : null, // å…¼å®¹æ—§ç‰ˆæœ¬
                createdAt: getCurrentUTCTimeString(),
                completedAt: null,
                completedBy: null
            };

            // è°ƒç”¨APIåˆ›å»ºä»»åŠ¡
            createTaskAPI(task).then(() => {
                // APIè°ƒç”¨æˆåŠŸåï¼Œé‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                loadTasksFromAPI().then(() => {
                    renderTasks();
                    // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
                    updateAssigneeFilterOptions();
                    // å…³é—­æ¨¡æ€æ¡†
                    closeAddTaskModal();
                });
            }).catch(error => {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // æ·»åŠ ä»»åŠ¡ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥å…¼å®¹å…¶ä»–åœ°æ–¹çš„è°ƒç”¨ï¼‰
        function addTask() {
            const taskTitleInput = document.getElementById('taskTitleInput');
            const taskNotesInput = document.getElementById('taskNotesInput');
            const prioritySelect = document.getElementById('prioritySelect');
            const categorySelect = document.getElementById('categorySelect');
            const deadlineInput = document.getElementById('deadlineInput');

            if (!taskTitleInput) {
                console.error('æ‰¾ä¸åˆ°ä»»åŠ¡æ ‡é¢˜è¾“å…¥æ¡†å…ƒç´ ');
                alert('é¡µé¢å…ƒç´ æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            const title = taskTitleInput.value.trim();
            if (!title) {
                alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                return;
            }

            // è·å–å³å°†åˆ›å»ºä»»åŠ¡çš„æˆªæ­¢æ—¶é—´
            const newTaskDeadline = deadlineInput ? deadlineInput ? deadlineInput.value : '' || null : null;

            // æ£€æŸ¥ä»»åŠ¡é‡å¤æ€§ï¼ˆåªæ£€æŸ¥æœªå®Œæˆçš„å½“æ—¥ä»»åŠ¡ï¼‰
            const duplicateTask = checkTaskDuplication(title, true, '');
            if (duplicateTask) {
                const deadlineText = duplicateTask.deadline ?
                    `ï¼Œæˆªæ­¢æ—¶é—´ï¼š${formatDeadline(duplicateTask.deadline)}` : '';
                const categoryText = getCategoryName(duplicateTask.category);
                const priorityText = getPriorityName(duplicateTask.priority);

                const confirmMessage = `ä»Šæ—¥å·²å­˜åœ¨ç›¸åŒåç§°çš„ä»»åŠ¡"${title}"ï¼\n\nç°æœ‰ä»»åŠ¡ä¿¡æ¯ï¼š\n` +
                    `åˆ†ç±»ï¼š${categoryText}\n` +
                    `ä¼˜å…ˆçº§ï¼š${priorityText}${deadlineText}\n\n` +
                    `æ˜¯å¦ä»è¦åˆ›å»ºé‡å¤ä»»åŠ¡ï¼Ÿ`;

                if (!confirm(confirmMessage)) {
                    return; // ç”¨æˆ·é€‰æ‹©ä¸åˆ›å»ºé‡å¤ä»»åŠ¡
                }
            }

            // å¦‚æœæ–°ä»»åŠ¡æ²¡æœ‰æˆªæ­¢æ—¶é—´ï¼Œä½†å½“æ—¥æœ‰åŒåä»»åŠ¡ï¼Œä¹Ÿéœ€è¦æé†’
            if (!newTaskDeadline) {
                const today = new Date().toDateString();
                const sameTitleTask = tasks.find(task =>
                    !task.completed &&
                    task.deadline &&
                    parseLocalDateTime(task.deadline).toDateString() === today &&
                    task.title.trim().toLowerCase() === title.trim().toLowerCase()
                );

                if (sameTitleTask) {
                    const categoryText = getCategoryName(sameTitleTask.category);
                    const priorityText = getPriorityName(sameTitleTask.priority);
                    const deadlineText = formatDeadline(sameTitleTask.deadline);

                    const confirmMessage = `ä»Šæ—¥å·²å­˜åœ¨ç›¸åŒåç§°çš„ä»»åŠ¡"${title}"ï¼\n\nç°æœ‰ä»»åŠ¡ä¿¡æ¯ï¼š\n` +
                        `åˆ†ç±»ï¼š${categoryText}\n` +
                        `ä¼˜å…ˆçº§ï¼š${priorityText}\n` +
                        `æˆªæ­¢æ—¶é—´ï¼š${deadlineText}\n\n` +
                        `æ‚¨åˆ›å»ºçš„æ–°ä»»åŠ¡æ²¡æœ‰æˆªæ­¢æ—¶é—´ï¼Œæ˜¯å¦ä»è¦åˆ›å»ºï¼Ÿ`;

                    if (!confirm(confirmMessage)) {
                        return; // ç”¨æˆ·é€‰æ‹©ä¸åˆ›å»ºé‡å¤ä»»åŠ¡
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰è®¾ç½®æˆªæ­¢æ—¥æœŸï¼Œé»˜è®¤è®¾ç½®ä¸ºä»Šæ—¥23:59
            let taskDeadline = deadlineInput ? deadlineInput.value : '';
            if (!taskDeadline) {
                const today = new Date();
                today.setHours(23, 59, 0, 0);
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const hours = String(today.getHours()).padStart(2, '0');
                const minutes = String(today.getMinutes()).padStart(2, '0');
                taskDeadline = `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            const task = {
                id: generateId(),
                title: title,
                notes: taskNotesInput ? taskNotesInput.value.trim() || '' : '',
                completed: false,
                priority: prioritySelect ? prioritySelect.value : 'medium',
                category: categorySelect ? categorySelect.value : 'work',
                deadline: taskDeadline,
                createdAt: getCurrentUTCTimeString(),
                completedAt: null,
                completedBy: null
            };

            // è°ƒç”¨APIåˆ›å»ºä»»åŠ¡
            createTaskAPI(task).then(() => {
                // APIè°ƒç”¨æˆåŠŸåï¼Œé‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                loadTasksFromAPI().then(() => {
                    renderTasks();
                    // æ¸…ç©ºè¾“å…¥
                    if (taskTitleInput) taskTitleInput.value = '';
                    if (taskNotesInput) taskNotesInput.value = '';
                    // é‡æ–°è®¾ç½®é»˜è®¤æˆªæ­¢æ—¶é—´
                    setDefaultDeadline();
                });
            }).catch(error => {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function toggleTask(id) {
            try {
                console.log('åˆ‡æ¢ä»»åŠ¡çŠ¶æ€ï¼Œid:', id);
                const task = tasks.find(t => t.id === id);
                if (task) {
                    // æƒé™æ£€æŸ¥ï¼šå¦‚æœå¯ç”¨äº†è§’è‰²é™åˆ¶ä¸”ç”¨æˆ·æœ‰èº«ä»½ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥æ“ä½œæ­¤ä»»åŠ¡
                    if (personalInfo.enableRoleRestriction && personalInfo.myAssignee) {
                        let canOperate = false;
                        if (task.assignees && Array.isArray(task.assignees)) {
                            canOperate = task.assignees.length === 0 || task.assignees.includes(personalInfo.myAssignee);
                        } else {
                            canOperate = !task.assignee || task.assignee === personalInfo.myAssignee;
                        }

                        if (!canOperate) {
                            const assignedTo = task.assignees && task.assignees.length > 0 ? task.assignees.join(', ') : task.assignee;
                            alert(`æ­¤ä»»åŠ¡åˆ†é…ç»™äº†"${assignedTo}"ï¼Œæ‚¨æ— æ³•æ“ä½œæ­¤ä»»åŠ¡ã€‚`);
                            return;
                        }
                    }

                    if (task.completed) {
                        // å¦‚æœå·²å®Œæˆï¼Œç›´æ¥åˆ‡æ¢ä¸ºæœªå®Œæˆ
                        task.completed = false;
                        task.completedAt = null;
                        task.completionNotes = null;
                        task.completionImage = null;
                        task.completedBy = null;

                        // é€šè¿‡APIæ›´æ–°ä»»åŠ¡
                        updateTaskAPI(task).then(success => {
                            if (success) {
                                renderTasks();
                            }
                        });

                        renderTasks();
                        console.log('ä»»åŠ¡å·²æ ‡è®°ä¸ºæœªå®Œæˆ:', task.title);
                    } else {
                        // å¦‚æœæœªå®Œæˆï¼Œæ˜¾ç¤ºå®Œæˆç¡®è®¤æ¨¡æ€æ¡†
                        showCompleteTaskModal(task);
                    }
                } else {
                    console.error('æœªæ‰¾åˆ°ä»»åŠ¡ï¼Œid:', id);
                }
            } catch (error) {
                console.error('åˆ‡æ¢ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™:', error);
            }
        }

        // æ˜¾ç¤ºä»»åŠ¡å®Œæˆæ¨¡æ€æ¡†
        function showCompleteTaskModal(task) {
            try {
                console.log('æ‰“å¼€ä»»åŠ¡å®Œæˆé¡µé¢ï¼Œtask:', task);

                // å°†ä»»åŠ¡æ•°æ®ä¿å­˜åˆ° localStorage
                localStorage.setItem('completeTask_' + task.id, JSON.stringify(task));

                // è·³è½¬åˆ°å®Œæˆé¡µé¢
                window.location.href = 'task_complete.html?id=' + task.id;
            } catch (error) {
                console.error('æ‰“å¼€å®Œæˆé¡µé¢æ—¶å‡ºé”™:', error);
                alert('æ‰“å¼€å®Œæˆé¡µé¢å¤±è´¥ï¼š' + error.message);
            }
        }

        // åº”ç”¨Android 14ä¸Šä¼ ä¿®å¤ - ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸æ”¹å˜æ ·å¼
        function applyAndroid14UploadFix() {
            console.log('åº”ç”¨Android 14ä¸Šä¼ ä¿®å¤ - ä¿æŒåŸæœ‰æ ·å¼ï¼Œä»…å¢å¼ºç‚¹å‡»åŠŸèƒ½');

            // ä¸åšä»»ä½•æ ·å¼ä¿®æ”¹ï¼Œä¿æŒåŸæœ‰çš„ä¸Šä¼ åŒºåŸŸå¤–è§‚
            // æ­¤å‡½æ•°ç°åœ¨ä»…ä½œä¸ºå ä½ç¬¦ï¼Œå®é™…çš„ç‚¹å‡»å¤„ç†å·²åœ¨bindAndroid14ImageUploadEventsä¸­å®ç°
            console.log('Android 14ä¸Šä¼ ä¿®å¤å·²åº”ç”¨ - ä¿æŒåŸæ ·å¼ï¼Œä»…å¢å¼ºåŠŸèƒ½');

        }

        // å…³é—­ä»»åŠ¡å®Œæˆæ¨¡æ€æ¡†
        function closeCompleteTaskModal() {
            const modal = document.getElementById('completeTaskModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
                // æ¸…ç†ä¸´æ—¶æ•°æ®
                delete modal.dataset.taskId;
                resetCompleteForm();
            }
        }

        // é‡ç½®å®Œæˆè¡¨å•
        function resetCompleteForm() {
            const completeNotes = document.getElementById('completeNotes');

            if (completeNotes) completeNotes.value = '';

            // é‡ç½®ä¸¤å¼ å›¾ç‰‡çš„ä¸Šä¼ åŒºåŸŸ
            for (let i = 1; i <= 2; i++) {
                const uploadPlaceholder = document.getElementById(`uploadPlaceholder${i}`);
                const imagePreview = document.getElementById(`imagePreview${i}`);
                const completeImageInput = document.getElementById(`completeImageInput${i}`);
                const previewImage = document.getElementById(`previewImage${i}`);

                if (uploadPlaceholder) uploadPlaceholder.style.display = 'flex';
                if (imagePreview) imagePreview.style.display = 'none';
                if (completeImageInput) completeImageInput.value = '';
                if (previewImage) previewImage.src = '';
            }

            // ç§»é™¤æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„completedå’Œhas-imageç±»ï¼Œæ¢å¤æ­£å¸¸çŠ¶æ€
            const uploadAreas = document.querySelectorAll('.image-upload-area');
            uploadAreas.forEach(area => {
                area.classList.remove('completed', 'has-image');
            });
        }

        // é€‰æ‹©å®Œæˆå›¾ç‰‡
        function selectCompleteImage(imageIndex = 1) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å›¾ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ä¸æ‰§è¡Œ
            const imagePreview = document.getElementById(`imagePreview${imageIndex}`);
            const previewImage = document.getElementById(`previewImage${imageIndex}`);

            if (imagePreview && imagePreview.style.display === 'block' &&
                previewImage && previewImage.src) {
                console.log(`å›¾ç‰‡${imageIndex}å·²å­˜åœ¨ï¼Œæ— æ³•é‡å¤ä¸Šä¼ ã€‚è¯·å…ˆåˆ é™¤ç°æœ‰å›¾ç‰‡ã€‚`);
                return;
            }

            const input = document.getElementById(`completeImageInput${imageIndex}`);
            if (input) {
                input.click();
            }
        }

        // å¤„ç†å®Œæˆå›¾ç‰‡é€‰æ‹©
        function handleCompleteImageSelect(event, imageIndex = 1) {
            const file = event.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBé™åˆ¶ï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                // å‹ç¼©å›¾ç‰‡ä»¥ç¬¦åˆæ•°æ®åº“å¤§å°é™åˆ¶
                compressImage(file, (compressedDataUrl) => {
                    const uploadPlaceholder = document.getElementById(`uploadPlaceholder${imageIndex}`);
                    const imagePreview = document.getElementById(`imagePreview${imageIndex}`);
                    const previewImage = document.getElementById(`previewImage${imageIndex}`);

                    if (uploadPlaceholder && imagePreview && previewImage) {
                        uploadPlaceholder.style.display = 'none';
                        imagePreview.style.display = 'block';
                        previewImage.src = compressedDataUrl;

                        // ç»™ä¸Šä¼ åŒºåŸŸæ·»åŠ has-imageç±»ï¼Œé˜²æ­¢é‡å¤ä¸Šä¼ 
                        const uploadArea = document.querySelector(`.image-upload-area:nth-child(${imageIndex})`);
                        if (uploadArea) {
                            uploadArea.classList.add('has-image');
                        }

                        const sizeKB = Math.round(compressedDataUrl.length / 1024);
                        console.log(`å›¾ç‰‡${imageIndex}å‹ç¼©å®Œæˆï¼Œå¤§å°:`, sizeKB, 'KB');

                        if (sizeKB > 50) {
                            console.warn(`å›¾ç‰‡${imageIndex}å‹ç¼©åä»ç„¶è¾ƒå¤§ï¼Œå¯èƒ½å½±å“æ•°æ®åº“å­˜å‚¨`);
                        }
                    }
                });
            }
        }

        // æ¸…ç†æ—§çš„å®Œæˆå›¾ç‰‡ä»¥å‡å°‘æ•°æ®å¤§å°
        function cleanupOldImages() {
            const completedTasksWithImages = tasks.filter(task =>
                task.completed && task.completionImage && task.completedAt
            );

            if (completedTasksWithImages.length === 0) {
                console.log('æ²¡æœ‰æ‰¾åˆ°å¯æ¸…ç†çš„å®Œæˆå›¾ç‰‡');
                return;
            }

            // æŒ‰å®Œæˆæ—¶é—´æ’åºï¼Œä¿ç•™æœ€æ–°çš„5å¼ å›¾ç‰‡
            completedTasksWithImages.sort((a, b) => parseLocalDateTime(b.completedAt) - parseLocalDateTime(a.completedAt));

            let cleanedCount = 0;
            const keepCount = 5; // ä¿ç•™æœ€æ–°çš„5å¼ å›¾ç‰‡

            for (let i = keepCount; i < completedTasksWithImages.length; i++) {
                const task = completedTasksWithImages[i];
                if (task.completionImage) {
                    task.completionImage = null;
                    cleanedCount++;
                }
            }

            console.log(`å·²æ¸…ç†${cleanedCount}å¼ æ—§çš„å®Œæˆå›¾ç‰‡ï¼Œä¿ç•™æœ€æ–°çš„${Math.min(keepCount, completedTasksWithImages.length)}å¼ `);
        }

        // å›¾ç‰‡å‹ç¼©å‡½æ•°
        function compressImage(file, callback, maxWidth = 800, quality = 0.7) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                let { width, height } = img;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
                ctx.drawImage(img, 0, 0, width, height);

                // è½¬æ¢ä¸ºbase64ï¼Œä½¿ç”¨æŒ‡å®šè´¨é‡
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                // æ£€æŸ¥å‹ç¼©åå¤§å°ï¼Œå¦‚æœè¿˜æ˜¯å¤ªå¤§å°±è¿›ä¸€æ­¥å‹ç¼©
                const sizeKB = Math.round(compressedDataUrl.length / 1024);

                if (sizeKB > 60 && quality > 0.3) {
                    // å¦‚æœè¿˜æ˜¯å¤ªå¤§ä¸”è´¨é‡è¿˜èƒ½é™ä½ï¼Œé€’å½’å‹ç¼©
                    compressImage(file, callback, Math.max(600, maxWidth * 0.8), quality * 0.8);
                } else {
                    callback(compressedDataUrl);
                }
            };

            img.src = URL.createObjectURL(file);
        }

        // ç§»é™¤å®Œæˆå›¾ç‰‡
        function removeCompleteImage(imageIndex = 1) {
            const uploadPlaceholder = document.getElementById(`uploadPlaceholder${imageIndex}`);
            const imagePreview = document.getElementById(`imagePreview${imageIndex}`);
            const completeImageInput = document.getElementById(`completeImageInput${imageIndex}`);

            if (uploadPlaceholder && imagePreview && completeImageInput) {
                uploadPlaceholder.style.display = 'flex';
                imagePreview.style.display = 'none';
                completeImageInput.value = '';

                // æ¸…ç©ºå›¾ç‰‡src
                const previewImage = document.getElementById(`previewImage${imageIndex}`);
                if (previewImage) {
                    previewImage.src = '';
                }

                // ç§»é™¤has-imageç±»ï¼Œé‡æ–°å¯ç”¨ä¸Šä¼ åŠŸèƒ½
                const uploadArea = document.querySelector(`.image-upload-area:nth-child(${imageIndex})`);
                if (uploadArea) {
                    uploadArea.classList.remove('has-image');
                }
            }
        }

        // ç¡®è®¤å®Œæˆä»»åŠ¡
        function confirmCompleteTask() {
            const modal = document.getElementById('completeTaskModal');
            const taskId = modal ? modal.dataset.taskId : null;

            if (!taskId) {
                console.error('æœªæ‰¾åˆ°ä»»åŠ¡ID');
                return;
            }

            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                console.error('æœªæ‰¾åˆ°ä»»åŠ¡');
                return;
            }

            const completeNotes = document.getElementById('completeNotes');
            const previewImage1 = document.getElementById('previewImage1');
            const previewImage2 = document.getElementById('previewImage2');

            console.log('å®Œæˆä»»åŠ¡è°ƒè¯•ä¿¡æ¯:');
            console.log('previewImage1å­˜åœ¨:', !!previewImage1);
            console.log('previewImage2å­˜åœ¨:', !!previewImage2);
            console.log('å›¾ç‰‡1ç±»å‹æ£€æŸ¥:', previewImage1 && previewImage1.src ? previewImage1.src.startsWith('data:image/') : false);
            console.log('å›¾ç‰‡2ç±»å‹æ£€æŸ¥:', previewImage2 && previewImage2.src ? previewImage2.src.startsWith('data:image/') : false);

            // æ ‡è®°ä»»åŠ¡ä¸ºå®Œæˆ
            task.completed = true;
            task.completedAt = getCurrentUTCTimeString();


            // æ·»åŠ å®Œæˆå¤‡æ³¨
            if (completeNotes && completeNotes.value.trim()) {
                task.completionNotes = completeNotes.value.trim();
            }

            // æ›´æ–°å®Œæˆäººä¿¡æ¯
            const selectedCompleteAssignees = getSelectedAssignees('complete');
            if (selectedCompleteAssignees.length > 0) {
                task.assignees = selectedCompleteAssignees;
                task.assignee = selectedCompleteAssignees[0]; // ä¿æŒå‘åå…¼å®¹
            }

            // æ·»åŠ å®Œæˆå›¾ç‰‡ï¼ˆæ”¯æŒä¸¤å¼ å›¾ç‰‡ï¼‰
            const completionImages = [];

            if (previewImage1 && previewImage1.src && previewImage1.src.startsWith('data:image/')) {
                completionImages.push(previewImage1.src);
                console.log('ä¿å­˜å®Œæˆå›¾ç‰‡1ï¼Œå¤§å°:', Math.round(previewImage1.src.length / 1024), 'KB');
            }

            if (previewImage2 && previewImage2.src && previewImage2.src.startsWith('data:image/')) {
                completionImages.push(previewImage2.src);
                console.log('ä¿å­˜å®Œæˆå›¾ç‰‡2ï¼Œå¤§å°:', Math.round(previewImage2.src.length / 1024), 'KB');
            }

            if (completionImages.length > 0) {
                task.completionImages = completionImages;
                // ä¸ºäº†å‘åå…¼å®¹ï¼Œå¦‚æœåªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œä¹Ÿä¿å­˜åˆ°åŸæ¥çš„å­—æ®µ
                if (completionImages.length === 1) {
                    task.completionImage = completionImages[0];
                }
                console.log(`ä¿å­˜äº† ${completionImages.length} å¼ å®Œæˆå›¾ç‰‡`);
            } else {
                console.log('æ²¡æœ‰å›¾ç‰‡éœ€è¦ä¿å­˜');
            }

            // è°ƒç”¨APIæ›´æ–°ä»»åŠ¡çŠ¶æ€
            updateTaskAPI(task).then(() => {
                console.log('ä»»åŠ¡å®ŒæˆçŠ¶æ€APIæ›´æ–°æˆåŠŸ');

                // å‘é€ä»»åŠ¡å®Œæˆé€šçŸ¥
                sendTaskCompletedNotification(task.title);

                // APIè°ƒç”¨æˆåŠŸåï¼Œé‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                loadTasksFromAPI().then(() => {
                    renderTasks();
                    console.log('ä»»åŠ¡å®Œæˆæ“ä½œæˆåŠŸ');
                });
            }).catch(error => {
                console.error('æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€å¤±è´¥:', error);
                alert('æ ‡è®°ä»»åŠ¡å®Œæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            });

            // ç»™æ–‡ä»¶é€‰æ‹©åŒºåŸŸæ·»åŠ completedç±»ï¼Œé˜²æ­¢è¯¯è§¦
            const uploadAreas = document.querySelectorAll('.image-upload-area');
            uploadAreas.forEach(area => {
                area.classList.add('completed');
            });

            closeCompleteTaskModal();

            console.log('ä»»åŠ¡å·²å®Œæˆ:', task.title);
            console.log('å®Œæˆå›¾ç‰‡å·²ä¿å­˜:', !!task.completionImage);
            console.log('å®Œæˆå¤‡æ³¨å·²ä¿å­˜:', !!task.completionNotes);

            // æ˜¾ç¤ºå®Œæˆæç¤º
            showSyncNotification(`ğŸ‰ ä»»åŠ¡"${task.title}"å·²å®Œæˆï¼`);

            // å‘é€ä»»åŠ¡å®Œæˆæ¶ˆæ¯ç»™å…¶ä»–äººï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
            sendTaskCompletionMessages(task);
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async function viewTaskDetail(taskId) {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            showLoading('æ­£åœ¨åŠ è½½è¯¦æƒ…...', 'è·å–å®Œæ•´ä»»åŠ¡ä¿¡æ¯');

            try {
                // ä»APIè·å–å®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯ï¼ˆåŒ…æ‹¬å›¾ç‰‡å­—æ®µï¼‰
                const url = `${DATABASE_CONFIG.supabaseUrl}/rest/v1/${DATABASE_CONFIG.tableName}?id=eq.${taskId}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const dbTask = data[0];

                        // è½¬æ¢æ•°æ®æ ¼å¼
                        let assigneesArray = [];
                        if (dbTask.assignee && dbTask.assignee.trim()) {
                            assigneesArray = dbTask.assignee.split(',').map(a => a.trim()).filter(a => a);
                        } else if (dbTask.assignees && Array.isArray(dbTask.assignees)) {
                            assigneesArray = dbTask.assignees;
                        }

                        const task = {
                            id: dbTask.id,
                            title: dbTask.title,
                            notes: dbTask.notes || '',
                            notesImages: dbTask.notes_images || null,
                            assignee: assigneesArray.length > 0 ? assigneesArray[0] : '',
                            category: dbTask.category || 'work',
                            deadline: dbTask.deadline || '',
                            priority: dbTask.priority || 'medium',
                            assignees: assigneesArray,
                            completed: dbTask.completed || false,
                            createdAt: dbTask.created_at,
                            completedAt: dbTask.completed_at || null,
                            completedBy: dbTask.completed_by || '',
                            completionImage: dbTask.completion_image || '',
                            completionNotes: dbTask.completion_notes || '',
                            completionImages: dbTask.completion_images || []
                        };

                        // ä¿å­˜å®Œæ•´ä»»åŠ¡æ•°æ®åˆ° localStorage
                        localStorage.setItem('viewTask_' + taskId, JSON.stringify(task));

                        // è·³è½¬åˆ°ä»»åŠ¡è¯¦æƒ…é¡µé¢
                        window.location.href = 'task_detail.html?id=' + taskId;
                    } else {
                        console.error('æœªæ‰¾åˆ°ä»»åŠ¡:', taskId);
                        alert('æœªæ‰¾åˆ°è¯¥ä»»åŠ¡');
                    }
                } else {
                    console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', response.status);
                    alert('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¼‚å¸¸:', error);
                alert('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æŸ¥çœ‹å®Œæˆå›¾ç‰‡
        function viewCompletionImage(taskId, imageIndex = 0) {
            const task = tasks.find(t => t.id === taskId);

            // æ”¯æŒæ–°æ—§æ ¼å¼çš„å›¾ç‰‡æ•°æ®
            let images = [];
            if (task.completionImages && Array.isArray(task.completionImages)) {
                images = task.completionImages;
            } else if (task.completionImage) {
                images = [task.completionImage];
            }

            if (!task || images.length === 0) {
                console.error('æœªæ‰¾åˆ°ä»»åŠ¡æˆ–å®Œæˆå›¾ç‰‡');
                return;
            }

            // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
            imageIndex = Math.max(0, Math.min(imageIndex, images.length - 1));

            const modal = document.getElementById('imageViewModal');
            const viewImage = document.getElementById('viewImage');
            const imageTaskInfo = document.getElementById('imageTaskInfo');
            const imageCompletionInfo = document.getElementById('imageCompletionInfo');

            if (modal && viewImage && imageTaskInfo && imageCompletionInfo) {
                // è®¾ç½®å›¾ç‰‡
                viewImage.src = images[imageIndex];

                // è®¾ç½®ä»»åŠ¡ä¿¡æ¯ï¼ˆåŒ…å«å›¾ç‰‡ç´¢å¼•ä¿¡æ¯ï¼‰
                const imageInfo = images.length > 1 ? ` (${imageIndex + 1}/${images.length})` : '';
                imageTaskInfo.textContent = `ä»»åŠ¡ï¼š${task.title}${imageInfo}`;

                // è®¾ç½®å®Œæˆä¿¡æ¯
                let completionInfo = '';
                if (task.completedAt) {
                    completionInfo += `å®Œæˆæ—¶é—´ï¼š${parseLocalDateTime(task.completedAt).toLocaleString('zh-CN')}`;
                }
                if (task.completionNotes) {
                    completionInfo += `\nå®Œæˆå¤‡æ³¨ï¼š${task.completionNotes}`;
                }
                imageCompletionInfo.textContent = completionInfo;

                // ä¿å­˜å½“å‰æŸ¥çœ‹çŠ¶æ€ä»¥ä¾¿å¯¼èˆª
                modal.dataset.taskId = taskId;
                modal.dataset.currentIndex = imageIndex;
                modal.dataset.totalImages = images.length;

                // æ·»åŠ å¯¼èˆªæ§åˆ¶
                addImageNavigation(modal, images.length > 1);

                lockScroll(); // é”å®šé¡µé¢æ»šåŠ¨
                modal.style.display = 'flex';
            }
        }

        // æ·»åŠ å›¾ç‰‡å¯¼èˆªåŠŸèƒ½
        function addImageNavigation(modal, showNavigation) {
            // ç§»é™¤ç°æœ‰çš„å¯¼èˆªæŒ‰é’®
            const existingNav = modal.querySelector('.image-navigation');
            if (existingNav) {
                existingNav.remove();
            }

            if (!showNavigation) return;

            // åˆ›å»ºå¯¼èˆªæ§åˆ¶
            const navigation = document.createElement('div');
            navigation.className = 'image-navigation';
            navigation.innerHTML = `
                <button class="nav-btn prev-btn" onclick="navigateImage(-1)">â€¹</button>
                <button class="nav-btn next-btn" onclick="navigateImage(1)">â€º</button>
            `;

            modal.appendChild(navigation);
        }

        // å›¾ç‰‡å¯¼èˆªå‡½æ•°
        function navigateImage(direction) {
            const modal = document.getElementById('imageViewModal');
            const taskId = modal.dataset.taskId;
            const currentIndex = parseInt(modal.dataset.currentIndex);
            const totalImages = parseInt(modal.dataset.totalImages);

            let newIndex = currentIndex + direction;

            // å¾ªç¯å¯¼èˆª
            if (newIndex < 0) {
                newIndex = totalImages - 1;
            } else if (newIndex >= totalImages) {
                newIndex = 0;
            }

            viewCompletionImage(taskId, newIndex);
        }

        // å…³é—­å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†
        function closeImageViewModal() {
            const modal = document.getElementById('imageViewModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';

                // æ¸…ç†å¯¼èˆªæŒ‰é’®
                const navigation = modal.querySelector('.image-navigation');
                if (navigation) {
                    navigation.remove();
                }

                // æ¸…ç†æ•°æ®å±æ€§
                delete modal.dataset.taskId;
                delete modal.dataset.currentIndex;
                delete modal.dataset.totalImages;
            }
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ï¼ˆAndroid 14å¤‡ç”¨æ–¹æ¡ˆï¼‰
        function customConfirm(message, callback) {
            // é˜²æ­¢é‡å¤åˆ›å»ºå¯¹è¯æ¡†
            if (document.querySelector('.custom-confirm-overlay')) {
                return;
            }

            // åˆ›å»ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const overlay = document.createElement('div');
            overlay.className = 'custom-confirm-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 12000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                animation: fadeIn 0.2s ease-out;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 320px;
                width: 90%;
                text-align: center;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                transform: scale(0.9);
                animation: scaleIn 0.2s ease-out forwards;
            `;

            dialog.innerHTML = `
                <div style="margin-bottom: 24px; font-size: 16px; color: #333; line-height: 1.5;">${message}</div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="confirmCancel" style="
                        padding: 12px 24px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        background: #f8f9fa;
                        color: #666;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        min-width: 80px;
                        min-height: 44px;
                        transition: all 0.2s;
                        -webkit-tap-highlight-color: transparent;
                        touch-action: manipulation;
                    ">å–æ¶ˆ</button>
                    <button id="confirmOk" style="
                        padding: 12px 24px;
                        border: none;
                        border-radius: 8px;
                        background: #d32f2f;
                        color: white;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        min-width: 80px;
                        min-height: 44px;
                        transition: all 0.2s;
                        -webkit-tap-highlight-color: transparent;
                        touch-action: manipulation;
                    ">ç¡®å®š</button>
                </div>
            `;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes scaleIn {
                    from { transform: scale(0.9); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }
                .custom-confirm-overlay button:hover {
                    transform: translateY(-1px);
                }
                .custom-confirm-overlay button:active {
                    transform: translateY(0) scale(0.98);
                }
                .custom-confirm-overlay #confirmCancel:hover {
                    background: #e9ecef;
                    border-color: #adb5bd;
                }
                .custom-confirm-overlay #confirmOk:hover {
                    background: #c62828;
                }
            `;
            document.head.appendChild(style);

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            const okBtn = dialog.querySelector('#confirmOk');
            const cancelBtn = dialog.querySelector('#confirmCancel');
            let dialogHandled = false;

            function cleanup() {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
                if (document.head.contains(style)) {
                    document.head.removeChild(style);
                }
            }

            function handleResult(result) {
                if (dialogHandled) return;
                dialogHandled = true;
                cleanup();
                setTimeout(() => callback(result), 10);
            }

            console.log('è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æŒ‰é’®äº‹ä»¶ç»‘å®š - é‡æ–°ç¼–å†™');

            // ç®€å•å¯é çš„äº‹ä»¶ç»‘å®š
            okBtn.addEventListener('click', function(e) {
                console.log('ç¡®è®¤å¯¹è¯æ¡† - ç¡®å®šæŒ‰é’®ç‚¹å‡»');
                e.preventDefault();
                e.stopPropagation();
                if (!dialogHandled) {
                    handleResult(true);
                }
            });

            cancelBtn.addEventListener('click', function(e) {
                console.log('ç¡®è®¤å¯¹è¯æ¡† - å–æ¶ˆæŒ‰é’®ç‚¹å‡»');
                e.preventDefault();
                e.stopPropagation();
                if (!dialogHandled) {
                    handleResult(false);
                }
            });

            // ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ
            okBtn.addEventListener('touchend', function(e) {
                console.log('ç¡®è®¤å¯¹è¯æ¡† - ç¡®å®šæŒ‰é’®è§¦æ‘¸');
                e.preventDefault();
                e.stopPropagation();
                if (!dialogHandled) {
                    handleResult(true);
                }
            });

            cancelBtn.addEventListener('touchend', function(e) {
                console.log('ç¡®è®¤å¯¹è¯æ¡† - å–æ¶ˆæŒ‰é’®è§¦æ‘¸');
                e.preventDefault();
                e.stopPropagation();
                if (!dialogHandled) {
                    handleResult(false);
                }
            });

            // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆæ·»åŠ å»¶è¿Ÿé˜²æ­¢æ„å¤–è§¦å‘ï¼‰
            setTimeout(() => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay && !dialogHandled) {
                        handleResult(false);
                    }
                });
            }, 300);

            // é”®ç›˜æ”¯æŒ
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape' && !dialogHandled) {
                    document.removeEventListener('keydown', escapeHandler);
                    handleResult(false);
                }
            });

            // èšç„¦åˆ°å–æ¶ˆæŒ‰é’®ï¼Œé¿å…æ„å¤–ç¡®è®¤
            setTimeout(() => {
                if (!dialogHandled) {
                    cancelBtn.focus();
                }
            }, 100);
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(id) {
            console.log('å¼€å§‹åˆ é™¤ä»»åŠ¡ï¼ŒID:', id);

            function handleConfirmResult(shouldDelete) {
                if (shouldDelete) {
                    console.log('ç”¨æˆ·ç¡®è®¤åˆ é™¤ä»»åŠ¡ID:', id);
                    // è°ƒç”¨APIåˆ é™¤ä»»åŠ¡
                    deleteTaskAPI(id).then(() => {
                        console.log('APIåˆ é™¤æˆåŠŸï¼Œä»æœ¬åœ°ä»»åŠ¡åˆ—è¡¨ç§»é™¤');
                        // ä»æœ¬åœ°ä»»åŠ¡æ•°ç»„ä¸­ç§»é™¤ï¼Œé¿å…å…¨é‡æŸ¥è¯¢
                        const index = tasks.findIndex(t => t.id === id);
                        if (index !== -1) {
                            tasks.splice(index, 1);
                        }
                        // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                        renderTasks();
                        updateStats();
                        console.log('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
                    }).catch(error => {
                        console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                        alert('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                } else {
                    console.log('ç”¨æˆ·å–æ¶ˆåˆ é™¤æ“ä½œ');
                }
            }

            // æ£€æµ‹Androidè®¾å¤‡å’Œç‰ˆæœ¬
            const isAndroid = /Android/i.test(navigator.userAgent);
            const androidVersion = isAndroid ? parseFloat((navigator.userAgent.match(/Android ([\d.]+)/) || [])[1]) : 0;
            const forceCustomDialog = isAndroid && androidVersion >= 14;

            if (forceCustomDialog) {
                // Android 14+ å¼ºåˆ¶ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†
                console.log('æ£€æµ‹åˆ°Android 14+ï¼Œä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†');
                customConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ', handleConfirmResult);
                return;
            }

            // å…¶ä»–è®¾å¤‡å°è¯•ä½¿ç”¨åŸç”Ÿconfirm
            try {
                if (typeof confirm === 'function') {
                    console.log('ä½¿ç”¨åŸç”Ÿç¡®è®¤å¯¹è¯æ¡†');
                    const result = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ');
                    handleConfirmResult(result);
                    return;
                }
            } catch (error) {
                console.error('åŸç”Ÿconfirmå¯¹è¯æ¡†å‡ºé”™:', error);
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†
            console.log('ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
            customConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ', handleConfirmResult);
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function editTask(id) {
            try {
                console.log('ç¼–è¾‘ä»»åŠ¡ï¼Œid:', id);
                const task = tasks.find(t => t.id === id);
                if (!task) {
                    console.error('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„ä»»åŠ¡ï¼Œid:', id);
                    alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„ä»»åŠ¡');
                    return;
                }

                // å°†ä»»åŠ¡æ•°æ®ä¿å­˜åˆ° localStorage
                localStorage.setItem('editTask_' + id, JSON.stringify(task));

                // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
                window.location.href = 'task_edit.html?id=' + id;
            } catch (error) {
                console.error('æ‰“å¼€ç¼–è¾‘é¡µé¢æ—¶å‡ºé”™:', error);
                alert('æ‰“å¼€ç¼–è¾‘é¡µé¢å¤±è´¥ï¼š' + error.message);
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            console.log('closeEditModalå‡½æ•°è¢«è°ƒç”¨');
            const editModal = document.getElementById('editModal');
            if (editModal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                editModal.style.display = 'none';
                console.log('ç¼–è¾‘æ¨¡æ€æ¡†å·²å…³é—­');
            } else {
                console.error('æœªæ‰¾åˆ°editModalå…ƒç´ ï¼Œæ— æ³•å…³é—­');
            }
            editingTaskId = null;
            console.log('editingTaskIdå·²é‡ç½®ä¸ºnull');
        }

        // ä¿å­˜ç¼–è¾‘çš„ä»»åŠ¡
        function saveEditTask() {
            try {
                console.log('=== saveEditTaskå‡½æ•°å¼€å§‹æ‰§è¡Œ ===');
                console.log('editingTaskId:', editingTaskId);
                console.log('å½“å‰tasksæ•°ç»„é•¿åº¦:', tasks.length);

                // æ£€æŸ¥ç¼–è¾‘æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
                const editModal = document.getElementById('editModal');
                if (!editModal || editModal.style.display === 'none') {
                    console.error('ç¼–è¾‘æ¨¡æ€æ¡†æœªæ‰“å¼€æˆ–ä¸å­˜åœ¨');
                    alert('ç¼–è¾‘æ¨¡æ€æ¡†æœªæ­£ç¡®æ‰“å¼€');
                    return;
                }
                console.log('ç¼–è¾‘æ¨¡æ€æ¡†çŠ¶æ€æ­£å¸¸');

                if (!editingTaskId) {
                    console.error('editingTaskIdä¸ºç©º');
                    alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„ä»»åŠ¡ID');
                    return;
                }
                
                const task = tasks.find(t => t.id === editingTaskId);
                if (!task) {
                    console.error('æœªæ‰¾åˆ°idä¸º', editingTaskId, 'çš„ä»»åŠ¡');
                    alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„ä»»åŠ¡');
                    return;
                }

                console.log('æ‰¾åˆ°è¦ç¼–è¾‘çš„ä»»åŠ¡:', task);
                console.log('å¼€å§‹æŸ¥æ‰¾è¡¨å•å…ƒç´ ...');

                const editTaskTitle = document.getElementById('editTaskTitle');
                const editTaskNotes = document.getElementById('editTaskNotes');
                const editDeadline = document.getElementById('editDeadline');

                console.log('è¡¨å•å…ƒç´ æŸ¥æ‰¾ç»“æœ:', {
                    editTaskTitle: !!editTaskTitle,
                    editTaskNotes: !!editTaskNotes,
                    editDeadline: !!editDeadline
                });

                // æ£€æŸ¥å¿…éœ€çš„è¡¨å•å…ƒç´ 
                if (!editTaskTitle || !editTaskNotes || !editDeadline) {
                    console.error('åŸºæœ¬ç¼–è¾‘è¡¨å•å…ƒç´ æœªæ‰¾åˆ°:', {
                        editTaskTitle: !!editTaskTitle,
                        editTaskNotes: !!editTaskNotes,
                        editDeadline: !!editDeadline
                    });
                    alert('ç¼–è¾‘è¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // æ£€æŸ¥è‡ªå®šä¹‰é€‰æ‹©å™¨æ˜¯å¦å­˜åœ¨
                const priorityDisplay = document.getElementById('editPriorityDisplay');
                const categoryDisplay = document.getElementById('editCategoryDisplay');
                if (!priorityDisplay || !categoryDisplay) {
                    console.error('è‡ªå®šä¹‰é€‰æ‹©å™¨å…ƒç´ æœªæ‰¾åˆ°:', {
                        priorityDisplay: !!priorityDisplay,
                        categoryDisplay: !!categoryDisplay
                    });
                    alert('ç¼–è¾‘è¡¨å•é€‰æ‹©å™¨æœªæ‰¾åˆ°');
                    return;
                }
                
                const title = editTaskTitle.value.trim();
                if (!title) {
                    alert('ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                    return;
                }

                // æ£€æŸ¥ç¼–è¾‘åçš„æ ‡é¢˜æ˜¯å¦ä¸å…¶ä»–å½“æ—¥ä»»åŠ¡é‡å¤ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„ä»»åŠ¡å’Œå·²å®Œæˆçš„ä»»åŠ¡ï¼‰
                const today = new Date().toDateString();
                const duplicateTask = tasks.find(t => {
                    if (t.id === editingTaskId || t.completed) return false;

                    // åªæ£€æµ‹æœ‰æˆªæ­¢æ—¶é—´ä¸”æˆªæ­¢æ—¶é—´ä¸ºå½“æ—¥çš„ä»»åŠ¡
                    if (!t.deadline) return false;
                    const taskDate = parseLocalDateTime(t.deadline).toDateString();
                    if (taskDate !== today) return false;

                    return t.title.trim().toLowerCase() === title.trim().toLowerCase();
                });

                if (duplicateTask) {
                    const deadlineText = duplicateTask.deadline ?
                        `ï¼Œæˆªæ­¢æ—¶é—´ï¼š${formatDeadline(duplicateTask.deadline)}` : '';
                    const categoryText = getCategoryName(duplicateTask.category);
                    const priorityText = getPriorityName(duplicateTask.priority);

                    const confirmMessage = `ä¿®æ”¹åçš„ä»»åŠ¡æ ‡é¢˜"${title}"ä¸ä»Šæ—¥ç°æœ‰ä»»åŠ¡é‡å¤ï¼\n\né‡å¤ä»»åŠ¡ä¿¡æ¯ï¼š\n` +
                        `åˆ†ç±»ï¼š${categoryText}\n` +
                        `ä¼˜å…ˆçº§ï¼š${priorityText}${deadlineText}\n\n` +
                        `æ˜¯å¦ä»è¦ä¿å­˜æ­¤ä¿®æ”¹ï¼Ÿ`;

                    if (!confirm(confirmMessage)) {
                        return; // ç”¨æˆ·é€‰æ‹©ä¸ä¿å­˜é‡å¤æ ‡é¢˜
                    }
                }

                // æ›´æ–°ä»»åŠ¡
                task.title = title;
                task.notes = editTaskNotes.value.trim();
                task.notesImages = JSON.stringify(notesImages); // æ›´æ–°å¤‡æ³¨å›¾ç‰‡æ•°æ®
                task.priority = getCustomSingleSelectValue('editPriority');
                task.category = getCustomSingleSelectValue('editCategory');
                task.deadline = editDeadline.value || null;

                // ä½¿ç”¨å¤šé€‰å®ŒæˆäººåŠŸèƒ½
                const selectedEditAssignees = getSelectedAssignees('edit');
                task.assignees = selectedEditAssignees;
                task.assignee = selectedEditAssignees.length > 0 ? selectedEditAssignees[0] : null; // ä¿æŒå‘åå…¼å®¹

                task.updatedAt = getCurrentUTCTimeString();
                
                console.log('æ›´æ–°åçš„ä»»åŠ¡:', task);

                console.log('å¼€å§‹è°ƒç”¨APIä¿å­˜...');
                // è°ƒç”¨APIæ›´æ–°ä»»åŠ¡
                updateTaskAPI(task).then(() => {
                    console.log('APIè°ƒç”¨æˆåŠŸï¼Œé‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨');
                    // APIè°ƒç”¨æˆåŠŸåï¼Œé‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    loadTasksFromAPI().then(() => {
                        renderTasks();
                        console.log('åˆ—è¡¨å·²é‡æ–°æ¸²æŸ“');
                        closeEditModal();
                        console.log('æ¨¡æ€æ¡†å·²å…³é—­');
                        console.log('ä»»åŠ¡ä¿å­˜æˆåŠŸ');
                    });
                }).catch(error => {
                    console.error('æ›´æ–°ä»»åŠ¡å¤±è´¥:', error);
                    alert('æ›´æ–°ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            } catch (error) {
                console.error('ä¿å­˜ä»»åŠ¡æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆå§‹åŒ–ç­›é€‰å™¨
        function initializeFilters() {
            const dateFilter = document.getElementById('dateFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const sortFilter = document.getElementById('sortFilter');
            const sortOrderFilter = document.getElementById('sortOrderFilter');

            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    currentDateFilter = this.value;
                    const customDateGroup = document.getElementById('customDateGroup');
                    if (this.value === 'custom') {
                        customDateGroup.style.display = 'flex';
                    } else {
                        customDateGroup.style.display = 'none';
                        customDate = null;
                    }
                    renderTasks(true); // ä¿æŒæ»šåŠ¨ä½ç½®
                });
                dateFilter.value = 'today';
            }

            if (priorityFilter) {
                priorityFilter.addEventListener('change', function() {
                    currentPriorityFilter = this.value;
                    renderTasks(true); // ä¿æŒæ»šåŠ¨ä½ç½®
                });
            }

            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    currentCategoryFilter = this.value;
                    renderTasks(true); // ä¿æŒæ»šåŠ¨ä½ç½®
                });
            }


            if (sortFilter) {
                sortFilter.addEventListener('change', function() {
                    currentSortBy = this.value;
                    renderTasks(true); // ä¿æŒæ»šåŠ¨ä½ç½®
                });
                sortFilter.value = 'deadline';
            }

            if (sortOrderFilter) {
                sortOrderFilter.addEventListener('change', function() {
                    currentSortOrder = this.value;
                    renderTasks(true); // ä¿æŒæ»šåŠ¨ä½ç½®
                });
                sortOrderFilter.value = 'asc';
            }

            // æ—¶é—´èŒƒå›´é€‰æ‹©å·²ç§»é™¤customDatePickerç›¸å…³ä»£ç 
        }

        // æ¸…é™¤æ‰€æœ‰ç­›é€‰
        function clearAllFilters() {
            currentDateFilter = 'all';
            currentPriorityFilter = 'all';
            currentCategoryFilter = 'all';
            currentFilter = 'all';
            currentSortBy = 'deadline';
            currentSortOrder = 'asc';
            customDate = null;

            const dateFilter = document.getElementById('dateFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const sortFilter = document.getElementById('sortFilter');
            const sortOrderFilter = document.getElementById('sortOrderFilter');
            const customDateRangeRow = document.getElementById('customDateRangeRow');

            if (dateFilter) dateFilter.value = 'all';
            if (priorityFilter) priorityFilter.value = 'all';
            if (categoryFilter) categoryFilter.value = 'all';
            if (sortFilter) sortFilter.value = 'deadline';
            if (sortOrderFilter) sortOrderFilter.value = 'asc';

            // éšè—å¹¶é‡ç½®æ—¶é—´èŒƒå›´é€‰æ‹©è¡Œ
            if (customDateRangeRow) {
                customDateRangeRow.classList.remove('show');
                const startDateInput = document.getElementById('startDateInput');
                const endDateInput = document.getElementById('endDateInput');
                if (startDateInput) startDateInput.value = '';
                if (endDateInput) endDateInput.value = '';
            }

            // æ›´æ–°çŠ¶æ€æŒ‰é’®
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const filterAllBtn = document.getElementById('filterAll');
            if (filterAllBtn) filterAllBtn.classList.add('active');

            renderTasks();
        }

        // è®¾ç½®è¿‡æ»¤å™¨
        function setFilter(filter) {
            currentFilter = filter;

            // æ›´æ–°çŠ¶æ€ç­›é€‰æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`.status-filter-btn[data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            renderTasks();
        }

        // æ¸…ç©ºå·²å®Œæˆä»»åŠ¡
        function clearCompleted() {
            const completedCount = tasks.filter(t => t.completed).length;
            if (completedCount === 0) {
                alert('æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…ç©º ${completedCount} ä¸ªå·²å®Œæˆçš„ä»»åŠ¡å—ï¼Ÿ`)) {
                // æ‰¾åˆ°æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡ID
                const completedTaskIds = tasks.filter(t => t.completed).map(t => t.id);

                // æ‰¹é‡åˆ é™¤APIè°ƒç”¨
                const deletePromises = completedTaskIds.map(id => deleteTaskAPI(id));

                Promise.all(deletePromises).then(() => {
                    console.log('æ‰¹é‡åˆ é™¤å·²å®Œæˆä»»åŠ¡æˆåŠŸ');
                    // ä»æœ¬åœ°ä»»åŠ¡æ•°ç»„ä¸­ç§»é™¤å·²åˆ é™¤çš„ä»»åŠ¡ï¼Œé¿å…å…¨é‡æŸ¥è¯¢
                    tasks = tasks.filter(t => !completedTaskIds.includes(t.id));
                    // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                    renderTasks();
                    updateStats();
                    alert(`æˆåŠŸåˆ é™¤ ${completedCount} ä¸ªå·²å®Œæˆä»»åŠ¡`);
                }).catch(error => {
                    console.error('æ‰¹é‡åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                    alert('åˆ é™¤å·²å®Œæˆä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks(preserveScrollPosition = false) {
            console.log('renderTaskså‡½æ•°è¢«è°ƒç”¨');
            console.log('tasksæ•°ç»„:', tasks);
            console.log('å½“å‰ä»»åŠ¡æ•°é‡:', tasks ? tasks.length : 'tasksæœªå®šä¹‰');
            console.log('å½“å‰è¿‡æ»¤å™¨:', currentFilter);

            // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰å™¨è¾“å…¥æ¡†å­˜åœ¨ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨ç»Ÿä¸€çš„ç­›é€‰é€»è¾‘
            const keywordSearch = document.getElementById('keywordSearch');
            const dateFilter = document.getElementById('dateFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilterContainer');
            const assigneeFilter = document.getElementById('assigneeFilterContainer');

            // å¦‚æœæ–°çš„ç­›é€‰å™¨å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨applyFiltersç»Ÿä¸€å¤„ç†
            // ä½†æ˜¯åœ¨æ—¥æœŸé€‰æ‹©è¿‡ç¨‹ä¸­æˆ–åˆå§‹åŒ–æœŸé—´ä¸è‡ªåŠ¨è§¦å‘ç­›é€‰
            if ((keywordSearch || dateFilter || priorityFilter || categoryFilter || statusFilter || assigneeFilter) &&
                !isDateSelectionInProgress && !window.isInitializing) {
                console.log('æ£€æµ‹åˆ°æ–°ç­›é€‰å™¨å­˜åœ¨ï¼Œä½¿ç”¨ç»Ÿä¸€ç­›é€‰é€»è¾‘');
                applyFilters();
                return;
            }

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆåªåœ¨éœ€è¦æ—¶ï¼‰
            const scrollTop = preserveScrollPosition ? (window.pageYOffset || document.documentElement.scrollTop) : 0;

            if (!tasks) {
                console.error('tasksæ•°ç»„æœªå®šä¹‰');
                return;
            }

            const taskList = document.getElementById('taskList');

            if (!taskList) {
                console.error('æœªæ‰¾åˆ°taskListå…ƒç´ ');
                return;
            }

            // è¿‡æ»¤ä»»åŠ¡ - ä»…ç”¨äºå‘åå…¼å®¹
            let filteredTasks = [...tasks]; // åˆ›å»ºå‰¯æœ¬é¿å…ä¿®æ”¹åŸæ•°ç»„
            console.log('è¿‡æ»¤å‰ä»»åŠ¡æ•°é‡:', filteredTasks.length);
            
            try {
                // æŒ‰çŠ¶æ€è¿‡æ»¤
                if (currentFilter === 'active') {
                    filteredTasks = filteredTasks.filter(t => !t.completed);
                } else if (currentFilter === 'completed') {
                    filteredTasks = filteredTasks.filter(t => t.completed);
                }
                
                // æŒ‰æ—¥æœŸè¿‡æ»¤
                if (currentDateFilter !== 'all') {
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.deadline) return currentDateFilter === 'all';
                        
                        const taskDate = parseLocalDateTime(task.deadline);
                        const today = new Date();
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        
                        switch (currentDateFilter) {
                            case 'today':
                                return taskDate.toDateString() === today.toDateString();
                            case 'tomorrow':
                                return taskDate.toDateString() === tomorrow.toDateString();
                            case 'week':
                                const weekFromNow = new Date(today);
                                weekFromNow.setDate(today.getDate() + 7);
                                return taskDate >= today && taskDate <= weekFromNow;
                            case 'overdue':
                                return isTaskOverdue(task.deadline) && !task.completed;
                            case 'custom':
                                if (customDate) {
                                    const selectedDate = new Date(customDate);
                                    return taskDate.toDateString() === selectedDate.toDateString();
                                }
                                return true;
                            default:
                                return true;
                        }
                    });
                }
                
                // æŒ‰ä¼˜å…ˆçº§è¿‡æ»¤
                if (currentPriorityFilter !== 'all') {
                    filteredTasks = filteredTasks.filter(t => t.priority === currentPriorityFilter);
                }
                
                // æŒ‰åˆ†ç±»è¿‡æ»¤
                if (currentCategoryFilter !== 'all') {
                    filteredTasks = filteredTasks.filter(t => t.category === currentCategoryFilter);
                }


                // è§’è‰²æƒé™ï¼šæ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡ï¼Œä½†åœ¨UIä¸ŠåŒºåˆ†æ“ä½œæƒé™
                // ä¸å†è¿‡æ»¤ä»»åŠ¡ï¼Œè®©ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
                // æ“ä½œæƒé™åœ¨æŒ‰é’®æ¸²æŸ“æ—¶æ§åˆ¶

                console.log('è¿‡æ»¤åä»»åŠ¡æ•°é‡:', filteredTasks.length);
            } catch (error) {
                console.error('è¿‡æ»¤ä»»åŠ¡æ—¶å‡ºé”™:', error);
                filteredTasks = tasks;
            }

            // æ’åºä»»åŠ¡
            try {
                filteredTasks.sort((a, b) => {
                    let result = 0;

                    switch (currentSortBy) {
                        case 'deadline':
                            // æˆªæ­¢æ—¶é—´æ’åº - ä¼˜å…ˆæ˜¾ç¤ºæœ‰æˆªæ­¢æ—¶é—´çš„ä»»åŠ¡
                            if (!a.deadline && !b.deadline) result = 0;
                            else if (!a.deadline) result = 1;
                            else if (!b.deadline) result = -1;
                            else result = new Date(a.deadline) - new Date(b.deadline);
                            break;

                        case 'priority':
                            // ä¼˜å…ˆçº§æ’åº - é«˜ä¼˜å…ˆçº§åœ¨å‰
                            const priorityOrder = { high: 3, medium: 2, low: 1 };
                            result = (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                            break;

                        case 'created':
                            // åˆ›å»ºæ—¶é—´æ’åº - æ–°åˆ›å»ºçš„åœ¨å‰
                            result = new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                            break;

                        case 'category':
                            // åˆ†ç±»æ’åº - æŒ‰å­—æ¯é¡ºåº
                            result = (a.category || '').localeCompare(b.category || '');
                            break;

                        default:
                            result = 0;
                    }

                    // åº”ç”¨æ’åºé¡ºåº
                    return currentSortOrder === 'desc' ? -result : result;
                });
                console.log('æ’åºå®Œæˆï¼Œæ’åºæ–¹å¼:', currentSortBy);
            } catch (error) {
                console.error('æ’åºä»»åŠ¡æ—¶å‡ºé”™:', error);
            }
            
            if (filteredTasks.length === 0) {
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                taskList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªå¼€å§‹å§ï¼</div></div>';
                return;
            }
            
            // ç©ºçŠ¶æ€å·²é€šè¿‡innerHTMLå¤„ç†ï¼Œæ— éœ€å•ç‹¬éšè—
            
            const taskListElement = document.getElementById('taskList');
            if (isBatchMode) {
                taskListElement.classList.add('batch-mode');
            } else {
                taskListElement.classList.remove('batch-mode');
            }
            
            taskList.innerHTML = filteredTasks.map(task => {
                const isOverdue = task.deadline && isTaskOverdue(task.deadline) && !task.completed;
                const isSelected = selectedTasks.has(task.id);

                // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ“ä½œæ­¤ä»»åŠ¡ï¼ˆæƒé™æ§åˆ¶ï¼‰
                let canOperate = true;
                if (personalInfo.enableRoleRestriction && personalInfo.myAssignee) {
                    if (task.assignees && Array.isArray(task.assignees)) {
                        canOperate = task.assignees.length === 0 || task.assignees.includes(personalInfo.myAssignee);
                    } else {
                        canOperate = !task.assignee || task.assignee === personalInfo.myAssignee;
                    }
                }

                // è°ƒè¯•æƒé™æ£€æŸ¥
                if (personalInfo.enableRoleRestriction && task.assignee && personalInfo.myAssignee) {
                    console.log(`ä»»åŠ¡æ“ä½œæƒé™æ£€æŸ¥: ${task.title}`, {
                        taskAssignee: task.assignee,
                        myAssignee: personalInfo.myAssignee,
                        canOperate: canOperate,
                        message: canOperate ? 'âœ… å¯ä»¥æ“ä½œ' : 'âŒ åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½æ“ä½œ'
                    });
                }

                const buttonDisabled = !canOperate;
                const buttonTitle = buttonDisabled ?
                    `æ­¤ä»»åŠ¡åˆ†é…ç»™"${task.assignee}"ï¼Œæ‚¨æ— æ³•æ“ä½œ` :
                    (task.completed ? 'æ ‡è®°ä¸ºæœªå®Œæˆ' : 'æ ‡è®°ä¸ºå®Œæˆ');

                return `
                    <div class="task-item ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''} ${isSelected ? 'selected' : ''} ${buttonDisabled ? 'not-operable' : ''}" data-id="${task.id}">
                        ${isBatchMode ? `<input type="checkbox" class="batch-checkbox" data-task-id="${task.id}" ${isSelected ? 'checked' : ''} ${buttonDisabled ? 'disabled title="æ— æƒé™æ“ä½œæ­¤ä»»åŠ¡"' : ''}>` : ''}
                        <button class="task-complete-btn ${task.completed ? 'completed' : ''} ${buttonDisabled ? 'disabled' : ''}"
                                data-task-id="${task.id}"
                                title="${buttonTitle}"
                                ${buttonDisabled ? 'disabled' : ''}>
                            ${task.completed ? 'âœ…' : 'â­•'}
                        </button>
                        <div class="task-content" onclick="event.stopPropagation(); viewTaskDetail('${task.id}');" style="cursor: pointer;">
                            <div class="task-title">
                                ${isOverdue ? '<span class="overdue-badge">è¶…æ—¶</span>' : ''}
                                ${escapeHtml(task.title || task.text || 'æ— æ ‡é¢˜')}
                            </div>
                            <div class="task-meta">
                                <span class="task-category category-${task.category}">${getCategoryName(task.category)}</span>
                                <span class="task-priority priority-${task.priority}">${getPriorityName(task.priority)}</span>
                                ${task.deadline ? `<span class="task-deadline ${isOverdue ? 'overdue' : ''}">${formatDeadline(task.deadline)}</span>` : ''}
                                ${task.assignees && task.assignees.length > 0 ? `<span class="task-assignee">ğŸ‘¤ ${task.assignees.join(', ')}</span>` : task.assignee ? `<span class="task-assignee">ğŸ‘¤ ${task.assignee}</span>` : ''}
                            </div>
                            <div class="task-time-info">
                                <span class="task-created">åˆ›å»ºäº ${task.createdAt ? formatRelativeTime(task.createdAt) : 'æœªçŸ¥æ—¶é—´'}</span>
                                ${task.completed ? `<span class="task-completed">å®Œæˆäº ${task.completedAt ? formatRelativeTime(task.completedAt) : 'æœªçŸ¥æ—¶é—´'}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn edit-btn" data-task-id="${task.id}" title="ç¼–è¾‘" ${isBatchMode ? 'style="display:none;"' : ''}>
                                <span class="emoji-icon">âœï¸</span>
                            </button>
                            <button class="action-btn delete-btn" data-task-id="${task.id}" title="åˆ é™¤" ${isBatchMode ? 'style="display:none;"' : ''}>
                                <span class="emoji-icon">ğŸ—‘ï¸</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // é‡æ–°ç»‘å®šäº‹ä»¶å¤„ç†å™¨
            bindTaskEvents();

            // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆåªåœ¨éœ€è¦æ—¶ï¼‰
            if (preserveScrollPosition && scrollTop > 0) {
                requestAnimationFrame(() => {
                    // åªæœ‰åœ¨æ»šåŠ¨ä½ç½®å‘ç”Ÿå˜åŒ–æ—¶æ‰æ¢å¤
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    if (Math.abs(currentScrollTop - scrollTop) > 10) { // å…è®¸10pxçš„è¯¯å·®
                        window.scrollTo(0, scrollTop);
                    }
                });
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œä¼ é€’å½“å‰æ˜¾ç¤ºçš„ä»»åŠ¡åˆ—è¡¨
            updateStats(filteredTasks);
        }

        // ç»‘å®šä»»åŠ¡äº‹ä»¶
        function bindTaskEvents() {
            console.log('å¼€å§‹ç»‘å®šä»»åŠ¡äº‹ä»¶');
            
            // ç»‘å®šå®Œæˆä»»åŠ¡æŒ‰é’®äº‹ä»¶
            const completeButtons = document.querySelectorAll('.task-complete-btn');
            console.log('æ‰¾åˆ°', completeButtons.length, 'ä¸ªå®Œæˆä»»åŠ¡æŒ‰é’®');
            completeButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨
                    if (this.disabled || this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('æŒ‰é’®è¢«ç¦ç”¨ï¼Œæ— æ³•æ“ä½œ');
                        return;
                    }

                    const taskId = this.getAttribute('data-task-id');
                    console.log('å®Œæˆä»»åŠ¡æŒ‰é’®ç‚¹å‡»ï¼ŒtaskId:', taskId);
                    if (taskId) {
                        toggleTask(taskId);
                    } else {
                        console.error('å®Œæˆä»»åŠ¡æŒ‰é’®æ²¡æœ‰data-task-idå±æ€§');
                    }
                });
            });
            
            // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
            const editBtns = document.querySelectorAll('.edit-btn');
            console.log('æ‰¾åˆ°', editBtns.length, 'ä¸ªç¼–è¾‘æŒ‰é’®');
            editBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const taskId = this.getAttribute('data-task-id');
                    console.log('ç¼–è¾‘æŒ‰é’®ç‚¹å‡»ï¼ŒtaskId:', taskId);
                    if (taskId) {
                        editTask(taskId);
                    } else {
                        console.error('ç¼–è¾‘æŒ‰é’®æ²¡æœ‰data-task-idå±æ€§');
                    }
                });
            });
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteBtns = document.querySelectorAll('.delete-btn');
            console.log('æ‰¾åˆ°', deleteBtns.length, 'ä¸ªåˆ é™¤æŒ‰é’®');
            deleteBtns.forEach(btn => {
                // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                btn.removeEventListener('click', btn._deleteHandler);
                btn.removeEventListener('touchend', btn._touchHandler);

                // é˜²æ­¢é‡å¤è§¦å‘çš„æ ‡è®°
                btn._deleteInProgress = false;

                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å™¨
                btn._deleteHandler = function(e) {
                    // é˜²æ­¢é‡å¤æ‰§è¡Œ
                    if (this._deleteInProgress) {
                        console.log('åˆ é™¤æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è§¦å‘');
                        return;
                    }

                    console.log('åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const taskId = this.getAttribute('data-task-id');
                    console.log('åˆ é™¤æŒ‰é’®ç‚¹å‡»ï¼ŒtaskId:', taskId);

                    if (taskId) {
                        // è®¾ç½®æ“ä½œæ ‡è®°
                        this._deleteInProgress = true;

                        // æ·»åŠ è§†è§‰åé¦ˆ
                        this.style.backgroundColor = '#ff9999';
                        this.style.transform = 'scale(0.95)';

                        // å»¶è¿Ÿæ‰§è¡Œåˆ é™¤ï¼Œç»™ç”¨æˆ·åé¦ˆæ—¶é—´
                        setTimeout(() => {
                            deleteTask(taskId);
                            // é‡ç½®çŠ¶æ€
                            this.style.backgroundColor = '';
                            this.style.transform = '';
                            this._deleteInProgress = false;
                        }, 150);
                    } else {
                        console.error('åˆ é™¤æŒ‰é’®æ²¡æœ‰data-task-idå±æ€§');
                        alert('åˆ é™¤å¤±è´¥ï¼šä»»åŠ¡IDä¸¢å¤±');
                        this._deleteInProgress = false;
                    }
                };

                // Android 14ç‰¹æ®Šå¤„ç†çš„è§¦æ‘¸äº‹ä»¶
                btn._touchHandler = function(e) {
                    // é˜²æ­¢é‡å¤æ‰§è¡Œ
                    if (this._deleteInProgress) {
                        return;
                    }

                    console.log('åˆ é™¤æŒ‰é’®touchendäº‹ä»¶');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // é¿å…åŒæ—¶è§¦å‘clickå’Œtouchend
                    setTimeout(() => {
                        if (!this._deleteInProgress) {
                            btn._deleteHandler.call(this, e);
                        }
                    }, 50);
                };

                // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
                btn.addEventListener('click', btn._deleteHandler, { passive: false });

                // æ£€æµ‹Androidè®¾å¤‡å¹¶æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                const isAndroid = /Android/i.test(navigator.userAgent);
                const androidVersion = isAndroid ? parseFloat((navigator.userAgent.match(/Android ([\d.]+)/) || [])[1]) : 0;

                if (isAndroid && androidVersion >= 14) {
                    // Android 14+ ç‰¹æ®Šå¤„ç†ï¼šåªä½¿ç”¨touchendäº‹ä»¶
                    btn.removeEventListener('click', btn._deleteHandler);
                    btn.addEventListener('touchend', btn._touchHandler, { passive: false });

                    // å®Œå…¨ç¦ç”¨clickäº‹ä»¶é˜²æ­¢å†²çª
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }, { passive: false, capture: true });
                } else if (isAndroid) {
                    // å…¶ä»–Androidç‰ˆæœ¬ï¼šåŒæ—¶æ”¯æŒclickå’Œtouchend
                    btn.addEventListener('touchend', btn._touchHandler, { passive: false });
                }
            });
            
            // ç»‘å®šæ‰¹é‡é€‰æ‹©å¤é€‰æ¡†äº‹ä»¶
            const batchCheckboxes = document.querySelectorAll('.batch-checkbox');
            console.log('æ‰¾åˆ°', batchCheckboxes.length, 'ä¸ªæ‰¹é‡é€‰æ‹©å¤é€‰æ¡†');
            batchCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const taskId = this.getAttribute('data-task-id');
                    console.log('æ‰¹é‡é€‰æ‹©å¤é€‰æ¡†å˜åŒ–ï¼ŒtaskId:', taskId, 'checked:', this.checked);
                    if (this.checked) {
                        selectedTasks.add(taskId);
                    } else {
                        selectedTasks.delete(taskId);
                    }
                    updateSelectedCount();
                    updateToggleSelectButton();
                    updateTaskSelection(taskId, this.checked);
                });
            });

            // ç»‘å®šé•¿æŒ‰äº‹ä»¶è¿›å…¥æ‰¹é‡æ¨¡å¼
            const taskItems = document.querySelectorAll('.task-item');
            console.log('æ‰¾åˆ°', taskItems.length, 'ä¸ªä»»åŠ¡å¡ç‰‡ï¼Œç»‘å®šé•¿æŒ‰äº‹ä»¶');
            taskItems.forEach(taskItem => {
                let longPressTimer = null;
                let touchStarted = false;

                // é•¿æŒ‰å¼€å§‹
                const startLongPress = (e) => {
                    // å¦‚æœå·²ç»åœ¨æ‰¹é‡æ¨¡å¼ï¼Œä¸å¤„ç†é•¿æŒ‰
                    if (isBatchMode) return;

                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–è¾“å…¥æ¡†ï¼Œä¸å¤„ç†é•¿æŒ‰
                    if (e.target.closest('.task-complete-btn') ||
                        e.target.closest('.action-btn') ||
                        e.target.closest('.batch-checkbox')) {
                        return;
                    }

                    touchStarted = true;
                    taskItem.classList.add('long-press-active');

                    longPressTimer = setTimeout(() => {
                        if (touchStarted) {
                            console.log('é•¿æŒ‰è§¦å‘ï¼Œè¿›å…¥æ‰¹é‡æ¨¡å¼');
                            // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                            }

                            // è‡ªåŠ¨é€‰ä¸­å½“å‰ä»»åŠ¡ï¼ˆåœ¨è¿›å…¥æ‰¹é‡æ¨¡å¼ä¹‹å‰ï¼‰
                            const taskId = taskItem.getAttribute('data-id');
                            if (taskId) {
                                selectedTasks.add(taskId);
                            }

                            // è¿›å…¥æ‰¹é‡æ¨¡å¼ï¼ˆä¸åˆ·æ–°åˆ—è¡¨ï¼Œåªæ›´æ–°UIçŠ¶æ€ï¼‰
                            enterBatchModeWithoutRefresh();
                        }
                    }, 500); // 500ms é•¿æŒ‰è§¦å‘
                };

                // é•¿æŒ‰å–æ¶ˆ
                const cancelLongPress = () => {
                    touchStarted = false;
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    taskItem.classList.remove('long-press-active');
                };

                // è§¦æ‘¸äº‹ä»¶
                taskItem.addEventListener('touchstart', startLongPress, { passive: true });
                taskItem.addEventListener('touchend', cancelLongPress, { passive: true });
                taskItem.addEventListener('touchmove', cancelLongPress, { passive: true });
                taskItem.addEventListener('touchcancel', cancelLongPress, { passive: true });

                // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢ç«¯æµ‹è¯•ï¼‰
                taskItem.addEventListener('mousedown', startLongPress);
                taskItem.addEventListener('mouseup', cancelLongPress);
                taskItem.addEventListener('mouseleave', cancelLongPress);
            });

            console.log('äº‹ä»¶ç»‘å®šå®Œæˆ');

            // æ ¹æ®ç­›é€‰å™¨æŠ˜å çŠ¶æ€è°ƒæ•´task-itemé«˜åº¦
            if (enableCompactModeToggle) {
                const filterCollapsed = localStorage.getItem('filterSectionCollapsed') === 'true';
                if (filterCollapsed) {
                    adjustTaskItemHeight('normal');
                } else {
                    adjustTaskItemHeight('compact');
                }
            } else {
                console.log('æ¨¡å¼åˆ‡æ¢å·²ç¦ç”¨ï¼Œä½¿ç”¨é»˜è®¤æ ·å¼');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(currentTasks = null) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥å½“å‰ä»»åŠ¡åˆ—è¡¨ï¼Œåˆ™ä½¿ç”¨å…¨éƒ¨ä»»åŠ¡
            const tasksToCount = currentTasks || tasks;
            const total = tasksToCount.length;
            const completed = tasksToCount.filter(t => t.completed).length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            // æ›´æ–°è¿›åº¦æ¡ï¼ˆä»ä½¿ç”¨å…¨éƒ¨ä»»åŠ¡ï¼‰
            const allTotal = tasks.length;
            const allCompleted = tasks.filter(t => t.completed).length;
            const allRate = allTotal > 0 ? Math.round((allCompleted / allTotal) * 100) : 0;

            // document.getElementById('progressInfo').textContent = `${allCompleted}/${allTotal} å®Œæˆ`;
            // document.getElementById('progressFill').style.width = `${allRate}%`;

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨å½“å‰åˆ—è¡¨çš„æ•°æ®ï¼‰
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('completionRate').textContent = `${rate}%`;
        }

        // ä¿å­˜ä»»åŠ¡ - APIä¼˜å…ˆï¼Œä¸éœ€è¦æœ¬åœ°å­˜å‚¨
        function saveTasks() {
            // åœ¨API-firstæ¨¡å¼ä¸‹ï¼Œä¸ªåˆ«æ“ä½œç›´æ¥è°ƒç”¨API
            // æ­¤å‡½æ•°ä¿ç•™ä»¥å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            console.log('saveTasks called - using API-first approach, no action needed');
        }

        // åŠ è½½ä»»åŠ¡ - ç›´æ¥ä»APIåŠ è½½
        async function loadTasks() {
            await loadTasksFromAPI();

            // åŠ è½½ä»»åŠ¡åæ›´æ–°ç­›é€‰å™¨é€‰é¡¹
            updateAssigneeFilterOptions();
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `daily-todo-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('fileInput').click();
        }

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedTasks = JSON.parse(e.target.result);
                    if (Array.isArray(importedTasks)) {
                        if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${importedTasks.length} ä¸ªä»»åŠ¡å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ã€‚`)) {
                            tasks = importedTasks;
                            saveTasks();
                            renderTasks();
                            updateStats();
                            alert('å¯¼å…¥æˆåŠŸï¼');
                        }
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCategoryName(category) {
            const names = {
                work: 'å·¥ä½œ',
                life: 'ç”Ÿæ´»',
                study: 'å­¦ä¹ ',
                other: 'å…¶ä»–'
            };
            return names[category] || 'å…¶ä»–';
        }

        function getPriorityName(priority) {
            const names = {
                high: 'é«˜',
                medium: 'ä¸­',
                low: 'ä½'
            };
            return names[priority] || 'ä¸­';
        }

        function formatDeadline(deadline) {
            if (!deadline) return '';

            try {
                // ä½¿ç”¨æ–°çš„æ—¶é—´è½¬æ¢å‡½æ•°ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„æ—¶é—´
                const displayDate = convertUTCToLocalForDisplay(deadline);
                if (!displayDate) {
                    console.warn('Invalid deadline format:', deadline);
                    return String(deadline);
                }

                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                const taskDate = new Date(displayDate.getFullYear(), displayDate.getMonth(), displayDate.getDate());

                // æ ¼å¼åŒ–æ—¶é—´éƒ¨åˆ†
                const timeStr = displayDate.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                if (taskDate.getTime() === today.getTime()) {
                    return `ä»Šå¤© ${timeStr}`;
                } else if (taskDate.getTime() === tomorrow.getTime()) {
                    return `æ˜å¤© ${timeStr}`;
                } else {
                    // æ˜¾ç¤ºæœˆ/æ—¥ æ—¶é—´æ ¼å¼
                    const month = displayDate.getMonth() + 1;
                    const day = displayDate.getDate();
                    return `${month}/${day} ${timeStr}`;
                }
            } catch (error) {
                console.error('Error formatting deadline:', deadline, error);
                return String(deadline); // è¿”å›åŸå§‹å­—ç¬¦ä¸²
            }
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const timeDiff = now.getTime() - date.getTime();
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 0) {
                return `ä»Šå¤© ${date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}`;
            } else if (daysDiff === 1) {
                return `æ˜¨å¤© ${date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}`;
            } else if (daysDiff < 7) {
                return `${daysDiff}å¤©å‰`;
            } else {
                return date.toLocaleString('zh-CN', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        function formatRelativeTime(dateTime) {
            if (!dateTime) return 'æœªçŸ¥æ—¶é—´';

            try {
                // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´è½¬æ¢å‡½æ•°ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                const displayDate = convertUTCToLocalForDisplay(dateTime);
                if (!displayDate) {
                    console.warn('Invalid dateTime format:', dateTime);
                    return String(dateTime);
                }

                const now = new Date();
                const timeDiff = now.getTime() - displayDate.getTime();

                // å¦‚æœæ˜¯æœªæ¥æ—¶é—´ï¼Œæ˜¾ç¤ºç»å¯¹æ—¶é—´
                if (timeDiff < 0) {
                    return displayDate.toLocaleString('zh-CN', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }

                const minutes = Math.floor(timeDiff / (1000 * 60));
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                if (minutes < 1) {
                    return 'åˆšåˆš';
                } else if (minutes < 60) {
                    return `${minutes}åˆ†é’Ÿå‰`;
                } else if (hours < 24) {
                    return `${hours}å°æ—¶å‰`;
                } else if (days < 30) {
                    return `${days}å¤©å‰`;
                } else {
                    return displayDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                console.error('Error formatting relative time:', dateTime, error);
                return 'æ—¶é—´é”™è¯¯'; // è¿”å›æ˜ç¡®çš„é”™è¯¯æç¤º
            }
        }

        // æ¯æ—¥å¾…åŠç›¸å…³åŠŸèƒ½
        function showDailyTodoSettings() {
            const modal = document.getElementById('dailyTodoModal');
            if (modal) {
                // åŠ è½½å½“å‰è®¾ç½®
                loadDailyTodoSettings();
                lockScroll(); // é”å®šé¡µé¢æ»šåŠ¨
                modal.style.display = 'flex';
            }
        }

        // å¾®ä¿¡é€šçŸ¥è®¾ç½®åŠŸèƒ½
        function showWechatSettings() {
            const modal = document.getElementById('wechatModal');
            if (modal) {
                // åŠ è½½å½“å‰è®¾ç½®
                loadWechatSettings();
                lockScroll(); // é”å®šé¡µé¢æ»šåŠ¨
                modal.style.display = 'flex';
            }
        }

        function closeWechatModal() {
            const modal = document.getElementById('wechatModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
            }
        }

        // æ•°æ®åº“è®¾ç½®åŠŸèƒ½
        function showDatabaseSettings() {
            const modal = document.getElementById('databaseModal');
            if (modal) {
                // åŠ è½½å½“å‰è®¾ç½®
                loadDatabaseSettings();
                lockScroll(); // é”å®šé¡µé¢æ»šåŠ¨
                modal.style.display = 'flex';
            }
        }

        function closeDatabaseModal() {
            const modal = document.getElementById('databaseModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
            }
        }

        function closeDailyTodoModal() {
            const modal = document.getElementById('dailyTodoModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
            }
        }

        function loadDailyTodoSettings() {
            const settings = getDailyTodoSettings();
            const templateTextarea = document.getElementById('dailyTasksTemplate');
            const autoAddTimeInput = document.getElementById('autoAddTime');
            const enableCheckbox = document.getElementById('enableDailyTodo');
            const skipHolidaysCheckbox = document.getElementById('skipHolidays');

            if (templateTextarea && settings.template) {
                templateTextarea.value = settings.template;
            }
            if (autoAddTimeInput && settings.autoAddTime) {
                autoAddTimeInput.value = settings.autoAddTime;
            }
            if (enableCheckbox) {
                enableCheckbox.checked = settings.enabled;
            }
            if (skipHolidaysCheckbox) {
                skipHolidaysCheckbox.checked = settings.skipHolidays !== false; // é»˜è®¤ä¸ºtrue
            }
        }

        // å¾®ä¿¡è®¾ç½®åŠ è½½å‡½æ•°
        function loadWechatSettings() {
            const settings = getDailyTodoSettings();
            const serverChanKeyInput = document.getElementById('serverChanKey');
            const enableWechatNotifyCheckbox = document.getElementById('enableWechatNotify');
            const morningNotifyTimeInput = document.getElementById('morningNotifyTime');
            const eveningNotifyTimeInput = document.getElementById('eveningNotifyTime');

            if (serverChanKeyInput && settings.serverChanKey) {
                serverChanKeyInput.value = settings.serverChanKey;
            }
            if (enableWechatNotifyCheckbox) {
                enableWechatNotifyCheckbox.checked = settings.enableWechatNotify || false;
            }
            if (morningNotifyTimeInput && settings.morningNotifyTime) {
                morningNotifyTimeInput.value = settings.morningNotifyTime;
            }
            if (eveningNotifyTimeInput && settings.eveningNotifyTime) {
                eveningNotifyTimeInput.value = settings.eveningNotifyTime;
            }

            // åˆå§‹åŒ–æ—¶åŒæ­¥æ™¨æŠ¥æ™šæŠ¥æ—¶é—´é…ç½®åˆ°Android
            syncReportTimeToAndroid(settings);
        }

        // åŒæ­¥æŠ¥å‘Šæ—¶é—´é…ç½®åˆ°Android
        function syncReportTimeToAndroid(settings) {
            try {
                if (window.AndroidDatabase && typeof window.AndroidDatabase.saveReportTimeSettings === 'function') {
                    const morningTime = settings.morningNotifyTime || '09:00';
                    const eveningTime = settings.eveningNotifyTime || '18:00';

                    const success = window.AndroidDatabase.saveReportTimeSettings(morningTime, eveningTime);
                    console.log('åˆå§‹åŒ–æ—¶åŒæ­¥AndroidæŠ¥å‘Šæ—¶é—´é…ç½®:', { morningTime, eveningTime, success });
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–æ—¶åŒæ­¥AndroidæŠ¥å‘Šæ—¶é—´é…ç½®å¤±è´¥:', error);
            }
        }

        // æ•°æ®åº“è®¾ç½®åŠ è½½å‡½æ•°
        function loadDatabaseSettings() {
            const settings = getDailyTodoSettings();
            const supabaseUrlInput = document.getElementById('supabaseUrl');
            const supabaseAnonKeyInput = document.getElementById('supabaseAnonKey');
            const supabaseUserIdInput = document.getElementById('supabaseUserId');
            const enableOnlineSyncCheckbox = document.getElementById('enableOnlineSync');
            const syncIntervalSelect = document.getElementById('syncIntervalSelect');
            const statusText = document.getElementById('statusText');

            // Supabase URLé…ç½®
            if (supabaseUrlInput) {
                supabaseUrlInput.value = DATABASE_CONFIG.supabaseUrl && !DATABASE_CONFIG.supabaseUrl.includes('YOUR_PROJECT_ID') ? DATABASE_CONFIG.supabaseUrl : '';
            }

            // Supabase Anon Keyé…ç½®
            if (supabaseAnonKeyInput) {
                supabaseAnonKeyInput.value = DATABASE_CONFIG.supabaseAnonKey && !DATABASE_CONFIG.supabaseAnonKey.includes('YOUR_SUPABASE_ANON_KEY') ? DATABASE_CONFIG.supabaseAnonKey : '';
            }

            // Supabaseç”¨æˆ·IDé…ç½®
            if (supabaseUserIdInput) {
                supabaseUserIdInput.value = DATABASE_CONFIG.userId || '';
            }

            if (enableOnlineSyncCheckbox) {
                enableOnlineSyncCheckbox.checked = settings.enableOnlineSync !== false;
            }
            // è®¾ç½®è‡ªå®šä¹‰åŒæ­¥é—´éš”é€‰æ‹©å™¨
            customSingleSelectValues.syncIntervalSelect = String(syncInterval / (60 * 1000));
            updateCustomSingleSelectDisplay('syncIntervalSelect');
            updateCustomSingleSelectOptions('syncIntervalSelect');

            // æ›´æ–°æ•°æ®åº“çŠ¶æ€æ˜¾ç¤º
            updateDatabaseStatusDisplay();
        }

        // æ›´æ–°æ•°æ®åº“çŠ¶æ€æ˜¾ç¤º
        function updateDatabaseStatusDisplay() {
            const statusText = document.getElementById('statusText');
            const databaseStatus = document.getElementById('databaseStatus');
            const binIdInfo = document.getElementById('binIdInfo');

            if (!statusText || !databaseStatus) return;

            if (!DATABASE_CONFIG.apiKey || DATABASE_CONFIG.apiKey.includes('YOUR_API_KEY')) {
                statusText.textContent = 'âŒ æœªé…ç½®API Key';
                databaseStatus.style.background = '#ffebee';
                databaseStatus.style.color = '#d32f2f';
            } else if (!syncStatus.isOnline) {
                statusText.textContent = 'ğŸ“± ç¦»çº¿æ¨¡å¼';
                databaseStatus.style.background = '#fff3e0';
                databaseStatus.style.color = '#f57c00';
            } else if (syncStatus.syncInProgress) {
                statusText.textContent = 'ğŸ”„ åŒæ­¥ä¸­...';
                databaseStatus.style.background = '#e3f2fd';
                databaseStatus.style.color = '#1976d2';
            } else if (DATABASE_CONFIG.binId) {
                // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å›ºå®šçš„Bin ID
                const settings = getDailyTodoSettings();
                const isFixed = settings.fixedBinId && settings.fixedBinId === DATABASE_CONFIG.binId;
                const modeText = isFixed ? ' (å›ºå®šæ¨¡å¼)' : ' (è‡ªåŠ¨åˆ›å»º)';
                statusText.textContent = 'âœ… å·²è¿æ¥å¹¶åŒæ­¥' + modeText;
                databaseStatus.style.background = '#e8f5e8';
                databaseStatus.style.color = '#388e3c';
            } else {
                statusText.textContent = 'âš ï¸ éœ€è¦æµ‹è¯•è¿æ¥';
                databaseStatus.style.background = '#fff3e0';
                databaseStatus.style.color = '#f57c00';
            }

            // æ›´æ–°Bin IDä¿¡æ¯æ˜¾ç¤º
            if (binIdInfo) {
                if (DATABASE_CONFIG.binId) {
                    const settings = getDailyTodoSettings();
                    const isFixed = settings.fixedBinId && settings.fixedBinId === DATABASE_CONFIG.binId;
                    binIdInfo.textContent = `Bin ID: ${DATABASE_CONFIG.binId} ${isFixed ? '(ç”¨æˆ·è®¾ç½®)' : '(è‡ªåŠ¨ç”Ÿæˆ)'}`;
                } else {
                    binIdInfo.textContent = 'æš‚æ— Bin ID';
                }
            }
        }

        async function saveDailyTodoSettings() {
            const templateTextarea = document.getElementById('dailyTasksTemplate');
            const autoAddTimeInput = document.getElementById('autoAddTime');
            const enableCheckbox = document.getElementById('enableDailyTodo');
            const skipHolidaysCheckbox = document.getElementById('skipHolidays');

            const oldSettings = getDailyTodoSettings();

            // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            const newTemplate = templateTextarea ? templateTextarea.value.trim() : '';
            const newEnabled = enableCheckbox ? enableCheckbox.checked : true;
            const newSkipHolidays = skipHolidaysCheckbox ? skipHolidaysCheckbox.checked : true;

            const templateChanged = oldSettings.template !== newTemplate;
            const enabledChanged = oldSettings.enabled !== newEnabled;

            const newSettings = {
                ...oldSettings, // ä¿ç•™å…¶ä»–è®¾ç½®
                template: newTemplate,
                autoAddTime: autoAddTimeInput ? autoAddTimeInput.value : '09:00',
                enabled: newEnabled,
                skipHolidays: newSkipHolidays,
                // åªæœ‰åœ¨æ¨¡æ¿æˆ–å¼€å…³æœ‰å˜åŒ–æ—¶æ‰é‡ç½®æ—¥æœŸï¼Œå¦åˆ™ä¿æŒåŸæœ‰æ—¥æœŸé¿å…é‡å¤ç”Ÿæˆ
                lastAddedDate: (templateChanged || enabledChanged) ? null : oldSettings.lastAddedDate,
            };

            const skipHolidaysChanged = oldSettings.skipHolidays !== newSkipHolidays;

            // æ³¨æ„ï¼šä»»åŠ¡ç”Ÿæˆå·²ç§»è‡³åå°æœåŠ¡ï¼Œå‰ç«¯åªè´Ÿè´£ä¿å­˜é…ç½®å’Œè§¦å‘ç”Ÿæˆ

            localStorage.setItem('dailyTodoSettings', JSON.stringify(newSettings));

            // åŒæ­¥æ¯æ—¥å¾…åŠé…ç½®åˆ°Androidç«¯
            try {
                if (window.AndroidDatabase && typeof window.AndroidDatabase.saveDailyTodoSettings === 'function') {
                    const success = window.AndroidDatabase.saveDailyTodoSettings(
                        newSettings.template,
                        newSettings.enabled,
                        newSettings.skipHolidays
                    );
                    console.log('Androidæ¯æ—¥å¾…åŠé…ç½®åŒæ­¥ç»“æœ:', success);
                    if (success) {
                        console.log('æ¯æ—¥å¾…åŠé…ç½®å·²åŒæ­¥åˆ°åå°æœåŠ¡');
                    }
                }
            } catch (error) {
                console.error('åŒæ­¥æ¯æ—¥å¾…åŠé…ç½®åˆ°Androidå¤±è´¥:', error);
            }

            // è§¦å‘åå°ç›´æ¥ç”Ÿæˆä»Šæ—¥ä»»åŠ¡ï¼ˆä¸ä½¿ç”¨å¹¿æ’­ï¼‰
            try {
                if (window.AndroidDatabase && typeof window.AndroidDatabase.triggerDailyTodoGeneration === 'function') {
                    window.AndroidDatabase.triggerDailyTodoGeneration();
                    console.log('å·²è§¦å‘åå°ç›´æ¥ç”Ÿæˆæ¯æ—¥å¾…åŠä»»åŠ¡');

                    // ç­‰å¾…2ç§’ååˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆç»™ä»»åŠ¡åˆ›å»ºè¶³å¤Ÿæ—¶é—´ï¼‰
                    setTimeout(async () => {
                        console.log('åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ç”Ÿæˆçš„ä»»åŠ¡');
                        await loadTasksFromAPI();
                        renderTasks();
                        updateStats();
                    }, 2000);
                }
            } catch (error) {
                console.error('è§¦å‘åå°ç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);
            }

            closeDailyTodoModal();

            // æ„å»ºæç¤ºä¿¡æ¯
            let message = 'æ¯æ—¥å¾…åŠè®¾ç½®å·²ä¿å­˜';
            if (newSettings.enabled && newSettings.template) {
                message += 'ï¼Œä»»åŠ¡ç”Ÿæˆä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰';
            }

            alert(message);
        }

        // è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºæ¯æ—¥å¾…åŠè¯Šæ–­ä¿¡æ¯
        function showDailyTodoDebugInfo() {
            try {
                if (window.AndroidDatabase && typeof window.AndroidDatabase.getDailyTodoDebugInfo === 'function') {
                    const debugInfo = window.AndroidDatabase.getDailyTodoDebugInfo();
                    console.log('æ¯æ—¥å¾…åŠè¯Šæ–­ä¿¡æ¯:', debugInfo);

                    // è§£æJSONå¹¶æ˜¾ç¤º
                    try {
                        const info = JSON.parse(debugInfo);

                        // æ„å»ºå¯è¯»çš„è¯Šæ–­ä¿¡æ¯
                        let message = 'ğŸ“Š æ¯æ—¥å¾…åŠè¯Šæ–­ä¿¡æ¯\n\n';
                        message += `ğŸ“… å½“å‰æ—¥æœŸ: ${info.currentDate}\n`;
                        message += `ğŸ‰ æ˜¯å¦èŠ‚å‡æ—¥: ${info.isHoliday ? 'æ˜¯' : 'å¦'}\n`;
                        message += `âœ… æ˜¯å¦åº”ç”Ÿæˆ: ${info.shouldGenerate ? 'æ˜¯' : 'å¦'}\n\n`;

                        message += 'âš™ï¸ é…ç½®çŠ¶æ€:\n';
                        message += `  - åŠŸèƒ½å¯ç”¨: ${info.configuration.enabled ? 'æ˜¯' : 'å¦'}\n`;
                        message += `  - è·³è¿‡èŠ‚å‡æ—¥: ${info.configuration.skipHolidays ? 'æ˜¯' : 'å¦'}\n`;
                        message += `  - æ¨¡æ¿è¡Œæ•°: ${info.configuration.templateLineCount}\n`;
                        message += `  - ä¸Šæ¬¡ç”Ÿæˆ: ${info.configuration.lastAddedDate || 'ä»æœª'}\n\n`;

                        message += 'ğŸ”— SupabaseçŠ¶æ€:\n';
                        message += `  - URLé…ç½®: ${info.supabaseConfig.urlConfigured ? 'âœ“' : 'âœ—'}\n`;
                        message += `  - Keyé…ç½®: ${info.supabaseConfig.keyConfigured ? 'âœ“' : 'âœ—'}\n`;
                        message += `  - ç”¨æˆ·ID: ${info.supabaseConfig.userIdConfigured ? 'âœ“' : 'âœ—'}\n\n`;

                        message += 'ğŸš« é˜»æ­¢åŸå› :\n';
                        if (info.blockReasons && info.blockReasons.length > 0) {
                            info.blockReasons.forEach(reason => {
                                message += `  ${reason}\n`;
                            });
                        }

                        alert(message);
                    } catch (parseError) {
                        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹ä¿¡æ¯
                        alert('è¯Šæ–­ä¿¡æ¯:\n\n' + debugInfo);
                    }
                } else {
                    alert('âŒ AndroidDatabaseæ¥å£ä¸å¯ç”¨\nè¯·ç¡®ä¿åœ¨Androidåº”ç”¨ä¸­è¿è¡Œ');
                }
            } catch (error) {
                console.error('è·å–è¯Šæ–­ä¿¡æ¯å¤±è´¥:', error);
                alert('âŒ è·å–è¯Šæ–­ä¿¡æ¯å¤±è´¥:\n' + error.message);
            }
        }

        // è°ƒè¯•å‡½æ•°ï¼šæµ‹è¯•ä»»åŠ¡åˆ›å»º
        function testTaskCreation() {
            try {
                if (window.AndroidDatabase && typeof window.AndroidDatabase.testCreateTask === 'function') {
                    window.AndroidDatabase.testCreateTask();
                    console.log('å·²è§¦å‘æµ‹è¯•ä»»åŠ¡åˆ›å»º');

                    // ç­‰å¾…3ç§’ååˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    setTimeout(async () => {
                        console.log('åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºæµ‹è¯•ä»»åŠ¡');
                        await loadTasksFromAPI();
                        renderTasks();
                        updateStats();
                    }, 3000);
                } else {
                    alert('âŒ AndroidDatabaseæ¥å£ä¸å¯ç”¨\nè¯·ç¡®ä¿åœ¨Androidåº”ç”¨ä¸­è¿è¡Œ');
                }
            } catch (error) {
                console.error('æµ‹è¯•ä»»åŠ¡åˆ›å»ºå¤±è´¥:', error);
                alert('âŒ æµ‹è¯•ä»»åŠ¡åˆ›å»ºå¤±è´¥:\n' + error.message);
            }
        }

        // å¾®ä¿¡è®¾ç½®ä¿å­˜å‡½æ•°
        function saveWechatSettings() {
            const serverChanKeyInput = document.getElementById('serverChanKey');
            const enableWechatNotifyCheckbox = document.getElementById('enableWechatNotify');
            const morningNotifyTimeInput = document.getElementById('morningNotifyTime');
            const eveningNotifyTimeInput = document.getElementById('eveningNotifyTime');

            const oldSettings = getDailyTodoSettings();
            const newSettings = {
                ...oldSettings, // ä¿ç•™å…¶ä»–è®¾ç½®
                serverChanKey: serverChanKeyInput ? serverChanKeyInput.value.trim() : '',
                enableWechatNotify: enableWechatNotifyCheckbox ? enableWechatNotifyCheckbox.checked : false,
                morningNotifyTime: morningNotifyTimeInput ? morningNotifyTimeInput.value : '09:00',
                eveningNotifyTime: eveningNotifyTimeInput ? eveningNotifyTimeInput.value : '18:00'
            };

            localStorage.setItem('dailyTodoSettings', JSON.stringify(newSettings));

            // åŒæ­¥æ™¨æŠ¥æ™šæŠ¥æ—¶é—´é…ç½®åˆ°Android
            try {
                if (window.AndroidDatabase && typeof window.AndroidDatabase.saveReportTimeSettings === 'function') {
                    const success = window.AndroidDatabase.saveReportTimeSettings(
                        newSettings.morningNotifyTime,
                        newSettings.eveningNotifyTime
                    );
                    console.log('AndroidæŠ¥å‘Šæ—¶é—´é…ç½®åŒæ­¥ç»“æœ:', success);
                }
            } catch (error) {
                console.error('åŒæ­¥AndroidæŠ¥å‘Šæ—¶é—´é…ç½®å¤±è´¥:', error);
            }

            closeWechatModal();
            alert('å¾®ä¿¡é€šçŸ¥è®¾ç½®å·²ä¿å­˜');
        }

        // æ•°æ®åº“è®¾ç½®ä¿å­˜å‡½æ•°
        function saveDatabaseSettings() {
            const supabaseUrlInput = document.getElementById('supabaseUrl');
            const supabaseAnonKeyInput = document.getElementById('supabaseAnonKey');
            const supabaseUserIdInput = document.getElementById('supabaseUserId');
            const enableOnlineSyncCheckbox = document.getElementById('enableOnlineSync');
            const syncIntervalSelect = document.getElementById('syncIntervalSelect');

            const oldSettings = getDailyTodoSettings();
            const newSettings = {
                ...oldSettings, // ä¿ç•™å…¶ä»–è®¾ç½®
                enableOnlineSync: enableOnlineSyncCheckbox ? enableOnlineSyncCheckbox.checked : true
            };

            // æ›´æ–°Supabase URLé…ç½®
            if (supabaseUrlInput && supabaseUrlInput.value.trim()) {
                DATABASE_CONFIG.supabaseUrl = supabaseUrlInput.value.trim();
                localStorage.setItem('supabase_url', DATABASE_CONFIG.supabaseUrl);
            }

            // æ›´æ–°Supabase Anon Keyé…ç½®
            if (supabaseAnonKeyInput && supabaseAnonKeyInput.value.trim()) {
                const anonKey = supabaseAnonKeyInput.value.trim();
                // éªŒè¯Anon Keyæ ¼å¼
                if (anonKey.length > 0) {
                    DATABASE_CONFIG.supabaseAnonKey = anonKey;
                    localStorage.setItem('supabase_anon_key', DATABASE_CONFIG.supabaseAnonKey);
                    console.log('Supabase Anon Keyå·²è®¾ç½®');
                } else {
                    alert('Anon Keyæ ¼å¼ä¸æ­£ç¡®ï¼è¯·è¾“å…¥å®Œæ•´çš„Supabase Anon Key');
                    return;
                }
            }

            // æ›´æ–°Supabaseç”¨æˆ·IDé…ç½®
            if (supabaseUserIdInput) {
                const userId = supabaseUserIdInput.value.trim();
                if (userId) {
                    // éªŒè¯ç”¨æˆ·IDæ ¼å¼ï¼ˆå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­åˆ’çº¿ï¼‰
                    if (/^[a-zA-Z0-9_-]+$/.test(userId)) {
                        DATABASE_CONFIG.userId = userId;
                        localStorage.setItem('supabase_user_id', userId);
                        console.log('Supabaseç”¨æˆ·IDå·²è®¾ç½®:', userId);
                    } else {
                        alert('ç”¨æˆ·IDæ ¼å¼ä¸æ­£ç¡®ï¼åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­åˆ’çº¿');
                        return;
                    }
                } else {
                    // ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ç”¨æˆ·ID
                    if (!DATABASE_CONFIG.userId) {
                        DATABASE_CONFIG.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('supabase_user_id', DATABASE_CONFIG.userId);
                    }
                    console.log('ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ç”¨æˆ·ID:', DATABASE_CONFIG.userId);
                }
            }

            // æ›´æ–°åŒæ­¥é—´éš”
            const newInterval = parseInt(getCustomSingleSelectValue('syncIntervalSelect'));
            if (newInterval && newInterval > 0) {
                setSyncInterval(newInterval);
            }

            localStorage.setItem('dailyTodoSettings', JSON.stringify(newSettings));
            closeDatabaseModal();

            // åŒæ­¥æ•°æ®åº“é…ç½®åˆ°Androidç«¯
            syncDatabaseConfigToAndroid();

            // æä¾›æ›´è¯¦ç»†çš„ä¿å­˜ç¡®è®¤ä¿¡æ¯
            const userIdText = DATABASE_CONFIG.userId ? `\nç”¨æˆ·ID: ${DATABASE_CONFIG.userId}` : '';
            alert('Supabaseæ•°æ®åº“è®¾ç½®å·²ä¿å­˜' + userIdText);
        }

        // æµ‹è¯•Supabaseæ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            const supabaseUrlInput = document.getElementById('supabaseUrl');
            const supabaseAnonKeyInput = document.getElementById('supabaseAnonKey');
            const supabaseUrlValue = supabaseUrlInput ? supabaseUrlInput.value.trim() : '';
            const anonKey = supabaseAnonKeyInput ? supabaseAnonKeyInput.value.trim() : '';

            if (!supabaseUrlValue || !anonKey) {
                alert('è¯·å…ˆè¾“å…¥Supabaseé¡¹ç›®URLå’ŒAnon Key');
                return;
            }

            try {
                // æµ‹è¯•Supabaseè¿æ¥
                const url = `${supabaseUrlValue}/rest/v1/${DATABASE_CONFIG.tableName}?user_id=eq.test_connection`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': anonKey,
                        'Authorization': `Bearer ${anonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // è¿æ¥æˆåŠŸ
                    alert('âœ… Supabaseæ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼\\nå¯ä»¥æ­£å¸¸è®¿é—®æ•°æ®è¡¨ã€‚');
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'è¯·æ£€æŸ¥Supabaseé¡¹ç›®URLå’ŒAnon Keyæ˜¯å¦æ­£ç¡®';

                    if (response.status === 401) {
                        errorMessage = 'Anon Keyæ— æ•ˆæˆ–æƒé™ä¸è¶³';
                    } else if (response.status === 404) {
                        errorMessage = 'æ•°æ®è¡¨ä¸å­˜åœ¨æˆ–é¡¹ç›®URLé”™è¯¯';
                    }

                    alert(`âŒ Supabaseè¿æ¥å¤±è´¥ï¼š${errorMessage}`);
                    console.error('Supabaseè¿æ¥é”™è¯¯:', errorText);
                }

            } catch (error) {
                alert(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥ï¼š${error.message}`);
                console.error('Firebaseè¿æ¥æµ‹è¯•å¤±è´¥:', error);
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateDatabaseStatusDisplay();
        }

        // å®Œæˆäººç®¡ç†åŠŸèƒ½
        let assignees = [];

        // ä¸ªäººä¿¡æ¯è®¾ç½®
        let personalInfo = {
            myAssignee: null, // æˆ‘çš„èº«ä»½ï¼ˆå®Œæˆäººåç§°ï¼‰
            enableRoleRestriction: false // æ˜¯å¦å¯ç”¨è§’è‰²é™åˆ¶
        };

        // åˆå§‹åŒ–å®Œæˆäººä¸‹æ‹‰åˆ—è¡¨
        function initializeAssigneeSelect() {
            const assigneeOptions = document.getElementById('addTaskAssigneeOptions');
            if (!assigneeOptions) {
                console.error('addTaskAssigneeOptions element not found');
                return;
            }

            console.log('Initializing assignee multi-select, assignees:', assignees);

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            assigneeOptions.innerHTML = '';

            // æ·»åŠ å®Œæˆäººé€‰é¡¹
            assignees.forEach(assignee => {
                const option = document.createElement('div');
                option.className = 'assignee-option';

                // å¤„ç†å­—ç¬¦ä¸²æˆ–å¯¹è±¡æ ¼å¼
                const assigneeName = typeof assignee === 'string' ? assignee : assignee.name;

                option.innerHTML = `
                    <input type="checkbox" id="add_${assigneeName}" value="${assigneeName}" onchange="toggleAssigneeSelection('add', '${assigneeName}')">
                    <label for="add_${assigneeName}">${assigneeName}</label>
                `;
                assigneeOptions.appendChild(option);
                console.log('Added assignee option:', assigneeName);
            });

            // å¦‚æœæ²¡æœ‰å®Œæˆäººï¼Œæ·»åŠ ä¸€ä¸ªæç¤º
            if (assignees.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-message';
                emptyMessage.textContent = 'è¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ å®Œæˆäºº';
                assigneeOptions.appendChild(emptyMessage);
                console.log('No assignees found, added help text');
            }
        }

        function showAssigneeSettings() {
            const modal = document.getElementById('assigneeModal');
            if (modal) {
                loadAssignees();
                renderAssigneeList();
                lockScroll(); // é”å®šé¡µé¢æ»šåŠ¨
                modal.style.display = 'flex';
            }
        }

        function closeAssigneeModal() {
            const modal = document.getElementById('assigneeModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
            }
        }

        function loadAssignees() {
            const saved = localStorage.getItem('assignees');
            if (saved) {
                try {
                    assignees = JSON.parse(saved);
                    // è§„èŒƒåŒ–æ•°æ®æ ¼å¼ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡
                    assignees = assignees.map(assignee => {
                        if (typeof assignee === 'string') {
                            return {
                                id: generateId(),
                                name: assignee,
                                createdAt: getCurrentUTCTimeString()
                            };
                        }
                        return assignee;
                    });
                    // ä¿å­˜è§„èŒƒåŒ–åçš„æ•°æ®
                    saveAssignees();
                } catch (error) {
                    console.error('åŠ è½½å®Œæˆäººåˆ—è¡¨å¤±è´¥:', error);
                    assignees = [];
                }
            } else {
                assignees = [];
            }
        }

        function saveAssignees() {
            try {
                localStorage.setItem('assignees', JSON.stringify(assignees));
            } catch (error) {
                console.error('ä¿å­˜å®Œæˆäººåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        function addAssignee() {
            const input = document.getElementById('newAssigneeName');
            const name = input.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å®Œæˆäººå§“å');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (assignees.find(assignee => assignee.name === name)) {
                alert('è¯¥å®Œæˆäººå·²å­˜åœ¨');
                return;
            }

            // æ·»åŠ å®Œæˆäººå¯¹è±¡
            const newAssignee = {
                id: generateId(),
                name: name,
                createdAt: getCurrentUTCTimeString()
            };

            assignees.push(newAssignee);
            saveAssignees();
            renderAssigneeList();
            updateCompletedByOptions();
            // åˆ·æ–°æ¨¡æ€æ¡†ä¸­çš„å®Œæˆäººé€‰é¡¹ï¼ˆå¦‚æœæ¨¡æ€æ¡†å¤„äºæ‰“å¼€çŠ¶æ€ï¼‰
            refreshAssigneeOptions();
            updateAssigneeFilterOptions(); // åˆ·æ–°ç­›é€‰å™¨çš„å®Œæˆäººé€‰é¡¹
            input.value = '';
        }

        function removeAssignee(name) {
            if (confirm(`ç¡®è®¤åˆ é™¤å®Œæˆäºº"${name}"å—ï¼Ÿ`)) {
                assignees = assignees.filter(assignee => assignee.name !== name);
                saveAssignees();
                renderAssigneeList();
                updateCompletedByOptions();
                // åˆ·æ–°æ¨¡æ€æ¡†ä¸­çš„å®Œæˆäººé€‰é¡¹ï¼ˆå¦‚æœæ¨¡æ€æ¡†å¤„äºæ‰“å¼€çŠ¶æ€ï¼‰
                refreshAssigneeOptions();
                updateAssigneeFilterOptions(); // åˆ·æ–°ç­›é€‰å™¨çš„å®Œæˆäººé€‰é¡¹
            }
        }

        function renderAssigneeList() {
            const listContainer = document.getElementById('assigneeList');
            if (!listContainer) return;

            if (assignees.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— å®Œæˆäºº</div>';
                return;
            }

            listContainer.innerHTML = assignees.map(assignee => {
                const assigneeName = typeof assignee === 'string' ? assignee : assignee.name;
                return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 8px;">
                    <span>${assigneeName}</span>
                    <button onclick="removeAssignee('${assigneeName}')" style="background: #ff4757; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
                </div>
                `;
            }).join('');
        }

        function updateCompletedByOptions() {
            const select = document.getElementById('completedBySelect');
            if (select) {
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
                select.innerHTML = '<option value="">è¯·é€‰æ‹©å®Œæˆäºº</option>';

                // æ·»åŠ å®Œæˆäººé€‰é¡¹
                assignees.forEach(assignee => {
                    const option = document.createElement('option');
                    const assigneeName = typeof assignee === 'string' ? assignee : assignee.name;
                    option.value = assigneeName;
                    option.textContent = assigneeName;
                    select.appendChild(option);
                });
            }

        }

        // ========== ç•Œé¢åˆ‡æ¢åŠŸèƒ½ ==========

        // åˆ‡æ¢åˆ°ä»»åŠ¡ç•Œé¢
        function switchToTaskView() {
            console.log('åˆ‡æ¢åˆ°ä»»åŠ¡ç•Œé¢');

            const taskView = document.getElementById('taskView');
            const settingsView = document.getElementById('settingsView');
            const taskViewBtn = document.getElementById('taskViewBtn');
            const settingsViewBtn = document.getElementById('settingsViewBtn');

            if (taskView) taskView.style.display = 'block';
            if (settingsView) settingsView.style.display = 'none';

            if (taskViewBtn) taskViewBtn.classList.add('active');
            if (settingsViewBtn) settingsViewBtn.classList.remove('active');

            console.log('ä»»åŠ¡ç•Œé¢åˆ‡æ¢å®Œæˆ');
        }

        // åˆ‡æ¢åˆ°è®¾ç½®ç•Œé¢
        function switchToSettingsView() {
            console.log('=== å¼€å§‹åˆ‡æ¢åˆ°è®¾ç½®ç•Œé¢ ===');

            const taskView = document.getElementById('taskView');
            const settingsView = document.getElementById('settingsView');
            const taskViewBtn = document.getElementById('taskViewBtn');
            const settingsViewBtn = document.getElementById('settingsViewBtn');

            console.log('æ‰¾åˆ°çš„å…ƒç´ :');
            console.log('- taskView:', taskView);
            console.log('- settingsView:', settingsView);
            console.log('- taskViewBtn:', taskViewBtn);
            console.log('- settingsViewBtn:', settingsViewBtn);

            // å¼ºåˆ¶æ˜¾ç¤ºè®¾ç½®ç•Œé¢
            if (settingsView) {
                settingsView.style.display = 'block';
                settingsView.style.visibility = 'visible';
                settingsView.style.opacity = '1';
                console.log('âœ… è®¾ç½®ç•Œé¢æ ·å¼å·²è®¾ç½®ä¸ºæ˜¾ç¤º');
                console.log('è®¾ç½®ç•Œé¢å½“å‰æ ·å¼:', settingsView.style.cssText);
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°è®¾ç½®ç•Œé¢å…ƒç´ ');
                return;
            }

            // éšè—ä»»åŠ¡ç•Œé¢
            if (taskView) {
                taskView.style.display = 'none';
                console.log('âœ… ä»»åŠ¡ç•Œé¢å·²éšè—');
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (taskViewBtn) taskViewBtn.classList.remove('active');
            if (settingsViewBtn) settingsViewBtn.classList.add('active');

            console.log('=== è®¾ç½®ç•Œé¢åˆ‡æ¢å®Œæˆ ===');
        }

        // è°ƒè¯•å‡½æ•°ï¼šå¼ºåˆ¶æ˜¾ç¤ºè®¾ç½®ç•Œé¢
        function forceShowSettings() {
            console.log('å¼ºåˆ¶æ˜¾ç¤ºè®¾ç½®ç•Œé¢');
            const settingsView = document.getElementById('settingsView');
            if (settingsView) {
                settingsView.style.display = 'block';
                settingsView.style.visibility = 'visible';
                settingsView.style.opacity = '1';
                console.log('è®¾ç½®ç•Œé¢åº”è¯¥ç°åœ¨å¯è§äº†');
            } else {
                console.error('æ‰¾ä¸åˆ°è®¾ç½®ç•Œé¢å…ƒç´ ');
            }
        }

        // æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿è°ƒè¯•
        window.forceShowSettings = forceShowSettings;

        // ========== æ‚¬æµ®çƒåŠŸèƒ½ ==========

        let fabOpen = false;

        // åˆ‡æ¢æ‚¬æµ®çƒèœå•
        function toggleFab() {
            const fabMain = document.getElementById('fabMain');
            const fabMenu = document.getElementById('fabMenu');

            fabOpen = !fabOpen;

            if (fabOpen) {
                fabMain.classList.add('active');
                fabMenu.classList.add('active');
            } else {
                fabMain.classList.remove('active');
                fabMenu.classList.remove('active');
            }
        }

        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ‚¬æµ®çƒèœå•
        document.addEventListener('click', function(event) {
            const fabContainer = document.querySelector('.fab-container');
            if (fabOpen && !fabContainer.contains(event.target)) {
                toggleFab();
            }
        });

        // ========== å¤šé€‰å®ŒæˆäººåŠŸèƒ½ ==========

        // å­˜å‚¨é€‰ä¸­çš„å®Œæˆäºº
        let selectedAssignees = {
            add: [],
            edit: [],
            complete: []
        };

        // åˆ‡æ¢ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçŠ¶æ€
        function toggleAssigneeDropdown(type) {
            const display = document.getElementById(`${type}TaskAssigneeDisplay`);
            const dropdown = document.getElementById(`${type}TaskAssigneeDropdown`);

            if (!display || !dropdown) return;

            const isActive = dropdown.classList.contains('active');

            // å…³é—­æ‰€æœ‰ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.multi-select-display').forEach(d => d.classList.remove('active'));

            if (!isActive) {
                dropdown.classList.add('active');
                display.classList.add('active');
                // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†å†…å®¹
                initializeAssigneeOptions(type);
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ‰“å¼€çš„æ¨¡æ€æ¡†ä¸­çš„å®Œæˆäººé€‰é¡¹
        function refreshAssigneeOptions() {
            // æ£€æŸ¥æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
            const addModal = document.getElementById('addModal');
            if (addModal && addModal.style.display !== 'none') {
                const addDropdown = document.querySelector('#addTaskAssigneeDropdown.active');
                if (addDropdown) {
                    initializeAssigneeOptions('add');
                }
            }

            // æ£€æŸ¥ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
            const editModal = document.getElementById('editModal');
            if (editModal && editModal.style.display !== 'none') {
                const editDropdown = document.querySelector('#editTaskAssigneeDropdown.active');
                if (editDropdown) {
                    initializeAssigneeOptions('edit');
                }
            }
        }

        // åˆå§‹åŒ–å®Œæˆäººé€‰é¡¹
        function initializeAssigneeOptions(type) {
            const optionsContainer = document.getElementById(`${type}TaskAssigneeOptions`);
            if (!optionsContainer) return;

            // ä½¿ç”¨é…ç½®çš„å®Œæˆäººåˆ—è¡¨ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤åˆ—è¡¨
            const configuredAssignees = assignees && assignees.length > 0 ? assignees : [
                'å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'å­™ä¸ƒ',
                'å‘¨å…«', 'å´ä¹', 'éƒ‘å', 'é™ˆä¸€', 'åˆ˜äºŒ'
            ];

            optionsContainer.innerHTML = '';

            configuredAssignees.forEach(assignee => {
                // å¤„ç†å­—ç¬¦ä¸²æˆ–å¯¹è±¡æ ¼å¼
                const assigneeName = typeof assignee === 'string' ? assignee : assignee.name;
                const option = document.createElement('div');
                option.className = 'assignee-option';
                option.innerHTML = `
                    <input type="checkbox" id="${type}_${assigneeName}" onchange="toggleAssigneeSelection('${type}', '${assigneeName}')">
                    <label for="${type}_${assigneeName}">${assigneeName}</label>
                `;

                // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
                if (selectedAssignees[type].includes(assigneeName)) {
                    option.querySelector('input').checked = true;
                    option.classList.add('selected');
                }

                optionsContainer.appendChild(option);
            });
        }

        // åˆ‡æ¢å®Œæˆäººé€‰ä¸­çŠ¶æ€
        function toggleAssigneeSelection(type, assignee) {
            const checkbox = document.getElementById(`${type}_${assignee}`);
            const option = checkbox.closest('.assignee-option');

            if (checkbox.checked) {
                if (!selectedAssignees[type].includes(assignee)) {
                    selectedAssignees[type].push(assignee);
                }
                option.classList.add('selected');
            } else {
                selectedAssignees[type] = selectedAssignees[type].filter(a => a !== assignee);
                option.classList.remove('selected');
            }

            updateAssigneeDisplay(type);
        }

        // æ›´æ–°æ˜¾ç¤ºåŒºåŸŸ
        function updateAssigneeDisplay(type) {
            const display = document.getElementById(`${type}TaskAssigneeDisplay`);
            if (!display) return;

            const placeholder = display.querySelector('.placeholder');
            let selectedItemsContainer = display.querySelector('.selected-items');

            // åˆ é™¤ç°æœ‰çš„é€‰ä¸­é¡¹å®¹å™¨
            if (selectedItemsContainer) {
                selectedItemsContainer.remove();
            }

            if (selectedAssignees[type].length === 0) {
                placeholder.style.display = 'block';
            } else {
                placeholder.style.display = 'none';

                // åˆ›å»ºæ–°çš„é€‰ä¸­é¡¹å®¹å™¨
                selectedItemsContainer = document.createElement('div');
                selectedItemsContainer.className = 'selected-items';

                selectedAssignees[type].forEach(assignee => {
                    const item = document.createElement('span');
                    item.className = 'selected-item';
                    item.innerHTML = `
                        ${assignee}
                        <span class="remove" onclick="removeAssignee('${type}', '${assignee}')">Ã—</span>
                    `;
                    selectedItemsContainer.appendChild(item);
                });

                display.insertBefore(selectedItemsContainer, display.querySelector('.dropdown-arrow'));
            }
        }

        // ç§»é™¤å®Œæˆäºº
        function removeAssignee(type, assignee) {
            selectedAssignees[type] = selectedAssignees[type].filter(a => a !== assignee);
            updateAssigneeDisplay(type);

            // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
            const checkbox = document.getElementById(`${type}_${assignee}`);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.assignee-option').classList.remove('selected');
            }
        }

        // ç­›é€‰å®Œæˆäºº
        function filterAssignees(type, searchText) {
            const options = document.querySelectorAll(`#${type}TaskAssigneeOptions .assignee-option`);
            const lowerSearchText = searchText.toLowerCase();

            let hasResults = false;
            options.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                if (label.includes(lowerSearchText)) {
                    option.style.display = 'flex';
                    hasResults = true;
                } else {
                    option.style.display = 'none';
                }
            });

            // æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
            const container = document.getElementById(`${type}TaskAssigneeOptions`);
            let noResults = container.querySelector('.no-results');

            if (!hasResults && searchText.trim()) {
                if (!noResults) {
                    noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.textContent = 'æœªæ‰¾åˆ°ç›¸å…³å®Œæˆäºº';
                    container.appendChild(noResults);
                }
            } else if (noResults) {
                noResults.remove();
            }
        }

        // è®¾ç½®é€‰ä¸­çš„å®Œæˆäººï¼ˆç”¨äºç¼–è¾‘ä»»åŠ¡æ—¶åˆå§‹åŒ–ï¼‰
        function setSelectedAssignees(type, assignees) {
            selectedAssignees[type] = Array.isArray(assignees) ? [...assignees] : [];
            updateAssigneeDisplay(type);
        }

        // è·å–é€‰ä¸­çš„å®Œæˆäºº
        function getSelectedAssignees(type) {
            return [...selectedAssignees[type]];
        }

        // æ¸…ç©ºé€‰ä¸­çš„å®Œæˆäºº
        function clearSelectedAssignees(type) {
            setSelectedAssignees(type, []);
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ ï¼Œä¸å¤„ç†ä¸‹æ‹‰æ¡†å…³é—­
            if (e.target.closest('.modal') ||
                e.target.closest('.close-btn') ||
                e.target.classList.contains('close-btn') ||
                e.target.closest('[id*="cancel"]') ||
                e.target.closest('[id*="close"]') ||
                e.target.closest('[id*="Modal"]') ||
                e.target.closest('.modal-content') ||
                e.target.closest('.modal-header') ||
                e.target.closest('.modal-footer') ||
                e.target.id.includes('cancel') ||
                e.target.id.includes('close') ||
                e.target.id.includes('Cancel') ||
                e.target.id.includes('Close')) {
                return;
            }

            if (!e.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('active'));
                document.querySelectorAll('.multi-select-display').forEach(d => d.classList.remove('active'));
            }
        });

        // ========== ä¸ªäººä¿¡æ¯è®¾ç½®åŠŸèƒ½ ==========

        // æ˜¾ç¤ºä¸ªäººä¿¡æ¯è®¾ç½®æ¨¡æ€æ¡†
        function showPersonalInfoModal() {
            const modal = document.getElementById('personalInfoModal');
            if (modal) {
                lockScroll(); // é”å®šé¡µé¢æ»šåŠ¨
                modal.style.display = 'flex';
                initializeMyAssigneeSelect();
                loadPersonalInfo(); // åœ¨åˆå§‹åŒ–é€‰é¡¹åå†åŠ è½½è®¾ç½®
                updateCurrentIdentityDisplay(); // æ›´æ–°å½“å‰èº«ä»½æ˜¾ç¤º
            }
        }

        // å…³é—­ä¸ªäººä¿¡æ¯è®¾ç½®æ¨¡æ€æ¡†
        function closePersonalInfoModal() {
            const modal = document.getElementById('personalInfoModal');
            if (modal) {
                unlockScroll(); // è§£é”é¡µé¢æ»šåŠ¨
                modal.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–æˆ‘çš„èº«ä»½ä¸‹æ‹‰åˆ—è¡¨
        function initializeMyAssigneeSelect() {
            const myAssigneeDropdown = document.getElementById('myAssigneeSelectDropdown');
            if (!myAssigneeDropdown) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
            myAssigneeDropdown.innerHTML = `
                <div class="custom-select-option" data-value="">
                    <span>è¯·ä»å®Œæˆäººåˆ—è¡¨ä¸­é€‰æ‹©è‡ªå·±</span>
                </div>
            `;

            // æ·»åŠ å®Œæˆäººé€‰é¡¹
            assignees.forEach(assignee => {
                const assigneeName = typeof assignee === 'string' ? assignee : assignee.name;
                const optionDiv = document.createElement('div');
                optionDiv.className = 'custom-select-option';
                optionDiv.dataset.value = assigneeName;
                optionDiv.innerHTML = `<span>${assigneeName}</span>`;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                optionDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleCustomSingleSelectOption('myAssigneeSelect', this);
                });

                myAssigneeDropdown.appendChild(optionDiv);
            });

            // æ›´æ–°æ˜¾ç¤º
            updateCustomSingleSelectDisplay('myAssigneeSelect');
            updateCustomSingleSelectOptions('myAssigneeSelect');
        }

        // æ›´æ–°å½“å‰èº«ä»½æ˜¾ç¤º
        function updateCurrentIdentityDisplay() {
            const currentIdentityDisplay = document.getElementById('currentIdentityDisplay');
            if (!currentIdentityDisplay) return;

            const identityIcon = currentIdentityDisplay.querySelector('.identity-icon');
            const identityName = currentIdentityDisplay.querySelector('.identity-name');

            if (personalInfo.myAssignee) {
                const assigneeName = personalInfo.myAssignee;
                const firstChar = assigneeName.charAt(0).toUpperCase();

                identityIcon.textContent = firstChar;
                identityIcon.style.background = '#66BB6A';
                identityName.textContent = assigneeName;
                identityName.style.color = '#2E7D32';
            } else {
                identityIcon.textContent = '?';
                identityIcon.style.background = '#bbb';
                identityName.textContent = 'æœªè®¾ç½®èº«ä»½';
                identityName.style.color = '#666';
            }
        }

        // åˆ‡æ¢æƒé™é™åˆ¶è­¦å‘Šæ˜¾ç¤º
        function toggleRestrictionWarning(show) {
            const warning = document.getElementById('restrictionWarning');
            if (warning) {
                warning.style.display = show ? 'block' : 'none';
            }
        }

        // å¤„ç†è§’è‰²é™åˆ¶å¤é€‰æ¡†å˜åŒ–
        function handleRoleRestrictionChange() {
            toggleRestrictionWarning(this.checked);
        }

        // åŠ è½½ä¸ªäººä¿¡æ¯
        function loadPersonalInfo() {
            const saved = localStorage.getItem('personalInfo');
            if (saved) {
                personalInfo = JSON.parse(saved);
                console.log('Loaded personal info:', personalInfo);
            }

            const myAssigneeSelectContainer = document.getElementById('myAssigneeSelectContainer');
            const enableRoleRestrictionCheckbox = document.getElementById('enableRoleRestriction');

            // è®¾ç½®è‡ªå®šä¹‰é€‰æ‹©å™¨çš„å€¼
            customSingleSelectValues.myAssigneeSelect = personalInfo.myAssignee || '';
            updateCustomSingleSelectDisplay('myAssigneeSelect');
            updateCustomSingleSelectOptions('myAssigneeSelect');
            console.log('Set myAssignee to:', personalInfo.myAssignee);

            if (enableRoleRestrictionCheckbox) {
                enableRoleRestrictionCheckbox.checked = personalInfo.enableRoleRestriction || false;
                console.log('Set enableRoleRestriction to:', personalInfo.enableRoleRestriction);

                // æ˜¾ç¤º/éšè—è­¦å‘Šä¿¡æ¯
                toggleRestrictionWarning(personalInfo.enableRoleRestriction);

                // ç§»é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                enableRoleRestrictionCheckbox.removeEventListener('change', handleRoleRestrictionChange);

                // æ·»åŠ å¤é€‰æ¡†å˜åŒ–äº‹ä»¶ç›‘å¬
                enableRoleRestrictionCheckbox.addEventListener('change', handleRoleRestrictionChange);
            }

            updateCurrentIdentityDisplay();
        }

        // ä¿å­˜ä¸ªäººä¿¡æ¯
        function savePersonalInfo() {
            console.log('savePersonalInfo called');
            const myAssigneeSelectContainer = document.getElementById('myAssigneeSelectContainer');
            const enableRoleRestrictionCheckbox = document.getElementById('enableRoleRestriction');

            if (!myAssigneeSelectContainer || !enableRoleRestrictionCheckbox) {
                console.error('Personal info form elements not found', {
                    myAssigneeSelectContainer: !!myAssigneeSelectContainer,
                    enableRoleRestrictionCheckbox: !!enableRoleRestrictionCheckbox
                });
                alert('ä¿å­˜å¤±è´¥ï¼šè¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            const previousAssignee = personalInfo.myAssignee;
            const previousRestriction = personalInfo.enableRoleRestriction;

            personalInfo.myAssignee = getCustomSingleSelectValue('myAssigneeSelect') || null;
            personalInfo.enableRoleRestriction = enableRoleRestrictionCheckbox.checked;

            console.log('Saving personal info:', personalInfo);
            localStorage.setItem('personalInfo', JSON.stringify(personalInfo));

            // æ›´æ–°èº«ä»½æ˜¾ç¤º
            updateCurrentIdentityDisplay();

            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            let changeMessage = 'ä¸ªäººä¿¡æ¯å·²ä¿å­˜ï¼';
            if (previousAssignee !== personalInfo.myAssignee) {
                changeMessage += personalInfo.myAssignee ?
                    `\nèº«ä»½å·²è®¾ç½®ä¸ºï¼š${personalInfo.myAssignee}` :
                    '\nèº«ä»½å·²æ¸…é™¤';
            }
            if (previousRestriction !== personalInfo.enableRoleRestriction) {
                changeMessage += personalInfo.enableRoleRestriction ?
                    '\nè§’è‰²é™åˆ¶å·²å¯ç”¨' :
                    '\nè§’è‰²é™åˆ¶å·²å…³é—­';
            }

            alert(changeMessage);

            closePersonalInfoModal();

            // åŒæ­¥ç”¨æˆ·è®¾ç½®åˆ°Androidç«¯
            syncUserSettingsToAndroid();

            // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä»¥åº”ç”¨æƒé™è¿‡æ»¤
            renderTasks();
        }

        function getDailyTodoSettings() {
            const saved = localStorage.getItem('dailyTodoSettings');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                template: 'ä¸Šç­æ‰“å¡|high|work|09:50\nä¸‹ç­æ‰“å¡|high|work|19:00',
                autoAddTime: '09:00',
                enabled: true,
                skipHolidays: true, // é»˜è®¤è·³è¿‡èŠ‚å‡æ—¥
                lastAddedDate: null,
                serverChanKey: '',
                enableWechatNotify: false,
                morningNotifyTime: '09:00',
                eveningNotifyTime: '18:00',
                lastNotifyDate: null,
                lastNotifyInfo: {}
            };
        }

        async function checkAndAddDailyTodos() {
            const settings = getDailyTodoSettings();
            if (!settings.enabled || !settings.template) return false;

            const today = new Date();
            const todayString = today.toDateString();

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ å½“æ—¥ä»»åŠ¡
            if (!settings.lastAddedDate || settings.lastAddedDate !== todayString) {
                await addDailyTodos(settings, today);

                // æ›´æ–°æœ€åæ·»åŠ æ—¥æœŸ
                settings.lastAddedDate = todayString;
                localStorage.setItem('dailyTodoSettings', JSON.stringify(settings));

                // è¿”å›trueè¡¨ç¤ºæ·»åŠ äº†æ–°ä»»åŠ¡ï¼Œéœ€è¦é‡æ–°åŠ è½½æ•°æ®
                return true;
            }

            // è¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ·»åŠ æ–°ä»»åŠ¡
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºèŠ‚å‡æ—¥æˆ–ä¼‘æ¯æ—¥ï¼ˆè€ƒè™‘è°ƒä¼‘ï¼‰
        function isHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // JavaScriptæœˆä»½ä»0å¼€å§‹
            const day = date.getDate();
            const dayOfWeek = date.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            const dateStr = `${month}-${day}`;

            // è°ƒä¼‘å·¥ä½œæ—¥ï¼ˆåŸæœ¬æ˜¯å‘¨æœ«ä½†éœ€è¦ä¸Šç­çš„æ—¥æœŸï¼‰
            const makeupWorkDays = {
                2024: [
                    '2-4',   // æ˜¥èŠ‚è°ƒä¼‘ï¼š2æœˆ4æ—¥(å‘¨æ—¥)ä¸Šç­
                    '2-18',  // æ˜¥èŠ‚è°ƒä¼‘ï¼š2æœˆ18æ—¥(å‘¨æ—¥)ä¸Šç­
                    '4-7',   // æ¸…æ˜è°ƒä¼‘ï¼š4æœˆ7æ—¥(å‘¨æ—¥)ä¸Šç­
                    '4-28',  // åŠ³åŠ¨èŠ‚è°ƒä¼‘ï¼š4æœˆ28æ—¥(å‘¨æ—¥)ä¸Šç­
                    '5-11',  // åŠ³åŠ¨èŠ‚è°ƒä¼‘ï¼š5æœˆ11æ—¥(å‘¨å…­)ä¸Šç­
                    '9-14',  // ä¸­ç§‹è°ƒä¼‘ï¼š9æœˆ14æ—¥(å‘¨å…­)ä¸Šç­
                    '9-29',  // å›½åº†è°ƒä¼‘ï¼š9æœˆ29æ—¥(å‘¨æ—¥)ä¸Šç­
                    '10-12'  // å›½åº†è°ƒä¼‘ï¼š10æœˆ12æ—¥(å‘¨å…­)ä¸Šç­
                ],
                2025: [
                    '1-26',  // æ˜¥èŠ‚è°ƒä¼‘ï¼š1æœˆ26æ—¥(å‘¨æ—¥)ä¸Šç­ï¼ˆé¢„è®¡ï¼‰
                    '2-8',   // æ˜¥èŠ‚è°ƒä¼‘ï¼š2æœˆ8æ—¥(å‘¨å…­)ä¸Šç­ï¼ˆé¢„è®¡ï¼‰
                    '4-27',  // åŠ³åŠ¨èŠ‚è°ƒä¼‘ï¼š4æœˆ27æ—¥(å‘¨æ—¥)ä¸Šç­ï¼ˆé¢„è®¡ï¼‰
                    '5-4',   // åŠ³åŠ¨èŠ‚è°ƒä¼‘ï¼š5æœˆ4æ—¥(å‘¨æ—¥)ä¸Šç­ï¼ˆé¢„è®¡ï¼‰
                    '9-28',  // å›½åº†è°ƒä¼‘ï¼š9æœˆ28æ—¥(å‘¨æ—¥)ä¸Šç­ï¼ˆé¢„è®¡ï¼‰
                    '10-11'  // å›½åº†è°ƒä¼‘ï¼š10æœˆ11æ—¥(å‘¨å…­)ä¸Šç­ï¼ˆé¢„è®¡ï¼‰
                ]
            };

            // æ³•å®šèŠ‚å‡æ—¥ï¼ˆæ”¾å‡æ—¥æœŸï¼ŒåŒ…å«å› è°ƒä¼‘å½¢æˆçš„è¿ä¼‘ï¼‰
            const holidays = {
                2024: [
                    // å…ƒæ—¦ï¼š1æœˆ1æ—¥
                    '1-1',
                    // æ˜¥èŠ‚ï¼š2æœˆ10æ—¥-17æ—¥ï¼ˆè°ƒä¼‘åçš„å®é™…æ”¾å‡æ—¥æœŸï¼‰
                    '2-10', '2-11', '2-12', '2-13', '2-14', '2-15', '2-16', '2-17',
                    // æ¸…æ˜èŠ‚ï¼š4æœˆ4æ—¥-6æ—¥
                    '4-4', '4-5', '4-6',
                    // åŠ³åŠ¨èŠ‚ï¼š5æœˆ1æ—¥-5æ—¥
                    '5-1', '5-2', '5-3', '5-4', '5-5',
                    // ç«¯åˆèŠ‚ï¼š6æœˆ10æ—¥
                    '6-10',
                    // ä¸­ç§‹èŠ‚ï¼š9æœˆ15æ—¥-17æ—¥
                    '9-15', '9-16', '9-17',
                    // å›½åº†èŠ‚ï¼š10æœˆ1æ—¥-7æ—¥
                    '10-1', '10-2', '10-3', '10-4', '10-5', '10-6', '10-7'
                ],
                2025: [
                    // å…ƒæ—¦ï¼š1æœˆ1æ—¥
                    '1-1',
                    // æ˜¥èŠ‚ï¼š1æœˆ28æ—¥-2æœˆ3æ—¥ï¼ˆé¢„è®¡ï¼‰
                    '1-28', '1-29', '1-30', '1-31', '2-1', '2-2', '2-3',
                    // æ¸…æ˜èŠ‚ï¼š4æœˆ5æ—¥-7æ—¥ï¼ˆé¢„è®¡ï¼‰
                    '4-5', '4-6', '4-7',
                    // åŠ³åŠ¨èŠ‚ï¼š5æœˆ1æ—¥-5æ—¥ï¼ˆé¢„è®¡ï¼‰
                    '5-1', '5-2', '5-3', '5-4', '5-5',
                    // ç«¯åˆèŠ‚ï¼š5æœˆ31æ—¥-6æœˆ2æ—¥ï¼ˆé¢„è®¡ï¼‰
                    '5-31', '6-1', '6-2',
                    // ä¸­ç§‹èŠ‚ï¼š10æœˆ6æ—¥-8æ—¥ï¼ˆé¢„è®¡ï¼‰
                    '10-6', '10-7', '10-8',
                    // å›½åº†èŠ‚ï¼š10æœˆ1æ—¥-7æ—¥
                    '10-1', '10-2', '10-3', '10-4', '10-5', '10-6', '10-7'
                ]
            };

            // æ£€æŸ¥æ˜¯å¦ä¸ºè°ƒä¼‘å·¥ä½œæ—¥ï¼ˆå‘¨æœ«å˜å·¥ä½œæ—¥ï¼‰
            const yearMakeupDays = makeupWorkDays[year];
            if (yearMakeupDays && yearMakeupDays.includes(dateStr)) {
                return false; // è°ƒä¼‘å·¥ä½œæ—¥ï¼Œä¸è·³è¿‡ä»»åŠ¡
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºæ³•å®šèŠ‚å‡æ—¥
            const yearHolidays = holidays[year];
            if (yearHolidays && yearHolidays.includes(dateStr)) {
                return true; // æ³•å®šèŠ‚å‡æ—¥ï¼Œè·³è¿‡ä»»åŠ¡
            }

            // æ™®é€šå‘¨æœ«æ£€æŸ¥ï¼ˆéè°ƒä¼‘å·¥ä½œæ—¥çš„å‘¨æœ«ï¼‰
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return true; // æ™®é€šå‘¨æœ«ï¼Œè·³è¿‡ä»»åŠ¡
            }

            return false; // æ™®é€šå·¥ä½œæ—¥ï¼Œä¸è·³è¿‡ä»»åŠ¡
        }

        // åªä¸ºå½“å¤©æ·»åŠ æ¯æ—¥å¾…åŠä»»åŠ¡
        async function addDailyTodos(settings, targetDate = new Date()) {
            const lines = settings.template.split('\n').filter(line => line.trim());
            let createdCount = 0;
            const targetDateString = targetDate.toDateString();

            // æ£€æŸ¥æ˜¯å¦ä¸ºèŠ‚å‡æ—¥ï¼Œå¦‚æœå¼€å¯äº†è·³è¿‡èŠ‚å‡æ—¥è®¾ç½®ä¸”æ˜¯èŠ‚å‡æ—¥ï¼Œåˆ™è·³è¿‡
            if (settings.skipHolidays && isHoliday(targetDate)) {
                console.log(`è·³è¿‡èŠ‚å‡æ—¥ä»»åŠ¡ç”Ÿæˆ: ${targetDateString}`);
                return createdCount;
            }

            for (const line of lines) {
                const parts = line.split('|');
                if (parts.length >= 1) {
                    const title = parts[0].trim();
                    const priority = parts[1] ? parts[1].trim() : 'medium';
                    const category = parts[2] ? parts[2].trim() : 'other';
                    const timeStr = parts[3] ? parts[3].trim() : '23:59';
                    const assignee = parts[4] ? parts[4].trim() : '';

                    // æ™ºèƒ½é‡å¤æ£€æµ‹é€»è¾‘ï¼ˆåŒ…å«å®Œæˆäººæ£€æµ‹ï¼‰
                    const shouldSkipTask = checkDailyTaskDuplication(title, targetDateString, assignee);

                    if (!shouldSkipTask) {
                        // è§£ææˆªæ­¢æ—¶é—´
                        const deadline = new Date(targetDate);
                        if (timeStr && timeStr.includes(':')) {
                            const [hours, minutes] = timeStr.split(':').map(n => parseInt(n));
                            if (!isNaN(hours) && !isNaN(minutes) && hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                                deadline.setHours(hours + 8, minutes, 0, 0); // ä¿®å¤æ—¶åŒºé—®é¢˜ï¼šå¢åŠ 8å°æ—¶
                            } else {
                                deadline.setHours(23 + 8, 59, 0, 0); // é»˜è®¤23:59 + 8å°æ—¶ = æ¬¡æ—¥7:59
                            }
                        } else {
                            deadline.setHours(23 + 8, 59, 0, 0); // é»˜è®¤23:59 + 8å°æ—¶ = æ¬¡æ—¥7:59
                        }

                        const task = {
                            id: generateId(),
                            title: title,
                            notes: '',
                            completed: false,
                            priority: ['high', 'medium', 'low'].includes(priority) ? priority : 'medium',
                            category: ['work', 'life', 'study', 'other'].includes(category) ? category : 'other',
                            deadline: deadline.toISOString(),
                            createdAt: getCurrentUTCTimeString(),
                            assignee: assignee,
                            assignees: assignee ? [assignee] : [],
                            completedBy: '',
                            isDailyTodo: true // æ ‡è®°ä¸ºæ¯æ—¥å¾…åŠä»»åŠ¡
                        };

                        tasks.push(task);
                        createdCount++;

                        // åŒæ­¥æ¯æ—¥å¾…åŠä»»åŠ¡åˆ°äº‘ç«¯
                        try {
                            await createTaskAPI(task);
                            console.log('æ¯æ—¥å¾…åŠä»»åŠ¡å·²åŒæ­¥åˆ°äº‘ç«¯:', title);
                        } catch (error) {
                            console.error('æ¯æ—¥å¾…åŠä»»åŠ¡åŒæ­¥å¤±è´¥:', title, error);
                        }
                    }
                }
            }

            if (createdCount > 0) {
                console.log(`æˆåŠŸåˆ›å»º ${createdCount} ä¸ªå½“æ—¥æ¯æ—¥å¾…åŠä»»åŠ¡å¹¶åŒæ­¥åˆ°äº‘ç«¯`);
            }
            return createdCount;
        }

        async function addWeeklyTodos(settings, startDate = new Date()) {
            const lines = settings.template.split('\n').filter(line => line.trim());
            let createdCount = 0;

            // ä¸ºæ¥ä¸‹æ¥çš„7å¤©æ·»åŠ ä»»åŠ¡
            for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                const targetDate = new Date(startDate);
                targetDate.setDate(startDate.getDate() + dayOffset);
                const targetDateString = targetDate.toDateString();

                // æ£€æŸ¥æ˜¯å¦ä¸ºèŠ‚å‡æ—¥ï¼Œå¦‚æœå¼€å¯äº†è·³è¿‡èŠ‚å‡æ—¥è®¾ç½®ä¸”æ˜¯èŠ‚å‡æ—¥ï¼Œåˆ™è·³è¿‡
                if (settings.skipHolidays && isHoliday(targetDate)) {
                    console.log(`è·³è¿‡èŠ‚å‡æ—¥ä»»åŠ¡ç”Ÿæˆ: ${targetDateString}`);
                    continue;
                }
                
                for (const line of lines) {
                    const parts = line.split('|');
                    if (parts.length >= 1) {
                        const title = parts[0].trim();
                        const priority = parts[1] ? parts[1].trim() : 'medium';
                        const category = parts[2] ? parts[2].trim() : 'other';
                        const timeStr = parts[3] ? parts[3].trim() : '23:59';
                        const assignee = parts[4] ? parts[4].trim() : '';

                        // æ™ºèƒ½é‡å¤æ£€æµ‹é€»è¾‘ï¼ˆåŒ…å«å®Œæˆäººæ£€æµ‹ï¼‰
                        const shouldSkipTask = checkDailyTaskDuplication(title, targetDateString, assignee);

                        if (!shouldSkipTask) {
                            // è§£ææˆªæ­¢æ—¶é—´
                            const deadline = new Date(targetDate);
                            if (timeStr && timeStr.includes(':')) {
                                const [hours, minutes] = timeStr.split(':').map(n => parseInt(n));
                                if (!isNaN(hours) && !isNaN(minutes) && hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                                    deadline.setHours(hours + 8, minutes, 0, 0); // ä¿®å¤æ—¶åŒºé—®é¢˜ï¼šå¢åŠ 8å°æ—¶
                                } else {
                                    deadline.setHours(23 + 8, 59, 0, 0); // é»˜è®¤23:59 + 8å°æ—¶ = æ¬¡æ—¥7:59
                                }
                            } else {
                                deadline.setHours(23 + 8, 59, 0, 0); // é»˜è®¤23:59 + 8å°æ—¶ = æ¬¡æ—¥7:59
                            }

                            const task = {
                                id: generateId(),
                                title: title,
                                notes: '',
                                completed: false,
                                priority: ['high', 'medium', 'low'].includes(priority) ? priority : 'medium',
                                category: ['work', 'life', 'study', 'other'].includes(category) ? category : 'other',
                                deadline: deadline.toISOString(),
                                createdAt: getCurrentUTCTimeString(),
                                completedAt: null,
                                assignee: assignee,
                                assignees: assignee ? [assignee] : [],
                                isDailyTodo: true // æ ‡è®°ä¸ºæ¯æ—¥å¾…åŠä»»åŠ¡
                            };

                            // è°ƒç”¨APIåˆ›å»ºä»»åŠ¡åˆ°äº‘ç«¯æ•°æ®åº“
                            try {
                                await createTaskAPI(task);
                                createdCount++;
                                console.log('æ¯æ—¥å¾…åŠä»»åŠ¡å·²åŒæ­¥åˆ°äº‘ç«¯:', title);
                            } catch (error) {
                                console.error('æ¯æ—¥å¾…åŠä»»åŠ¡åŒæ­¥å¤±è´¥:', title, error);
                                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè‡³å°‘æ·»åŠ åˆ°æœ¬åœ°æ•°ç»„ä»¥ä¿æŒåŠŸèƒ½å¯ç”¨
                                tasks.unshift(task);
                            }
                        }
                    }
                }
            }

            if (createdCount > 0) {
                console.log(`æˆåŠŸåˆ›å»º ${createdCount} ä¸ªæ¯æ—¥å¾…åŠä»»åŠ¡å¹¶åŒæ­¥åˆ°äº‘ç«¯`);
            }
        }

        function cleanupExpiredDailyTodos() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºä»Šå¤©å¼€å§‹
            
            // åˆ é™¤æ˜¨å¤©åŠæ›´æ—©çš„æœªå®Œæˆæ¯æ—¥å¾…åŠä»»åŠ¡
            const originalLength = tasks.length;
            tasks = tasks.filter(task => {
                // ä¿ç•™éæ¯æ—¥å¾…åŠä»»åŠ¡
                if (!task.isDailyTodo) return true;
                
                // ä¿ç•™å·²å®Œæˆçš„æ¯æ—¥å¾…åŠä»»åŠ¡
                if (task.completed) return true;
                
                // æ£€æŸ¥æˆªæ­¢æ—¥æœŸ
                if (task.deadline) {
                    const taskDate = new Date(task.deadline);
                    taskDate.setHours(0, 0, 0, 0);
                    
                    // ä¿ç•™ä»Šå¤©åŠä»¥åçš„ä»»åŠ¡
                    return taskDate >= today;
                }
                
                return true;
            });
            
            // å¦‚æœåˆ é™¤äº†ä»»åŠ¡ï¼Œä¿å­˜æ›´æ–°
            if (tasks.length !== originalLength) {
                saveTasks();
                console.log(`æ¸…ç†äº† ${originalLength - tasks.length} ä¸ªè¿‡æœŸçš„æ¯æ—¥å¾…åŠä»»åŠ¡`);
            }
        }

        function bindDailyTodoEvents() {
            console.log('é‡æ–°ç»‘å®šæ¯æ—¥å¾…åŠè®¾ç½®æŒ‰é’®äº‹ä»¶');

            // ç»‘å®šæ¯æ—¥å¾…åŠè®¾ç½®æŒ‰é’®
            bindButton('closeDailyTodoBtn', closeDailyTodoModal, 'æ¯æ—¥å¾…åŠå…³é—­æŒ‰é’®');
            bindButton('cancelDailyTodoBtn', closeDailyTodoModal, 'æ¯æ—¥å¾…åŠå–æ¶ˆæŒ‰é’®');
            bindButton('saveDailyTodoBtn', saveDailyTodoSettings, 'æ¯æ—¥å¾…åŠä¿å­˜æŒ‰é’®');

            // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
            const dailyTodoModal = document.getElementById('dailyTodoModal');
            if (dailyTodoModal) {
                dailyTodoModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('æ¯æ—¥å¾…åŠæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»');
                        closeDailyTodoModal();
                    }
                });
            }
        }

        function bindWechatEvents() {
            console.log('é‡æ–°ç»‘å®šå¾®ä¿¡è®¾ç½®æŒ‰é’®äº‹ä»¶');

            // ç»‘å®šå¾®ä¿¡è®¾ç½®æŒ‰é’®
            bindButton('closeWechatBtn', closeWechatModal, 'å¾®ä¿¡è®¾ç½®å…³é—­æŒ‰é’®');
            bindButton('cancelWechatBtn', closeWechatModal, 'å¾®ä¿¡è®¾ç½®å–æ¶ˆæŒ‰é’®');
            bindButton('saveWechatBtn', saveWechatSettings, 'å¾®ä¿¡è®¾ç½®ä¿å­˜æŒ‰é’®');

            // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
            const wechatModal = document.getElementById('wechatModal');
            if (wechatModal) {
                wechatModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('å¾®ä¿¡è®¾ç½®æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»');
                        closeWechatModal();
                    }
                });
            }
        }

        function bindAssigneeEvents() {
            console.log('é‡æ–°ç»‘å®šå®Œæˆäººç®¡ç†æŒ‰é’®äº‹ä»¶');

            // ç»‘å®šå®Œæˆäººç®¡ç†æŒ‰é’®
            bindButton('closeAssigneeBtn', closeAssigneeModal, 'å®Œæˆäººç®¡ç†å…³é—­æŒ‰é’®');
            bindButton('cancelAssigneeBtn', closeAssigneeModal, 'å®Œæˆäººç®¡ç†å–æ¶ˆæŒ‰é’®');

            // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
            const assigneeModal = document.getElementById('assigneeModal');
            if (assigneeModal) {
                assigneeModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('å®Œæˆäººç®¡ç†æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»');
                        closeAssigneeModal();
                    }
                });
            }

            // æ·»åŠ å›è½¦é”®æ”¯æŒ
            const newAssigneeNameInput = document.getElementById('newAssigneeName');
            if (newAssigneeNameInput) {
                newAssigneeNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addAssignee();
                    }
                });
            }
        }

        function bindDatabaseEvents() {
            console.log('é‡æ–°ç»‘å®šæ•°æ®åº“è®¾ç½®æŒ‰é’®äº‹ä»¶');

            // ç»‘å®šæ•°æ®åº“è®¾ç½®æŒ‰é’®
            bindButton('closeDatabaseBtn', closeDatabaseModal, 'æ•°æ®åº“è®¾ç½®å…³é—­æŒ‰é’®');
            bindButton('cancelDatabaseBtn', closeDatabaseModal, 'æ•°æ®åº“è®¾ç½®å–æ¶ˆæŒ‰é’®');
            bindButton('saveDatabaseBtn', saveDatabaseSettings, 'æ•°æ®åº“è®¾ç½®ä¿å­˜æŒ‰é’®');

            // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
            const databaseModal = document.getElementById('databaseModal');
            if (databaseModal) {
                databaseModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('æ•°æ®åº“è®¾ç½®æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»');
                        closeDatabaseModal();
                    }
                });
            }
        }

        function bindCompleteTaskEvents() {
            console.log('é‡æ–°ç»‘å®šä»»åŠ¡å®Œæˆå¼¹æ¡†æŒ‰é’®äº‹ä»¶');

            // ç»‘å®šä»»åŠ¡å®Œæˆå¼¹æ¡†æŒ‰é’®
            bindButton('closeCompleteBtn', closeCompleteTaskModal, 'ä»»åŠ¡å®Œæˆå…³é—­æŒ‰é’®');
            bindButton('cancelCompleteBtn', closeCompleteTaskModal, 'ä»»åŠ¡å®Œæˆå–æ¶ˆæŒ‰é’®');
            bindButton('confirmCompleteBtn', confirmCompleteTask, 'ä»»åŠ¡å®Œæˆç¡®è®¤æŒ‰é’®');
            bindButton('closePersonalInfoBtn', closePersonalInfoModal, 'ä¸ªäººä¿¡æ¯å…³é—­æŒ‰é’®');

            // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
            const completeTaskModal = document.getElementById('completeTaskModal');
            if (completeTaskModal) {
                completeTaskModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('ä»»åŠ¡å®Œæˆæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»');
                        closeCompleteTaskModal();
                    }
                });
            }

            const personalInfoModal = document.getElementById('personalInfoModal');
            if (personalInfoModal) {
                personalInfoModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»');
                        closePersonalInfoModal();
                    }
                });
            }

            // Android 14 ä¸“é—¨çš„å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ç»‘å®š
            if (isAndroid14()) {
                bindAndroid14ImageUploadEvents();
            }
        }




        // Android 14 å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ç»‘å®š - ä»…é’ˆå¯¹æ–‡å­—å…ƒç´ 
        function bindAndroid14ImageUploadEvents() {
            console.log('ç»‘å®šAndroid 14å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ - ä»…é’ˆå¯¹æ–‡å­—å…ƒç´ ');

            // ä¸ºä¸¤ä¸ªä¸Šä¼ åŒºåŸŸçš„æ–‡å­—å…ƒç´ ç»‘å®šå¢å¼ºäº‹ä»¶
            for (let i = 1; i <= 2; i++) {
                // æŸ¥æ‰¾å…·ä½“çš„æ–‡å­—å…ƒç´ ï¼Œè€Œä¸æ˜¯æ•´ä¸ªä¸Šä¼ åŒºåŸŸ
                const uploadArea = document.querySelector(`.image-upload-area:nth-child(${i})`);
                const uploadText = uploadArea ? uploadArea.querySelector('.upload-text') : null;
                const fileInput = document.getElementById(`completeImageInput${i}`);

                if (uploadText && fileInput) {
                    console.log(`æ‰¾åˆ°ä¸Šä¼ æ–‡å­—å…ƒç´ ${i}:`, uploadText);
                    console.log(`æ‰¾åˆ°æ–‡ä»¶è¾“å…¥${i}:`, fileInput);

                    // ç§»é™¤æ•´ä¸ªä¸Šä¼ åŒºåŸŸçš„ä»»ä½•ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                    if (uploadArea) {
                        // å…‹éš†å…ƒç´ ä»¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                        const newUploadArea = uploadArea.cloneNode(true);
                        uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);

                        // é‡æ–°è·å–æ–°çš„æ–‡å­—å…ƒç´ å¼•ç”¨
                        const newUploadText = newUploadArea.querySelector('.upload-text');

                        if (newUploadText) {
                            // åªç»™æ–‡å­—å…ƒç´ æ·»åŠ å¢å¼ºçš„ç‚¹å‡»äº‹ä»¶
                            const handleTextClick = function(e) {
                                console.log(`Android 14: ç‚¹å‡»ä¸Šä¼ æ–‡å­—${i}`);
                                e.preventDefault();
                                e.stopPropagation();

                                // ä½¿ç”¨åŸæœ‰çš„selectCompleteImageå‡½æ•°
                                selectCompleteImage(i);
                            };

                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                            newUploadText.addEventListener('click', handleTextClick);
                            newUploadText.addEventListener('touchend', handleTextClick);

                            // ç¡®ä¿æ–‡å­—å…ƒç´ æœ‰æ­£ç¡®çš„æ ·å¼
                            newUploadText.style.cursor = 'pointer';
                            newUploadText.setAttribute('role', 'button');
                            newUploadText.setAttribute('tabindex', '0');
                            newUploadText.setAttribute('aria-label', `é€‰æ‹©å›¾ç‰‡${i}`);
                        }
                    }

                    console.log(`å·²ç»‘å®šç¬¬${i}ä¸ªä¸Šä¼ æ–‡å­—çš„Android 14äº‹ä»¶`);
                } else {
                    console.warn(`æœªæ‰¾åˆ°ä¸Šä¼ æ–‡å­—å…ƒç´ æˆ–æ–‡ä»¶è¾“å…¥${i}`);
                }
            }
        }

        // Android 14ä¸“ç”¨æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleAndroid14FileSelect(event, imageIndex) {
            console.log(`Android 14æ–‡ä»¶é€‰æ‹©å¤„ç†${imageIndex}:`, event.target.files);
            handleCompleteImageSelect(event, imageIndex);
        }

        // æ›´ç›´æ¥çš„æ–‡ä»¶é€‰æ‹©è§¦å‘æ–¹æ³•
        function directTriggerFileSelect(imageIndex) {
            console.log(`è§¦å‘æ–‡ä»¶é€‰æ‹©${imageIndex}`);

            // ä¼˜å…ˆä½¿ç”¨åŸå§‹input
            const input = document.getElementById(`completeImageInput${imageIndex}`);
            if (input) {
                input.click();
                return;
            }

            // å¦‚æœåŸå§‹inputä¸å­˜åœ¨ï¼Œå°è¯•Android 14ä¸“ç”¨input
            const android14Input = document.getElementById(`android14Input${imageIndex}`);
            if (android14Input) {
                android14Input.click();
            }
        }

        // åˆ›å»ºå¯è§çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼ˆAndroid 14ä¸“ç”¨æ–¹æ¡ˆï¼‰
        function createVisibleFileInput(imageIndex) {
            console.log(`åˆ›å»ºå¯è§æ–‡ä»¶è¾“å…¥æ¡†${imageIndex}`);

            // åˆ›å»ºæ¨¡æ€è¦†ç›–å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 12000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å®¹å™¨
            const container = document.createElement('div');
            container.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                max-width: 300px;
                width: 90%;
            `;

            // æ·»åŠ æ ‡é¢˜
            const title = document.createElement('div');
            title.textContent = `é€‰æ‹©å›¾ç‰‡${imageIndex}`;
            title.style.cssText = `
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 15px;
                color: #333;
            `;

            // åˆ›å»ºå¯è§çš„æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,image/jpeg,image/png,image/gif';
            fileInput.style.cssText = `
                width: 100%;
                padding: 10px;
                border: 2px solid #667eea;
                border-radius: 4px;
                margin-bottom: 15px;
                font-size: 16px;
                background: white;
            `;

            // æ·»åŠ æŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 10px;
                justify-content: center;
            `;

            // å–æ¶ˆæŒ‰é’®
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.style.cssText = `
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                background: #ccc;
                color: #333;
                font-size: 16px;
                cursor: pointer;
            `;

            // ç¡®è®¤æŒ‰é’®
            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'ç¡®è®¤é€‰æ‹©';
            confirmButton.style.cssText = `
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                background: #667eea;
                color: white;
                font-size: 16px;
                cursor: pointer;
            `;

            // äº‹ä»¶å¤„ç†
            let selectedFile = null;

            fileInput.addEventListener('change', function(e) {
                selectedFile = e.target.files[0];
                console.log('é€‰æ‹©äº†æ–‡ä»¶:', selectedFile);
                if (selectedFile) {
                    confirmButton.style.background = '#4CAF50';
                    confirmButton.textContent = `å·²é€‰æ‹©: ${selectedFile.name.substring(0, 20)}...`;
                }
            });

            cancelButton.addEventListener('click', function() {
                console.log('å–æ¶ˆæ–‡ä»¶é€‰æ‹©');
                document.body.removeChild(overlay);
            });

            confirmButton.addEventListener('click', function() {
                console.log('ç¡®è®¤æ–‡ä»¶é€‰æ‹©:', selectedFile);
                if (selectedFile) {
                    // åˆ›å»ºæ¨¡æ‹Ÿçš„changeäº‹ä»¶å¯¹è±¡
                    const mockEvent = {
                        target: {
                            files: [selectedFile]
                        }
                    };

                    // è°ƒç”¨å¤„ç†å‡½æ•°
                    handleCompleteImageSelect(mockEvent, imageIndex);
                }
                document.body.removeChild(overlay);
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });

            // ç»„è£…å…ƒç´ 
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(confirmButton);

            container.appendChild(title);
            container.appendChild(fileInput);
            container.appendChild(buttonContainer);

            overlay.appendChild(container);
            document.body.appendChild(overlay);

            // è‡ªåŠ¨èšç„¦åˆ°æ–‡ä»¶è¾“å…¥æ¡†
            setTimeout(() => {
                fileInput.focus();
                fileInput.click();
            }, 100);
        }

        // Android 14 æ–‡ä»¶é€‰æ‹©è§¦å‘å‡½æ•°
        function triggerAndroid14FileSelect(imageIndex) {
            const input = document.getElementById(`completeImageInput${imageIndex}`);

            if (input) {
                console.log(`è§¦å‘Android 14æ–‡ä»¶é€‰æ‹©ï¼Œå›¾ç‰‡ç´¢å¼•: ${imageIndex}`);
                input.click();
            }
        }

        // æ£€æŸ¥Android 14æ–‡ä»¶è®¿é—®æƒé™
        function checkAndroid14FileAccess() {
            try {
                // æ£€æŸ¥åŸºæœ¬çš„æ–‡ä»¶APIå¯ç”¨æ€§
                if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
                    console.warn('æ–‡ä»¶APIä¸å®Œæ•´');
                    return false;
                }

                // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¸Šä¸‹æ–‡ï¼Œå¯èƒ½å½±å“æ–‡ä»¶è®¿é—®');
                }

                // æ£€æŸ¥ç”¨æˆ·æ¿€æ´»çŠ¶æ€ï¼ˆAndroid 14ä¸¥æ ¼è¦æ±‚ï¼‰
                if (window.navigator && window.navigator.userActivation && !window.navigator.userActivation.isActive) {
                    console.warn('ç”¨æˆ·æ¿€æ´»çŠ¶æ€æ— æ•ˆ');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('æ–‡ä»¶è®¿é—®æ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }

        // ç®€å•å¯é çš„æŒ‰é’®ç»‘å®šå‡½æ•°
        function bindButton(buttonId, callback, buttonName) {
            const button = document.getElementById(buttonId);
            if (!button) {
                console.log(`æŒ‰é’®ä¸å­˜åœ¨: ${buttonId}`);
                return;
            }

            if (typeof callback !== 'function') {
                console.log(`å›è°ƒå‡½æ•°æ— æ•ˆ: ${buttonName}`);
                return;
            }

            console.log(`ç»‘å®šæŒ‰é’®: ${buttonName} (${buttonId})`);

            // æ¸…é™¤ç°æœ‰äº‹ä»¶
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);

            // ç®€å•çš„ç‚¹å‡»äº‹ä»¶ç»‘å®š
            newButton.addEventListener('click', function(e) {
                console.log(`æŒ‰é’®ç‚¹å‡»: ${buttonName}`);
                try {
                    callback();
                } catch (error) {
                    console.error(`æŒ‰é’®å›è°ƒé”™è¯¯ ${buttonName}:`, error);
                }
            });

            // ä¸ºç§»åŠ¨ç«¯æ·»åŠ è§¦æ‘¸äº‹ä»¶
            newButton.addEventListener('touchend', function(e) {
                console.log(`è§¦æ‘¸ç»“æŸ: ${buttonName}`);
                e.preventDefault();
                try {
                    callback();
                } catch (error) {
                    console.error(`è§¦æ‘¸å›è°ƒé”™è¯¯ ${buttonName}:`, error);
                }
            });

            console.log(`âœ… ${buttonName} ç»‘å®šå®Œæˆ`);
        }

        // ç«‹å³é‡æ–°ç»‘å®šæ‰€æœ‰æŒ‰é’®ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        window.rebindAllButtons = function() {
            console.log('=== ç«‹å³é‡æ–°ç»‘å®šæ‰€æœ‰æŒ‰é’® ===');

            try {
                // é‡æ–°ç»‘å®šæ‰€æœ‰æ¨¡æ€æ¡†æŒ‰é’®
                bindCompleteTaskEvents();
                bindDailyTodoEvents();
                bindWechatEvents();
                bindDatabaseEvents();
                bindAssigneeEvents();

                console.log('âœ… æ‰€æœ‰æŒ‰é’®é‡æ–°ç»‘å®šå®Œæˆ');
                alert('æ‰€æœ‰æŒ‰é’®å·²é‡æ–°ç»‘å®šï¼Œç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼');
            } catch (error) {
                console.error('é‡æ–°ç»‘å®šæŒ‰é’®æ—¶å‡ºé”™:', error);
                alert('é‡æ–°ç»‘å®šå¤±è´¥: ' + error.message);
            }
        };

        // åº”æ€¥ä¿®å¤ï¼šå¼ºåˆ¶æ¢å¤æ‰€æœ‰æŒ‰é’®åŠŸèƒ½ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        window.emergencyFixAllButtons = function() {
            console.log('=== åº”æ€¥ä¿®å¤ï¼šå¼ºåˆ¶æ¢å¤æ‰€æœ‰æŒ‰é’®åŠŸèƒ½ ===');

            // æ‰€æœ‰å¯èƒ½çš„æŒ‰é’®ID
            const buttonIds = [
                'closeCompleteBtn', 'cancelCompleteBtn', 'confirmCompleteBtn',
                'closeDailyTodoBtn', 'cancelDailyTodoBtn', 'saveDailyTodoBtn',
                'closeWechatBtn', 'cancelWechatBtn', 'saveWechatBtn',
                'closeDatabaseBtn', 'cancelDatabaseBtn', 'saveDatabaseBtn',
                'closeAssigneeBtn', 'cancelAssigneeBtn',
                'closePersonalInfoBtn'
            ];

            // å¯¹åº”çš„å›è°ƒå‡½æ•°
            const callbacks = {
                closeCompleteBtn: () => closeCompleteTaskModal(),
                cancelCompleteBtn: () => closeCompleteTaskModal(),
                confirmCompleteBtn: () => confirmCompleteTask(),
                closeDailyTodoBtn: () => closeDailyTodoModal(),
                cancelDailyTodoBtn: () => closeDailyTodoModal(),
                saveDailyTodoBtn: () => saveDailyTodoSettings(),
                closeWechatBtn: () => closeWechatModal(),
                cancelWechatBtn: () => closeWechatModal(),
                saveWechatBtn: () => saveWechatSettings(),
                closeDatabaseBtn: () => closeDatabaseModal(),
                cancelDatabaseBtn: () => closeDatabaseModal(),
                saveDatabaseBtn: () => saveDatabaseSettings(),
                closeAssigneeBtn: () => closeAssigneeModal(),
                cancelAssigneeBtn: () => closeAssigneeModal(),
                closePersonalInfoBtn: () => closePersonalInfoModal()
            };

            buttonIds.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                const callback = callbacks[buttonId];

                if (button && callback) {
                    // ç§»é™¤æ‰€æœ‰ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);

                    // æ·»åŠ ç®€å•çš„clickäº‹ä»¶
                    newButton.addEventListener('click', function(e) {
                        console.log(`åº”æ€¥ä¿®å¤: ${buttonId} è¢«ç‚¹å‡»`);
                        try {
                            callback();
                        } catch (err) {
                            console.error(`åº”æ€¥ä¿®å¤: ${buttonId} æ‰§è¡Œå¤±è´¥:`, err);
                        }
                    });

                    console.log(`âœ… å·²ä¿®å¤æŒ‰é’®: ${buttonId}`);
                } else {
                    console.log(`âŒ æŒ‰é’®ä¸å­˜åœ¨æˆ–æ— å›è°ƒ: ${buttonId}`);
                }
            });

            console.log('=== åº”æ€¥ä¿®å¤å®Œæˆ ===');
            alert('åº”æ€¥ä¿®å¤å®Œæˆï¼æ‰€æœ‰å¼¹æ¡†æŒ‰é’®åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚');
        };

        // Android 14 å¼¹æ¡†æŒ‰é’®è°ƒè¯•å‡½æ•°ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        window.debugAndroid14Modal = function() {
            console.log('=== Android 14 å¼¹æ¡†æŒ‰é’®è°ƒè¯•ä¿¡æ¯ ===');
            console.log('å½“å‰UserAgent:', navigator.userAgent);
            console.log('æ£€æµ‹åˆ°çš„Androidç‰ˆæœ¬:', getAndroidVersion());
            console.log('æ˜¯å¦ä¸ºAndroid 14:', isAndroid14());

            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
            const buttons = [
                { name: 'å…³é—­å®Œæˆä»»åŠ¡æŒ‰é’®', id: 'closeCompleteBtn' },
                { name: 'å–æ¶ˆå®Œæˆä»»åŠ¡æŒ‰é’®', id: 'cancelCompleteBtn' },
                { name: 'ç¡®è®¤å®Œæˆä»»åŠ¡æŒ‰é’®', id: 'confirmCompleteBtn' },
                { name: 'å…³é—­ä¸ªäººä¿¡æ¯æŒ‰é’®', id: 'closePersonalInfoBtn' }
            ];

            buttons.forEach(btn => {
                const element = document.getElementById(btn.id);
                console.log(`${btn.name}:`, element ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                if (element) {
                    console.log(`  - å¯è§æ€§:`, getComputedStyle(element).display !== 'none' ? 'âœ… å¯è§' : 'âŒ éšè—');
                    console.log(`  - æŒ‡é’ˆäº‹ä»¶:`, getComputedStyle(element).pointerEvents);
                }
            });

            // æ£€æŸ¥æ¨¡æ€æ¡†çŠ¶æ€
            const modals = [
                { name: 'å®Œæˆä»»åŠ¡æ¨¡æ€æ¡†', id: 'completeTaskModal' },
                { name: 'ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†', id: 'personalInfoModal' }
            ];

            modals.forEach(modal => {
                const element = document.getElementById(modal.id);
                console.log(`${modal.name}:`, element ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                if (element) {
                    console.log(`  - æ˜¾ç¤ºçŠ¶æ€:`, element.style.display);
                }
            });

            console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
        };

        // Android 14 è°ƒè¯•å‡½æ•°ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        window.debugAndroid14Upload = function() {
            console.log('=== Android 14 ä¸Šä¼ è°ƒè¯•ä¿¡æ¯ ===');
            console.log('å½“å‰UserAgent:', navigator.userAgent);

            try {
                console.log('æ£€æµ‹åˆ°çš„Androidç‰ˆæœ¬:', getAndroidVersion());
                console.log('æ˜¯å¦ä¸ºAndroid 14:', isAndroid14());
            } catch (e) {
                console.error('Androidç‰ˆæœ¬æ£€æµ‹å‡½æ•°é”™è¯¯:', e);
            }

            console.log('bodyæ˜¯å¦æœ‰android-14-compatç±»:', document.body.classList.contains('android-14-compat'));

            // æ£€æŸ¥ä¸Šä¼ åŒºåŸŸ
            for (let i = 1; i <= 2; i++) {
                const uploadArea = document.querySelector(`.image-upload-area:nth-child(${i})`);
                const fileInput = document.getElementById(`completeImageInput${i}`);
                console.log(`ä¸Šä¼ åŒºåŸŸ${i}:`, uploadArea);
                console.log(`æ–‡ä»¶è¾“å…¥${i}:`, fileInput);

                if (uploadArea) {
                    console.log(`ä¸Šä¼ åŒºåŸŸ${i}äº‹ä»¶ç›‘å¬å™¨:`, getEventListeners ? getEventListeners(uploadArea) : 'æ— æ³•è·å–');
                }
            }

            // æ£€æŸ¥æ–‡ä»¶API
            console.log('File APIæ”¯æŒ:', {
                File: !!window.File,
                FileReader: !!window.FileReader,
                FileList: !!window.FileList,
                Blob: !!window.Blob,
                DataTransfer: !!window.DataTransfer
            });

            // æ£€æŸ¥ç”¨æˆ·æ¿€æ´»
            if (window.navigator && window.navigator.userActivation) {
                console.log('ç”¨æˆ·æ¿€æ´»çŠ¶æ€:', {
                    isActive: window.navigator.userActivation.isActive,
                    hasBeenActive: window.navigator.userActivation.hasBeenActive
                });
            }

            console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
        };

        // æ‰‹åŠ¨è§¦å‘ä¸Šä¼ ï¼ˆè°ƒè¯•ç”¨ï¼‰
        window.manualTriggerUpload = function(imageIndex) {
            console.log(`æ‰‹åŠ¨è§¦å‘ä¸Šä¼ ${imageIndex}`);
            try {
                if (isAndroid14()) {
                    console.log('ä½¿ç”¨Android 14ä¸“ç”¨ä¸Šä¼ æ–¹æ³•');
                    directTriggerFileSelect(imageIndex);
                } else {
                    console.log('ä½¿ç”¨æ ‡å‡†ä¸Šä¼ æ–¹æ³•');
                    selectCompleteImage(imageIndex);
                }
            } catch (e) {
                console.error('æ‰‹åŠ¨è§¦å‘ä¸Šä¼ å¤±è´¥:', e);
                // å¤‡ç”¨æ–¹æ³•
                try {
                    selectCompleteImage(imageIndex);
                } catch (e2) {
                    console.error('å¤‡ç”¨æ–¹æ³•ä¹Ÿå¤±è´¥:', e2);
                }
            }
        };

        // æµ‹è¯•Androidç‰ˆæœ¬æ£€æµ‹ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        window.testAndroidDetection = function() {
            console.log('=== Androidç‰ˆæœ¬æ£€æµ‹æµ‹è¯• ===');
            console.log('UserAgent:', navigator.userAgent);

            try {
                const version = getAndroidVersion();
                const isA14 = isAndroid14();

                console.log('Androidç‰ˆæœ¬:', version);
                console.log('æ˜¯å¦ä¸ºAndroid 14+:', isA14);
                console.log('æ£€æµ‹ç»“æœ:', version >= 14 ? 'âœ… Android 14+' : 'âŒ éAndroid 14+');

                // æµ‹è¯•ç›¸å…³åŠŸèƒ½
                if (typeof directTriggerFileSelect === 'function') {
                    console.log('âœ… directTriggerFileSelect å‡½æ•°å­˜åœ¨');
                } else {
                    console.log('âŒ directTriggerFileSelect å‡½æ•°ä¸å­˜åœ¨');
                }

                if (typeof bindAndroid14ImageUploadEvents === 'function') {
                    console.log('âœ… bindAndroid14ImageUploadEvents å‡½æ•°å­˜åœ¨');
                } else {
                    console.log('âŒ bindAndroid14ImageUploadEvents å‡½æ•°ä¸å­˜åœ¨');
                }

            } catch (e) {
                console.error('Androidç‰ˆæœ¬æ£€æµ‹æµ‹è¯•å¤±è´¥:', e);
            }

            console.log('=== æµ‹è¯•ç»“æŸ ===');
        };

        // å¼ºåˆ¶å¯ç”¨Android 14åŸç”Ÿæ–‡ä»¶è¾“å…¥æ¨¡å¼ï¼ˆè°ƒè¯•ç”¨ï¼‰
        window.forceAndroid14NativeMode = function() {
            console.log('å¼ºåˆ¶å¯ç”¨Android 14åŸç”Ÿæ–‡ä»¶è¾“å…¥æ¨¡å¼');
            applyAndroid14UploadFix();
        };

        // æ‰‹åŠ¨åº”ç”¨ä¿®å¤ï¼ˆå…¨å±€å¯ç”¨ï¼‰
        window.fixAndroid14Upload = function() {
            console.log('æ‰‹åŠ¨åº”ç”¨Android 14ä¸Šä¼ ä¿®å¤');
            applyAndroid14UploadFix();
        };

        function bindImageViewEvents() {
            const closeImageViewBtn = document.getElementById('closeImageViewBtn');
            const imageViewModal = document.getElementById('imageViewModal');

            if (closeImageViewBtn) {
                closeImageViewBtn.addEventListener('click', closeImageViewModal);
            }

            if (imageViewModal) {
                imageViewModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeImageViewModal();
                    }
                });
            }
        }

        // æ‰¹é‡æ“ä½œç›¸å…³å‡½æ•°
        function toggleBatchMode() {
            if (isBatchMode) {
                exitBatchMode();
            } else {
                enterBatchMode();
            }
        }

        function enterBatchMode() {
            isBatchMode = true;
            selectedTasks.clear();

            // è®¾ç½®bodyç±»åä»¥ä¾¿CSSå’Œå…¶ä»–ä»£ç æ£€æµ‹æ‰¹é‡æ¨¡å¼
            document.body.classList.add('batch-mode');

            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®æ–‡å­—å’Œæ ·å¼
            const batchModeBtn = document.querySelector('.batch-mode-btn');
            if (batchModeBtn) {
                batchModeBtn.innerHTML = 'âŒ é€€å‡ºæ‰¹é‡';
                batchModeBtn.classList.add('active');
            }

            // åŒæ—¶æ›´æ–°æ–°çš„æ‰¹é‡æ¨¡å¼æŒ‰é’®
            updateBatchModeButton();

            // æ˜¾ç¤ºæ‰¹é‡æ“ä½œæ§åˆ¶åŒº
            const batchControls = document.getElementById('batchControls');
            console.log('æ‰¹é‡æ§åˆ¶åŒºå…ƒç´ :', batchControls);
            if (batchControls) {
                batchControls.style.display = 'block';
                console.log('æ‰¹é‡æ§åˆ¶åŒºå·²æ˜¾ç¤ºï¼Œdisplay:', batchControls.style.display);
            } else {
                console.error('æœªæ‰¾åˆ°æ‰¹é‡æ§åˆ¶åŒºå…ƒç´ ');
            }

            // åªæ›´æ–°UIçŠ¶æ€ï¼Œä¸é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
            // renderTasks(); // å·²ç§»é™¤ï¼šé¿å…ä¸å¿…è¦çš„åˆ·æ–°
            updateSelectedCount();
            updateToggleSelectButton();

            // æ‰‹åŠ¨æ›´æ–°ç°æœ‰ä»»åŠ¡é¡¹çš„å¤é€‰æ¡†æ˜¾ç¤º
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                const checkbox = item.querySelector('.task-checkbox');
                if (checkbox) {
                    checkbox.style.display = 'inline-block';
                }
            });

            // ä¸ºæ‰¹é‡æ“ä½œæŒ‰é’®ç»‘å®šå¢å¼ºçš„äº‹ä»¶å¤„ç†å™¨
            bindBatchModeEvents();

            console.log('è¿›å…¥æ‰¹é‡æ“ä½œæ¨¡å¼');
        }

        // é•¿æŒ‰è¿›å…¥æ‰¹é‡æ¨¡å¼ï¼ˆä¸æ¸…ç©ºå·²é€‰ä»»åŠ¡ï¼Œä¸åˆ·æ–°åˆ—è¡¨ï¼‰
        function enterBatchModeWithoutRefresh() {
            isBatchMode = true;
            // ä¸æ¸…ç©º selectedTasksï¼Œä¿ç•™å·²é€‰ä¸­çš„ä»»åŠ¡

            // è®¾ç½®bodyç±»åä»¥ä¾¿CSSå’Œå…¶ä»–ä»£ç æ£€æµ‹æ‰¹é‡æ¨¡å¼
            document.body.classList.add('batch-mode');
            const taskListElement = document.getElementById('taskList');
            if (taskListElement) {
                taskListElement.classList.add('batch-mode');
            }

            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®æ–‡å­—å’Œæ ·å¼
            const batchModeBtn = document.querySelector('.batch-mode-btn');
            if (batchModeBtn) {
                batchModeBtn.innerHTML = 'âŒ é€€å‡ºæ‰¹é‡';
                batchModeBtn.classList.add('active');
            }

            // åŒæ—¶æ›´æ–°æ–°çš„æ‰¹é‡æ¨¡å¼æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const batchToggleBtn = document.getElementById('batchToggleBtn');
            if (batchToggleBtn) {
                batchToggleBtn.textContent = 'âŒ é€€å‡ºæ‰¹é‡';
                batchToggleBtn.classList.add('active');
            }

            // æ˜¾ç¤ºæ‰¹é‡æ“ä½œæ§åˆ¶åŒº
            const batchControls = document.getElementById('batchControls');
            if (batchControls) {
                batchControls.style.display = 'block';
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateSelectedCount();
            updateToggleSelectButton();

            // ä¸åˆ·æ–°åˆ—è¡¨ï¼Œç›´æ¥é€šè¿‡DOMæ“ä½œæ˜¾ç¤ºå¤é€‰æ¡†å’Œéšè—æ“ä½œæŒ‰é’®
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                const taskId = item.getAttribute('data-id');

                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¤é€‰æ¡†ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
                let checkbox = item.querySelector('.batch-checkbox');
                if (!checkbox) {
                    checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'batch-checkbox';
                    checkbox.setAttribute('data-task-id', taskId);

                    // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
                    if (selectedTasks.has(taskId)) {
                        checkbox.checked = true;
                        item.classList.add('selected');
                    }

                    // æ·»åŠ äº‹ä»¶ç›‘å¬
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedTasks.add(taskId);
                            item.classList.add('selected');
                        } else {
                            selectedTasks.delete(taskId);
                            item.classList.remove('selected');
                        }
                        updateSelectedCount();
                        updateToggleSelectButton();
                    });

                    // æ’å…¥åˆ°ä»»åŠ¡é¡¹çš„å¼€å¤´ï¼ˆåœ¨å®ŒæˆæŒ‰é’®ä¹‹å‰ï¼‰
                    item.insertBefore(checkbox, item.firstChild);
                } else {
                    // å¦‚æœå¤é€‰æ¡†å·²å­˜åœ¨ï¼Œæ›´æ–°é€‰ä¸­çŠ¶æ€
                    if (selectedTasks.has(taskId)) {
                        checkbox.checked = true;
                        item.classList.add('selected');
                    }
                }

                // éšè—ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                const editBtn = item.querySelector('.edit-btn');
                const deleteBtn = item.querySelector('.delete-btn');
                if (editBtn) editBtn.style.display = 'none';
                if (deleteBtn) deleteBtn.style.display = 'none';
            });

            // ä¸ºæ‰¹é‡æ“ä½œæŒ‰é’®ç»‘å®šå¢å¼ºçš„äº‹ä»¶å¤„ç†å™¨
            bindBatchModeEvents();

            console.log('é•¿æŒ‰è¿›å…¥æ‰¹é‡æ“ä½œæ¨¡å¼ï¼ˆä¸åˆ·æ–°åˆ—è¡¨ï¼‰');
        }

        function exitBatchMode() {
            isBatchMode = false;
            selectedTasks.clear();

            // ç§»é™¤bodyç±»å
            document.body.classList.remove('batch-mode');
            const taskListElement = document.getElementById('taskList');
            if (taskListElement) {
                taskListElement.classList.remove('batch-mode');
            }

            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®æ–‡å­—å’Œæ ·å¼
            const batchModeBtn = document.querySelector('.batch-mode-btn');
            if (batchModeBtn) {
                batchModeBtn.innerHTML = 'â˜‘ï¸ æ‰¹é‡æ“ä½œ';
                batchModeBtn.classList.remove('active');
            }

            // åŒæ—¶æ›´æ–°æ–°çš„æ‰¹é‡æ¨¡å¼æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const batchToggleBtn = document.getElementById('batchToggleBtn');
            if (batchToggleBtn) {
                batchToggleBtn.textContent = 'â˜‘ï¸ æ‰¹é‡æ¨¡å¼';
                batchToggleBtn.classList.remove('active');
            }

            // éšè—æ‰¹é‡æ“ä½œæ§åˆ¶åŒº
            const batchControls = document.getElementById('batchControls');
            console.log('é€€å‡ºæ‰¹é‡æ¨¡å¼ï¼Œæ‰¹é‡æ§åˆ¶åŒºå…ƒç´ :', batchControls);
            if (batchControls) {
                batchControls.style.display = 'none';
                console.log('æ‰¹é‡æ§åˆ¶åŒºå·²éšè—');
            }

            // ä¸åˆ·æ–°åˆ—è¡¨ï¼Œç›´æ¥é€šè¿‡DOMæ“ä½œç§»é™¤å¤é€‰æ¡†å’Œæ˜¾ç¤ºæ“ä½œæŒ‰é’®
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                // ç§»é™¤å¤é€‰æ¡†
                const checkbox = item.querySelector('.batch-checkbox');
                if (checkbox) {
                    checkbox.remove();
                }

                // ç§»é™¤é€‰ä¸­çŠ¶æ€
                item.classList.remove('selected');

                // æ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                const editBtn = item.querySelector('.edit-btn');
                const deleteBtn = item.querySelector('.delete-btn');
                if (editBtn) editBtn.style.display = '';
                if (deleteBtn) deleteBtn.style.display = '';
            });

            console.log('é€€å‡ºæ‰¹é‡æ“ä½œæ¨¡å¼ï¼ˆä¸åˆ·æ–°åˆ—è¡¨ï¼‰');
        }

        function updateSelectedCount() {
            const selectedCountElement = document.getElementById('selectedCount');
            if (selectedCountElement) {
                selectedCountElement.textContent = selectedTasks.size;
            }
        }

        function updateTaskSelection(taskId, selected) {
            const taskItem = document.querySelector(`[data-id="${taskId}"]`);
            if (taskItem) {
                if (selected) {
                    taskItem.classList.add('selected');
                } else {
                    taskItem.classList.remove('selected');
                }
            }
        }

        function selectAllTasks() {
            // è·å–å½“å‰æ˜¾ç¤ºçš„æ‰€æœ‰ä»»åŠ¡
            const visibleTasks = document.querySelectorAll('.task-item[data-id]');
            
            visibleTasks.forEach(taskItem => {
                const taskId = taskItem.getAttribute('data-id');
                selectedTasks.add(taskId);
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                const checkbox = taskItem.querySelector('.batch-checkbox');
                if (checkbox) {
                    checkbox.checked = true;
                }
                
                // æ›´æ–°ä»»åŠ¡é¡¹æ ·å¼
                taskItem.classList.add('selected');
            });
            
            updateSelectedCount();
            updateToggleSelectButton();
            console.log('å·²å…¨é€‰', selectedTasks.size, 'ä¸ªä»»åŠ¡');
        }

        function deselectAllTasks() {
            selectedTasks.clear();

            // æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
            const checkboxes = document.querySelectorAll('.batch-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // ç§»é™¤æ‰€æœ‰é€‰ä¸­æ ·å¼
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                item.classList.remove('selected');
            });

            updateSelectedCount();
            updateToggleSelectButton();
            console.log('å·²å–æ¶ˆå…¨é€‰');
        }

        // åˆ‡æ¢å…¨é€‰/å–æ¶ˆå…¨é€‰å‡½æ•°
        function toggleSelectAllTasks() {
            // è·å–å½“å‰æ˜¾ç¤ºçš„æœªå®Œæˆä»»åŠ¡ï¼ˆä¸selectAllTaskså’ŒupdateToggleSelectButtonä¿æŒä¸€è‡´ï¼‰
            const visibleTasks = document.querySelectorAll('.task-item[data-id]');
            const visibleUncompletedTasks = Array.from(visibleTasks).filter(taskItem => {
                const taskId = taskItem.getAttribute('data-id');
                const task = tasks.find(t => t.id === taskId);
                return task && !task.completed;
            });

            const isAllSelected = visibleUncompletedTasks.length > 0 && selectedTasks.size === visibleUncompletedTasks.length;

            if (isAllSelected) {
                deselectAllTasks();
            } else {
                selectAllTasks();
            }
        }

        // æ›´æ–°åˆ‡æ¢æŒ‰é’®çš„çŠ¶æ€å’Œæ–‡å­—
        function updateToggleSelectButton() {
            const toggleBtn = document.querySelector('.toggle-select-btn');
            if (!toggleBtn) {
                console.log('updateToggleSelectButton: toggle button not found');
                return;
            }

            // è·å–å½“å‰æ˜¾ç¤ºçš„æœªå®Œæˆä»»åŠ¡ï¼ˆä¸selectAllTasksä¿æŒä¸€è‡´ï¼‰
            const visibleTasks = document.querySelectorAll('.task-item[data-id]');
            const visibleUncompletedTasks = Array.from(visibleTasks).filter(taskItem => {
                const taskId = taskItem.getAttribute('data-id');
                const task = tasks.find(t => t.id === taskId);
                return task && !task.completed;
            });

            const isAllSelected = visibleUncompletedTasks.length > 0 && selectedTasks.size === visibleUncompletedTasks.length;
            console.log('updateToggleSelectButton: visibleUncompleted count:', visibleUncompletedTasks.length, 'selectedTasks size:', selectedTasks.size, 'isAllSelected:', isAllSelected);

            if (isAllSelected) {
                toggleBtn.innerHTML = 'â¬œ å–æ¶ˆ';
                toggleBtn.classList.add('all-selected');
                console.log('updateToggleSelectButton: set to deselect mode');
            } else {
                toggleBtn.innerHTML = 'â˜‘ï¸ å…¨é€‰';
                toggleBtn.classList.remove('all-selected');
                console.log('updateToggleSelectButton: set to select mode');
            }
        }

        function deleteSelectedTasks() {
            if (selectedTasks.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»»åŠ¡');
                return;
            }

            const count = selectedTasks.size;

            function handleBatchDeleteConfirm(shouldDelete) {
                if (shouldDelete) {
                    console.log('ç”¨æˆ·ç¡®è®¤æ‰¹é‡åˆ é™¤ä»»åŠ¡ï¼Œæ•°é‡:', count);

                    // è·å–è¦åˆ é™¤çš„ä»»åŠ¡IDæ•°ç»„
                    const taskIdsToDelete = Array.from(selectedTasks);

                    // æ‰¹é‡åˆ é™¤APIè°ƒç”¨
                    const deletePromises = taskIdsToDelete.map(id => deleteTaskAPI(id));

                    Promise.all(deletePromises).then(() => {
                        console.log('æ‰¹é‡åˆ é™¤APIè°ƒç”¨æˆåŠŸ');

                        // ä»æœ¬åœ°ä»»åŠ¡æ•°ç»„ä¸­ç§»é™¤å·²åˆ é™¤çš„ä»»åŠ¡ï¼Œé¿å…å…¨é‡æŸ¥è¯¢
                        tasks = tasks.filter(t => !taskIdsToDelete.includes(t.id));

                        // æ¸…ç©ºé€‰æ‹©
                        selectedTasks.clear();

                        // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨å¹¶æ›´æ–°æ˜¾ç¤º
                        renderTasks();
                        updateStats();
                        updateSelectedCount();
                        updateToggleSelectButton();

                        alert(`å·²åˆ é™¤ ${count} ä¸ªä»»åŠ¡`);
                        console.log('æ‰¹é‡åˆ é™¤äº†', count, 'ä¸ªä»»åŠ¡');
                    }).catch(error => {
                        console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                } else {
                    console.log('ç”¨æˆ·å–æ¶ˆæ‰¹é‡åˆ é™¤æ“ä½œ');
                }
            }

            // æ£€æµ‹Androidè®¾å¤‡å’Œç‰ˆæœ¬ï¼Œä½¿ç”¨é€‚å½“çš„ç¡®è®¤å¯¹è¯æ¡†
            const isAndroid = /Android/i.test(navigator.userAgent);
            const androidVersion = isAndroid ? parseFloat((navigator.userAgent.match(/Android ([\d.]+)/) || [])[1]) : 0;
            const forceCustomDialog = isAndroid && androidVersion >= 14;

            if (forceCustomDialog) {
                // Android 14+ å¼ºåˆ¶ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†
                console.log('æ£€æµ‹åˆ°Android 14+ï¼Œæ‰¹é‡åˆ é™¤ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†');
                customConfirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªä»»åŠ¡å—ï¼Ÿ`, handleBatchDeleteConfirm);
                return;
            }

            // å…¶ä»–è®¾å¤‡å°è¯•ä½¿ç”¨åŸç”Ÿconfirm
            try {
                if (typeof confirm === 'function') {
                    console.log('ä½¿ç”¨åŸç”Ÿç¡®è®¤å¯¹è¯æ¡†è¿›è¡Œæ‰¹é‡åˆ é™¤');
                    const result = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªä»»åŠ¡å—ï¼Ÿ`);
                    handleBatchDeleteConfirm(result);
                    return;
                }
            } catch (error) {
                console.error('åŸç”Ÿconfirmå¯¹è¯æ¡†å‡ºé”™:', error);
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†
            console.log('ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ä½œä¸ºæ‰¹é‡åˆ é™¤å¤‡ç”¨æ–¹æ¡ˆ');
            customConfirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªä»»åŠ¡å—ï¼Ÿ`, handleBatchDeleteConfirm);
        }

        function completeSelectedTasks() {
            if (selectedTasks.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å®Œæˆçš„ä»»åŠ¡');
                return;
            }
            
            let completedCount = 0;
            const now = getCurrentUTCTimeString();
            
            // æ ‡è®°é€‰ä¸­çš„ä»»åŠ¡ä¸ºå·²å®Œæˆï¼ˆæ£€æŸ¥æƒé™ï¼‰
            tasks.forEach(task => {
                if (selectedTasks.has(task.id) && !task.completed) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æ“ä½œæ­¤ä»»åŠ¡
                    let canOperate = true;
                    if (personalInfo.enableRoleRestriction && personalInfo.myAssignee) {
                        if (task.assignees && Array.isArray(task.assignees)) {
                            canOperate = task.assignees.length === 0 || task.assignees.includes(personalInfo.myAssignee);
                        } else {
                            canOperate = !task.assignee || task.assignee === personalInfo.myAssignee;
                        }
                    }

                    if (canOperate) {
                        task.completed = true;
                        task.completedAt = now;
                        completedCount++;
                    } else {
                        const assignedTo = task.assignees && task.assignees.length > 0 ? task.assignees.join(', ') : task.assignee;
                        console.log(`è·³è¿‡ä»»åŠ¡ "${task.title}"ï¼Œåˆ†é…ç»™äº† "${assignedTo}"`);
                    }
                }
            });
            
            if (completedCount > 0) {
                const tasksToUpdate = tasks.filter(task =>
                    selectedTasks.has(task.id) && task.completed && task.completedAt === now
                );

                // æ‰¹é‡æ›´æ–°APIè°ƒç”¨
                const updatePromises = tasksToUpdate.map(task => updateTaskAPI(task));

                Promise.all(updatePromises).then(() => {
                    console.log('æ‰¹é‡å®Œæˆä»»åŠ¡APIè°ƒç”¨æˆåŠŸ');

                    // æ¸…ç©ºé€‰æ‹©
                    selectedTasks.clear();

                    // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨å¹¶æ›´æ–°æ˜¾ç¤ºï¼ˆä»»åŠ¡å·²åœ¨æœ¬åœ°æ›´æ–°ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢ï¼‰
                    renderTasks();
                    updateStats();
                    updateSelectedCount();
                    updateToggleSelectButton();
                    alert(`å·²å®Œæˆ ${completedCount} ä¸ªä»»åŠ¡`);
                }).catch(error => {
                    console.error('æ‰¹é‡å®Œæˆä»»åŠ¡å¤±è´¥:', error);
                    alert('æ‰¹é‡å®Œæˆä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            } else {
                alert('æ‰€é€‰ä»»åŠ¡éƒ½å·²å®Œæˆ');
            }
        }

        // ========== å¾®ä¿¡é€šçŸ¥åŠŸèƒ½ ==========

        // å‘é€Serveré…±å¾®ä¿¡é€šçŸ¥
        async function sendWechatNotification(title, content) {
            const settings = getDailyTodoSettings();

            if (!settings.enableWechatNotify || !settings.serverChanKey) {
                console.log('å¾®ä¿¡é€šçŸ¥æœªå¯ç”¨æˆ–æœªé…ç½®SendKey');
                return false;
            }

            try {
                const url = `https://sctapi.ftqq.com/${settings.serverChanKey}.send`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        desp: content
                    })
                });

                const result = await response.json();
                console.log('å¾®ä¿¡é€šçŸ¥å‘é€ç»“æœ:', result);

                if (result.code === 0) {
                    console.log('å¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ');
                    return true;
                } else {
                    console.error('å¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('å‘é€å¾®ä¿¡é€šçŸ¥æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        // æ£€æŸ¥å¹¶å‘é€å®šæ—¶å¾®ä¿¡é€šçŸ¥
        function checkAndSendWechatNotification() {
            const settings = getDailyTodoSettings();
            if (!settings.enableWechatNotify || !settings.serverChanKey) return;

            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MMæ ¼å¼
            const today = now.toDateString();

            // æ£€æŸ¥æ˜¯å¦å·²ç»å‘é€è¿‡ä»Šå¤©çš„é€šçŸ¥
            const lastNotifyInfo = settings.lastNotifyInfo || {};
            const todayNotifyInfo = lastNotifyInfo[today] || { morning: false, evening: false };

            // æ£€æŸ¥æ˜¯å¦åˆ°äº†æ™¨æŠ¥æ—¶é—´
            const shouldSendMorning = currentTime >= settings.morningNotifyTime &&
                                    currentTime < addMinutesToTime(settings.morningNotifyTime, 5) &&
                                    !todayNotifyInfo.morning;

            // æ£€æŸ¥æ˜¯å¦åˆ°äº†æ™šæŠ¥æ—¶é—´
            const shouldSendEvening = currentTime >= settings.eveningNotifyTime &&
                                    currentTime < addMinutesToTime(settings.eveningNotifyTime, 5) &&
                                    !todayNotifyInfo.evening;

            if (shouldSendMorning) {
                const { title, content } = generateNotificationContent('morning');

                // å‘é€Webé€šçŸ¥
                sendDailyReportNotification('morning');

                // é€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå‘é€æ™¨æŠ¥
                 sendSystemMessage('daily_report', title, content);

                // æ›´æ–°é€šçŸ¥è®°å½•
                todayNotifyInfo.morning = true;
                lastNotifyInfo[today] = todayNotifyInfo;
                settings.lastNotifyInfo = lastNotifyInfo;
                localStorage.setItem('dailyTodoSettings', JSON.stringify(settings));
            }

            if (shouldSendEvening) {
                const { title, content } = generateNotificationContent('evening');

                // å‘é€Webé€šçŸ¥
                sendDailyReportNotification('evening');

                // é€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå‘é€æ™šæŠ¥
                 sendSystemMessage('daily_report', title, content);

                // æ›´æ–°é€šçŸ¥è®°å½•
                todayNotifyInfo.evening = true;
                lastNotifyInfo[today] = todayNotifyInfo;
                settings.lastNotifyInfo = lastNotifyInfo;
                localStorage.setItem('dailyTodoSettings', JSON.stringify(settings));
            }

            // æ£€æŸ¥ä»»åŠ¡è¶…æ—¶æé†’ï¼ˆæˆªæ­¢æ—¶é—´å‰10åˆ†é’Ÿï¼‰
            checkTaskDeadlineReminders(settings);
        }

        // æ£€æŸ¥ä»»åŠ¡æˆªæ­¢æ—¶é—´æé†’
        function checkTaskDeadlineReminders(settings) {
            const now = new Date();

            // æ£€æŸ¥å³å°†åˆ°æœŸçš„ä»»åŠ¡ï¼ˆ10åˆ†é’Ÿå†…ï¼‰
            checkUpcomingDeadlines(now, settings);

            // æ£€æŸ¥å·²è¶…æ—¶çš„ä»»åŠ¡
            checkOverdueTasks(now, settings);
        }

        // æ£€æŸ¥å³å°†åˆ°æœŸçš„ä»»åŠ¡
        function checkUpcomingDeadlines(now, settings) {
            const tenMinutesLater = new Date(now.getTime() + 10 * 60 * 1000);

            // è·å–å³å°†åˆ°æœŸçš„ä»»åŠ¡ï¼ˆæœªå®Œæˆä¸”åœ¨10åˆ†é’Ÿå†…åˆ°æœŸï¼‰
            const upcomingDeadlineTasks = tasks.filter(task => {
                if (task.completed || !task.deadline) return false;

                const taskDeadline = new Date(task.deadline.replace(/-/g, '/'));
                // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨å½“å‰æ—¶é—´åˆ°10åˆ†é’Ÿåä¹‹é—´åˆ°æœŸ
                return taskDeadline >= now && taskDeadline <= tenMinutesLater;
            });

            if (upcomingDeadlineTasks.length === 0) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸ºè¿™äº›ä»»åŠ¡å‘é€è¿‡æé†’ï¼ˆæ¯å°æ—¶æœ€å¤šæé†’5æ¬¡ï¼‰
            const reminderKey = 'taskDeadlineReminders';
            const sentReminders = JSON.parse(localStorage.getItem(reminderKey) || '{}');
            const currentHour = now.toISOString().slice(0, 13); // YYYY-MM-DDTHH

            const newReminders = upcomingDeadlineTasks.filter(task => {
                const taskHourKey = `${task.id}_${currentHour}`;
                const reminderCount = sentReminders[taskHourKey] || 0;
                return reminderCount < 5; // æ¯å°æ—¶æœ€å¤š5æ¬¡
            });

            if (newReminders.length === 0) return;

            // ç”Ÿæˆå³å°†åˆ°æœŸæé†’é€šçŸ¥å†…å®¹
            const { title, content } = generateDeadlineReminderContent(newReminders);

            // å‘é€Webé€šçŸ¥
            sendDeadlineWarningNotification(newReminders);

            // é€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå‘é€æˆªæ­¢æ—¶é—´æé†’
             sendSystemMessage('deadline_warning', title, content);

            // è®°å½•å·²å‘é€çš„æé†’ï¼ˆå¢åŠ è®¡æ•°ï¼‰
            newReminders.forEach(task => {
                const taskHourKey = `${task.id}_${currentHour}`;
                sentReminders[taskHourKey] = (sentReminders[taskHourKey] || 0) + 1;
            });

            // æ¸…ç†7å¤©å‰çš„æé†’è®°å½•
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const sevenDaysAgoKey = sevenDaysAgo.toISOString().slice(0, 13);
            Object.keys(sentReminders).forEach(key => {
                if (key.includes('_') && key.split('_')[1] < sevenDaysAgoKey) {
                    delete sentReminders[key];
                }
            });

            localStorage.setItem(reminderKey, JSON.stringify(sentReminders));
            console.log(`å‘é€äº† ${newReminders.length} ä¸ªä»»åŠ¡çš„æˆªæ­¢æ—¶é—´æé†’`);
        }

        // æ£€æŸ¥å·²è¶…æ—¶çš„ä»»åŠ¡
        function checkOverdueTasks(now, settings) {
            // è·å–å·²è¶…æ—¶çš„ä»»åŠ¡
            const overdueTasks = tasks.filter(task => {
                if (task.completed || !task.deadline) return false;
                const taskDeadline = new Date(task.deadline.replace(/-/g, '/'));
                return taskDeadline < now;
            });

            if (overdueTasks.length === 0) return;

            // æ£€æŸ¥è¶…æ—¶æé†’é¢‘ç‡ï¼ˆæ ¹æ®è¶…æ—¶æ—¶é—´è°ƒæ•´æé†’é¢‘ç‡ï¼‰
            const overdueReminderKey = 'taskOverdueReminders';
            const sentOverdueReminders = JSON.parse(localStorage.getItem(overdueReminderKey) || '{}');

            const tasksToRemind = overdueTasks.filter(task => {
                const taskDeadline = new Date(task.deadline.replace(/-/g, '/'));
                const overdueHours = Math.floor((now - taskDeadline) / (1000 * 60 * 60));

                // æ ¹æ®è¶…æ—¶æ—¶é—´ç¡®å®šæé†’é—´éš”
                let reminderInterval;
                if (overdueHours < 2) {
                    reminderInterval = 30; // è¶…æ—¶2å°æ—¶å†…ï¼Œæ¯30åˆ†é’Ÿæé†’
                } else if (overdueHours < 12) {
                    reminderInterval = 120; // è¶…æ—¶12å°æ—¶å†…ï¼Œæ¯2å°æ—¶æé†’
                } else if (overdueHours < 48) {
                    reminderInterval = 360; // è¶…æ—¶48å°æ—¶å†…ï¼Œæ¯6å°æ—¶æé†’
                } else {
                    reminderInterval = 720; // è¶…æ—¶48å°æ—¶åï¼Œæ¯12å°æ—¶æé†’
                }

                const taskKey = `${task.id}_overdue`;
                const lastReminder = sentOverdueReminders[taskKey];

                if (!lastReminder) return true;

                const timeSinceLastReminder = now - new Date(lastReminder);
                const minutesSinceLastReminder = timeSinceLastReminder / (1000 * 60);

                return minutesSinceLastReminder >= reminderInterval;
            });

            if (tasksToRemind.length === 0) return;

            // å‘é€è¶…æ—¶æé†’
            const { title, content } = generateOverdueReminderContent(tasksToRemind);

            // å‘é€Webé€šçŸ¥
            sendOverdueNotification(tasksToRemind);

            // é€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå‘é€è¶…æ—¶æé†’
             sendSystemMessage('overdue_warning', title, content);

            // è®°å½•æé†’æ—¶é—´
            tasksToRemind.forEach(task => {
                const taskKey = `${task.id}_overdue`;
                sentOverdueReminders[taskKey] = now.toISOString();
            });

            localStorage.setItem(overdueReminderKey, JSON.stringify(sentOverdueReminders));
            console.log(`å‘é€äº† ${tasksToRemind.length} ä¸ªè¶…æ—¶ä»»åŠ¡çš„æé†’`);
        }

        // ç”Ÿæˆæˆªæ­¢æ—¶é—´æé†’é€šçŸ¥å†…å®¹
        function generateDeadlineReminderContent(tasks) {
            const title = `â° ä»»åŠ¡å³å°†åˆ°æœŸæé†’`;
            let content = `ğŸš¨ ä»¥ä¸‹ä»»åŠ¡å³å°†åœ¨10åˆ†é’Ÿå†…åˆ°æœŸï¼Œè¯·æŠ“ç´§æ—¶é—´å®Œæˆï¼\n\n`;

            tasks.forEach((task, index) => {
                const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const category = getCategoryName(task.category);
                const deadline = task.deadline ? formatDeadline(task.deadline) : '';
                const assignee = task.assignees && task.assignees.length > 0 ? `ğŸ‘¤ ${task.assignees.join(', ')}` : task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';
                const timeLeft = getTimeUntilDeadline(task.deadline);

                content += `${index + 1}. ${priority} **${task.title}**\n`;
                content += `   - åˆ†ç±»ï¼š${category}\n`;
                content += `   - å®Œæˆäººï¼š${assignee}\n`;
                content += `   - æˆªæ­¢æ—¶é—´ï¼š${deadline}\n`;
                content += `   - å‰©ä½™æ—¶é—´ï¼š${timeLeft}\n`;
                if (task.notes) content += `   - å¤‡æ³¨ï¼š${task.notes}\n`;
                content += '\n';
            });

            content += `---\nâš¡ æ—¶é—´ç´§è¿«ï¼Œè¯·ç«‹å³å¤„ç†ï¼\n\nğŸ’¡ æ¥è‡ªæ‚¨çš„æ¯æ—¥å¾…åŠåŠ©æ‰‹`;

            return { title, content };
        }

        // è®¡ç®—è·ç¦»æˆªæ­¢æ—¶é—´è¿˜æœ‰å¤šé•¿æ—¶é—´
        function getTimeUntilDeadline(deadline) {
            if (!deadline) return '';

            const now = new Date();
            const deadlineDate = new Date(deadline);
            const timeDiff = deadlineDate - now;

            if (timeDiff <= 0) return 'å·²è¿‡æœŸ';

            const minutes = Math.ceil(timeDiff / (1000 * 60));
            if (minutes < 60) {
                return `${minutes}åˆ†é’Ÿ`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return remainingMinutes > 0 ? `${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
            }
        }

        // æ—¶é—´åŠ åˆ†é’Ÿè¾…åŠ©å‡½æ•°
        function addMinutesToTime(timeStr, minutes) {
            const [hours, mins] = timeStr.split(':').map(Number);
            const totalMins = hours * 60 + mins + minutes;
            const newHours = Math.floor(totalMins / 60) % 24;
            const newMins = totalMins % 60;
            return `${String(newHours).padStart(2, '0')}:${String(newMins).padStart(2, '0')}`;
        }

        // ç”Ÿæˆé€šçŸ¥å†…å®¹
        function generateNotificationContent(notifyType) {
            const now = new Date();
            const today = now.toDateString();

            // è·å–ä»Šæ—¥ä»»åŠ¡
            const todayTasks = tasks.filter(task => {
                if (!task.deadline || task.completed) return false;
                const taskDate = parseLocalDateTime(task.deadline).toDateString();
                return taskDate === today;
            });

            // è·å–ä»Šæ—¥å·²å®Œæˆä»»åŠ¡
            const todayCompletedTasks = tasks.filter(task => {
                if (!task.completed || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt).toDateString();
                return completedDate === today;
            });

            // è·å–é€¾æœŸä»»åŠ¡
            const overdueTasks = tasks.filter(task => {
                if (!task.deadline || task.completed) return false;
                const taskDate = new Date(task.deadline);
                return taskDate < now;
            });

            const timeLabel = notifyType === 'morning' ? 'æ™¨æŠ¥' : 'æ™šæŠ¥';
            const greeting = notifyType === 'morning' ? 'æ—©ä¸Šå¥½ï¼' : 'æ™šä¸Šå¥½ï¼';
            const timeEmoji = notifyType === 'morning' ? 'ğŸŒ…' : 'ğŸŒ™';

            let title = `${timeEmoji} æ¯æ—¥å¾…åŠ${timeLabel}`;
            let content = `${greeting}ä»¥ä¸‹æ˜¯æ‚¨çš„ä»»åŠ¡æé†’ï¼š\n\n`;

            // ä»Šæ—¥ä»»åŠ¡éƒ¨åˆ†
            if (todayTasks.length > 0) {
                content += `## ğŸ“… ä»Šæ—¥ä»»åŠ¡ (${todayTasks.length}é¡¹)\n\n`;
                todayTasks.forEach((task, index) => {
                    const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                    const category = getCategoryName(task.category);
                    const deadline = task.deadline ? formatDeadline(task.deadline) : '';
                    const assignee = task.assignees && task.assignees.length > 0 ? `ğŸ‘¤ ${task.assignees.join(', ')}` : task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';
                    content += `${index + 1}. ${priority} **${task.title}**\n`;
                    content += `   - åˆ†ç±»ï¼š${category}\n`;
                    content += `   - å®Œæˆäººï¼š${assignee}\n`;
                    if (deadline) content += `   - æˆªæ­¢ï¼š${deadline}\n`;
                    if (task.notes) content += `   - å¤‡æ³¨ï¼š${task.notes}\n`;
                    content += '\n';
                });
            } else {
                content += `## ğŸ“… ä»Šæ—¥ä»»åŠ¡\n\nâœ¨ ä»Šæ—¥æ— å¾…åŠä»»åŠ¡ï¼Œäº«å—è½»æ¾æ—¶å…‰ï¼\n\n`;
            }

            // é€¾æœŸä»»åŠ¡éƒ¨åˆ†
            if (overdueTasks.length > 0) {
                content += `## âš ï¸ é€¾æœŸä»»åŠ¡ (${overdueTasks.length}é¡¹)\n\n`;
                overdueTasks.forEach((task, index) => {
                    const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                    const category = getCategoryName(task.category);
                    const deadline = task.deadline ? formatDeadline(task.deadline) : '';
                    const assignee = task.assignees && task.assignees.length > 0 ? `ğŸ‘¤ ${task.assignees.join(', ')}` : task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';
                    content += `${index + 1}. ${priority} **${task.title}**\n`;
                    content += `   - åˆ†ç±»ï¼š${category}\n`;
                    content += `   - å®Œæˆäººï¼š${assignee}\n`;
                    if (deadline) content += `   - æˆªæ­¢ï¼š${deadline}\n`;
                    if (task.notes) content += `   - å¤‡æ³¨ï¼š${task.notes}\n`;
                    content += '\n';
                });
            } else {
                content += `## âš ï¸ é€¾æœŸä»»åŠ¡\n\nâœ… æ— é€¾æœŸä»»åŠ¡ï¼\n\n`;
            }

            // ä»Šæ—¥å®Œæˆä»»åŠ¡éƒ¨åˆ†
            if (todayCompletedTasks.length > 0) {
                content += `## âœ… ä»Šæ—¥å®Œæˆä»»åŠ¡ (${todayCompletedTasks.length}é¡¹)\n\n`;
                todayCompletedTasks.forEach((task, index) => {
                    const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                    const category = getCategoryName(task.category);
                    const assignee = task.assignees && task.assignees.length > 0 ? `ğŸ‘¤ ${task.assignees.join(', ')}` : task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';
                    const completedTime = task.completedAt ? formatRelativeTime(task.completedAt) : '';
                    content += `${index + 1}. ${priority} **${task.title}**\n`;
                    content += `   - åˆ†ç±»ï¼š${category}\n`;
                    content += `   - å®Œæˆäººï¼š${assignee}\n`;
                    if (completedTime) content += `   - å®Œæˆæ—¶é—´ï¼š${completedTime}\n`;
                    content += '\n';
                });
            } else {
                content += `## âœ… ä»Šæ—¥å®Œæˆä»»åŠ¡\n\nğŸ˜´ ä»Šæ—¥è¿˜æ²¡æœ‰å®Œæˆä»»åŠ¡ï¼Œç»§ç»­åŠ æ²¹ï¼\n\n`;
            }

            // ç»Ÿè®¡ä¿¡æ¯ - ä¸“æ³¨äºå½“æ—¥ä»»åŠ¡
            const todayTotalTasks = todayTasks.length + todayCompletedTasks.length;
            const todayRate = todayTotalTasks > 0 ?
                Math.round((todayCompletedTasks.length / todayTotalTasks) * 100) : 0;

            content += `## ğŸ“Š ä»Šæ—¥ç»Ÿè®¡\n\n`;
            content += `- ä»Šæ—¥ä»»åŠ¡æ€»è®¡ï¼š${todayTotalTasks}é¡¹\n`;
            content += `- ä»Šæ—¥å¾…åŠï¼š${todayTasks.length}é¡¹\n`;
            content += `- ä»Šæ—¥å®Œæˆï¼š${todayCompletedTasks.length}é¡¹\n`;
            content += `- ä»Šæ—¥å®Œæˆç‡ï¼š${todayRate}%\n`;
            if (overdueTasks.length > 0) {
                content += `- é€¾æœŸä»»åŠ¡ï¼š${overdueTasks.length}é¡¹\n`;
            }
            content += `\n`;

            const motivationalMessage = notifyType === 'morning' ?
                'ğŸŒŸ æ–°çš„ä¸€å¤©ï¼ŒåŠ æ²¹ï¼' :
                'ğŸŒ™ è¾›è‹¦äº†ä¸€å¤©ï¼Œç»§ç»­ä¿æŒï¼';

            content += `---\n${motivationalMessage}\n\nğŸ’¡ æ¥è‡ªæ‚¨çš„æ¯æ—¥å¾…åŠåŠ©æ‰‹`;

            return { title, content };
        }

        // æ·»åŠ æµ‹è¯•å¾®ä¿¡é€šçŸ¥çš„æŒ‰é’®åŠŸèƒ½
        function testWechatNotification() {
            const settings = getDailyTodoSettings();
            if (!settings.serverChanKey) {
                alert('è¯·å…ˆè®¾ç½®Serveré…±çš„SendKey');
                return;
            }
            if (!settings.enableWechatNotify) {
                alert('è¯·å…ˆå¯ç”¨å¾®ä¿¡é€šçŸ¥');
                return;
            }

            const { title, content } = generateNotificationContent('morning');
            sendWechatNotification(title, content);
            alert('æµ‹è¯•æ™¨æ™šæŠ¥å·²å‘é€ï¼Œè¯·æ£€æŸ¥å¾®ä¿¡');
        }

        // æµ‹è¯•è¶…æ—¶æé†’åŠŸèƒ½
        function testDeadlineReminder() {
            const settings = getDailyTodoSettings();
            if (!settings.serverChanKey) {
                alert('è¯·å…ˆè®¾ç½®Serveré…±çš„SendKey');
                return;
            }
            if (!settings.enableWechatNotify) {
                alert('è¯·å…ˆå¯ç”¨å¾®ä¿¡é€šçŸ¥');
                return;
            }

            // æ˜¾ç¤ºå½“å‰è¶…æ—¶ä»»åŠ¡çš„è°ƒè¯•ä¿¡æ¯
            const overdueTasks = tasks.filter(task => task.deadline && isTaskOverdue(task.deadline) && !task.completed);
            console.log('=== è¶…æ—¶ä»»åŠ¡è°ƒè¯•ä¿¡æ¯ ===');
            console.log('å½“å‰è¶…æ—¶ä»»åŠ¡æ•°é‡:', overdueTasks.length);
            console.log('è¶…æ—¶ä»»åŠ¡è¯¦æƒ…:', overdueTasks.map(task => ({
                title: task.title,
                deadline: task.deadline,
                deadlineLocal: convertUTCToLocalForDisplay(task.deadline)?.toLocaleString(),
                isOverdue: isTaskOverdue(task.deadline),
                completed: task.completed
            })));

            // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„å³å°†åˆ°æœŸä»»åŠ¡ç”¨äºæµ‹è¯•
            const mockTask = {
                id: 'test_' + Date.now(),
                title: 'æµ‹è¯•ä»»åŠ¡ - å³å°†åˆ°æœŸ',
                priority: 'high',
                category: 'work',
                assignee: 'æµ‹è¯•ç”¨æˆ·',
                deadline: new Date(Date.now() + 3 * 60 * 1000).toISOString(), // 3åˆ†é’Ÿååˆ°æœŸ
                notes: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•è¶…æ—¶æé†’çš„ä»»åŠ¡',
                completed: false
            };

            const { title, content } = generateDeadlineReminderContent([mockTask]);
            sendWechatNotification(title, content);
            alert(`æµ‹è¯•è¶…æ—¶æé†’å·²å‘é€ï¼Œå½“å‰æœ‰ ${overdueTasks.length} ä¸ªè¶…æ—¶ä»»åŠ¡ã€‚è¯·æ£€æŸ¥å¾®ä¿¡å’Œæ§åˆ¶å°æ—¥å¿—æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚`);
        }

        // åˆ›å»ºæµ‹è¯•è¶…æ—¶ä»»åŠ¡
        function createTestOverdueTask() {
            try {
                // åˆ›å»ºä¸€ä¸ªå·²ç»è¶…æ—¶çš„æµ‹è¯•ä»»åŠ¡
                const now = new Date();
                const overdueTime = new Date(now.getTime() - 2 * 60 * 60 * 1000); // 2å°æ—¶å‰

                const testTask = {
                    id: Date.now(),
                    title: 'æµ‹è¯•è¶…æ—¶ä»»åŠ¡ - è¯·éªŒè¯æ ·å¼',
                    notes: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•è¶…æ—¶æ ·å¼çš„ä»»åŠ¡ï¼Œåº”è¯¥æ˜¾ç¤ºçº¢è‰²è­¦å‘Šæ ·å¼',
                    priority: 'high',
                    category: 'work',
                    assignee: personalInfo.myAssignee || 'æµ‹è¯•ç”¨æˆ·',
                    assignees: [personalInfo.myAssignee || 'æµ‹è¯•ç”¨æˆ·'],
                    deadline: convertLocalTimeToUTC(overdueTime.toISOString().slice(0, 16)),
                    completed: false,
                    createdAt: getCurrentUTCTimeString(),
                    completedAt: null,
                    completedBy: null,
                    isDailyTodo: false
                };

                console.log('åˆ›å»ºæµ‹è¯•è¶…æ—¶ä»»åŠ¡:', {
                    task: testTask,
                    overdueTime: overdueTime.toLocaleString(),
                    isOverdue: isTaskOverdue(testTask.deadline)
                });

                // æ·»åŠ åˆ°æœ¬åœ°ä»»åŠ¡æ•°ç»„
                tasks.unshift(testTask);

                // å¦‚æœå¯ç”¨äº†åœ¨çº¿åŒæ­¥ï¼Œä¹Ÿè¦æ·»åŠ åˆ°æ•°æ®åº“
                if (getDailyTodoSettings().enableOnlineSync) {
                    createTaskAPI(testTask).then(() => {
                        console.log('æµ‹è¯•è¶…æ—¶ä»»åŠ¡å·²åŒæ­¥åˆ°æ•°æ®åº“');
                        loadTasksFromAPI().then(() => {
                            renderTasks();
                            updateStats();
                        });
                    }).catch(error => {
                        console.error('åŒæ­¥æµ‹è¯•ä»»åŠ¡åˆ°æ•°æ®åº“å¤±è´¥:', error);
                        // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿè¦æ›´æ–°æœ¬åœ°æ˜¾ç¤º
                        renderTasks();
                        updateStats();
                    });
                } else {
                    // åªæ›´æ–°æœ¬åœ°æ˜¾ç¤º
                    saveTasks();
                    renderTasks();
                    updateStats();
                }

                alert('å·²åˆ›å»ºæµ‹è¯•è¶…æ—¶ä»»åŠ¡ï¼è¯·æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨ä¸­çš„çº¢è‰²è­¦å‘Šæ ·å¼ã€‚ä»»åŠ¡æ ‡é¢˜ï¼š' + testTask.title);
            } catch (error) {
                console.error('åˆ›å»ºæµ‹è¯•è¶…æ—¶ä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ›å»ºæµ‹è¯•ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        }

        // æ‰‹åŠ¨è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥
        function triggerTaskReminders() {
            try {
                console.log('æ‰‹åŠ¨è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥');

                if (window.AndroidDatabase && typeof window.AndroidDatabase.triggerTaskReminders === 'function') {
                    window.AndroidDatabase.triggerTaskReminders();
                    console.log('å·²è°ƒç”¨Androidä»»åŠ¡æé†’æ£€æŸ¥');
                    alert('å·²è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥ï¼è¯·æŸ¥çœ‹Androidæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
                } else {
                    console.warn('AndroidDatabaseæ¥å£ä¸å¯ç”¨');
                    alert('AndroidDatabaseæ¥å£ä¸å¯ç”¨ï¼Œæ— æ³•è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥');
                }
            } catch (error) {
                console.error('è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥å¤±è´¥:', error);
                alert('è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // å®Œæ•´çš„æé†’ç³»ç»Ÿæµ‹è¯•
        function testReminderSystem() {
            try {
                console.log('=== å¼€å§‹å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯• ===');

                // æ˜¾ç¤ºæµ‹è¯•å¼€å§‹ä¿¡æ¯
                alert('å¼€å§‹å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯•...\n\nå°†ä¾æ¬¡æ‰§è¡Œ:\n1. æ—¶é—´è½¬æ¢å‡½æ•°æµ‹è¯•\n2. åˆ›å»ºæµ‹è¯•é€¾æœŸä»»åŠ¡\n3. è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥\n4. åˆ·æ–°ä»»åŠ¡åˆ—è¡¨');

                // 1. æµ‹è¯•æ—¶é—´è½¬æ¢å‡½æ•°
                console.log('=== æ­¥éª¤1: æ—¶é—´è½¬æ¢æµ‹è¯• ===');
                const now = new Date();
                const testDeadlineOverdue = new Date(now.getTime() - 2 * 60 * 60 * 1000); // 2å°æ—¶å‰
                const testDeadlineUpcoming = new Date(now.getTime() + 2 * 60 * 60 * 1000); // 2å°æ—¶å

                const overdueUtc = testDeadlineOverdue.toISOString();
                const upcomingUtc = testDeadlineUpcoming.toISOString();

                console.log('å½“å‰æ—¶é—´:', now.toLocaleString());
                console.log('æµ‹è¯•é€¾æœŸUTCæ—¶é—´:', overdueUtc);
                console.log('æµ‹è¯•å³å°†åˆ°æœŸUTCæ—¶é—´:', upcomingUtc);
                console.log('é€¾æœŸä»»åŠ¡è½¬æ¢ç»“æœ:', convertUTCToLocalForDisplay(overdueUtc));
                console.log('å³å°†åˆ°æœŸä»»åŠ¡è½¬æ¢ç»“æœ:', convertUTCToLocalForDisplay(upcomingUtc));
                console.log('é€¾æœŸåˆ¤æ–­ç»“æœ:', isTaskOverdue(overdueUtc));
                console.log('å³å°†åˆ°æœŸåˆ¤æ–­ç»“æœ:', isTaskOverdue(upcomingUtc));

                // 2. åˆ›å»ºæµ‹è¯•é€¾æœŸä»»åŠ¡
                setTimeout(() => {
                    console.log('=== æ­¥éª¤2: åˆ›å»ºæµ‹è¯•é€¾æœŸä»»åŠ¡ ===');
                    createTestOverdueTask();
                }, 1000);

                // 3. è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥
                setTimeout(() => {
                    console.log('=== æ­¥éª¤3: è§¦å‘ä»»åŠ¡æé†’æ£€æŸ¥ ===');
                    triggerTaskReminders();
                }, 2000);

                // 4. åˆ·æ–°ä»»åŠ¡åˆ—è¡¨éªŒè¯ç»“æœ
                setTimeout(() => {
                    console.log('=== æ­¥éª¤4: åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ ===');
                    loadTasks();
                    console.log('=== å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯•å®Œæˆ ===');
                    alert('å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼\n\nè¯·æ£€æŸ¥:\n1. æ§åˆ¶å°æ—¥å¿—è¾“å‡º\n2. Androidæ—¥å¿—ä¸­çš„æé†’æ£€æŸ¥\n3. ç³»ç»Ÿé€šçŸ¥\n4. ä»»åŠ¡åˆ—è¡¨ä¸­çš„é€¾æœŸæ ·å¼');
                }, 3000);

            } catch (error) {
                console.error('å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯•å¤±è´¥:', error);
                alert('å®Œæ•´æé†’ç³»ç»Ÿæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†åŠŸèƒ½
        function testImageModal() {
            try {
                console.log('=== å¼€å§‹å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æµ‹è¯• ===');

                // åˆ›å»ºæµ‹è¯•å›¾ç‰‡æ•°æ® (1x1åƒç´ çš„é€æ˜PNG base64)
                const testImageData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAI9jU77yQAAAABJRU5ErkJggg==';
                const testImageName = 'æµ‹è¯•å›¾ç‰‡';

                console.log('æµ‹è¯•å›¾ç‰‡æ•°æ®é•¿åº¦:', testImageData.length);
                console.log('æµ‹è¯•å›¾ç‰‡åç§°:', testImageName);

                // æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
                alert('æµ‹è¯•å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†\n\nå°†æ˜¾ç¤ºä¸€ä¸ªæµ‹è¯•å›¾ç‰‡çš„é¢„è§ˆçª—å£\nç‚¹å‡»çª—å£ä»»æ„ä½ç½®å¯å…³é—­');

                // è°ƒç”¨showImageModalå‡½æ•°
                showImageModal(testImageData, testImageName);

                console.log('å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                console.log('=== å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æµ‹è¯•å®Œæˆ ===');

            } catch (error) {
                console.error('å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æµ‹è¯•å¤±è´¥:', error);
                alert('å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨å®šæ—¶æ£€æŸ¥å¾®ä¿¡é€šçŸ¥
        function startNotificationScheduler() {
            // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦å‘é€é€šçŸ¥
            setInterval(() => {
                checkAndSendWechatNotification();
            }, 60000); // 60ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // ========== Web Notification API é€šçŸ¥åŠŸèƒ½ ==========

        // æ£€æŸ¥é€šçŸ¥æ”¯æŒå’Œæƒé™
        function isNotificationSupported() {
            return 'Notification' in window;
        }

        // è¯·æ±‚é€šçŸ¥æƒé™
        async function requestNotificationPermission() {
            if (!isNotificationSupported()) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒ Web Notification API');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            } else if (Notification.permission === 'denied') {
                console.warn('é€šçŸ¥æƒé™è¢«æ‹’ç»');
                return false;
            } else {
                try {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                } catch (error) {
                    console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:', error);
                    return false;
                }
            }
        }

        // å‘é€ Web é€šçŸ¥åˆ°ç³»ç»Ÿé€šçŸ¥æ 
        async function sendWebNotification(notificationData) {
            try {
                // æ£€æŸ¥æƒé™
                const hasPermission = await requestNotificationPermission();
                if (!hasPermission) {
                    console.warn('æ— é€šçŸ¥æƒé™ï¼Œæ— æ³•å‘é€é€šçŸ¥');
                    return false;
                }

                // æ„å»ºé€šçŸ¥é€‰é¡¹
                const options = {
                    body: notificationData.message || notificationData.body || '',
                    icon: notificationData.icon || '/favicon.ico', // é€šçŸ¥å›¾æ ‡
                    badge: notificationData.badge || '/favicon.ico', // å¾½ç« å›¾æ ‡
                    image: notificationData.image, // å¤§å›¾ç‰‡
                    tag: notificationData.tag || 'todo-notification', // é€šçŸ¥æ ‡ç­¾ï¼Œç”¨äºæ›¿æ¢ç›¸åŒæ ‡ç­¾çš„é€šçŸ¥
                    renotify: notificationData.renotify || false, // æ˜¯å¦é‡æ–°é€šçŸ¥
                    silent: notificationData.silent || false, // æ˜¯å¦é™é»˜
                    requireInteraction: notificationData.requireInteraction || false, // æ˜¯å¦éœ€è¦ç”¨æˆ·äº¤äº’æ‰æ¶ˆå¤±
                    timestamp: notificationData.timestamp || Date.now(),
                    data: notificationData.data || {}, // è‡ªå®šä¹‰æ•°æ®
                    actions: notificationData.actions || [] // é€šçŸ¥åŠ¨ä½œæŒ‰é’®
                };

                // åˆ›å»ºé€šçŸ¥
                const notification = new Notification(
                    notificationData.title || 'å¾…åŠæé†’',
                    options
                );

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus(); // èšç„¦åˆ°çª—å£

                    // æ‰§è¡Œè‡ªå®šä¹‰ç‚¹å‡»åŠ¨ä½œ
                    if (notificationData.onClick) {
                        notificationData.onClick(event);
                    }

                    // å…³é—­é€šçŸ¥
                    notification.close();
                };

                notification.onshow = function() {
                    console.log('é€šçŸ¥å·²æ˜¾ç¤º:', notificationData.title);
                };

                notification.onerror = function(error) {
                    console.error('é€šçŸ¥æ˜¾ç¤ºé”™è¯¯:', error);
                };

                // è‡ªåŠ¨å…³é—­é€šçŸ¥ï¼ˆå¦‚æœè®¾ç½®äº†ï¼‰
                if (notificationData.autoClose && notificationData.autoClose > 0) {
                    setTimeout(() => {
                        notification.close();
                    }, notificationData.autoClose);
                }

                console.log('Web é€šçŸ¥å·²å‘é€:', notificationData.title);
                return true;

            } catch (error) {
                console.error('å‘é€ Web é€šçŸ¥å¤±è´¥:', error);
                return false;
            }
        }

        // å‘é€ä»»åŠ¡å®Œæˆé€šçŸ¥
        function sendTaskCompletedNotification(taskTitle) {
            const notificationData = {
                title: 'ğŸ‰ ä»»åŠ¡å®Œæˆ',
                message: `æ­å–œï¼æ‚¨å·²å®Œæˆä»»åŠ¡ï¼š"${taskTitle}"`,
                body: `æ­å–œï¼æ‚¨å·²å®Œæˆä»»åŠ¡ï¼š"${taskTitle}"\n\nç»§ç»­ä¿æŒè¿™æ ·çš„é«˜æ•ˆç‡ï¼Œæ‚¨æ­£åœ¨æœç€ç›®æ ‡ç¨³æ­¥å‰è¿›ï¼`,
                icon: '/favicon.ico',
                tag: 'task-completed',
                requireInteraction: true,
                autoClose: 5000,
                onClick: () => {
                    // èšç„¦åˆ°ä»»åŠ¡åˆ—è¡¨
                    document.getElementById('taskList')?.scrollIntoView({ behavior: 'smooth' });
                }
            };
            return sendWebNotification(notificationData);
        }

        // å‘é€ä»»åŠ¡æé†’é€šçŸ¥
        function sendTaskReminderNotification(tasks) {
            if (!tasks || tasks.length === 0) return false;

            const taskCount = tasks.length;
            const firstTask = tasks[0];

            let title, body;

            if (taskCount === 1) {
                title = 'ğŸ“‹ ä»»åŠ¡æé†’';
                body = `æ‚¨æœ‰ä¸€ä¸ªå¾…å®Œæˆçš„ä»»åŠ¡ï¼š${firstTask.title}\næˆªæ­¢æ—¶é—´ï¼š${firstTask.deadline || 'æ— é™åˆ¶'}\n\n${firstTask.notes || ''}`;
            } else {
                title = 'ğŸ“‹ ä»»åŠ¡æé†’';
                body = `æ‚¨æœ‰ ${taskCount} ä¸ªå¾…å®Œæˆçš„ä»»åŠ¡\n\n${tasks.slice(0, 3).map((task, index) =>
                    `${index + 1}. ${task.title}${task.deadline ? '\n   æˆªæ­¢ï¼š' + task.deadline : ''}`
                ).join('\n\n')}${taskCount > 3 ? `\n\nè¿˜æœ‰ ${taskCount - 3} ä¸ªä»»åŠ¡...` : ''}`;
            }

            const notificationData = {
                title,
                body,
                icon: '/favicon.ico',
                tag: 'task-reminder',
                autoClose: 8000,
                onClick: () => {
                    // èšç„¦åˆ°ä»»åŠ¡åˆ—è¡¨
                    document.getElementById('taskList')?.scrollIntoView({ behavior: 'smooth' });
                }
            };
            return sendWebNotification(notificationData);
        }

        // å‘é€æ™¨æ™šæŠ¥é€šçŸ¥
        function sendDailyReportNotification(type = 'morning') {
            // ä½¿ç”¨å…¨å±€taskså˜é‡ï¼Œå¦‚æœä¸ºç©ºåˆ™ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            if (!tasks || tasks.length === 0) {
                const storedTasks = localStorage.getItem('tasks');
                if (storedTasks) {
                    tasks = JSON.parse(storedTasks);
                }
            }
            const today = new Date();
            today.setHours(23, 59, 0, 0);

            // ç­›é€‰å½“æ—¥ä»»åŠ¡ï¼šæˆªæ­¢æ—¶é—´ä¸ºä»Šæ—¥ä¸”æœªå®Œæˆçš„ä»»åŠ¡
            const todayPendingTasks = tasks.filter(task => {
                if (task.completed || !task.deadline) return false;
                const taskDate = new Date(task.deadline);
                console.log('ä»»åŠ¡æˆªæ­¢æ—¥æœŸ:', taskDate, 'ä»Šæ—¥æ—¥æœŸ:', today,'ä¸ªäººä¿¡æ¯:',personalInfo.myAssignee,'ä»»åŠ¡åˆ†é…ç»™:',task.assignee);
                // åŒ…å«ä»Šæ—¥æˆªæ­¢å’Œå·²é€¾æœŸçš„å¾…åŠä»»åŠ¡
                return (taskDate.toDateString() === today.toDateString() || taskDate < today)&&(task.assignee&&task.assignee.includes(personalInfo.myAssignee));
            });

            // ç­›é€‰å½“æ—¥å·²å®Œæˆä»»åŠ¡ï¼šä»Šæ—¥å®Œæˆçš„ä»»åŠ¡
            const todayCompletedTasks = tasks.filter(task => {
                if (!task.completed || !task.completedAt) return false;
                let completedDate;
                if (typeof task.completedAt === 'string' && task.completedAt.includes('T')) {
                    completedDate = new Date(task.completedAt).toDateString();
                } else {
                    completedDate = new Date(task.completedAt.replace(/-/g, '/')).toDateString();
                }
                return completedDate === today.toDateString();
            });

            let title, body;

            if (type === 'morning') {
                title = `ğŸŒ… æ—©å®‰${personalInfo.myAssignee}ï¼æ–°çš„ä¸€å¤©å¼€å§‹äº†`;

                // ç”Ÿæˆè¯¦ç»†çš„æ™¨æŠ¥å†…å®¹
                let morningContent = `â˜€ï¸ æ—©å®‰ï¼ä»Šå¤©æ˜¯ç¾å¥½çš„ä¸€å¤©ã€‚\n\nğŸ“Š ä»Šæ—¥æ¦‚è§ˆï¼š\nâ€¢ å¾…åŠä»»åŠ¡ï¼š${todayPendingTasks.length}ä¸ª\nâ€¢ å·²å®Œæˆï¼š${todayCompletedTasks.length}ä¸ª`;

                if (todayPendingTasks.length > 0) {
                    const detailedTasks = todayPendingTasks.slice(0, 3).map((task, index) => {
                        const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                        const category = getCategoryName(task.category);
                        const formattedDeadline = formatDeadline(task.deadline);
                        const assignee = task.assignees && task.assignees.length > 0 ?
                            `ğŸ‘¤ ${task.assignees.join(', ')}` :
                            task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';

                        let taskInfo = `${index + 1}. ${priority} ${task.title}\n`;
                        taskInfo += `   ğŸ“ ${category}`;
                        taskInfo += ` | ${assignee}`;
                        taskInfo += `\n   â° ${formattedDeadline}`;

                        if (task.notes && task.notes.trim()) {
                            const shortNotes = task.notes.length > 40 ?
                                task.notes.substring(0, 40) + '...' : task.notes;
                            taskInfo += `\n   ğŸ“ ${shortNotes}`;
                        }

                        return taskInfo;
                    });

                    morningContent += `\n\nğŸ“‹ ä»Šæ—¥é‡ç‚¹ä»»åŠ¡ï¼š\n\n${detailedTasks.join('\n\n')}`;

                    if (todayPendingTasks.length > 3) {
                        morningContent += `\n\nâš¡ è¿˜æœ‰ ${todayPendingTasks.length - 3} ä¸ªä»»åŠ¡å¾…å¤„ç†...`;
                    }

                    morningContent += `\n\nğŸ’ª åŠ æ²¹ï¼ä»Šå¤©ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ï¼`;
                } else {
                    morningContent += `\n\nğŸ‰ ä»Šæ—¥æ— å¾…åŠä»»åŠ¡ï¼Œå¯ä»¥äº«å—è½»æ¾çš„ä¸€å¤©ï¼\n\nğŸŒŸ ä¸å¦¨åˆ©ç”¨è¿™ä¸ªæœºä¼šä¼‘æ¯æˆ–å­¦ä¹ æ–°çŸ¥è¯†ã€‚`;
                }

                body = morningContent;
            } else {
                title = 'ğŸŒ™ æ™šå®‰ï¼ä¸€å¤©è¾›è‹¦äº†';

                // ç”Ÿæˆè¯¦ç»†çš„æ™šæŠ¥å†…å®¹
                let eveningContent = `ğŸŒ› æ™šå®‰ï¼æ„Ÿè°¢æ‚¨ä»Šå¤©çš„åŠªåŠ›ã€‚\n\nğŸ“Š ä»Šæ—¥æ€»ç»“ï¼š\nâ€¢ å®Œæˆä»»åŠ¡ï¼š${todayCompletedTasks.length}ä¸ª\nâ€¢ å‰©ä½™å¾…åŠï¼š${todayPendingTasks.length}ä¸ª`;

                if (todayCompletedTasks.length > 0) {
                    const detailedCompletedTasks = todayCompletedTasks.slice(-3).map((task, index) => {
                        const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                        const category = getCategoryName(task.category);
                        const assignee = task.assignees && task.assignees.length > 0 ?
                            `ğŸ‘¤ ${task.assignees.join(', ')}` :
                            task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';
                        const completedTime = task.completedAt ? formatRelativeTime(task.completedAt) : 'ä»Šæ—¥';

                        let taskInfo = `${index + 1}. âœ… ${priority} ${task.title}\n`;
                        taskInfo += `   ğŸ“ ${category}`;
                        taskInfo += ` | ${assignee}`;
                        taskInfo += `\n   ğŸ• å®Œæˆäºï¼š${completedTime}`;

                        return taskInfo;
                    });

                    eveningContent += `\n\nğŸ¯ ä»Šæ—¥æˆå°±ï¼š\n\n${detailedCompletedTasks.join('\n\n')}`;

                    if (todayCompletedTasks.length > 3) {
                        eveningContent += `\n\nâ­ ä»Šæ—¥æ€»å…±å®Œæˆäº† ${todayCompletedTasks.length} ä¸ªä»»åŠ¡ï¼`;
                    }
                } else {
                    eveningContent += `\n\nğŸ˜´ ä»Šå¤©æ²¡æœ‰å®Œæˆä»»åŠ¡ï¼Œä¸è¦æ°”é¦ï¼`;
                }

                if (todayPendingTasks.length > 0) {
                    eveningContent += `\n\nğŸ“‹ æ˜æ—¥ç»§ç»­ï¼šè¿˜æœ‰ ${todayPendingTasks.length} ä¸ªä»»åŠ¡ç­‰å¾…å®Œæˆ`;

                    // æ˜¾ç¤ºæœ€é«˜ä¼˜å…ˆçº§çš„æœªå®Œæˆä»»åŠ¡
                    const highPriorityTasks = todayPendingTasks.filter(task => task.priority === 'high');
                    if (highPriorityTasks.length > 0) {
                        eveningContent += `\nğŸ”´ å…¶ä¸­ ${highPriorityTasks.length} ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡éœ€è¦é‡ç‚¹å…³æ³¨`;
                    }
                }

                eveningContent += `\n\nğŸŒŸ è¾›è‹¦äº†ï¼å¥½å¥½ä¼‘æ¯ï¼Œæ˜å¤©ç»§ç»­åŠ æ²¹ï¼`;
                body = eveningContent;
            }

            const notificationData = {
                title,
                body,
                icon: '/favicon.ico',
                tag: type === 'morning' ? 'morning-report' : 'evening-report',
                autoClose: 10000,
                onClick: () => {
                    // èšç„¦åˆ°ä»»åŠ¡åˆ—è¡¨
                    document.getElementById('taskList')?.scrollIntoView({ behavior: 'smooth' });
                }
            };
            return sendWebNotification(notificationData);
        }

        // å‘é€è¶…æ—¶æé†’é€šçŸ¥
        function sendOverdueNotification(overdueTasks) {
            if (!overdueTasks || overdueTasks.length === 0) return false;

            const taskCount = overdueTasks.length;
            const title = 'âš ï¸ ä»»åŠ¡è¶…æ—¶æé†’';

            // æ ¼å¼åŒ–è¶…æ—¶æ—¶é—´æ˜¾ç¤º
            function formatOverdueTime(minutes) {
                if (minutes < 60) {
                    return `${minutes}åˆ†é’Ÿ`;
                } else if (minutes < 1440) { // å°äº24å°æ—¶
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    return remainingMinutes > 0 ? `${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
                } else { // å¤§äºç­‰äº24å°æ—¶
                    const days = Math.floor(minutes / 1440);
                    const remainingHours = Math.floor((minutes % 1440) / 60);
                    return remainingHours > 0 ? `${days}å¤©${remainingHours}å°æ—¶` : `${days}å¤©`;
                }
            }

            // ç”Ÿæˆè¯¦ç»†çš„è¶…æ—¶ä»»åŠ¡ä¿¡æ¯
            const detailedOverdueTasks = overdueTasks.slice(0, 3).map((task, index) => {
                const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const category = getCategoryName(task.category);
                const overdueMinutes = calculateOverdueMinutes(task.deadline);
                const formattedDeadline = formatDeadline(task.deadline);
                const assignee = task.assignees && task.assignees.length > 0 ?
                    `ğŸ‘¤ ${task.assignees.join(', ')}` :
                    task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';

                let taskInfo = `${index + 1}. ${priority} ${task.title}\n`;
                taskInfo += `   ğŸ“ åˆ†ç±»ï¼š${category}\n`;
                taskInfo += `   ${assignee}\n`;
                taskInfo += `   â° åŸå®šæˆªæ­¢ï¼š${formattedDeadline}\n`;
                taskInfo += `   âš ï¸ å·²è¶…æ—¶ï¼š${formatOverdueTime(overdueMinutes)}`;

                if (task.notes && task.notes.trim()) {
                    // é™åˆ¶å¤‡æ³¨é•¿åº¦ï¼Œé¿å…é€šçŸ¥è¿‡é•¿
                    const shortNotes = task.notes.length > 50 ?
                        task.notes.substring(0, 50) + '...' : task.notes;
                    taskInfo += `\n   ğŸ“ å¤‡æ³¨ï¼š${shortNotes}`;
                }

                return taskInfo;
            });

            const body = `ğŸš¨ æ‚¨æœ‰ ${taskCount} ä¸ªä»»åŠ¡å·²è¶…è¿‡æˆªæ­¢æ—¶é—´ï¼\n\n${detailedOverdueTasks.join('\n\n')}${taskCount > 3 ? `\n\nâš¡ è¿˜æœ‰ ${taskCount - 3} ä¸ªè¶…æ—¶ä»»åŠ¡...` : ''}\n\nâ° è¯·åŠæ—¶å¤„ç†è¿™äº›è¶…æ—¶ä»»åŠ¡ï¼`;

            const notificationData = {
                title,
                body,
                icon: '/favicon.ico',
                tag: 'overdue-reminder',
                requireInteraction: true, // éœ€è¦ç”¨æˆ·äº¤äº’æ‰æ¶ˆå¤±ï¼Œå› ä¸ºè¿™æ˜¯é‡è¦æé†’
                onClick: () => {
                    // èšç„¦åˆ°ä»»åŠ¡åˆ—è¡¨
                    document.getElementById('taskList')?.scrollIntoView({ behavior: 'smooth' });
                }
            };
            return sendWebNotification(notificationData);
        }

        // å‘é€å³å°†åˆ°æœŸè­¦å‘Šé€šçŸ¥ï¼ˆåŸç”Ÿé€šçŸ¥ï¼‰
        function sendDeadlineWarningNotification(upcomingTasks) {
            if (!upcomingTasks || upcomingTasks.length === 0) return false;

            const taskCount = upcomingTasks.length;
            const title = 'â° ä»»åŠ¡å³å°†åˆ°æœŸ';

            // ç”Ÿæˆè¯¦ç»†çš„ä»»åŠ¡ä¿¡æ¯
            const detailedTasks = upcomingTasks.slice(0, 3).map((task, index) => {
                const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const category = getCategoryName(task.category);
                const formattedDeadline = formatDeadline(task.deadline);
                const assignee = task.assignees && task.assignees.length > 0 ?
                    `ğŸ‘¤ ${task.assignees.join(', ')}` :
                    task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';

                // è®¡ç®—å‰©ä½™æ—¶é—´
                const deadlineTime = new Date(task.deadline.replace(/-/g, '/'));
                const now = new Date();
                const remainingMinutes = Math.max(0, Math.floor((deadlineTime - now) / (1000 * 60)));
                const timeLeft = remainingMinutes > 0 ? `â±ï¸ å‰©ä½™${remainingMinutes}åˆ†é’Ÿ` : 'âš ï¸ å·²åˆ°æœŸ';

                let taskInfo = `${index + 1}. ${priority} ${task.title}\n`;
                taskInfo += `   ğŸ“ åˆ†ç±»ï¼š${category}\n`;
                taskInfo += `   ${assignee}\n`;
                taskInfo += `   â° æˆªæ­¢ï¼š${formattedDeadline}\n`;
                taskInfo += `   ${timeLeft}`;

                if (task.notes && task.notes.trim()) {
                    // é™åˆ¶å¤‡æ³¨é•¿åº¦ï¼Œé¿å…é€šçŸ¥è¿‡é•¿
                    const shortNotes = task.notes.length > 50 ?
                        task.notes.substring(0, 50) + '...' : task.notes;
                    taskInfo += `\n   ğŸ“ å¤‡æ³¨ï¼š${shortNotes}`;
                }

                return taskInfo;
            });

            const body = `ğŸš¨ æ‚¨æœ‰ ${taskCount} ä¸ªä»»åŠ¡å³å°†åœ¨10åˆ†é’Ÿå†…åˆ°æœŸï¼\n\n${detailedTasks.join('\n\n')}${taskCount > 3 ? `\n\nâš¡ è¿˜æœ‰ ${taskCount - 3} ä¸ªä»»åŠ¡å³å°†åˆ°æœŸ...` : ''}\n\nğŸƒâ€â™‚ï¸ è¯·æŠ“ç´§æ—¶é—´å®Œæˆï¼`;

            const notificationData = {
                title,
                body,
                icon: '/favicon.ico',
                tag: 'deadline-warning',
                requireInteraction: true,
                onClick: () => {
                    document.getElementById('taskList')?.scrollIntoView({ behavior: 'smooth' });
                }
            };
            return sendWebNotification(notificationData);
        }

        // ç”Ÿæˆè¶…æ—¶æé†’å†…å®¹ï¼ˆç”¨äºå¾®ä¿¡é€šçŸ¥ï¼‰
        function generateOverdueReminderContent(overdueTasks) {
            const title = `âš ï¸ ä»»åŠ¡è¶…æ—¶æé†’`;
            let content = `ğŸš¨ ä»¥ä¸‹ä»»åŠ¡å·²è¶…è¿‡æˆªæ­¢æ—¶é—´ï¼Œè¯·å°½å¿«å¤„ç†ï¼\n\n`;

            overdueTasks.forEach((task, index) => {
                const priority = task.priority === 'high' ? 'ğŸ”´' : task.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const category = getCategoryName(task.category);
                const formattedDeadline = formatDeadline(task.deadline);
                const assignee = task.assignees && task.assignees.length > 0 ? `ğŸ‘¤ ${task.assignees.join(', ')}` : task.assignee ? `ğŸ‘¤ ${task.assignee}` : 'ğŸ‘¤ æœªåˆ†é…';
                const overdueMinutes = calculateOverdueMinutes(task.deadline);

                // æ ¼å¼åŒ–è¶…æ—¶æ—¶é—´
                let overdueTime;
                if (overdueMinutes < 60) {
                    overdueTime = `${overdueMinutes}åˆ†é’Ÿ`;
                } else if (overdueMinutes < 1440) {
                    const hours = Math.floor(overdueMinutes / 60);
                    overdueTime = `${hours}å°æ—¶`;
                } else {
                    const days = Math.floor(overdueMinutes / 1440);
                    overdueTime = `${days}å¤©`;
                }

                content += `${index + 1}. ${priority} **${task.title}**\n`;
                content += `   - åˆ†ç±»ï¼š${category}\n`;
                content += `   - å®Œæˆäººï¼š${assignee}\n`;
                content += `   - æˆªæ­¢æ—¶é—´ï¼š${formattedDeadline}\n`;
                content += `   - è¶…æ—¶ï¼š${overdueTime}\n`;
                if (task.notes) content += `   - å¤‡æ³¨ï¼š${task.notes}\n`;
                content += '\n';
            });

            content += `âš¡ è¯·å°½å¿«å¤„ç†è¿™ ${overdueTasks.length} ä¸ªè¶…æ—¶ä»»åŠ¡ï¼`;

            return { title, content };
        }

        // è®¡ç®—è¶…æ—¶å¤©æ•°
        function calculateOverdueMinutes(deadline) {
            if (!deadline) return 0;

            try {
                // ç¡®ä¿æ­£ç¡®è§£ææ—¶é—´ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                const deadlineDate = new Date(deadline.replace(/-/g, '/'));

                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(deadlineDate.getTime())) {
                    console.warn('Invalid deadline format in calculateOverdueMinutes:', deadline);
                    return 0;
                }

                const now = new Date();
                const diffTime = now - deadlineDate;
                const diffMinutes = Math.ceil(diffTime / (1000 * 60));
                return diffMinutes > 0 ? diffMinutes : 0;
            } catch (error) {
                console.error('Error calculating overdue minutes:', deadline, error);
                return 0;
            }
        }

        // ä¿æŒå‘åå…¼å®¹çš„å¤©æ•°è®¡ç®—å‡½æ•°
        function calculateOverdueDays(deadline) {
            if (!deadline) return 0;

            try {
                const deadlineDate = new Date(deadline.replace(/-/g, '/'));

                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(deadlineDate.getTime())) {
                    console.warn('Invalid deadline format in calculateOverdueDays:', deadline);
                    return 0;
                }

                const today = new Date();
                const diffTime = today - deadlineDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 ? diffDays : 0;
            } catch (error) {
                console.error('Error calculating overdue days:', deadline, error);
                return 0;
            }
        }

        // æµ‹è¯• Web é€šçŸ¥åŠŸèƒ½
        async function testWebNotification() {
            if (!isNotificationSupported()) {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒ Web Notification API');
                return;
            }

            const testNotification = {
                title: 'ğŸ“± æµ‹è¯•é€šçŸ¥',
                body: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥æ¶ˆæ¯\n\nå¦‚æœæ‚¨çœ‹åˆ°è¿™æ¡é€šçŸ¥ï¼Œè¯´æ˜ Web Notification API é›†æˆæˆåŠŸï¼\n\nç‚¹å‡»é€šçŸ¥å¯ä»¥è¿”å›åˆ°åº”ç”¨ã€‚',
                icon: '/favicon.ico',
                tag: 'test-notification',
                requireInteraction: true,
                onClick: () => {
                    console.log('é€šçŸ¥ç‚¹å‡»æˆåŠŸï¼Web Notification API å·¥ä½œæ­£å¸¸ã€‚');
                }
            };

            const success = await sendWebNotification(testNotification);
            if (success) {
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯è€Œä¸æ˜¯ä½¿ç”¨alert
                showMessage('æµ‹è¯•é€šçŸ¥å·²å‘é€ï¼Œè¯·æŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥æ ', 'success');
            } else {
                showMessage('å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é€šçŸ¥æƒé™', 'error');
            }
        }

        // åˆå§‹åŒ–æ—¶è¯·æ±‚é€šçŸ¥æƒé™
        async function initNotificationPermission() {
            if (isNotificationSupported()) {
                const hasPermission = await requestNotificationPermission();
                if (hasPermission) {
                    console.log('é€šçŸ¥æƒé™å·²è·å–');
                } else {
                    console.warn('é€šçŸ¥æƒé™æœªè·å–ï¼Œå°†æ— æ³•å‘é€é€šçŸ¥');
                }
            }
        }

        // æ˜¾ç¤ºåŒæ­¥é€šçŸ¥
        function showSyncNotification(message) {
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„é€šçŸ¥æç¤º
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 12000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.querySelector('#sync-notification-style')) {
                const style = document.createElement('style');
                style.id = 'sync-notification-style';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // æ·»åŠ ä¸€ä¸ªæ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°ï¼Œæ›¿ä»£alert
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 16px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                ${type === 'success' ? 'background-color: #4CAF50;' :
                  type === 'error' ? 'background-color: #f44336;' :
                  'background-color: #2196F3;'}
            `;
            messageDiv.textContent = message;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(messageDiv);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // ========== å®šæ—¶æ•°æ®åŒæ­¥åŠŸèƒ½ ==========

        let syncTimer = null;
        let syncInterval = 5 * 60 * 1000; // é»˜è®¤5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡

        // å¯åŠ¨å®šæ—¶æ•°æ®åŒæ­¥
        function startDataSyncScheduler() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (syncTimer) {
                clearInterval(syncTimer);
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            syncTimer = setInterval(async () => {
                if (syncStatus.isOnline && !syncStatus.syncInProgress) {
                    console.log('å®šæ—¶åŒæ­¥æ•°æ®...');
                    try {
                        // ç›´æ¥æ£€æŸ¥æœåŠ¡å™¨æ•°æ®å¹¶è¦†ç›–æœ¬åœ°æ•°æ®
                        await checkForUpdatesFromServer();
                    } catch (error) {
                        console.error('å®šæ—¶åŒæ­¥å¤±è´¥:', error);
                    }
                }
            }, syncInterval);

            console.log(`å®šæ—¶æ•°æ®åŒæ­¥å·²å¯åŠ¨ï¼Œé—´éš”: ${syncInterval / 1000}ç§’`);
        }

        // åœæ­¢å®šæ—¶æ•°æ®åŒæ­¥
        function stopDataSyncScheduler() {
            if (syncTimer) {
                clearInterval(syncTimer);
                syncTimer = null;
                console.log('å®šæ—¶æ•°æ®åŒæ­¥å·²åœæ­¢');
            }
        }

        // è®¾ç½®åŒæ­¥é—´éš”
        function setSyncInterval(intervalInMinutes) {
            syncInterval = intervalInMinutes * 60 * 1000;
            console.log(`åŒæ­¥é—´éš”å·²è®¾ç½®ä¸º: ${intervalInMinutes}åˆ†é’Ÿ`);

            // é‡å¯å®šæ—¶å™¨ä»¥åº”ç”¨æ–°é—´éš”
            if (syncTimer) {
                startDataSyncScheduler();
            }
        }

        // æ£€æŸ¥æœåŠ¡å™¨æ›´æ–°
        async function checkForUpdatesFromServer() {
            if (!DATABASE_CONFIG.binId || !syncStatus.isOnline) {
                return;
            }

            try {
                const response = await fetch(`${DATABASE_CONFIG.baseUrl}/${DATABASE_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DATABASE_CONFIG.apiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const serverTasks = data.record.tasks || [];
                    const serverLastModified = data.record.lastModified;

                    // æ•°æ®åº“æ•°æ®å§‹ç»ˆè¦†ç›–æœ¬åœ°æ•°æ®
                    console.log('åŒæ­¥æ•°æ®å®Œæˆ...');

                    const oldTasksLength = tasks.length;
                    tasks = serverTasks;

                    // API-firstæ¨¡å¼ä¸‹ä¸éœ€è¦æœ¬åœ°ä¿å­˜

                    // æ›´æ–°ç•Œé¢
                    renderTasks();
                    updateStats();

                    console.log(`æ•°æ®å·²è¦†ç›–: ${oldTasksLength} -> ${tasks.length} ä¸ªä»»åŠ¡`);

                    // æ˜¾ç¤ºåŒæ­¥æç¤º
                    showSyncNotification(`æ•°æ®å·²ä»æ•°æ®åº“åŒæ­¥ (${tasks.length}ä¸ªä»»åŠ¡)`);
                }
            } catch (error) {
                console.error('æ£€æŸ¥æœåŠ¡å™¨æ›´æ–°å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåŒæ­¥é€šçŸ¥

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        function handleVisibilityChange() {
            if (document.hidden) {
                // é¡µé¢ä¸å¯è§æ—¶åœæ­¢å®šæ—¶åŒæ­¥ä»¥èŠ‚çœèµ„æº
                console.log('é¡µé¢ä¸å¯è§ï¼Œæš‚åœå®šæ—¶åŒæ­¥');
                stopDataSyncScheduler();
            } else {
                // é¡µé¢å¯è§æ—¶æ¢å¤å®šæ—¶åŒæ­¥å¹¶ç«‹å³æ£€æŸ¥æ›´æ–°
                console.log('é¡µé¢å¯è§ï¼Œæ¢å¤å®šæ—¶åŒæ­¥');
                startDataSyncScheduler();

                // ç«‹å³æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
                if (syncStatus.isOnline) {
                    setTimeout(() => {
                        checkForUpdatesFromServer();
                    }, 1000);
                }
            }
        }

        // æŠ˜å åŠŸèƒ½
        function toggleFilterSection() {
            const content = document.getElementById('filterContent');
            const icon = document.getElementById('filterCollapseIcon');
            const taskList = document.getElementById('taskList');
            const taskView = document.getElementById('taskView');
            const viewContainer = document.querySelector('.view-container');

            console.log('toggleFilterSection called', {
                content: !!content,
                icon: !!icon,
                taskList: !!taskList,
                taskView: !!taskView,
                viewContainer: !!viewContainer
            });

            if (content && icon) {
                const isCollapsed = content.classList.contains('collapsed');
                console.log('isCollapsed:', isCollapsed);

                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;

                if (isCollapsed) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                    // å±•å¼€æ—¶ï¼Œå‡å°‘å„å®¹å™¨é«˜åº¦ä»¥å……åˆ†åˆ©ç”¨ç©ºé—´
                    if (taskList) {
                        if (isSmallMobile) {
                            taskList.style.maxHeight = 'calc(100vh - 360px)';
                        } else if (isMobile) {
                            taskList.style.maxHeight = 'calc(100vh - 380px)';
                        } else {
                            taskList.style.maxHeight = 'calc(100vh - 450px)';
                        }
                        console.log('å±•å¼€ï¼šè®¾ç½®task-listé«˜åº¦');
                    }
                    // if (taskView) {
                    //     if (isSmallMobile) {
                    //         taskView.style.height = 'auto';
                    //     } else if (isMobile) {
                    //         taskView.style.height = 'auto';
                    //     } else {
                    //         taskView.style.height = 'auto';
                    //     }
                    //     console.log('æŠ˜å ï¼šè®¾ç½®taskViewé«˜åº¦');
                    // }

                    // è°ƒæ•´task-itemé«˜åº¦
                    if (enableCompactModeToggle) {
                        adjustTaskItemHeight('compact');
                    }
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                    // æŠ˜å æ—¶ï¼Œå¢åŠ å„å®¹å™¨é«˜åº¦ä»¥å……åˆ†åˆ©ç”¨ç©ºé—´
                    if (taskList) {
                        if (isSmallMobile) {
                            taskList.style.maxHeight = 'calc(100vh - 300px)';
                        } else if (isMobile) {
                            taskList.style.maxHeight = 'calc(100vh - 320px)';
                        } else {
                            taskList.style.maxHeight = 'calc(100vh - 400px)';
                        }
                        console.log('æŠ˜å ï¼šè®¾ç½®task-listé«˜åº¦');
                    }
                    // if (taskView) {
                    //     if (isSmallMobile) {
                    //         taskView.style.height = '100vh';
                    //     } else if (isMobile) {
                    //         taskView.style.height = '100vh';
                    //     } else {
                    //         taskView.style.height = '100vh';
                    //     }
                    //     console.log('æŠ˜å ï¼šè®¾ç½®taskViewé«˜åº¦');
                    // }
                    // if (viewContainer) {
                    //     if (isSmallMobile) {
                    //         viewContainer.style.height = '100vh';
                    //     } else if (isMobile) {
                    //         viewContainer.style.height = '100vh';
                    //     } else {
                    //         viewContainer.style.height = '100vh';
                    //     }
                    //     console.log('æŠ˜å ï¼šè®¾ç½®viewContaineré«˜åº¦');
                    // }

                    // è°ƒæ•´task-itemé«˜åº¦
                    if (enableCompactModeToggle) {
                        adjustTaskItemHeight('normal');
                    }
                }

                // ä¿å­˜æŠ˜å çŠ¶æ€ï¼ˆæš‚æ—¶ä¿ç•™ä»¥å…¼å®¹ï¼‰
                localStorage.setItem('filterSectionCollapsed', !isCollapsed);
            }
        }

        // ç®€åŒ–ç‰ˆæœ¬ - ç­›é€‰å¤´éƒ¨å·²ç§»é™¤ï¼Œä½†ä¿ç•™å‡½æ•°ä»¥å…¼å®¹
        function toggleFilterSection() {
            console.log('toggleFilterSection: ç­›é€‰å¤´éƒ¨å·²ç§»é™¤ï¼Œä½¿ç”¨ toggleCollapsibleRows() æ›¿ä»£è¡Œçº§æŠ˜å ');
        }

        // è°ƒæ•´task-itemé«˜åº¦çš„è¾…åŠ©å‡½æ•° - ç§»åŠ¨ç«¯è‡ªé€‚åº”
        function adjustTaskItemHeight(mode) {
            // å¦‚æœæœªå¯ç”¨ç´§å‡‘æ¨¡å¼åˆ‡æ¢ï¼Œç›´æ¥è¿”å›ï¼Œä½¿ç”¨é»˜è®¤æ ·å¼
            if (!enableCompactModeToggle) {
                console.log('ç´§å‡‘æ¨¡å¼åˆ‡æ¢å·²ç¦ç”¨ï¼Œä½¿ç”¨é»˜è®¤æ ·å¼');
                return;
            }

            const taskItems = document.querySelectorAll('.task-item');
            const taskList = document.getElementById('taskList');

            taskItems.forEach(item => {
                // æ¸…é™¤ä¹‹å‰çš„å†…è”æ ·å¼ï¼Œè®©CSSåª’ä½“æŸ¥è¯¢ç”Ÿæ•ˆ
                item.style.padding = '';

                // æ ¹æ®å±å¹•å°ºå¯¸å’Œæ¨¡å¼è®¾ç½®padding
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;

                if (mode === 'compact') {
                    if (isSmallMobile) {
                        item.style.padding = '8px 14px'; /* å°å±å¹•ç´§å‡‘æ¨¡å¼ */
                    } else if (isMobile) {
                        item.style.padding = '10px 16px'; /* ç§»åŠ¨ç«¯ç´§å‡‘æ¨¡å¼ */
                    } else {
                        item.style.padding = '12px 20px';
                    }
                    console.log('è®¾ç½®task-itemä¸ºç´§å‡‘æ¨¡å¼');
                } else {
                    if (isSmallMobile) {
                        item.style.padding = '25px 20px'; /* å°å±å¹•æ­£å¸¸æ¨¡å¼ */
                    } else if (isMobile) {
                        item.style.padding = '25px 20px'; /* ç§»åŠ¨ç«¯æ­£å¸¸æ¨¡å¼ */
                    } else {
                        item.style.padding = '25px 20px';
                    }
                    console.log('è®¾ç½®task-itemä¸ºæ­£å¸¸æ¨¡å¼');
                }
            });

            // åŒæ—¶è°ƒæ•´task-listé«˜åº¦ä»¥é€‚åº”ç§»åŠ¨ç«¯
            if (taskList) {
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;

                if (mode === 'compact') {
                    if (isSmallMobile) {
                        taskList.style.maxHeight = 'calc(100vh - 300px)'; /* å°å±å¹•ç´§å‡‘æ¨¡å¼ */
                    } else if (isMobile) {
                        taskList.style.maxHeight = 'calc(100vh - 320px)'; /* ç§»åŠ¨ç«¯ç´§å‡‘æ¨¡å¼ */
                    } else {
                        taskList.style.maxHeight = 'calc(100vh - 400px)';
                    }
                } else {
                    if (isSmallMobile) {
                        taskList.style.maxHeight = 'calc(100vh - 280px)'; /* å°å±å¹•æ­£å¸¸æ¨¡å¼ */
                    } else if (isMobile) {
                        taskList.style.maxHeight = 'calc(100vh - 300px)'; /* ç§»åŠ¨ç«¯æ­£å¸¸æ¨¡å¼ */
                    } else {
                        taskList.style.maxHeight = 'calc(100vh - 380px)';
                    }
                }
            }
        }

        function toggleFunctionSection() {
            const content = document.getElementById('functionContent');
            const icon = document.getElementById('functionCollapseIcon');

            if (content && icon) {
                const isCollapsed = content.classList.contains('collapsed');

                if (isCollapsed) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }

                // ä¿å­˜æŠ˜å çŠ¶æ€
                localStorage.setItem('functionSectionCollapsed', !isCollapsed);
            }
        }

        function toggleSettingsSection() {
            const content = document.getElementById('settingsContent');
            const icon = document.getElementById('settingsCollapseIcon');

            if (content && icon) {
                const isCollapsed = content.classList.contains('collapsed');

                if (isCollapsed) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }

                // ä¿å­˜æŠ˜å çŠ¶æ€
                localStorage.setItem('settingsSectionCollapsed', !isCollapsed);
            }
        }

        // æ¢å¤æŠ˜å çŠ¶æ€
        function restoreCollapsedStates() {
            const taskList = document.getElementById('taskList');

            // æ¢å¤ç­›é€‰åŒºåŸŸçŠ¶æ€å¹¶è®¾ç½®ä»»åŠ¡åˆ—è¡¨é«˜åº¦
            if (enableCompactModeToggle) {
                // å¯ç”¨æ¨¡å¼åˆ‡æ¢æ—¶ï¼Œæ ¹æ®ç­›é€‰å™¨çŠ¶æ€è°ƒæ•´
                const filterCollapsed = localStorage.getItem('filterSectionCollapsed') === 'true';
                if (filterCollapsed) {
                    const filterContent = document.getElementById('filterContent');
                    const filterIcon = document.getElementById('filterCollapseIcon');
                    if (filterContent && filterIcon) {
                        filterContent.classList.add('collapsed');
                        filterIcon.classList.add('collapsed');
                        filterIcon.textContent = 'â–¶';
                        // æŠ˜å æ—¶ï¼Œå¢åŠ task-listé«˜åº¦
                        if (taskList) {
                            const isMobile = window.innerWidth <= 768;
                            const isSmallMobile = window.innerWidth <= 480;
                            if (isSmallMobile) {
                                taskList.style.maxHeight = 'calc(100vh - 300px)';
                            } else if (isMobile) {
                                taskList.style.maxHeight = 'calc(100vh - 320px)';
                            } else {
                                taskList.style.maxHeight = 'calc(100vh - 400px)';
                            }
                            console.log('é¡µé¢åŠ è½½ï¼šç­›é€‰å™¨æŠ˜å ï¼Œè®¾ç½®task-listé«˜åº¦');
                        }
                        // è®¾ç½®task-itemä¸ºæ­£å¸¸æ¨¡å¼
                        adjustTaskItemHeight('normal');
                    }
                } else {
                    // å±•å¼€æ—¶ï¼Œä½¿ç”¨é»˜è®¤é«˜åº¦
                    if (taskList) {
                        const isMobile = window.innerWidth <= 768;
                        const isSmallMobile = window.innerWidth <= 480;
                        if (isSmallMobile) {
                            taskList.style.maxHeight = 'calc(100vh - 360px)';
                        } else if (isMobile) {
                            taskList.style.maxHeight = 'calc(100vh - 380px)';
                        } else {
                            taskList.style.maxHeight = 'calc(100vh - 450px)';
                        }
                        console.log('é¡µé¢åŠ è½½ï¼šç­›é€‰å™¨å±•å¼€ï¼Œè®¾ç½®task-listé«˜åº¦');
                    }
                    // è®¾ç½®task-itemä¸ºç´§å‡‘æ¨¡å¼
                    adjustTaskItemHeight('compact');
                }
            } else {
                // æœªå¯ç”¨æ¨¡å¼åˆ‡æ¢æ—¶ï¼Œä»»åŠ¡åˆ—è¡¨å§‹ç»ˆé“ºæ»¡æ•´ä¸ªåŒºåŸŸ
                console.log('é¡µé¢åŠ è½½ï¼šæ¨¡å¼åˆ‡æ¢å·²ç¦ç”¨ï¼Œä»»åŠ¡åˆ—è¡¨é“ºæ»¡æ•´ä¸ªåŒºåŸŸ');
                // ä»»åŠ¡åˆ—è¡¨é«˜åº¦å·²åœ¨CSSä¸­è®¾ç½®ï¼Œæ— éœ€JavaScriptåŠ¨æ€è°ƒæ•´
            }

            // æ¢å¤åŠŸèƒ½åŒºåŸŸçŠ¶æ€
            const functionCollapsed = localStorage.getItem('functionSectionCollapsed') === 'true';
            if (functionCollapsed) {
                const functionContent = document.getElementById('functionContent');
                const functionIcon = document.getElementById('functionCollapseIcon');
                if (functionContent && functionIcon) {
                    functionContent.classList.add('collapsed');
                    functionIcon.classList.add('collapsed');
                    functionIcon.textContent = 'â–¶';
                }
            }

            // æ¢å¤è®¾ç½®åŒºåŸŸçŠ¶æ€
            const settingsCollapsed = localStorage.getItem('settingsSectionCollapsed') === 'true';
            if (settingsCollapsed) {
                const settingsContent = document.getElementById('settingsContent');
                const settingsIcon = document.getElementById('settingsCollapseIcon');
                if (settingsContent && settingsIcon) {
                    settingsContent.classList.add('collapsed');
                    settingsIcon.classList.add('collapsed');
                    settingsIcon.textContent = 'â–¶';
                }
            }
        }

        // æ‰¹é‡æ¨¡å¼äº‹ä»¶ç»‘å®šå‡½æ•° - Android 14 å…¼å®¹æ€§ä¼˜åŒ–
        function bindBatchModeEvents() {
            const isAndroid = /Android/i.test(navigator.userAgent);
            const androidVersion = isAndroid ? parseFloat((navigator.userAgent.match(/Android ([\d.]+)/) || [])[1]) : 0;
            const needsAndroidOptimization = isAndroid && androidVersion >= 14;

            console.log('ç»‘å®šæ‰¹é‡æ¨¡å¼äº‹ä»¶ï¼ŒAndroid 14ä¼˜åŒ–:', needsAndroidOptimization);

            // è·å–æ‰€æœ‰æ‰¹é‡æ“ä½œæŒ‰é’®
            const batchButtons = document.querySelectorAll('.batch-btn');

            batchButtons.forEach(button => {
                // ç§»é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
                const oldClickHandler = button._batchClickHandler;
                const oldTouchHandler = button._batchTouchHandler;

                if (oldClickHandler) {
                    button.removeEventListener('click', oldClickHandler);
                }
                if (oldTouchHandler) {
                    button.removeEventListener('touchend', oldTouchHandler);
                }

                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å™¨
                button._batchClickHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const actionType = this.getAttribute('onclick') || this.className;
                    console.log('æ‰¹é‡æ“ä½œæŒ‰é’®ç‚¹å‡»:', actionType);

                    // æ·»åŠ è§†è§‰åé¦ˆ
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);

                    // æ‰§è¡Œå¯¹åº”çš„æ“ä½œ
                    if (this.classList.contains('delete-selected-btn')) {
                        deleteSelectedTasks();
                    } else if (this.classList.contains('select-all-btn')) {
                        selectAllTasks();
                    } else if (this.classList.contains('deselect-all-btn')) {
                        deselectAllTasks();
                    } else if (this.classList.contains('toggle-select-btn')) {
                        toggleSelectAllTasks();
                    } else if (this.classList.contains('complete-selected-btn')) {
                        completeSelectedTasks();
                    } else if (this.classList.contains('cancel-batch-btn')) {
                        exitBatchMode();
                    }
                };

                // Android 14 ç‰¹æ®Šè§¦æ‘¸å¤„ç†
                if (needsAndroidOptimization) {
                    button._batchTouchHandler = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        console.log('æ‰¹é‡æ“ä½œæŒ‰é’®touchendäº‹ä»¶');

                        // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ä¸clickäº‹ä»¶å†²çª
                        setTimeout(() => {
                            button._batchClickHandler.call(this, e);
                        }, 50);
                    };

                    // ç»‘å®šè§¦æ‘¸äº‹ä»¶
                    button.addEventListener('touchend', button._batchTouchHandler, { passive: false });

                    // ç¦ç”¨clickäº‹ä»¶é˜²æ­¢é‡å¤è§¦å‘
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }, { passive: false, capture: true });
                } else {
                    // éAndroid 14è®¾å¤‡ä½¿ç”¨æ ‡å‡†clickäº‹ä»¶
                    button.addEventListener('click', button._batchClickHandler, { passive: false });
                }
            });

            console.log('æ‰¹é‡æ¨¡å¼äº‹ä»¶ç»‘å®šå®Œæˆï¼Œå¤„ç†æŒ‰é’®æ•°:', batchButtons.length);
        }

        // æ–°å¢çš„ç­›é€‰å™¨åŠŸèƒ½å‡½æ•°

        // åˆ‡æ¢ç­›é€‰é¢æ¿çš„æ˜¾ç¤º/éšè—
        function toggleFilterPanel() {
            const filterPanel = document.getElementById('filterPanel');
            const filterToggleBtn = document.getElementById('filterToggleBtn');

            if (filterPanel.classList.contains('collapsed')) {
                // æ˜¾ç¤ºç­›é€‰é¢æ¿
                filterPanel.classList.remove('collapsed');
                filterToggleBtn.classList.remove('active');
            } else {
                // éšè—ç­›é€‰é¢æ¿
                filterPanel.classList.add('collapsed');
                filterToggleBtn.classList.add('active');
            }
        }

        // åˆ‡æ¢æ’åºé¡ºåº
        function toggleSortOrder() {
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            const sortOrderIcon = document.getElementById('sortOrderIcon');

            // è·å–å½“å‰æ’åºé¡ºåº
            const currentOrder = getCustomSingleSelectValue('sortOrderFilter') || 'asc';

            // åˆ‡æ¢æ’åºé¡ºåº
            let newOrder;
            if (currentOrder === 'asc') {
                newOrder = 'desc';
                sortOrderBtn.classList.add('desc');
                sortOrderIcon.textContent = 'â†“';
            } else {
                newOrder = 'asc';
                sortOrderBtn.classList.remove('desc');
                sortOrderIcon.textContent = 'â†‘';
            }

            // æ›´æ–°è‡ªå®šä¹‰é€‰æ‹©å™¨çš„å€¼
            customSingleSelectValues['sortOrderFilter'] = newOrder;

            // æ›´æ–°æ˜¾ç¤º
            updateCustomSingleSelectDisplay('sortOrderFilter');
            updateCustomSingleSelectOptions('sortOrderFilter');

            // æ›´æ–°å…¨å±€å˜é‡
            currentSortOrder = newOrder;

            // åº”ç”¨ç­›é€‰ï¼ˆé‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ï¼‰
            applyFilters();
        }

        // æŠ˜å /å±•å¼€ç­›é€‰è¡Œ
        function toggleCollapsibleRows() {
            const collapsibleRows = document.querySelectorAll('.collapsible-row');
            const toggleBtn = document.getElementById('collapseToggleBtn');

            let isAnyCollapsed = false;
            collapsibleRows.forEach(row => {
                if (row.classList.contains('collapsed')) {
                    isAnyCollapsed = true;
                }
            });

            if (isAnyCollapsed) {
                // å±•å¼€æ‰€æœ‰è¡Œ
                collapsibleRows.forEach(row => {
                    row.classList.remove('collapsed');
                });
                toggleBtn.textContent = 'ğŸ“‹ æŠ˜å ç­›é€‰';
                toggleBtn.classList.remove('active');
                // åŒæ­¥æ»šåŠ¨å¤„ç†å™¨çš„çŠ¶æ€å˜é‡
                if (typeof isFilterCollapsed !== 'undefined') {
                    isFilterCollapsed = false;
                }
            } else {
                // æŠ˜å æ‰€æœ‰è¡Œ
                collapsibleRows.forEach(row => {
                    row.classList.add('collapsed');
                });
                toggleBtn.textContent = 'ğŸ“‹ å±•å¼€ç­›é€‰';
                toggleBtn.classList.add('active');
                // åŒæ­¥æ»šåŠ¨å¤„ç†å™¨çš„çŠ¶æ€å˜é‡
                if (typeof isFilterCollapsed !== 'undefined') {
                    isFilterCollapsed = true;
                }
            }
        }

        // å¤„ç†è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å˜åŒ–
        let lastCustomDateValue = '';
        let isDateSelectionInProgress = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨è¿›è¡Œæ—¥æœŸé€‰æ‹©

        // æ‰“å¼€æ—¥æœŸé€‰æ‹©å™¨
        function openDatePicker() {
            console.log('openDatePicker å‡½æ•°è¢«è°ƒç”¨'); // è°ƒè¯•æ—¥å¿—
            const hiddenDateInput = document.getElementById('hiddenDateInput');
            console.log('hiddenDateInput å…ƒç´ :', hiddenDateInput); // è°ƒè¯•æ—¥å¿—
            if (hiddenDateInput) {
                // å…ˆå°è¯•ç°ä»£API
                if (hiddenDateInput.showPicker) {
                    try {
                        hiddenDateInput.showPicker();
                        return;
                    } catch (e) {
                        console.log('showPicker failed:', e);
                    }
                }

                // å¤‡ç”¨æ–¹æ¡ˆï¼šä¸´æ—¶æ˜¾ç¤ºè¾“å…¥æ¡†è®©ç”¨æˆ·ç‚¹å‡»
                hiddenDateInput.style.position = 'fixed';
                hiddenDateInput.style.top = '50%';
                hiddenDateInput.style.left = '50%';
                hiddenDateInput.style.transform = 'translate(-50%, -50%)';
                hiddenDateInput.style.opacity = '0.01'; // å‡ ä¹é€æ˜ä½†å¯ç‚¹å‡»
                hiddenDateInput.style.pointerEvents = 'auto';
                hiddenDateInput.style.zIndex = '10000';
                hiddenDateInput.style.width = '200px';
                hiddenDateInput.style.height = '40px';

                // èšç„¦è¾“å…¥æ¡†
                hiddenDateInput.focus();

                // å°è¯•è§¦å‘ç‚¹å‡»
                setTimeout(() => {
                    hiddenDateInput.click();
                }, 50);

                // æ·»åŠ å¤±ç„¦äº‹ä»¶å¤„ç†ï¼Œå½“ç”¨æˆ·é€‰æ‹©å®Œæ—¥æœŸæˆ–ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—
                const hideInput = () => {
                    hiddenDateInput.style.position = 'absolute';
                    hiddenDateInput.style.left = '-9999px';
                    hiddenDateInput.style.top = 'auto';
                    hiddenDateInput.style.transform = 'none';
                    hiddenDateInput.style.opacity = '0';
                    hiddenDateInput.style.pointerEvents = 'none';
                    hiddenDateInput.style.zIndex = 'auto';
                    hiddenDateInput.style.width = 'auto';
                    hiddenDateInput.style.height = 'auto';
                    hiddenDateInput.removeEventListener('blur', hideInput);
                    hiddenDateInput.removeEventListener('change', hideInput);
                };

                hiddenDateInput.addEventListener('blur', hideInput);
                hiddenDateInput.addEventListener('change', hideInput);

                // 5ç§’åå¼ºåˆ¶éšè—
                setTimeout(hideInput, 5000);
            }
        }

        // æ–°å¢ï¼šå¤„ç†æ—¶é—´èŒƒå›´å˜åŒ–
        function handleDateRangeChange() {
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');

            if (startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
                // æ ‡è®°å·²å®Œæˆæ—¥æœŸé€‰æ‹©
                isDateSelectionInProgress = false;

                // è§¦å‘ç­›é€‰
                applyFilters();
            }
        }

        function handleCustomDateChange() {
            const hiddenDateInput = document.getElementById('hiddenDateInput');
            const customDatePickerDisplay = document.getElementById('customDatePickerDisplay');
            const currentValue = hiddenDateInput ? hiddenDateInput.value : '';

            // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
            if (customDatePickerDisplay) {
                if (currentValue) {
                    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                    const date = new Date(currentValue);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    customDatePickerDisplay.textContent = formattedDate;
                } else {
                    customDatePickerDisplay.textContent = 'é€‰æ‹©æ—¥æœŸ';
                }
            }

            // åªæœ‰å½“å€¼çœŸæ­£å‘ç”Ÿå˜åŒ–ä¸”ä¸ä¸ºç©ºæ—¶æ‰è§¦å‘ç­›é€‰
            if (currentValue && currentValue !== lastCustomDateValue) {
                lastCustomDateValue = currentValue;
                isDateSelectionInProgress = false; // æ ‡è®°æ—¥æœŸé€‰æ‹©å®Œæˆ

                // åœ¨åˆå§‹åŒ–æœŸé—´ä¸è§¦å‘æŸ¥è¯¢ï¼Œé¿å…é‡å¤åŠ è½½
                if (!window.isInitializing) {
                    applyFilters();
                }
            }
        }

        // ç»Ÿä¸€çš„ç­›é€‰åº”ç”¨å‡½æ•°
        async function applyFilters() {
            const keyword = document.getElementById('keywordSearch').value.toLowerCase().trim();
            const dateFilter = getCustomSingleSelectValue('dateFilter');
            const priorityFilter = getCustomSingleSelectValue('priorityFilter');
            const categoryFilter = getCustomSingleSelectValue('categoryFilter');
            const statusFilter = getCustomSelectValues('statusFilter');
            const assigneeFilter = getCustomSelectValues('assigneeFilter');
            const sortBy = getCustomSingleSelectValue('sortFilter');
            const sortOrder = getCustomSingleSelectValue('sortOrderFilter');

            // è·å–è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´å€¼
            let customDate = null;
            let startDate = null;
            let endDate = null;

            if (dateFilter === 'custom') {
                const startDateInput = document.getElementById('startDateInput');
                const endDateInput = document.getElementById('endDateInput');

                if (startDateInput && startDateInput.value) {
                    startDate = startDateInput.value;
                }
                if (endDateInput && endDateInput.value) {
                    endDate = endDateInput.value;
                }
            }

            // æ˜¾ç¤º/éšè—æ—¶é—´èŒƒå›´é€‰æ‹©è¡Œ
            const customDateRangeRow = document.getElementById('customDateRangeRow');
            if (dateFilter === 'custom') {
                if (customDateRangeRow) {
                    customDateRangeRow.classList.add('show');
                }
            } else {
                if (customDateRangeRow) {
                    customDateRangeRow.classList.remove('show');
                }
            }

            // æ„å»ºç­›é€‰æ¡ä»¶å¯¹è±¡
            const filters = {
                keyword: keyword || undefined,
                dateFilter: dateFilter,
                priority: priorityFilter,
                category: categoryFilter,
                status: statusFilter,
                assignee: assigneeFilter,
                sortBy: sortBy === 'createdAt' ? 'created_at' :
                       sortBy === 'deadline' ? 'deadline' :
                       sortBy === 'priority' ? 'priority' :
                       sortBy === 'title' ? 'title' : 'created_at',
                sortOrder: sortOrder,
                customDate: customDate || undefined,
                startDate: startDate || undefined,
                endDate: endDate || undefined
            };

            console.log('åº”ç”¨ç­›é€‰æ¡ä»¶:', filters);

            try {
                // ç›´æ¥ä»æ•°æ®åº“æŸ¥è¯¢å¸¦ç­›é€‰æ¡ä»¶çš„æ•°æ®
                const success = await loadTasksFromAPI(filters);
                if (success) {
                    // å¯¹äºå®Œæˆäººç­›é€‰ï¼Œç”±äºæ•°æ®åº“æŸ¥è¯¢å¯èƒ½ä¸æ”¯æŒJSONBæ•°ç»„ç­›é€‰ï¼Œ
                    // æˆ‘ä»¬åœ¨å‰ç«¯å†åšä¸€æ¬¡ç­›é€‰
                    let filteredTasks = tasks;

                    // å®Œæˆäººç­›é€‰ï¼ˆå‰ç«¯å¤„ç†ï¼‰
                    if (assigneeFilter && assigneeFilter.length > 0 && !assigneeFilter.includes('all')) {
                        filteredTasks = tasks.filter(task => filterByAssignee(task, assigneeFilter));
                    }

                    // æ¸²æŸ“ç»“æœ
                    renderFilteredTasks(filteredTasks);
                    updateFilterStats(filteredTasks);
                } else {
                    console.error('ç­›é€‰æŸ¥è¯¢å¤±è´¥');
                }
            } catch (error) {
                console.error('åº”ç”¨ç­›é€‰æ—¶å‡ºé”™:', error);
                alert('ç­›é€‰å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è·å–å¤šé€‰ä¸‹æ‹‰æ¡†çš„å€¼
        function getMultiSelectValues(selectId) {
            const select = document.getElementById(selectId);
            const values = [];
            if (select && select.selectedOptions) {
                for (let option of select.selectedOptions) {
                    values.push(option.value);
                }
            }
            return values;
        }

        // æ—¥æœŸç­›é€‰é€»è¾‘
        function filterByDate(task, dateFilter, customDate) {
            if (dateFilter === 'all') return true;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskDate = task.deadline ? new Date(task.deadline) : null;

            switch (dateFilter) {
                case 'today':
                    return taskDate && taskDate.toDateString() === today.toDateString();
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return taskDate && taskDate.toDateString() === tomorrow.toDateString();
                case 'week':
                    if (!taskDate) return false;
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    return taskDate >= today && taskDate <= weekEnd;
                case 'overdue':
                    return task.deadline && isTaskOverdue(task.deadline) && !task.completed;
                case 'custom':
                    // æ—¶é—´èŒƒå›´ç­›é€‰
                    const startDateInput = document.getElementById('startDateInput');
                    const endDateInput = document.getElementById('endDateInput');

                    if (!startDateInput || !endDateInput || !startDateInput.value || !endDateInput.value) {
                        return true; // å¦‚æœæ²¡æœ‰è®¾ç½®èŒƒå›´,æ˜¾ç¤ºæ‰€æœ‰
                    }

                    if (!taskDate) return false;

                    // å¼€å§‹æ—¶é—´è®¾ç½®ä¸º0ç‚¹
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);

                    // ç»“æŸæ—¶é—´è®¾ç½®ä¸º23:59:59
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);

                    // ä»»åŠ¡æ—¥æœŸåœ¨èŒƒå›´å†…
                    return taskDate >= startDate && taskDate <= endDate;
                default:
                    return true;
            }
        }

        // çŠ¶æ€ç­›é€‰é€»è¾‘
        function filterByStatus(task, statusFilters) {
            if (statusFilters.includes('all')) return true;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskDate = task.deadline ? new Date(task.deadline) : null;
            const isOverdue = task.deadline && isTaskOverdue(task.deadline) && !task.completed;

            if (statusFilters.includes('overdue') && isOverdue) return true;
            if (statusFilters.includes('completed') && task.completed) return true;
            if (statusFilters.includes('active') && !task.completed) return true; // ä¿®å¤ï¼šæœªå®ŒæˆåŒ…æ‹¬æ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œä¸ç®¡æ˜¯å¦è¿‡æœŸ

            return false;
        }

        // å®Œæˆäººç­›é€‰é€»è¾‘
        function filterByAssignee(task, assigneeFilters) {
            if (assigneeFilters.includes('all')) return true;

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†"æœªæŒ‡å®š"é€‰é¡¹
            const hasUnassignedFilter = assigneeFilters.includes('unassigned');

            // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºæœªæŒ‡å®šæ‰§è¡Œäºº
            const isTaskUnassigned = (!task.assignees || task.assignees.length === 0) &&
                                     (!task.assignee || task.assignee === '');

            // å¦‚æœé€‰æ‹©äº†"æœªæŒ‡å®š"ä¸”ä»»åŠ¡ç¡®å®æœªæŒ‡å®šæ‰§è¡Œäººï¼Œåˆ™è¿”å›true
            if (hasUnassignedFilter && isTaskUnassigned) {
                return true;
            }

            // å¦‚æœåªé€‰æ‹©äº†"æœªæŒ‡å®š"ä½†ä»»åŠ¡æœ‰æ‰§è¡Œäººï¼Œåˆ™è¿”å›false
            if (assigneeFilters.length === 1 && hasUnassignedFilter && !isTaskUnassigned) {
                return false;
            }

            // æ”¯æŒå¤šå®Œæˆäººç­›é€‰
            if (task.assignees && Array.isArray(task.assignees)) {
                return task.assignees.some(assignee => assigneeFilters.includes(assignee));
            }

            // å‘åå…¼å®¹å•ä¸ªå®Œæˆäºº
            const taskAssignee = task.assignee || '';
            return assigneeFilters.includes(taskAssignee);
        }

        // ä»»åŠ¡æ’åº
        function sortTasks(tasks, sortBy, sortOrder) {
            return tasks.sort((a, b) => {
                let comparison = 0;

                switch (sortBy) {
                    case 'deadline':
                        const dateA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
                        const dateB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
                        comparison = dateA - dateB;
                        break;
                    case 'priority':
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        comparison = (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                        break;
                    case 'created':
                        comparison = new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                        break;
                    case 'category':
                        comparison = (a.category || '').localeCompare(b.category || '');
                        break;
                    default:
                        return 0;
                }

                return sortOrder === 'desc' ? -comparison : comparison;
            });
        }

        // æ¸²æŸ“ç­›é€‰åçš„ä»»åŠ¡
        function renderFilteredTasks(filteredTasks, preserveScrollPosition = false) {
            // ç›´æ¥æ¸²æŸ“ä»»åŠ¡ï¼Œé¿å…é€’å½’è°ƒç”¨
            const taskList = document.getElementById('taskList');

            if (!taskList) {
                console.error('æœªæ‰¾åˆ°taskListå…ƒç´ ');
                return;
            }

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆåªåœ¨éœ€è¦æ—¶ï¼‰
            const scrollTop = preserveScrollPosition ? (window.pageYOffset || document.documentElement.scrollTop) : 0;

            // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰ä»»åŠ¡
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <div>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡</div>
                    </div>
                `;
            } else {
                // å¤ç”¨åŸå§‹renderTasksçš„HTMLç”Ÿæˆé€»è¾‘
                const isBatchMode = document.body.classList.contains('batch-mode');

                // ä¸ºä»»åŠ¡åˆ—è¡¨æ·»åŠ æ‰¹é‡æ¨¡å¼ç±»
                const taskListElement = document.getElementById('taskList');
                if (isBatchMode) {
                    taskListElement.classList.add('batch-mode');
                } else {
                    taskListElement.classList.remove('batch-mode');
                }

                taskList.innerHTML = filteredTasks.map(task => {
                    const isOverdue = task.deadline && isTaskOverdue(task.deadline) && !task.completed;
                    const isSelected = selectedTasks.has(task.id);

                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ“ä½œæ­¤ä»»åŠ¡ï¼ˆæƒé™æ§åˆ¶ï¼‰
                    let canOperate = true;
                    if (personalInfo.enableRoleRestriction && personalInfo.myAssignee) {
                        if (task.assignees && Array.isArray(task.assignees)) {
                            canOperate = task.assignees.length === 0 || task.assignees.includes(personalInfo.myAssignee);
                        } else {
                            canOperate = !task.assignee || task.assignee === personalInfo.myAssignee;
                        }
                    }

                    const buttonDisabled = !canOperate;
                    const buttonTitle = buttonDisabled ?
                        `æ­¤ä»»åŠ¡åˆ†é…ç»™"${task.assignee}"ï¼Œæ‚¨æ— æ³•æ“ä½œ` :
                        (task.completed ? 'æ ‡è®°ä¸ºæœªå®Œæˆ' : 'æ ‡è®°ä¸ºå®Œæˆ');

                    return `
                        <div class="task-item ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''} ${isSelected ? 'selected' : ''} ${buttonDisabled ? 'not-operable' : ''}" data-id="${task.id}">
                            ${isBatchMode ? `<input type="checkbox" class="batch-checkbox" data-task-id="${task.id}" ${isSelected ? 'checked' : ''} ${buttonDisabled ? 'disabled title="æ— æƒé™æ“ä½œæ­¤ä»»åŠ¡"' : ''}>` : ''}
                            <button class="task-complete-btn ${task.completed ? 'completed' : ''} ${buttonDisabled ? 'disabled' : ''}"
                                    data-task-id="${task.id}"
                                    title="${buttonTitle}"
                                    ${buttonDisabled ? 'disabled' : ''}>
                                ${task.completed ? 'âœ…' : 'â­•'}
                            </button>
                            <div class="task-content" onclick="event.stopPropagation(); viewTaskDetail('${task.id}');" style="cursor: pointer;">
                                <div class="task-title">
                                    ${isOverdue ? '<span class="overdue-badge">è¶…æ—¶</span>' : ''}
                                    ${escapeHtml(task.title || task.text || 'æ— æ ‡é¢˜')}
                                </div>
                                <div class="task-meta">
                                    <span class="task-category category-${task.category}">${getCategoryName(task.category)}</span>
                                    <span class="task-priority priority-${task.priority}">${getPriorityName(task.priority)}</span>
                                    ${task.deadline ? `<span class="task-deadline ${isOverdue ? 'overdue' : ''}">${formatDeadline(task.deadline)}</span>` : ''}
                                    ${task.assignees && task.assignees.length > 0 ? `<span class="task-assignee">ğŸ‘¤ ${task.assignees.join(', ')}</span>` : task.assignee ? `<span class="task-assignee">ğŸ‘¤ ${task.assignee}</span>` : ''}
                                </div>
                                <div class="task-time-info">
                                    <span class="task-created">åˆ›å»ºäº ${task.createdAt ? formatRelativeTime(task.createdAt) : 'æœªçŸ¥æ—¶é—´'}</span>
                                    ${task.completed ? `<span class="task-completed">å®Œæˆäº ${task.completedAt ? formatRelativeTime(task.completedAt) : 'æœªçŸ¥æ—¶é—´'}</span>` : ''}
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="edit-btn ${buttonDisabled ? 'disabled' : ''}" data-task-id="${task.id}" title="${buttonDisabled ? 'æ— æƒé™æ“ä½œæ­¤ä»»åŠ¡' : 'ç¼–è¾‘ä»»åŠ¡'}" ${buttonDisabled ? 'disabled' : ''}>
                                    <span class="emoji-icon">âœï¸</span>
                                </button>
                                <button class="delete-btn ${buttonDisabled ? 'disabled' : ''}" data-task-id="${task.id}" title="${buttonDisabled ? 'æ— æƒé™æ“ä½œæ­¤ä»»åŠ¡' : 'åˆ é™¤ä»»åŠ¡'}" ${buttonDisabled ? 'disabled' : ''}>
                                    <span class="emoji-icon">ğŸ—‘ï¸</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindTaskEvents();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateFilterStats(filteredTasks);

            // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆåªåœ¨éœ€è¦æ—¶ï¼‰
            if (preserveScrollPosition && scrollTop > 0) {
                setTimeout(() => {
                    window.scrollTo(0, scrollTop);
                }, 10);
            }
        }

        // æ›´æ–°ç­›é€‰ç»Ÿè®¡ä¿¡æ¯
        function updateFilterStats(filteredTasks) {
            const totalElement = document.getElementById('totalTasks');
            const completedElement = document.getElementById('completedTasks');
            const rateElement = document.getElementById('completionRate');

            if (totalElement) totalElement.textContent = filteredTasks.length;

            const completedCount = filteredTasks.filter(t => t.completed).length;
            if (completedElement) completedElement.textContent = completedCount;

            const completionRate = filteredTasks.length > 0 ? Math.round((completedCount / filteredTasks.length) * 100) : 0;
            if (rateElement) rateElement.textContent = completionRate + '%';
        }

        // æ¸…é™¤æ‰€æœ‰ç­›é€‰
        function clearAllFilters() {
            const keywordSearch = document.getElementById('keywordSearch');
            if (keywordSearch) keywordSearch.value = '';

            // é‡ç½®æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
            const customDateRangeRow = document.getElementById('customDateRangeRow');
            if (customDateRangeRow) {
                customDateRangeRow.classList.remove('show');
                const startDateInput = document.getElementById('startDateInput');
                const endDateInput = document.getElementById('endDateInput');
                if (startDateInput) startDateInput.value = '';
                if (endDateInput) endDateInput.value = '';
            }
            isDateSelectionInProgress = false; // é‡ç½®æ—¥æœŸé€‰æ‹©çŠ¶æ€æ ‡å¿—

            // é‡ç½®è‡ªå®šä¹‰å•é€‰é€‰æ‹©å™¨
            customSingleSelectValues.dateFilter = 'today';
            customSingleSelectValues.priorityFilter = 'all';
            customSingleSelectValues.categoryFilter = 'all';
            customSingleSelectValues.sortFilter = 'deadline';
            customSingleSelectValues.sortOrderFilter = 'asc';

            // é‡ç½®è‡ªå®šä¹‰å¤šé€‰é€‰æ‹©å™¨ï¼ˆé»˜è®¤ç­›é€‰æœªå®Œæˆä»»åŠ¡ï¼‰
            customSelectValues.statusFilter = ['pending'];
            // å¦‚æœé…ç½®äº†ä¸ªäººä¿¡æ¯ï¼Œé»˜è®¤ç­›é€‰æœ¬äººä»»åŠ¡ï¼Œå¦åˆ™æ˜¾ç¤ºæ‰€æœ‰äºº
            if (personalInfo.myAssignee) {
                customSelectValues.assigneeFilter = [personalInfo.myAssignee];
            } else {
                customSelectValues.assigneeFilter = ['all'];
            }

            // æ›´æ–°è‡ªå®šä¹‰å•é€‰é€‰æ‹©å™¨æ˜¾ç¤º
            updateCustomSingleSelectDisplay('dateFilter');
            updateCustomSingleSelectDisplay('priorityFilter');
            updateCustomSingleSelectDisplay('categoryFilter');
            updateCustomSingleSelectDisplay('sortFilter');
            updateCustomSingleSelectDisplay('sortOrderFilter');

            // æ›´æ–°è‡ªå®šä¹‰å¤šé€‰é€‰æ‹©å™¨æ˜¾ç¤º
            updateCustomSelectDisplay('statusFilter');
            updateCustomSelectDisplay('assigneeFilter');
            updateCustomSelectTags('statusFilter');
            updateCustomSelectTags('assigneeFilter');

            // æ›´æ–°è‡ªå®šä¹‰å•é€‰é€‰æ‹©å™¨é€‰é¡¹çŠ¶æ€
            updateCustomSingleSelectOptions('dateFilter');
            updateCustomSingleSelectOptions('priorityFilter');
            updateCustomSingleSelectOptions('categoryFilter');
            updateCustomSingleSelectOptions('sortFilter');
            updateCustomSingleSelectOptions('sortOrderFilter');

            // æ›´æ–°è‡ªå®šä¹‰å¤šé€‰é€‰æ‹©å™¨å¤é€‰æ¡†çŠ¶æ€
            updateCustomSelectCheckboxes('statusFilter');
            updateCustomSelectCheckboxes('assigneeFilter');

            // éšè—è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©åŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const customDateGroup = document.getElementById('customDateGroup');
            if (customDateGroup) {
                customDateGroup.style.display = 'none';
            }

            // åº”ç”¨é»˜è®¤ç­›é€‰ï¼ˆä»Šæ—¥ä»»åŠ¡ï¼‰
            applyFilters();
        }

        // é‡ç½®å¤šé€‰ä¸‹æ‹‰æ¡†
        function resetMultiSelect(selectId, defaultValues) {
            const select = document.getElementById(selectId);
            for (let option of select.options) {
                option.selected = defaultValues.includes(option.value);
            }
        }

        // åŠ¨æ€æ›´æ–°å®Œæˆäººé€‰é¡¹
        function updateAssigneeFilterOptions() {
            const assigneeDropdown = document.getElementById('assigneeFilterDropdown');
            // ä½¿ç”¨é…ç½®çš„å®Œæˆäººåˆ—è¡¨ï¼Œè€Œä¸æ˜¯ä»ä»»åŠ¡ä¸­æå–
            const configuredAssignees = assignees.map(assignee =>
                typeof assignee === 'string' ? assignee : assignee.name
            );

            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const selectedValues = customSelectValues.assigneeFilter || ['all'];

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†"æ‰€æœ‰äºº"å’Œ"æœªæŒ‡å®š"ï¼‰
            assigneeDropdown.innerHTML = `
                <div class="custom-select-option" data-value="all">
                    <input type="checkbox" class="custom-select-checkbox" ${selectedValues.includes('all') ? 'checked' : ''}>
                    <span>æ‰€æœ‰äºº</span>
                </div>
                <div class="custom-select-option" data-value="unassigned">
                    <input type="checkbox" class="custom-select-checkbox" ${selectedValues.includes('unassigned') ? 'checked' : ''}>
                    <span>æœªæŒ‡å®š</span>
                </div>
            `;

            // æ·»åŠ é…ç½®çš„å®Œæˆäººé€‰é¡¹
            configuredAssignees.forEach(assignee => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'custom-select-option';
                optionDiv.dataset.value = assignee;
                optionDiv.innerHTML = `
                    <input type="checkbox" class="custom-select-checkbox" ${selectedValues.includes(assignee) ? 'checked' : ''}>
                    <span>${assignee}</span>
                `;
                assigneeDropdown.appendChild(optionDiv);
            });

            // é‡æ–°ç»‘å®šé€‰é¡¹çš„äº‹ä»¶ç›‘å¬å™¨
            assigneeDropdown.querySelectorAll('.custom-select-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleCustomSelectOption('assigneeFilter', this);
                });
            });

            // æ›´æ–°é€‰ä¸­çŠ¶æ€å’Œæ˜¾ç¤º
            updateCustomSelectCheckboxes('assigneeFilter');
            updateCustomSelectDisplay('assigneeFilter');
            updateCustomSelectTags('assigneeFilter');
        }

        // åœ¨ä»»åŠ¡åŠ è½½æˆ–æ›´æ–°æ—¶è°ƒç”¨
        function initializeFilters() {
            updateAssigneeFilterOptions();

            // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•å®Œæˆäººï¼Œé»˜è®¤é€‰ä¸­"æ‰€æœ‰äºº"
            const assigneeFilter = document.getElementById('assigneeFilter');
            if (assigneeFilter && assigneeFilter.selectedOptions && assigneeFilter.selectedOptions.length === 0) {
                assigneeFilter.options[0].selected = true;
            }
        }

        // ä¿®æ”¹æ‰¹é‡æ¨¡å¼æŒ‰é’®çŠ¶æ€
        function updateBatchModeButton() {
            // æ‰¹é‡æ¨¡å¼æŒ‰é’®å·²è¢«åˆ é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä»¥å…¼å®¹æ—§ä»£ç 
            // ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            return;
        }

        // æ›´æ–°å¤šé€‰ä¸‹æ‹‰æ¡†çš„UIçŠ¶æ€
        function updateMultiSelectUI(selectElement) {
            if (!selectElement || !selectElement.selectedOptions) {
                return;
            }
            const selectedOptions = Array.from(selectElement.selectedOptions);
            const totalOptions = selectElement.options.length;
            const selectId = selectElement.id;
            const countElement = document.getElementById(selectId + 'Count');

            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            selectElement.classList.remove('all-selected', 'partial-selected');

            // è¿‡æ»¤æ‰"å…¨éƒ¨"é€‰é¡¹æ¥è®¡ç®—å®é™…é€‰ä¸­æ•°é‡
            const nonAllOptions = selectedOptions.filter(option => option.value !== 'all');
            const actualSelectedCount = nonAllOptions.length;

            // æ›´æ–°æ•°é‡æ˜¾ç¤º
            if (countElement) {
                if (actualSelectedCount > 1) {
                    countElement.textContent = actualSelectedCount;
                    countElement.classList.add('show');
                } else {
                    countElement.classList.remove('show');
                }
            }

            // æ›´æ–°é€‰æ‹©æ¡†æ ·å¼
            if (selectedOptions.some(option => option.value === 'all')) {
                // é€‰ä¸­äº†"å…¨éƒ¨"
                selectElement.classList.add('all-selected');
            } else if (actualSelectedCount > 0) {
                // éƒ¨åˆ†é€‰ä¸­
                selectElement.classList.add('partial-selected');
            }

            // å¤„ç†"å…¨éƒ¨"é€‰é¡¹çš„é€»è¾‘
            const allOption = selectElement.querySelector('option[value="all"]');
            if (allOption) {
                if (allOption.selected && actualSelectedCount > 0) {
                    // å¦‚æœåŒæ—¶é€‰ä¸­äº†"å…¨éƒ¨"å’Œå…¶ä»–é€‰é¡¹ï¼Œå–æ¶ˆå…¶ä»–é€‰é¡¹
                    Array.from(selectElement.options).forEach(option => {
                        if (option.value !== 'all') {
                            option.selected = false;
                        }
                    });
                } else if (!allOption.selected && actualSelectedCount === 0) {
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•é€‰é¡¹ï¼Œè‡ªåŠ¨é€‰ä¸­"å…¨éƒ¨"
                    allOption.selected = true;
                }
            }
        }

        // åˆå§‹åŒ–å¤šé€‰UIçŠ¶æ€
        function initializeMultiSelectUI() {
            const multiSelects = document.querySelectorAll('select[multiple].filter-select');
            multiSelects.forEach(select => {
                updateMultiSelectUI(select);
            });
        }

        // åˆå§‹åŒ–å®Œæˆäººä¸‹æ‹‰æ¡† - ä¿®å¤ç¼ºå¤±çš„å‡½æ•°
        function initializeAssigneeDropdown(type) {
            const optionsContainer = document.getElementById(`${type}TaskAssigneeOptions`);
            const displayElement = document.getElementById(`${type}TaskAssigneeDisplay`);

            if (!optionsContainer || !displayElement) {
                console.warn(`initializeAssigneeDropdown: æ‰¾ä¸åˆ°${type}çš„ä¸‹æ‹‰æ¡†å…ƒç´ `);
                return;
            }

            // ç¡®ä¿selectedAssignees[type]å·²åˆå§‹åŒ–
            if (!selectedAssignees[type]) {
                selectedAssignees[type] = [];
            }

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            optionsContainer.innerHTML = '';

            // ä½¿ç”¨é…ç½®çš„å®Œæˆäººåˆ—è¡¨
            const allAssignees = assignees.map(assignee =>
                typeof assignee === 'string' ? assignee : assignee.name
            );

            // ä¸ºæ¯ä¸ªå®Œæˆäººåˆ›å»ºé€‰é¡¹
            allAssignees.forEach(assigneeName => {
                // æ£€æŸ¥æ˜¯å¦å·²è¢«é€‰ä¸­
                const isSelected = selectedAssignees[type].includes(assigneeName);

                const optionDiv = document.createElement('div');
                optionDiv.className = 'assignee-option';
                optionDiv.innerHTML = `
                    <input type="checkbox" id="${type}_${assigneeName}" value="${assigneeName}" ${isSelected ? 'checked' : ''} onchange="updateAssigneeSelection('${type}')">
                    <label for="${type}_${assigneeName}">${assigneeName}</label>
                `;

                optionsContainer.appendChild(optionDiv);
            });

            // æ›´æ–°æ˜¾ç¤º
            updateAssigneeDisplay(type);
        }

        // æ›´æ–°å®Œæˆäººé€‰æ‹©çŠ¶æ€
        function updateAssigneeSelection(type) {
            const optionsContainer = document.getElementById(`${type}TaskAssigneeOptions`);
            if (!optionsContainer) return;

            const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            selectedAssignees[type] = Array.from(checkboxes).map(cb => cb.value);

            updateAssigneeDisplay(type);
        }

        // ========== è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨åŠŸèƒ½ ==========

        // å­˜å‚¨è‡ªå®šä¹‰é€‰æ‹©å™¨çš„é€‰ä¸­å€¼
        let customSelectValues = {
            statusFilter: ['pending'],  // é»˜è®¤ç­›é€‰æœªå®Œæˆä»»åŠ¡
            assigneeFilter: ['all']
        };

        // è‡ªå®šä¹‰å•é€‰ç­›é€‰å™¨ç›¸å…³å˜é‡
        let customSingleSelectValues = {
            dateFilter: 'today',
            priorityFilter: 'all',
            categoryFilter: 'all',
            sortFilter: 'deadline',
            sortOrderFilter: 'asc',
            addTaskPriority: 'medium',
            addTaskCategory: 'work',
            editPriority: 'high',
            editCategory: 'work',
            syncIntervalSelect: '5',
            myAssigneeSelect: ''
        };

        // åˆ‡æ¢è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨
        function toggleCustomSelect(selectId) {
            console.log('toggleCustomSelect è°ƒç”¨:', selectId); // è°ƒè¯•æ—¥å¿—
            const dropdown = document.getElementById(selectId + 'Dropdown');
            console.log('æ‰¾åˆ°ä¸‹æ‹‰æ¡†:', dropdown); // è°ƒè¯•æ—¥å¿—

            if (!dropdown) {
                console.error('æœªæ‰¾åˆ°ä¸‹æ‹‰æ¡†:', selectId + 'Dropdown');
                return;
            }

            const trigger = dropdown.previousElementSibling;
            console.log('æ‰¾åˆ°è§¦å‘å™¨:', trigger); // è°ƒè¯•æ—¥å¿—

            // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.custom-select-dropdown.active').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('active');
                    d.previousElementSibling.classList.remove('active');
                }
            });

            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†
            const wasActive = dropdown.classList.contains('active');
            dropdown.classList.toggle('active');
            trigger.classList.toggle('active');

            console.log('ä¸‹æ‹‰æ¡†çŠ¶æ€ä»', wasActive, 'å˜ä¸º', dropdown.classList.contains('active')); // è°ƒè¯•æ—¥å¿—
        }

        // å¤„ç†è‡ªå®šä¹‰é€‰æ‹©å™¨é€‰é¡¹ç‚¹å‡»
        function handleCustomSelectOption(selectId, optionElement) {
            const checkbox = optionElement.querySelector('.custom-select-checkbox');
            const value = optionElement.dataset.value;

            // åˆ‡æ¢å¤é€‰æ¡†çŠ¶æ€
            checkbox.checked = !checkbox.checked;

            // æ›´æ–°é€‰ä¸­å€¼æ•°ç»„
            if (checkbox.checked) {
                if (value === 'all') {
                    // é€‰ä¸­"å…¨éƒ¨"æ—¶ï¼Œå–æ¶ˆå…¶ä»–æ‰€æœ‰é€‰é¡¹
                    customSelectValues[selectId] = ['all'];
                    updateCustomSelectCheckboxes(selectId);
                } else {
                    // é€‰ä¸­å…·ä½“é€‰é¡¹æ—¶ï¼Œå–æ¶ˆ"å…¨éƒ¨"
                    customSelectValues[selectId] = customSelectValues[selectId].filter(v => v !== 'all');
                    if (!customSelectValues[selectId].includes(value)) {
                        customSelectValues[selectId].push(value);
                    }
                }
            } else {
                // å–æ¶ˆé€‰ä¸­
                customSelectValues[selectId] = customSelectValues[selectId].filter(v => v !== value);

                // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹ï¼Œè‡ªåŠ¨é€‰ä¸­"å…¨éƒ¨"
                if (customSelectValues[selectId].length === 0) {
                    customSelectValues[selectId] = ['all'];
                    updateCustomSelectCheckboxes(selectId);
                }
            }

            // æ›´æ–°æ˜¾ç¤º
            updateCustomSelectDisplay(selectId);
            updateCustomSelectTags(selectId);

            // åº”ç”¨ç­›é€‰ï¼ˆåœ¨åˆå§‹åŒ–æœŸé—´ä¸è§¦å‘æŸ¥è¯¢ï¼Œé¿å…é‡å¤åŠ è½½ï¼‰
            if (!window.isInitializing) {
                applyFilters();
            }
        }

        // æ›´æ–°è‡ªå®šä¹‰é€‰æ‹©å™¨çš„å¤é€‰æ¡†çŠ¶æ€
        function updateCustomSelectCheckboxes(selectId) {
            const dropdown = document.getElementById(selectId + 'Dropdown');
            const options = dropdown.querySelectorAll('.custom-select-option');

            options.forEach(option => {
                const checkbox = option.querySelector('.custom-select-checkbox');
                const value = option.dataset.value;
                checkbox.checked = customSelectValues[selectId].includes(value);

                // æ›´æ–°é€‰é¡¹æ ·å¼
                if (checkbox.checked) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // æ›´æ–°è‡ªå®šä¹‰é€‰æ‹©å™¨çš„æ˜¾ç¤ºæ–‡æœ¬
        function updateCustomSelectDisplay(selectId) {
            const display = document.getElementById(selectId + 'Display');
            const values = customSelectValues[selectId];

            if (values.includes('all')) {
                if (selectId === 'statusFilter') {
                    display.textContent = 'å…¨éƒ¨';
                } else {
                    display.textContent = 'æ‰€æœ‰äºº';
                }
            } else if (values.length === 1) {
                // å•ä¸ªé€‰æ‹©æ˜¾ç¤ºå…·ä½“æ–‡æœ¬
                const option = document.querySelector(`#${selectId}Dropdown [data-value="${values[0]}"]`);
                if (option) {
                    display.textContent = option.querySelector('span').textContent;
                }
            } else {
                // å¤šä¸ªé€‰æ‹©æ˜¾ç¤ºæ•°é‡
                display.textContent = `å·²é€‰æ‹© ${values.length} é¡¹`;
            }
        }

        // æ›´æ–°è‡ªå®šä¹‰é€‰æ‹©å™¨çš„æ ‡ç­¾æ˜¾ç¤º
        function updateCustomSelectTags(selectId) {
            const tagsContainer = document.getElementById(selectId + 'Tags');
            const values = customSelectValues[selectId];

            tagsContainer.innerHTML = '';

            if (values.includes('all')) {
                // é€‰æ‹©å…¨éƒ¨æ—¶ä¸æ˜¾ç¤ºæ ‡ç­¾
                return;
            }

            if (values.length > 1) {
                values.forEach(value => {
                    const option = document.querySelector(`#${selectId}Dropdown [data-value="${value}"]`);
                    if (option) {
                        const tag = document.createElement('span');
                        tag.className = 'selected-tag';

                        // ä¸ºçŠ¶æ€æ·»åŠ ç‰¹æ®Šé¢œè‰²
                        if (selectId === 'statusFilter') {
                            tag.classList.add(`status-tag-${value}`);
                        } else {
                            tag.classList.add('assignee-tag');
                        }

                        tag.textContent = option.querySelector('span').textContent;
                        tagsContainer.appendChild(tag);
                    }
                });
            }
        }

        // åˆå§‹åŒ–è‡ªå®šä¹‰é€‰æ‹©å™¨
        function initializeCustomSelects() {
            // ä¸ºæ‰€æœ‰è§¦å‘å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
                trigger.addEventListener('click', function(e) {
                    const selectId = this.dataset.selectId;
                    console.log('è§¦å‘å™¨ç‚¹å‡»:', selectId); // è°ƒè¯•æ—¥å¿—

                    // åªåœ¨è‡ªå®šä¹‰é€‰æ‹©å™¨å†…éƒ¨åœæ­¢ä¼ æ’­ï¼Œä¸å½±å“å…¶ä»–å…ƒç´ 
                    e.stopPropagation();

                    // åˆ¤æ–­æ˜¯å¤šé€‰è¿˜æ˜¯å•é€‰
                    if (this.closest('.custom-single-select')) {
                        toggleCustomSingleSelect(selectId);
                    } else {
                        toggleCustomSelect(selectId);
                    }
                });
            });

            // ä¸ºæ‰€æœ‰é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.custom-select-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    // åªåœ¨è‡ªå®šä¹‰é€‰æ‹©å™¨å†…éƒ¨åœæ­¢ä¼ æ’­ï¼Œä¸å½±å“å…¶ä»–å…ƒç´ 
                    e.stopPropagation();
                    const selectId = this.closest('.custom-select-dropdown').id.replace('Dropdown', '');

                    // åˆ¤æ–­æ˜¯å¤šé€‰è¿˜æ˜¯å•é€‰
                    if (this.closest('.custom-single-select')) {
                        handleCustomSingleSelectOption(selectId, this);
                    } else {
                        handleCustomSelectOption(selectId, this);
                    }
                });
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡† - ç¡®ä¿ä¸å¹²æ‰°æ¨¡æ€æ¡†äº‹ä»¶
            document.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ ï¼Œä¸å¤„ç†ä¸‹æ‹‰æ¡†å…³é—­
                if (e.target.closest('.modal') ||
                    e.target.closest('.close-btn') ||
                    e.target.classList.contains('close-btn') ||
                    e.target.closest('[id*="cancel"]') ||
                    e.target.closest('[id*="close"]') ||
                    e.target.closest('[id*="Modal"]') ||
                    e.target.closest('.modal-content') ||
                    e.target.closest('.modal-header') ||
                    e.target.closest('.modal-footer') ||
                    e.target.id.includes('cancel') ||
                    e.target.id.includes('close') ||
                    e.target.id.includes('Cancel') ||
                    e.target.id.includes('Close')) {
                    return;
                }

                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨ï¼Œå…³é—­æ‰€æœ‰ä¸‹æ‹‰æ¡†
                if (!e.target.closest('.custom-select')) {
                    document.querySelectorAll('.custom-select-dropdown.active').forEach(dropdown => {
                        dropdown.classList.remove('active');
                        dropdown.previousElementSibling.classList.remove('active');
                    });
                }
            });

            // åˆå§‹åŒ–å¤šé€‰æ˜¾ç¤º
            updateCustomSelectDisplay('statusFilter');
            updateCustomSelectDisplay('assigneeFilter');

            // åˆå§‹åŒ–å•é€‰æ˜¾ç¤º
            updateCustomSingleSelectDisplay('dateFilter');
            updateCustomSingleSelectDisplay('priorityFilter');
            updateCustomSingleSelectDisplay('categoryFilter');
            updateCustomSingleSelectDisplay('sortFilter');
            updateCustomSingleSelectDisplay('sortOrderFilter');
            updateCustomSingleSelectDisplay('addTaskPriority');
            updateCustomSingleSelectDisplay('addTaskCategory');
            updateCustomSingleSelectDisplay('editPriority');
            updateCustomSingleSelectDisplay('editCategory');
            updateCustomSingleSelectDisplay('syncIntervalSelect');
            updateCustomSingleSelectDisplay('myAssigneeSelect');

            // åˆå§‹åŒ–å•é€‰é€‰é¡¹çŠ¶æ€
            updateCustomSingleSelectOptions('dateFilter');
            updateCustomSingleSelectOptions('priorityFilter');
            updateCustomSingleSelectOptions('categoryFilter');
            updateCustomSingleSelectOptions('sortFilter');
            updateCustomSingleSelectOptions('sortOrderFilter');
            updateCustomSingleSelectOptions('addTaskPriority');
            updateCustomSingleSelectOptions('addTaskCategory');
            updateCustomSingleSelectOptions('editPriority');
            updateCustomSingleSelectOptions('editCategory');
            updateCustomSingleSelectOptions('syncIntervalSelect');
            updateCustomSingleSelectOptions('myAssigneeSelect');
        }

        // ========== è‡ªå®šä¹‰å•é€‰ä¸‹æ‹‰é€‰æ‹©å™¨åŠŸèƒ½ ==========

        // åˆ‡æ¢å•é€‰è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
        function toggleCustomSingleSelect(selectId) {
            const dropdown = document.getElementById(selectId + 'Dropdown');
            const trigger = document.querySelector(`[data-select-id="${selectId}"]`);

            if (!dropdown || !trigger) return;

            // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.custom-select-dropdown.active, .custom-single-select .custom-select-dropdown.active').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('active');
                    d.previousElementSibling.classList.remove('active');
                }
            });

            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†
            dropdown.classList.toggle('active');
            trigger.classList.toggle('active');
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºç­›é€‰åŒºåŸŸçš„é€‰æ‹©æ¡†
        function isFilterSelectBox(selectId) {
            // ç­›é€‰åŒºåŸŸçš„é€‰æ‹©æ¡†IDåˆ—è¡¨
            const filterSelectIds = [
                'dateFilter',           // æ—¥æœŸç­›é€‰
                'priorityFilter',       // ä¼˜å…ˆçº§ç­›é€‰
                'categoryFilter',       // åˆ†ç±»ç­›é€‰
                'statusFilter',         // çŠ¶æ€ç­›é€‰
                'assigneeFilter',       // å®Œæˆäººç­›é€‰
                'sortFilter',           // æ’åºæ–¹å¼ (ä¿®æ­£ID)
                'sortOrderFilter'       // æ’åºé¡ºåº
            ];

            return filterSelectIds.includes(selectId);
        }

        // å¤„ç†å•é€‰é€‰é¡¹ç‚¹å‡»
        function handleCustomSingleSelectOption(selectId, optionElement) {
            const value = optionElement.dataset.value;
            const display = optionElement.querySelector('span').textContent;

            // æ›´æ–°é€‰ä¸­å€¼
            customSingleSelectValues[selectId] = value;

            // æ›´æ–°æ˜¾ç¤º
            updateCustomSingleSelectDisplay(selectId);
            updateCustomSingleSelectOptions(selectId);

            // å…³é—­ä¸‹æ‹‰æ¡†
            const dropdown = document.getElementById(selectId + 'Dropdown');
            const trigger = document.querySelector(`[data-select-id="${selectId}"]`);
            if (dropdown && trigger) {
                dropdown.classList.remove('active');
                trigger.classList.remove('active');
            }

            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯æ—¥æœŸç­›é€‰
            if (selectId === 'dateFilter') {
                const customDateRangeRow = document.getElementById('customDateRangeRow');
                if (value === 'custom') {
                    isDateSelectionInProgress = true; // æ ‡è®°å¼€å§‹æ—¥æœŸé€‰æ‹©è¿‡ç¨‹

                    // æ˜¾ç¤ºæ—¶é—´èŒƒå›´é€‰æ‹©è¡Œ
                    if (customDateRangeRow) {
                        customDateRangeRow.classList.add('show');
                        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºä»Šå¤©å’Œæ˜å¤©
                        const today = new Date();
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);

                        const startDateInput = document.getElementById('startDateInput');
                        const endDateInput = document.getElementById('endDateInput');

                        if (startDateInput && !startDateInput.value) {
                            startDateInput.value = today.toISOString().split('T')[0];
                        }
                        if (endDateInput && !endDateInput.value) {
                            endDateInput.value = tomorrow.toISOString().split('T')[0];
                        }
                    }

                    // ä¸ç«‹å³è§¦å‘ç­›é€‰ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©å…·ä½“æ—¥æœŸ
                    return;
                } else {
                    // é€‰æ‹©å…¶ä»–æ—¥æœŸé€‰é¡¹æ—¶éšè—æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
                    if (customDateRangeRow) {
                        customDateRangeRow.classList.remove('show');
                    }
                    isDateSelectionInProgress = false; // é‡ç½®çŠ¶æ€
                }
            }

            // åªæœ‰ç­›é€‰åŒºåŸŸçš„é€‰æ‹©æ¡†æ‰è§¦å‘ç­›é€‰æ›´æ–°
            // åœ¨åˆå§‹åŒ–æœŸé—´ä¸è§¦å‘æŸ¥è¯¢ï¼Œé¿å…é‡å¤åŠ è½½
            if (isFilterSelectBox(selectId) && !window.isInitializing) {
                applyFilters();
            }
        }

        // æ›´æ–°å•é€‰é€‰æ‹©å™¨æ˜¾ç¤º
        function updateCustomSingleSelectDisplay(selectId) {
            const displayElement = document.getElementById(selectId + 'Display');
            const selectedValue = customSingleSelectValues[selectId];

            if (!displayElement) return;

            // æ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹æ–‡æœ¬
            const selectedOption = document.querySelector(`#${selectId}Dropdown [data-value="${selectedValue}"]`);
            if (selectedOption) {
                displayElement.textContent = selectedOption.querySelector('span').textContent;
            }
        }

        // æ›´æ–°å•é€‰é€‰æ‹©å™¨é€‰é¡¹çŠ¶æ€
        function updateCustomSingleSelectOptions(selectId) {
            const dropdown = document.getElementById(selectId + 'Dropdown');
            const selectedValue = customSingleSelectValues[selectId];

            if (!dropdown) return;

            const options = dropdown.querySelectorAll('.custom-select-option');
            options.forEach(option => {
                const value = option.dataset.value;
                if (value === selectedValue) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // è·å–å•é€‰ç­›é€‰å™¨çš„å€¼ï¼ˆå…¼å®¹åŸæœ‰æ¥å£ï¼‰
        function getCustomSingleSelectValue(selectId) {
            return customSingleSelectValues[selectId];
        }

        // è·å–è‡ªå®šä¹‰é€‰æ‹©å™¨çš„å€¼ï¼ˆç”¨äºç­›é€‰é€»è¾‘ï¼‰
        function getCustomSelectValues(selectId) {
            return customSelectValues[selectId] || [];
        }

        // ========== æ¶ˆæ¯å‘é€ç›¸å…³åŠŸèƒ½ ==========

        /**
         * å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™å½“å‰ç”¨æˆ·ï¼ˆç”¨äºæ›¿ä»£åŸç”Ÿé€šçŸ¥ï¼‰
         * @param {string} messageType - æ¶ˆæ¯ç±»å‹
         * @param {string} title - æ¶ˆæ¯æ ‡é¢˜
         * @param {string} content - æ¶ˆæ¯å†…å®¹
         */
        async function sendSystemMessage(messageType, title, content) {
            try {
                const currentUserId = getCurrentUserId();
                if (!currentUserId) {
                    console.warn('æ— æ³•è·å–å½“å‰ç”¨æˆ·IDï¼Œè·³è¿‡å‘é€ç³»ç»Ÿæ¶ˆæ¯');
                    return false;
                }

                const success = await insertMessageToDatabase(
                    'ç³»ç»Ÿ',                   // å‘é€äººï¼ˆç³»ç»Ÿï¼‰
                    currentUserId,           // æ¥æ”¶äººï¼ˆå½“å‰ç”¨æˆ·ï¼‰
                    null,                   // ä»»åŠ¡IDï¼ˆç³»ç»Ÿæ¶ˆæ¯æ— å…³è”ä»»åŠ¡ï¼‰
                    messageType,            // æ¶ˆæ¯ç±»å‹
                    title,                  // æ ‡é¢˜
                    content,                // å†…å®¹
                    null,                   // ä»»åŠ¡æ ‡é¢˜
                    null,                   // å®Œæˆå¤‡æ³¨
                    null                    // å®Œæˆå›¾ç‰‡
                );

                if (success) {
                    console.log(`ç³»ç»Ÿæ¶ˆæ¯å·²å‘é€: ${title}`);

                    // å‘é€å¹¿æ’­é€šçŸ¥ç›‘å¬æœåŠ¡ç«‹å³æ£€æŸ¥æ¶ˆæ¯
                    if (typeof Android !== 'undefined' && Android.sendNewMessageBroadcast) {
                        Android.sendNewMessageBroadcast();
                    }
                } else {
                    console.error('å‘é€ç³»ç»Ÿæ¶ˆæ¯å¤±è´¥');
                }

                return success;
            } catch (error) {
                console.error('å‘é€ç³»ç»Ÿæ¶ˆæ¯æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        // å‘é€ä»»åŠ¡å®Œæˆæ¶ˆæ¯ç»™å…¶ä»–äºº
        async function sendTaskCompletionMessages(task) {
            try {
                // è·å–å½“å‰ç”¨æˆ·èº«ä»½
                const currentUserId = getCurrentUserId();
                if (!currentUserId) {
                    console.warn('æœªè®¾ç½®ç”¨æˆ·èº«ä»½ï¼Œè·³è¿‡å‘é€ä»»åŠ¡å®Œæˆæ¶ˆæ¯');
                    return;
                }

                // è·å–æ‰€æœ‰å®Œæˆäººåˆ—è¡¨
                const allAssignees = getAssigneesList();
                if (!allAssignees || allAssignees.length === 0) {
                    console.warn('æ²¡æœ‰å®Œæˆäººåˆ—è¡¨ï¼Œè·³è¿‡å‘é€æ¶ˆæ¯');
                    return;
                }

                // å‡†å¤‡æ¶ˆæ¯å†…å®¹
                const messageTitle = 'ä»»åŠ¡å®Œæˆé€šçŸ¥';
                let messageContent = `${currentUserId} å®Œæˆäº†ä»»åŠ¡ï¼š${task.title}`;

                if (task.completionNotes && task.completionNotes.trim()) {
                    messageContent += `\n\nå®Œæˆå¤‡æ³¨ï¼š${task.completionNotes}`;
                }

                const completionTime = new Date(task.completedAt).toLocaleString('zh-CN');
                messageContent += `\n\nå®Œæˆæ—¶é—´ï¼š${completionTime}`;

                // å‡†å¤‡å®Œæˆå›¾ç‰‡æ•°æ®
                let completionImagesJson = null;
                if (task.completionImages && task.completionImages.length > 0) {
                    completionImagesJson = JSON.stringify(task.completionImages);
                } else if (task.completionImage) {
                    completionImagesJson = JSON.stringify([task.completionImage]);
                }

                // å‘æ¯ä¸ªå®Œæˆäººå‘é€æ¶ˆæ¯ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
                let successCount = 0;
                const promises = allAssignees.map(async (assignee) => {
                    // ç§»é™¤è¿™ä¸ªæ¡ä»¶ï¼Œç»™æ‰€æœ‰äººåŒ…æ‹¬è‡ªå·±å‘é€æ¶ˆæ¯
                    // if (assignee.name !== currentUserId) {
                        const success = await insertMessageToDatabase(
                            currentUserId,           // å‘é€äºº
                            assignee.name,               // æ¥æ”¶äºº
                            task.id,                // ä»»åŠ¡ID
                            'task_complete',        // æ¶ˆæ¯ç±»å‹
                            messageTitle,           // æ ‡é¢˜
                            messageContent,         // å†…å®¹
                            task.title,             // ä»»åŠ¡æ ‡é¢˜
                            task.completionNotes || null,  // å®Œæˆå¤‡æ³¨
                            completionImagesJson    // å®Œæˆå›¾ç‰‡
                        );
                        if (success) successCount++;
                        return success;
                    // å–æ¶ˆäº†æ¡ä»¶é™åˆ¶ï¼Œç»™æ‰€æœ‰äººå‘é€
                    // }
                    // return true;
                });

                await Promise.all(promises);
                console.log(`å·²å‘é€ä»»åŠ¡å®Œæˆæ¶ˆæ¯ç»™ ${successCount} ä¸ªç”¨æˆ·`);

                // é€šçŸ¥Androidç«¯æœ‰æ–°æ¶ˆæ¯
                notifyAndroidNewMessage();
            } catch (error) {
                console.error('å‘é€ä»»åŠ¡å®Œæˆæ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // æ’å…¥æ¶ˆæ¯åˆ°Supabaseæ•°æ®åº“
        async function insertMessageToDatabase(senderId, receiverId, taskId, messageType, title, content, taskTitle, completionNotes, completionImages) {
            try {
                if (!checkSupabaseConfig()) {
                    console.warn('Supabaseæœªé…ç½®ï¼Œè·³è¿‡æ¶ˆæ¯å‘é€');
                    return false;
                }

                // æ„é€ æ¶ˆæ¯æ•°æ®
                const messageData = {
                    sender_id: senderId,
                    receiver_id: receiverId,
                    task_id: taskId,
                    message_type: messageType,
                    title: title,
                    content: content,
                    task_title: taskTitle,
                    completion_notes: completionNotes,
                    completion_images: completionImages ? JSON.parse(completionImages) : null,
                    user_id: DATABASE_CONFIG.userId,
                    is_read: false,
                    created_at: getCurrentUTCTimeString()
                };

                // å‘é€åˆ°Supabase
                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`æ¶ˆæ¯å·²æ’å…¥Supabase: ${senderId} -> ${receiverId}`, result);
                    return true;
                } else {
                    const error = await response.text();
                    console.error('æ’å…¥æ¶ˆæ¯åˆ°Supabaseå¤±è´¥:', error);
                    return false;
                }
            } catch (error) {
                console.error('æ’å…¥æ¶ˆæ¯åˆ°æ•°æ®åº“å¤±è´¥:', error);
                return false;
            }
        }

        // è·å–å½“å‰ç”¨æˆ·IDï¼ˆä»ä¸ªäººä¿¡æ¯è®¾ç½®è·å–ï¼‰
        function getCurrentUserId() {
            try {
                const settings = JSON.parse(localStorage.getItem('personalInfo') || '{}');
                return settings.myAssignee || null;
            } catch (error) {
                console.error('è·å–å½“å‰ç”¨æˆ·IDå¤±è´¥:', error);
                return null;
            }
        }

        // è·å–å®Œæˆäººåˆ—è¡¨
        function getAssigneesList() {
            try {
                return JSON.parse(localStorage.getItem('assignees') || '[]');
            } catch (error) {
                console.error('è·å–å®Œæˆäººåˆ—è¡¨å¤±è´¥:', error);
                return [];
            }
        }

        // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ¥æ”¶æ¥è‡ªæŸäººçš„æ¶ˆæ¯ï¼ˆæ ¹æ®ä¸ªäººè®¾ç½®ï¼‰
        function shouldReceiveMessageFromSender(senderId) {
            try {
                const personalInfo = JSON.parse(localStorage.getItem('personalInfo') || '{}');

                // å¦‚æœå¼€å¯äº†è§’è‰²é™åˆ¶ï¼Œåªæ¥æ”¶ç›¸å…³äººå‘˜çš„æ¶ˆæ¯
                if (personalInfo.enableRoleRestriction) {
                    const currentUserId = personalInfo.myAssignee;
                    if (!currentUserId) return false;

                    // å¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯æ¥æ”¶è§„åˆ™ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
                    return true;
                }

                return true; // é»˜è®¤æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
            } catch (error) {
                console.error('æ£€æŸ¥æ¶ˆæ¯æ¥æ”¶è®¾ç½®å¤±è´¥:', error);
                return true;
            }
        }

        // é€šçŸ¥Androidç«¯æœ‰æ–°æ¶ˆæ¯
        function notifyAndroidNewMessage() {
            try {
                if (typeof AndroidDatabase !== 'undefined' && AndroidDatabase.onNewMessageNotification) {
                    AndroidDatabase.onNewMessageNotification();
                    console.log('å·²é€šçŸ¥Androidç«¯æœ‰æ–°æ¶ˆæ¯');
                }
            } catch (error) {
                console.error('é€šçŸ¥Androidç«¯æ–°æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // è·å–æœªè¯»æ¶ˆæ¯æ•°é‡ï¼ˆç»™Androidç«¯è°ƒç”¨ï¼‰
        async function getUnreadMessageCount(userId) {
            try {
                if (!checkSupabaseConfig()) {
                    return 0;
                }

                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/messages?user_id=eq.${DATABASE_CONFIG.userId}&receiver_id=eq.${userId}&is_read=eq.false&select=count`, {
                    method: 'GET',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.length || 0;
                } else {
                    console.error('è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥');
                    return 0;
                }
            } catch (error) {
                console.error('è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:', error);
                return 0;
            }
        }

        // è·å–ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯ï¼ˆç»™Androidç«¯è°ƒç”¨ï¼‰
        async function getUnreadMessages(userId) {
            try {
                if (!checkSupabaseConfig()) {
                    return [];
                }

                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/messages?user_id=eq.${DATABASE_CONFIG.userId}&receiver_id=eq.${userId}&is_read=eq.false&order=created_at.desc`, {
                    method: 'GET',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const messages = await response.json();
                    console.log(`è·å–åˆ° ${messages.length} æ¡æœªè¯»æ¶ˆæ¯`);
                    return messages;
                } else {
                    console.error('è·å–æœªè¯»æ¶ˆæ¯å¤±è´¥');
                    return [];
                }
            } catch (error) {
                console.error('è·å–æœªè¯»æ¶ˆæ¯å¤±è´¥:', error);
                return [];
            }
        }

        // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
        async function markMessageAsRead(messageId) {
            try {
                if (!checkSupabaseConfig()) {
                    return false;
                }

                const response = await fetch(`${DATABASE_CONFIG.supabaseUrl}/rest/v1/messages?id=eq.${messageId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': DATABASE_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${DATABASE_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        is_read: true,
                        read_at: getCurrentUTCTimeString()
                    })
                });

                if (response.ok) {
                    console.log('æ¶ˆæ¯å·²æ ‡è®°ä¸ºå·²è¯»:', messageId);
                    return true;
                } else {
                    console.error('æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»å¤±è´¥');
                    return false;
                }
            } catch (error) {
                console.error('æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»å¤±è´¥:', error);
                return false;
            }
        }

        // åŒæ­¥ç”¨æˆ·è®¾ç½®åˆ°Androidç«¯ï¼ˆå½“ç”¨æˆ·è®¾ç½®æ”¹å˜æ—¶è°ƒç”¨ï¼‰
        function syncUserSettingsToAndroid() {
            try {
                const currentUserId = getCurrentUserId();
                if (currentUserId && typeof AndroidDatabase !== 'undefined' && AndroidDatabase.updateCurrentUserId) {
                    AndroidDatabase.updateCurrentUserId(currentUserId);
                    console.log('ç”¨æˆ·è®¾ç½®å·²åŒæ­¥åˆ°Androidç«¯:', currentUserId);
                }
            } catch (error) {
                console.error('åŒæ­¥ç”¨æˆ·è®¾ç½®åˆ°Androidå¤±è´¥:', error);
            }
        }

        // åŒæ­¥æ•°æ®åº“é…ç½®åˆ°Androidç«¯
        function syncDatabaseConfigToAndroid() {
            try {
                const supabaseUrl = localStorage.getItem('supabase_url') || '';
                const supabaseAnonKey = localStorage.getItem('supabase_anon_key') || '';
                const supabaseUserId = localStorage.getItem('supabase_user_id') || '';

                if (typeof AndroidDatabase !== 'undefined' && AndroidDatabase.updateDatabaseConfig) {
                    const success = AndroidDatabase.updateDatabaseConfig(supabaseUrl, supabaseAnonKey, supabaseUserId);
                    if (success) {
                        console.log('æ•°æ®åº“é…ç½®å·²åŒæ­¥åˆ°Androidç«¯');
                    } else {
                        console.warn('æ•°æ®åº“é…ç½®åŒæ­¥åˆ°Androidç«¯å¤±è´¥');
                    }
                } else {
                    console.warn('AndroidDatabaseæ¥å£ä¸å¯ç”¨ï¼Œè·³è¿‡æ•°æ®åº“é…ç½®åŒæ­¥');
                }
            } catch (error) {
                console.error('åŒæ­¥æ•°æ®åº“é…ç½®åˆ°Androidå¤±è´¥:', error);
            }
        }

        // ==================== ç»Ÿä¸€æ—¶é—´å¤„ç†å·¥å…·å‡½æ•° ====================

        /**
         * è·å–å½“å‰æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
         * ä¸“é—¨ç”¨äºä¸­å›½æ—¶åŒº(UTC+8)ï¼Œè¿”å›æœ¬åœ°æ—¶é—´è€Œä¸æ˜¯UTCæ—¶é—´
         */
        function getCurrentUTCTimeString() {
            const now = new Date();

            // è·å–æœ¬åœ°æ—¶é—´çš„å„ä¸ªç»„ä»¶
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            // è¿”å›æœ¬åœ°æ—¶é—´æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œé€‚ç”¨äºä¸­å›½æ—¶åŒº
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }

        /**
         * è·å–å½“å‰çœŸæ­£çš„UTCæ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
         */
        function getCurrentRealUTCTimeString() {
            return new Date().toISOString();
        }

        /**
         * å°†datetime-localè¾“å…¥å€¼è½¬æ¢ä¸ºUTCæ—¶é—´å­—ç¬¦ä¸²
         * ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´å€¼åœ¨æ•°æ®åº“ä¸­ä¿æŒä¸å˜
         */
        function convertLocalTimeToUTC(localTimeString) {
            if (!localTimeString) return null;

            // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„ISOå­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›
            if (localTimeString.includes('Z') || localTimeString.includes('+')) {
                return localTimeString;
            }

            // è§£ædatetime-localæ ¼å¼çš„æ—¶é—´
            const [datePart, timePart] = localTimeString.split('T');
            if (!datePart || !timePart) return null;

            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes] = timePart.split(':').map(Number);

            // ç›´æ¥æ„é€ UTCæ—¶é—´ï¼Œæ—¶é—´æ•°å€¼ä¸ç”¨æˆ·è¾“å…¥ä¸€è‡´
            const utcDate = new Date(Date.UTC(year, month - 1, day, hours, minutes, 0, 0));
            return isNaN(utcDate.getTime()) ? null : utcDate.toISOString();
        }

        /**
         * å°†UTCæ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºdatetime-localæ ¼å¼æ˜¾ç¤º
         * æ˜¾ç¤ºæ—¶é—´å€¼ä¸ç”¨æˆ·å½“åˆé€‰æ‹©çš„å®Œå…¨ä¸€è‡´
         */
        function convertUTCToLocalDisplay(utcTimeString) {
            if (!utcTimeString) return '';

            const utcDate = new Date(utcTimeString);
            if (isNaN(utcDate.getTime())) return '';

            // ä½¿ç”¨UTCæ—¶é—´ç»„ä»¶ï¼Œç¡®ä¿æ˜¾ç¤ºä¸ç”¨æˆ·é€‰æ‹©ä¸€è‡´
            const year = utcDate.getUTCFullYear();
            const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(utcDate.getUTCDate()).padStart(2, '0');
            const hours = String(utcDate.getUTCHours()).padStart(2, '0');
            const minutes = String(utcDate.getUTCMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        /**
         * å°†UTCæ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ˜¾ç¤ºï¼ˆç”¨äºæ ¼å¼åŒ–æ˜¾ç¤ºï¼‰
         * ä¿®å¤æ˜¾ç¤ºæ—¶é—´ä¸æ•°æ®åº“æ—¶é—´ä¸€è‡´çš„é—®é¢˜
         */
        function convertUTCToLocalForDisplay(utcTimeString) {
            if (!utcTimeString) return null;

            const utcDate = new Date(utcTimeString);
            if (isNaN(utcDate.getTime())) return null;

            // ç›´æ¥ä½¿ç”¨UTCæ—¶é—´ç»„ä»¶åˆ›å»ºæœ¬åœ°Dateå¯¹è±¡ï¼Œé¿å…æ—¶åŒºè½¬æ¢
            return new Date(
                utcDate.getUTCFullYear(),
                utcDate.getUTCMonth(),
                utcDate.getUTCDate(),
                utcDate.getUTCHours(),
                utcDate.getUTCMinutes(),
                utcDate.getUTCSeconds()
            );
        }

        /**
         * åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¶…æ—¶
         * æ­£ç¡®å¤„ç†UTCå­˜å‚¨æ—¶é—´ä¸å½“å‰æœ¬åœ°æ—¶é—´çš„æ¯”è¾ƒ
         */
        function isTaskOverdue(deadline) {
            if (!deadline) return false;

            try {
                // å°†UTCå­˜å‚¨çš„æˆªæ­¢æ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
                const deadlineLocalTime = convertUTCToLocalForDisplay(deadline);
                if (!deadlineLocalTime) {
                    console.warn('Invalid deadline format in isTaskOverdue:', deadline);
                    return false;
                }

                // è·å–å½“å‰æœ¬åœ°æ—¶é—´
                const now = new Date();

                // æ¯”è¾ƒæœ¬åœ°æ—¶é—´
                const isOverdue = deadlineLocalTime < now;

                // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨æµ‹è¯•æ¨¡å¼ä¸‹è¾“å‡ºï¼‰
                if (isOverdue && window.location.search.includes('debug=true')) {
                    console.log('Task overdue detected:', {
                        deadline: deadline,
                        deadlineLocalTime: deadlineLocalTime.toLocaleString(),
                        now: now.toLocaleString(),
                        isOverdue: isOverdue
                    });
                }

                return isOverdue;
            } catch (error) {
                console.error('Error in isTaskOverdue:', error, 'deadline:', deadline);
                return false;
            }
        }

        /**
         * åˆ›å»ºæ—¥æœŸç­›é€‰çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼ˆUTCæ ¼å¼ï¼‰
         * ä¿®å¤ç­›é€‰å‚æ•°æ—¶åŒºé—®é¢˜
         */
        function createDateRangeForFilter(date, isStartOfDay = true) {
            if (!date) return null;

            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();

            if (isStartOfDay) {
                // å¼€å§‹æ—¶é—´ï¼š00:00:00
                return new Date(Date.UTC(year, month, day, 0, 0, 0, 0)).toISOString();
            } else {
                // ç»“æŸæ—¶é—´ï¼š23:59:59
                return new Date(Date.UTC(year, month, day, 23, 59, 59, 999)).toISOString();
            }
        }

        // æ—¶é—´å¤„ç†æµ‹è¯•å‡½æ•°
        function testTimeHandling() {
            console.log('=== å…³é”®æ—¶é—´å¤„ç†æµ‹è¯• ===');

            // æµ‹è¯•å½“å‰æ—¶é—´å‡½æ•°
            const currentLocalTime = getCurrentUTCTimeString();
            const currentRealUTCTime = getCurrentRealUTCTimeString();
            const jsLocalTime = new Date().toLocaleString('zh-CN');

            console.log('1. æœ¬åœ°æ—¶é—´å‡½æ•°ç»“æœ:', currentLocalTime);
            console.log('2. çœŸå®UTCæ—¶é—´ç»“æœ:', currentRealUTCTime);
            console.log('3. JSæœ¬åœ°æ—¶é—´æ˜¾ç¤º:', jsLocalTime);
            console.log('4. æ—¶åŒºåç§»:', new Date().getTimezoneOffset(), 'åˆ†é’Ÿ (è´Ÿæ•°è¡¨ç¤ºä¸œæ—¶åŒº)');

            // æµ‹è¯•datetime-localå€¼å¤„ç†
            const testTime = '2024-01-15T23:59';
            console.log('--- datetime-localæµ‹è¯• ---');
            console.log('1. datetime-localè¾“å…¥:', testTime);
            console.log('2. new Date()è§£æç»“æœ:', new Date(testTime).toString());
            console.log('3. toISOString()è½¬UTC:', new Date(testTime).toISOString());
            console.log('4. è½¬æ¢å‡½æ•°ç»“æœ:', convertLocalTimeToUTC(testTime));
            console.log('5. æœ€ç»ˆæ˜¾ç¤ºæ•ˆæœ:', new Date(convertLocalTimeToUTC(testTime)).toLocaleString('zh-CN'));

            console.log('--- æœŸæœ›ç»“æœ ---');
            console.log('ç”¨æˆ·é€‰æ‹©: 2024å¹´1æœˆ15æ—¥ 23:59');
            console.log('æ˜¾ç¤ºåº”è¯¥: 2024å¹´1æœˆ15æ—¥ 23:59');

            // éªŒè¯åˆ›å»ºæ—¶é—´æ˜¯å¦æ­£ç¡®
            console.log('--- åˆ›å»ºæ—¶é—´éªŒè¯ ---');
            console.log('åˆ›å»ºæ—¶é—´åº”è¯¥æ˜¯æœ¬åœ°æ—¶é—´:', currentLocalTime);
            console.log('å¯¹åº”çš„æœ¬åœ°æ˜¾ç¤º:', new Date(currentLocalTime).toLocaleString('zh-CN'));
        }



    </script>

    <!-- é€šç”¨Loadingè¦†ç›–å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">æ­£åœ¨åŠ è½½...</div>
            <div class="loading-subtitle" id="loadingSubtitle">è¯·ç¨å€™</div>
        </div>
    </div>

    <!-- åˆ·æ–°æ‚¬æµ®æŒ‰é’® -->
    <button class="refresh-fab" id="refreshFab" title="åˆ·æ–°ä»»åŠ¡åˆ—è¡¨">
        <span class="refresh-icon">ğŸ”„</span>
    </button>

</body>
</html>